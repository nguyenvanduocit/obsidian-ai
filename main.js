var ud=Object.create;var Ln=Object.defineProperty;var cd=Object.getOwnPropertyDescriptor;var ld=Object.getOwnPropertyNames;var dd=Object.getPrototypeOf,hd=Object.prototype.hasOwnProperty;var fd=(n,e,t)=>e in n?Ln(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var pe=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),_i=(n,e)=>{for(var t in e)Ln(n,t,{get:e[t],enumerable:!0})},eu=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of ld(e))!hd.call(n,s)&&s!==t&&Ln(n,s,{get:()=>e[s],enumerable:!(r=cd(e,s))||r.enumerable});return n};var Ce=(n,e,t)=>(t=n!=null?ud(dd(n)):{},eu(e||!n||!n.__esModule?Ln(t,"default",{value:n,enumerable:!0}):t,n)),pd=n=>eu(Ln({},"__esModule",{value:!0}),n);var _t=(n,e,t)=>(fd(n,typeof e!="symbol"?e+"":e,t),t);var cu=pe((Og,uu)=>{"use strict";uu.exports=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e=="undefined"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var gu=pe((Pg,Ai)=>{"use strict";var _d=/[\p{Lu}]/u,wd=/[\p{Ll}]/u,lu=/^[\p{Lu}](?![\p{Lu}])/gu,fu=/([\p{Alpha}\p{N}_]|$)/u,pu=/[_.\- ]+/,vd=new RegExp("^"+pu.source),du=new RegExp(pu.source+fu.source,"gu"),hu=new RegExp("\\d+"+fu.source,"gu"),Ad=(n,e,t)=>{let r=!1,s=!1,a=!1;for(let i=0;i<n.length;i++){let o=n[i];r&&_d.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,a=s,s=!0,i++):s&&a&&wd.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),a=s,s=!1,r=!0):(r=e(o)===o&&t(o)!==o,a=s,s=t(o)===o&&e(o)!==o)}return n},xd=(n,e)=>(lu.lastIndex=0,n.replace(lu,t=>e(t))),Ed=(n,e)=>(du.lastIndex=0,hu.lastIndex=0,n.replace(du,(t,r)=>e(r)).replace(hu,t=>e(t))),mu=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(a=>a.trim()).filter(a=>a.length).join("-"):n=n.trim(),n.length===0)return"";let t=e.locale===!1?a=>a.toLowerCase():a=>a.toLocaleLowerCase(e.locale),r=e.locale===!1?a=>a.toUpperCase():a=>a.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Ad(n,t,r)),n=n.replace(vd,""),e.preserveConsecutiveUppercase?n=xd(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Ed(n,r))};Ai.exports=mu;Ai.exports.default=mu});var Mu=pe((sy,Lu)=>{function Pe(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}Lu.exports=Pe;Pe.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Pe.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Pe.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};Pe.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Pe.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};Pe.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};Pe.prototype.start=Pe.prototype.try;Pe.prototype.errors=function(){return this._errors};Pe.prototype.attempts=function(){return this._attempts};Pe.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],a=s.message,i=(n[a]||0)+1;n[a]=i,i>=t&&(e=s,t=i)}return e}});var Du=pe(nr=>{var nh=Mu();nr.operation=function(n){var e=nr.timeouts(n);return new nh(e,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})};nr.timeouts=function(n){if(n instanceof Array)return[].concat(n);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in n)e[t]=n[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],s=0;s<e.retries;s++)r.push(this.createTimeout(s,e));return n&&n.forever&&!r.length&&r.push(this.createTimeout(s,e)),r.sort(function(a,i){return a-i}),r};nr.createTimeout=function(n,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,n));return r=Math.min(r,e.maxTimeout),r};nr.wrap=function(n,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in n)typeof n[r]=="function"&&t.push(r)}for(var s=0;s<t.length;s++){var a=t[s],i=n[a];n[a]=function(u){var c=nr.operation(e),l=Array.prototype.slice.call(arguments,1),d=l.pop();l.push(function(h){c.retry(h)||(h&&(arguments[0]=c.mainError()),d.apply(this,arguments))}),c.attempt(function(){u.apply(n,l)})}.bind(n,i),n[a].options=e}}});var zu=pe((iy,Fu)=>{Fu.exports=Du()});var Xs=pe((oy,Ys)=>{"use strict";var sh=zu(),ah=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],Js=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},ih=(n,e,t)=>{let r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},oh=n=>ah.includes(n),Uu=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let s=sh.operation(e);s.attempt(async a=>{try{t(await n(a))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof Js)s.stop(),r(i.originalError);else if(i instanceof TypeError&&!oh(i.message))s.stop(),r(i);else{ih(i,a,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}s.retry(i)||r(s.mainError())}}})});Ys.exports=Uu;Ys.exports.default=Uu;Ys.exports.AbortError=Js});var Ku=pe((uy,ki)=>{"use strict";var uh=Object.prototype.hasOwnProperty,ce="~";function Vn(){}Object.create&&(Vn.prototype=Object.create(null),new Vn().__proto__||(ce=!1));function ch(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function Bu(n,e,t,r,s){if(typeof t!="function")throw new TypeError("The listener must be a function");var a=new ch(t,r||n,s),i=ce?ce+e:e;return n._events[i]?n._events[i].fn?n._events[i]=[n._events[i],a]:n._events[i].push(a):(n._events[i]=a,n._eventsCount++),n}function Qs(n,e){--n._eventsCount===0?n._events=new Vn:delete n._events[e]}function ae(){this._events=new Vn,this._eventsCount=0}ae.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)uh.call(t,r)&&e.push(ce?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};ae.prototype.listeners=function(e){var t=ce?ce+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var s=0,a=r.length,i=new Array(a);s<a;s++)i[s]=r[s].fn;return i};ae.prototype.listenerCount=function(e){var t=ce?ce+e:e,r=this._events[t];return r?r.fn?1:r.length:0};ae.prototype.emit=function(e,t,r,s,a,i){var o=ce?ce+e:e;if(!this._events[o])return!1;var u=this._events[o],c=arguments.length,l,d;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,s),!0;case 5:return u.fn.call(u.context,t,r,s,a),!0;case 6:return u.fn.call(u.context,t,r,s,a,i),!0}for(d=1,l=new Array(c-1);d<c;d++)l[d-1]=arguments[d];u.fn.apply(u.context,l)}else{var h=u.length,f;for(d=0;d<h;d++)switch(u[d].once&&this.removeListener(e,u[d].fn,void 0,!0),c){case 1:u[d].fn.call(u[d].context);break;case 2:u[d].fn.call(u[d].context,t);break;case 3:u[d].fn.call(u[d].context,t,r);break;case 4:u[d].fn.call(u[d].context,t,r,s);break;default:if(!l)for(f=1,l=new Array(c-1);f<c;f++)l[f-1]=arguments[f];u[d].fn.apply(u[d].context,l)}}return!0};ae.prototype.on=function(e,t,r){return Bu(this,e,t,r,!1)};ae.prototype.once=function(e,t,r){return Bu(this,e,t,r,!0)};ae.prototype.removeListener=function(e,t,r,s){var a=ce?ce+e:e;if(!this._events[a])return this;if(!t)return Qs(this,a),this;var i=this._events[a];if(i.fn)i.fn===t&&(!s||i.once)&&(!r||i.context===r)&&Qs(this,a);else{for(var o=0,u=[],c=i.length;o<c;o++)(i[o].fn!==t||s&&!i[o].once||r&&i[o].context!==r)&&u.push(i[o]);u.length?this._events[a]=u.length===1?u[0]:u:Qs(this,a)}return this};ae.prototype.removeAllListeners=function(e){var t;return e?(t=ce?ce+e:e,this._events[t]&&Qs(this,t)):(this._events=new Vn,this._eventsCount=0),this};ae.prototype.off=ae.prototype.removeListener;ae.prototype.addListener=ae.prototype.on;ae.prefixed=ce;ae.EventEmitter=ae;typeof ki!="undefined"&&(ki.exports=ae)});var qu=pe((cy,Hu)=>{"use strict";Hu.exports=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var Gu=pe((ly,ta)=>{"use strict";var lh=qu(),ea=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},Vu=(n,e,t)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}let a=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){s(u)}return}let i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new ea(i);typeof n.cancel=="function"&&n.cancel(),s(o)},e);lh(n.then(r,s),()=>{clearTimeout(a)})});ta.exports=Vu;ta.exports.default=Vu;ta.exports.TimeoutError=ea});var Zu=pe(Ni=>{"use strict";Object.defineProperty(Ni,"__esModule",{value:!0});function dh(n,e,t){let r=0,s=n.length;for(;s>0;){let a=s/2|0,i=r+a;t(n[i],e)<=0?(r=++i,s-=a+1):s=a}return r}Ni.default=dh});var Wu=pe(ji=>{"use strict";Object.defineProperty(ji,"__esModule",{value:!0});var hh=Zu(),Ri=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let s=hh.default(this._queue,r,(a,i)=>i.priority-a.priority);this._queue.splice(s,0,r)}dequeue(){let e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};ji.default=Ri});var na=pe(Li=>{"use strict";Object.defineProperty(Li,"__esModule",{value:!0});var fh=Ku(),Ju=Gu(),ph=Wu(),ra=()=>{},mh=new Ju.TimeoutError,$i=class extends fh{constructor(e){var t,r,s,a;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=ra,this._resolveIdle=ra,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:ph.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(a=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&a!==void 0?a:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=ra,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=ra,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,s)=>{let a=async()=>{this._pendingCount++,this._intervalCount++;try{let i=this._timeout===void 0&&t.timeout===void 0?e():Ju.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(mh)});r(await i)}catch(i){s(i)}this._next()};this._queue.enqueue(a,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Li.default=$i});var ec=pe(aa=>{"use strict";aa.byteLength=_h;aa.toByteArray=vh;aa.fromByteArray=Eh;var He=[],Ie=[],bh=typeof Uint8Array!="undefined"?Uint8Array:Array,Mi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(sr=0,Xu=Mi.length;sr<Xu;++sr)He[sr]=Mi[sr],Ie[Mi.charCodeAt(sr)]=sr;var sr,Xu;Ie[45]=62;Ie[95]=63;function Qu(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function _h(n){var e=Qu(n),t=e[0],r=e[1];return(t+r)*3/4-r}function wh(n,e,t){return(e+t)*3/4-t}function vh(n){var e,t=Qu(n),r=t[0],s=t[1],a=new bh(wh(n,r,s)),i=0,o=s>0?r-4:r,u;for(u=0;u<o;u+=4)e=Ie[n.charCodeAt(u)]<<18|Ie[n.charCodeAt(u+1)]<<12|Ie[n.charCodeAt(u+2)]<<6|Ie[n.charCodeAt(u+3)],a[i++]=e>>16&255,a[i++]=e>>8&255,a[i++]=e&255;return s===2&&(e=Ie[n.charCodeAt(u)]<<2|Ie[n.charCodeAt(u+1)]>>4,a[i++]=e&255),s===1&&(e=Ie[n.charCodeAt(u)]<<10|Ie[n.charCodeAt(u+1)]<<4|Ie[n.charCodeAt(u+2)]>>2,a[i++]=e>>8&255,a[i++]=e&255),a}function Ah(n){return He[n>>18&63]+He[n>>12&63]+He[n>>6&63]+He[n&63]}function xh(n,e,t){for(var r,s=[],a=e;a<t;a+=3)r=(n[a]<<16&16711680)+(n[a+1]<<8&65280)+(n[a+2]&255),s.push(Ah(r));return s.join("")}function Eh(n){for(var e,t=n.length,r=t%3,s=[],a=16383,i=0,o=t-r;i<o;i+=a)s.push(xh(n,i,i+a>o?o:i+a));return r===1?(e=n[t-1],s.push(He[e>>2]+He[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],s.push(He[e>>10]+He[e>>4&63]+He[e<<2&63]+"=")),s.join("")}});var bc=pe((zy,yc)=>{"use strict";var mc=(n=0)=>e=>`\x1B[${38+n};5;${e}m`,gc=(n=0)=>(e,t,r)=>`\x1B[${38+n};2;${e};${t};${r}m`;function Lf(){let n=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[s,a]of Object.entries(r))e[s]={open:`\x1B[${a[0]}m`,close:`\x1B[${a[1]}m`},r[s]=e[s],n.set(a[0],a[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:n,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=mc(),e.color.ansi16m=gc(),e.bgColor.ansi256=mc(10),e.bgColor.ansi16m=gc(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,s)=>t===r&&r===s?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(s/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:s}=r.groups;s.length===3&&(s=s.split("").map(i=>i+i).join(""));let a=Number.parseInt(s,16);return[a>>16&255,a>>8&255,a&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty(yc,"exports",{enumerable:!0,get:Lf})});var Gm={};_i(Gm,{default:()=>bi});module.exports=pd(Gm);var Be=require("obsidian");var tu=require("obsidian"),js=class extends tu.Events{constructor(){super()}on(e,t){return super.on(e,t)}trigger(e,...t){return super.trigger(e,...t)}};var ru=require("obsidian");var wi={header:"_header_jetps_1"};var Ls="ai-assistant-view";console.log(wi);var $s=class extends ru.ItemView{constructor(e,t){super(e),this.plugin=t}async onload(){this.renderView()}renderView(){this.contentEl.empty(),this.contentEl.addClass("ai-assistant--view"),this.contentEl.createDiv(wi.header).createEl("h2",{text:"AI Assistant",cls:"ai-assistant--title"})}onunload(){super.onunload()}onPaneMenu(e,t){super.onPaneMenu(e,t),e.addItem(r=>{r.setTitle("Help..."),r.setIcon("globe"),r.onClick(()=>{open("https://twitter.com/duocdev")})})}getViewType(){return Ls}getDisplayText(){return"AI Assistant"}getIcon(){return"lucide-sparkles"}};var nu=require("obsidian"),Yr=n=>{let e=n.workspace.getActiveViewOfType(nu.ItemView);return(e==null?void 0:e.getViewType())==="canvas"?e.canvas:null};function vi(n,e){let t=Object.keys(e).map(r=>md(n,r,e[r]));return t.length===1?t[0]:function(){t.forEach(r=>r())}}function md(n,e,t){let r=n[e],s=n.hasOwnProperty(e),a=s?r:function(){return Object.getPrototypeOf(n)[e].apply(this,arguments)},i=t(a);return r&&Object.setPrototypeOf(i,r),Object.setPrototypeOf(o,i),n[e]=o,u;function o(...c){return i===a&&n[e]===o&&u(),i.apply(this,c)}function u(){n[e]===o&&(s?n[e]=a:delete n[e]),i!==a&&(i=a,Object.setPrototypeOf(o,r||Function))}}var Ms=n=>{let e=Yr(n.app);return e?(e.menu&&n.register(vi(e.menu.constructor.prototype,{render:t=>(console.log("[patched] menu.render"),function(...r){let s=t.call(this,...r);if(this.menuEl.children.length===0||this.canvas.selection.size!==1)return s;let a=this.canvas.selection.values().next().value;return Object.prototype.hasOwnProperty.call(a,"path")||Object.prototype.hasOwnProperty.call(a,"bgPath")||n.events.trigger("canvas:node-menu",this,this.canvas,a),s})})),n.register(vi(e.constructor.prototype,{addEdge:t=>(console.log("[patched] canvas.addEdge"),function(...r){var s,a;return r[0].color=(a=(s=r[0].from)==null?void 0:s.node)==null?void 0:a.color,t.call(this,...r)})})),!0):!1};var iu=require("obsidian");var Mn=n=>{let e=[];for(let t=0;t<n;t++)e.push((16*Math.random()|0).toString(16));return e.join("")};var su=async(n,e,t,r,s)=>{if(!n)return;let a=n.getData();a&&(n.importData({edges:[...a.edges,{...s,id:e,fromNode:t.node.id,fromSide:t.side,toNode:r.node.id,toSide:r.side}],nodes:a.nodes}),await n.requestFrame())};var au=async(n,e)=>{if(!n)return;let t=n.getData();t&&(n.importData({edges:[...t.edges,...e],nodes:t.nodes}),await n.requestFrame())};var Ds=50,Xr=80;function bd(n,e,t,r){var l,d,h,f,p,y;let s=e.x+e.width+Xr,a=e.y+e.height+Xr,i=n.getEdgesForNode(e).filter(m=>m.from.node.id==e.id&&m.from.side==t).map(m=>m.to.node),o=i.reduce((m,_)=>{switch(t){case"left":case"right":return _.y>m.y?_:m;case"top":case"bottom":return _.x>m.x?_:m}},i[0]),u=(d=(l=r==null?void 0:r.size)==null?void 0:l.width)!=null?d:500,c=(f=(h=r==null?void 0:r.size)==null?void 0:h.height)!=null?f:250;switch(t){case"left":s=o?o.x+o.width-u:e.x-u-Xr,a=o?o.y+o.height+Ds:e.y+e.height/2-c/2;break;case"right":s=(p=o==null?void 0:o.x)!=null?p:e.x+e.width+Xr,a=o?o.y+o.height+Ds:e.y+e.height/2-c/2;break;case"top":s=o?o.x+o.width+Ds:e.x+e.width/2-u/2,a=o?o.y+o.height-c:e.y-c-Xr;break;case"bottom":s=o?o.x+o.width+Ds:e.x+e.width/2-u/2,a=(y=o==null?void 0:o.y)!=null?y:e.y+e.height+Xr;break}return{x:s,y:a,width:u,height:c}}var Qr=async(n,e,t,r,s)=>{var f,p,y,m;let a=n.getEdgesForNode(e).filter(_=>_.to.node.id===e.id),i="bottom",o="top";if(a.length>0){let _=a[0];_.to.side==="left"?(i="right",o="left"):_.to.side==="right"?(i="left",o="right"):_.to.side==="top"?(i="bottom",o="top"):_.to.side==="bottom"&&(i="top",o="bottom")}let{x:u,y:c,width:l,height:d}=bd(n,e,i,t),h=n.createTextNode({pos:{x:u,y:c},size:{height:(p=(f=t==null?void 0:t.size)==null?void 0:f.height)!=null?p:d,width:(m=(y=t==null?void 0:t.size)==null?void 0:y.width)!=null?m:l},text:t==null?void 0:t.text,focus:!1});return r&&h.setData(r),n.deselectAll(),n.addNode(h),await su(n,Mn(16),{side:i,node:e},{side:o,node:h},s),h};var ou=async n=>{let e=Yr(n);if(!e){new iu.Notice("No active canvas");return}let r=e.selection.values().next().value;e.deselectAll();let s=await Qr(e,r,{size:{height:50}},{role:"user"});await e.requestSave(),await e.requestFrame(),setTimeout(()=>{s.startEditing()},100)};var yu=Ce(cu(),1),Od=Ce(gu(),1);function bu(n,e){return(e==null?void 0:e[n])||(0,yu.default)(n)}function _u(n,e,t){let r={};for(let s in n)Object.hasOwn(n,s)&&(r[e(s,t)]=n[s]);return r}function wu(n){return Array.isArray(n)?[...n]:{...n}}function Pd(n,e){let t=wu(n);for(let[r,s]of Object.entries(e)){let[a,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=wu(o[u]),o=o[u]}o[a]!==void 0&&(o[a]={lc:1,type:"secret",id:[s]})}return t}function xi(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var Se=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,xi(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((s,a)=>(s[a]=a in this?this[a]:this.lc_kwargs[a],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let a=this,i=r,[o,...u]=s.split(".").reverse();for(let c of u.reverse()){if(!(c in a)||a[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof a[c]=="object"&&a[c]!=null?i[c]={}:Array.isArray(a[c])&&(i[c]=[])),a=a[c],i=i[c]}o in a&&a[o]!==void 0&&(i[o]=i[o]||a[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:_u(Object.keys(t).length?Pd(r,t):r,bu,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function en(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}var Zt=class extends Se{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){let e=this._getType();if(e==="human")return new Dn({...this});if(e==="ai")return new tt({...this});if(e==="system")return new Fn({...this});if(e==="function")return new zn({...this});if(vt.isInstance(this))return new Un({...this});throw new Error("Unknown message type.")}};function vu(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}function be(n,e){var r,s;let t={...n};for(let[a,i]of Object.entries(e))if(t[a]==null)t[a]=i;else{if(i==null)continue;if(typeof t[a]!=typeof i||Array.isArray(t[a])!==Array.isArray(i))throw new Error(`field[${a}] already exists in the message chunk, but with a different type.`);if(typeof t[a]=="string")t[a]=t[a]+i;else if(!Array.isArray(t[a])&&typeof t[a]=="object")t[a]=be(t[a],i);else if(a==="tool_calls"&&vu(t[a])&&vu(i))for(let o of i)((r=t[a])==null?void 0:r[o.index])!==void 0?t[a]=(s=t[a])==null?void 0:s.map((u,c)=>{var l,d,h;return c!==o.index?u:{...u,...o,function:{name:(l=o.function.name)!=null?l:u.function.name,arguments:((d=u.function.arguments)!=null?d:"")+((h=o.function.arguments)!=null?h:"")}}}):t[a][o.index]=o;else if(Array.isArray(t[a]))t[a]=t[a].concat(i);else{if(t[a]===i)continue;console.warn(`field[${a}] already exists in this message chunk and value has unsupported type.`)}}return t}var wt=class extends Zt{},_e=class extends Zt{static lc_name(){return"HumanMessage"}_getType(){return"human"}},Dn=class n extends wt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:en(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata)})}},Oe=class extends Zt{static lc_name(){return"AIMessage"}_getType(){return"ai"}},tt=class n extends wt{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new n({content:en(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata)})}},Wt=class extends Zt{static lc_name(){return"SystemMessage"}_getType(){return"system"}},Fn=class n extends wt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:en(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata)})}};var zn=class n extends wt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){var t;return new n({content:en(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),name:(t=this.name)!=null?t:""})}};var Fs=class n extends wt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new n({content:en(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}},vt=class n extends Zt{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}};function Jt(n){return typeof(n==null?void 0:n._getType)=="function"}function Au(n){return Jt(n)&&typeof n.concat=="function"}function Yt(n){if(typeof n=="string")return new _e(n);if(Jt(n))return n;let[e,t]=n;if(e==="human"||e==="user")return new _e({content:t});if(e==="ai"||e==="assistant")return new Oe({content:t});if(e==="system")return new Wt({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}var Un=class n extends wt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:en(this.content,e.content),additional_kwargs:be(this.additional_kwargs,e.additional_kwargs),response_metadata:be(this.response_metadata,e.response_metadata),role:this.role})}};function tn(n,e="Human",t="AI"){let r=[];for(let s of n){let a;if(s._getType()==="human")a=e;else if(s._getType()==="ai")a=t;else if(s._getType()==="system")a="System";else if(s._getType()==="function")a="Function";else if(s._getType()==="tool")a="Tool";else if(s._getType()==="generic")a=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);let i=s.name?`${s.name}, `:"";r.push(`${a}: ${i}${s.content}`)}return r.join(`
`)}var yi=require("obsidian");function Id(n){let t=n.canvas.getEdgesForNode(n).filter(r=>r.to.node.id===n.id).map(r=>r.from.node);return t.sort((r,s)=>s.x-r.x),t}async function xu(n,e,t=Id){let r=new Set,s=[{node:n,depth:0}];for(;s.length>0;){let{node:a,depth:i}=s.shift();if(r.has(a.id))continue;if(!await e(a,i))break;r.add(a.id);let u=t(a);for(let c of u)r.has(c.id)||s.push({node:c,depth:i+1})}}var $g=Ce(require("electron")),zs=require("obsidian");async function Td(n,e,t){var s;let r=await n.vault.read(e);if(t){let a=n.metadataCache.getFileCache(e);if(a){let i=(0,zs.resolveSubpath)(a,t);if(!i)return console.warn("Failed to get subpath",{file:e,subpath:t}),r;if(i.start||i.end){let o=r.slice(i.start.offset,(s=i.end)==null?void 0:s.offset);return o||(console.warn("Failed to get subpath",{file:e,subpath:t}),r)}}}return r}async function Cd(n){return await n.executeJavaScript("document.body.innerText")}var Sd="https://get-youtube-transcript.fly.dev/transcripts/:id/?format=plain&chunk-size=3000&include-time=true";async function kd(n){var a;let e=(a=n.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/))==null?void 0:a[1];if(!e)throw new Error("Failed to get youtube id");let t=Sd.replace(":id",e),r=await fetch(t);if(!r.ok)throw new Error("Failed to get youtube transcript");return(await r.json()).join(" ")}async function Us(n){let e=n.app,t=n.getData();switch(t.type){case"text":return t.text;case"file":{let r=e.vault.getAbstractFileByPath(t.file);if(r instanceof zs.TFile){let s=await e.vault.read(r);return n.subpath?await Td(e,r,t.subpath):`## ${r.basename}
${s}`}throw new Error("Failed to get file content")}case"link":{let r;if(t.url.includes("youtube.com"))r=await kd(t.url);else{let a=n.nodeEl.querySelector("webview");a&&(r=await Cd(a))}return r!=null?r:t.url}}}var Eu=async n=>{let e=[];return await xu(n,async(r,s)=>{let a=r.getData(),i=await Us(r);return i===void 0||i.length===0||i.startsWith("function")||(a.role==="ai"?e.push(new Oe(i)):a.role==="system"?e.push(new Wt(i)):e.push(new _e(i))),!0}),e.reverse()};var Xt;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(Xt||(Xt={}));var Qt;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(Qt||(Qt={}));var Ou;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(Ou||(Ou={}));var Pu;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(Pu||(Pu={}));var Bs;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.OTHER="OTHER"})(Bs||(Bs={}));var Iu;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(Iu||(Iu={}));var er=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},Ks=class extends er{constructor(e,t){super(e),this.response=t}};var Nd="https://generativelanguage.googleapis.com",Rd="v1",jd="0.1.3",$d="genai-js",tr;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(tr||(tr={}));var rr=class{constructor(e,t,r,s){this.model=e,this.task=t,this.apiKey=r,this.stream=s}toString(){let e=`${Nd}/${Rd}/models/${this.model}:${this.task}`;return this.stream&&(e+="?alt=sse"),e}};function Ld(){return`${$d}/${jd}`}async function qn(n,e){let t;try{if(t=await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-client":Ld(),"x-goog-api-key":n.apiKey},body:e}),!t.ok){let r="";try{let s=await t.json();r=s.error.message,s.error.details&&(r+=` ${JSON.stringify(s.error.details)}`)}catch(s){}throw new Error(`[${t.status} ${t.statusText}] ${r}`)}}catch(r){let s=new er(`Error fetching from ${n.toString()}: ${r.message}`);throw s.stack=r.stack,s}return t}function Ii(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Su(n.candidates[0]))throw new Ks(`${Hs(n)}`,n);return Md(n)}else if(n.promptFeedback)throw new Ks(`Text not available. ${Hs(n)}`,n);return""},n}function Md(n){var e,t,r,s;return!((s=(r=(t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0?void 0:t.parts)===null||r===void 0?void 0:r[0])===null||s===void 0)&&s.text?n.candidates[0].content.parts[0].text:""}var Dd=[Bs.RECITATION,Bs.SAFETY];function Su(n){return!!n.finishReason&&Dd.includes(n.finishReason)}function Hs(n){var e,t,r;let s="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)s+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(s+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(s+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){let a=n.candidates[0];Su(a)&&(s+=`Candidate was blocked due to ${a.finishReason}`,a.finishMessage&&(s+=`: ${a.finishMessage}`))}return s}function Kn(n){return this instanceof Kn?(this.v=n,this):new Kn(n)}function Fd(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),s,a=[];return s={},i("next"),i("throw"),i("return"),s[Symbol.asyncIterator]=function(){return this},s;function i(h){r[h]&&(s[h]=function(f){return new Promise(function(p,y){a.push([h,f,p,y])>1||o(h,f)})})}function o(h,f){try{u(r[h](f))}catch(p){d(a[0][3],p)}}function u(h){h.value instanceof Kn?Promise.resolve(h.value.v).then(c,l):d(a[0][2],h)}function c(h){o("next",h)}function l(h){o("throw",h)}function d(h,f){h(f),a.shift(),a.length&&o(a[0][0],a[0][1])}}var Tu=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function zd(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=Kd(e),[r,s]=t.tee();return{stream:Bd(r),response:Ud(s)}}async function Ud(n){let e=[],t=n.getReader();for(;;){let{done:r,value:s}=await t.read();if(r)return Ii(Hd(e));e.push(s)}}function Bd(n){return Fd(this,arguments,function*(){let t=n.getReader();for(;;){let{value:r,done:s}=yield Kn(t.read());if(s)break;yield yield Kn(Ii(r))}})}function Kd(n){let e=n.getReader();return new ReadableStream({start(r){let s="";return a();function a(){return e.read().then(({value:i,done:o})=>{if(o){if(s.trim()){r.error(new er("Failed to parse stream"));return}r.close();return}s+=i;let u=s.match(Tu),c;for(;u;){try{c=JSON.parse(u[1])}catch(l){r.error(new er(`Error parsing JSON response: "${u[1]}"`));return}r.enqueue(c),s=s.substring(u[0].length),u=s.match(Tu)}return a()})}}})}function Hd(n){let e=n[n.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(let r of n)if(r.candidates)for(let s of r.candidates){let a=s.index;if(t.candidates||(t.candidates=[]),t.candidates[a]||(t.candidates[a]={index:s.index}),t.candidates[a].citationMetadata=s.citationMetadata,t.candidates[a].finishReason=s.finishReason,t.candidates[a].finishMessage=s.finishMessage,t.candidates[a].safetyRatings=s.safetyRatings,s.content&&s.content.parts){t.candidates[a].content||(t.candidates[a].content={role:s.content.role||"user",parts:[{text:""}]});for(let i of s.content.parts)i.text&&(t.candidates[a].content.parts[0].text+=i.text)}}return t}async function ku(n,e,t){let r=new rr(e,tr.STREAM_GENERATE_CONTENT,n,!0),s=await qn(r,JSON.stringify(t));return zd(s)}async function Nu(n,e,t){let r=new rr(e,tr.GENERATE_CONTENT,n,!1),a=await(await qn(r,JSON.stringify(t))).json();return{response:Ii(a)}}function Bn(n,e){let t=[];if(typeof n=="string")t=[{text:n}];else for(let r of n)typeof r=="string"?t.push({text:r}):t.push(r);return{role:e,parts:t}}function Ei(n){return n.contents?n:{contents:[Bn(n,"user")]}}function qd(n){return typeof n=="string"||Array.isArray(n)?{content:Bn(n,"user")}:n}var Cu="SILENT_ERROR",Oi=class{constructor(e,t,r){this.model=t,this.params=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r!=null&&r.history&&(this._history=r.history.map(s=>{if(!s.role)throw new Error("Missing role for history item: "+JSON.stringify(s));return Bn(s.parts,s.role)}))}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,r;await this._sendPromise;let s=Bn(e,"user"),a={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,contents:[...this._history,s]},i;return this._sendPromise=this._sendPromise.then(()=>Nu(this._apiKey,this.model,a)).then(o=>{var u;if(o.response.candidates&&o.response.candidates.length>0){this._history.push(s);let c=Object.assign({parts:[],role:"model"},(u=o.response.candidates)===null||u===void 0?void 0:u[0].content);this._history.push(c)}else{let c=Hs(o.response);c&&console.warn(`sendMessage() was unsuccessful. ${c}. Inspect response object for details.`)}i=o}),await this._sendPromise,i}async sendMessageStream(e){var t,r;await this._sendPromise;let s=Bn(e,"user"),a={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,contents:[...this._history,s]},i=ku(this._apiKey,this.model,a);return this._sendPromise=this._sendPromise.then(()=>i).catch(o=>{throw new Error(Cu)}).then(o=>o.response).then(o=>{if(o.candidates&&o.candidates.length>0){this._history.push(s);let u=Object.assign({},o.candidates[0].content);u.role||(u.role="model"),this._history.push(u)}else{let u=Hs(o);u&&console.warn(`sendMessageStream() was unsuccessful. ${u}. Inspect response object for details.`)}}).catch(o=>{o.message!==Cu&&console.error(o)}),i}};async function Vd(n,e,t){let r=new rr(e,tr.COUNT_TOKENS,n,!1);return(await qn(r,JSON.stringify(Object.assign(Object.assign({},t),{model:e})))).json()}async function Gd(n,e,t){let r=new rr(e,tr.EMBED_CONTENT,n,!1);return(await qn(r,JSON.stringify(t))).json()}async function Zd(n,e,t){let r=new rr(e,tr.BATCH_EMBED_CONTENTS,n,!1),s=t.requests.map(i=>Object.assign(Object.assign({},i),{model:`models/${e}`}));return(await qn(r,JSON.stringify({requests:s}))).json()}var Pi=class{constructor(e,t){var r;this.apiKey=e,t.model.startsWith("models/")?this.model=(r=t.model.split("models/"))===null||r===void 0?void 0:r[1]:this.model=t.model,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[]}async generateContent(e){let t=Ei(e);return Nu(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings},t))}async generateContentStream(e){let t=Ei(e);return ku(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings},t))}startChat(e){return new Oi(this.apiKey,this.model,e)}async countTokens(e){let t=Ei(e);return Vd(this.apiKey,this.model,t)}async embedContent(e){let t=qd(e);return Gd(this.apiKey,this.model,t)}async batchEmbedContents(e){return Zd(this.apiKey,this.model,e)}};var Hn=class{constructor(e){this.apiKey=e}getGenerativeModel(e){if(!e.model)throw new er("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Pi(this.apiKey,e)}};var Wd=()=>typeof window!="undefined"&&typeof window.document!="undefined",Jd=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Yd=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Ru=()=>typeof Deno!="undefined",Xd=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!Ru(),Qd=()=>{let n;return Wd()?n="browser":Xd()?n="node":Jd()?n="webworker":Yd()?n="jsdom":Ru()?n="deno":n="other",n},Ti;async function ju(){return Ti===void 0&&(Ti={library:"langchain-js",runtime:Qd()}),Ti}function U(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:void 0}catch(t){return}}var qs="__run",At=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},rt=class n extends At{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};var eh=typeof window=="object"?window:{},R="0123456789abcdef".split(""),th=[-2147483648,8388608,32768,128],ke=[24,16,8,0];var Q=[];function Ne(n){n?(Q[0]=Q[16]=Q[1]=Q[2]=Q[3]=Q[4]=Q[5]=Q[6]=Q[7]=Q[8]=Q[9]=Q[10]=Q[11]=Q[12]=Q[13]=Q[14]=Q[15]=0,this.blocks=Q):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}Ne.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===eh.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,s,a=n.length||0,i=this.blocks;r<a;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(s=this.start;r<a&&s<64;++r)i[s>>2]|=n[r]<<ke[s++&3];else for(s=this.start;r<a&&s<64;++r)t=n.charCodeAt(r),t<128?i[s>>2]|=t<<ke[s++&3]:t<2048?(i[s>>2]|=(192|t>>6)<<ke[s++&3],i[s>>2]|=(128|t&63)<<ke[s++&3]):t<55296||t>=57344?(i[s>>2]|=(224|t>>12)<<ke[s++&3],i[s>>2]|=(128|t>>6&63)<<ke[s++&3],i[s>>2]|=(128|t&63)<<ke[s++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[s>>2]|=(240|t>>18)<<ke[s++&3],i[s>>2]|=(128|t>>12&63)<<ke[s++&3],i[s>>2]|=(128|t>>6&63)<<ke[s++&3],i[s>>2]|=(128|t&63)<<ke[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=i[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};Ne.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=th[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};Ne.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4,a,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)a=e&t|~e&r,o=n<<5|n>>>27,s=o+a+s+1518500249+u[i]<<0,e=e<<30|e>>>2,a=n&e|~n&t,o=s<<5|s>>>27,r=o+a+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,a=s&n|~s&e,o=r<<5|r>>>27,t=o+a+t+1518500249+u[i+2]<<0,s=s<<30|s>>>2,a=r&s|~r&n,o=t<<5|t>>>27,e=o+a+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,a=t&r|~t&s,o=e<<5|e>>>27,n=o+a+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)a=e^t^r,o=n<<5|n>>>27,s=o+a+s+1859775393+u[i]<<0,e=e<<30|e>>>2,a=n^e^t,o=s<<5|s>>>27,r=o+a+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,a=s^n^e,o=r<<5|r>>>27,t=o+a+t+1859775393+u[i+2]<<0,s=s<<30|s>>>2,a=r^s^n,o=t<<5|t>>>27,e=o+a+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,a=t^r^s,o=e<<5|e>>>27,n=o+a+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)a=e&t|e&r|t&r,o=n<<5|n>>>27,s=o+a+s-1894007588+u[i]<<0,e=e<<30|e>>>2,a=n&e|n&t|e&t,o=s<<5|s>>>27,r=o+a+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,a=s&n|s&e|n&e,o=r<<5|r>>>27,t=o+a+t-1894007588+u[i+2]<<0,s=s<<30|s>>>2,a=r&s|r&n|s&n,o=t<<5|t>>>27,e=o+a+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,a=t&r|t&s|r&s,o=e<<5|e>>>27,n=o+a+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)a=e^t^r,o=n<<5|n>>>27,s=o+a+s-899497514+u[i]<<0,e=e<<30|e>>>2,a=n^e^t,o=s<<5|s>>>27,r=o+a+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,a=s^n^e,o=r<<5|r>>>27,t=o+a+t-899497514+u[i+2]<<0,s=s<<30|s>>>2,a=r^s^n,o=t<<5|t>>>27,e=o+a+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,a=t^r^s,o=e<<5|e>>>27,n=o+a+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0};Ne.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return R[n>>28&15]+R[n>>24&15]+R[n>>20&15]+R[n>>16&15]+R[n>>12&15]+R[n>>8&15]+R[n>>4&15]+R[n&15]+R[e>>28&15]+R[e>>24&15]+R[e>>20&15]+R[e>>16&15]+R[e>>12&15]+R[e>>8&15]+R[e>>4&15]+R[e&15]+R[t>>28&15]+R[t>>24&15]+R[t>>20&15]+R[t>>16&15]+R[t>>12&15]+R[t>>8&15]+R[t>>4&15]+R[t&15]+R[r>>28&15]+R[r>>24&15]+R[r>>20&15]+R[r>>16&15]+R[r>>12&15]+R[r>>8&15]+R[r>>4&15]+R[r&15]+R[s>>28&15]+R[s>>24&15]+R[s>>20&15]+R[s>>16&15]+R[s>>12&15]+R[s>>8&15]+R[s>>4&15]+R[s&15]};Ne.prototype.toString=Ne.prototype.hex;Ne.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]};Ne.prototype.array=Ne.prototype.digest;Ne.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var Ci=n=>new Ne(!0).update(n).hex();var $u=(...n)=>Ci(n.join("_"));var Si=class{},rh=new Map,Vs=class n extends Si{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e!=null?e:new Map}lookup(e,t){var r;return Promise.resolve((r=this.cache.get($u(e,t)))!=null?r:null)}async update(e,t,r){this.cache.set($u(e,t),r)}static global(){return new n(rh)}};var Gs=class extends Se{},Zs=class extends Gs{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new _e(this.value)]}},Ws=class extends Gs{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return tn(this.messages)}toChatMessages(){return this.messages}};var Yu=Ce(Xs(),1),sa=Ce(na(),1),gh=[400,401,402,403,404,405,406,407,409],yh=n=>{var t,r,s;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;let e=(r=(t=n==null?void 0:n.response)==null?void 0:t.status)!=null?r:n==null?void 0:n.status;if(e&&gh.includes(+e))throw n;if(((s=n==null?void 0:n.error)==null?void 0:s.code)==="insufficient_quota"){let a=new Error(n==null?void 0:n.message);throw a.name="InsufficientQuotaError",a}},nt=class{constructor(e){var r,s,a;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(s=e.maxRetries)!=null?s:6,this.onFailedAttempt=(a=e.onFailedAttempt)!=null?a:yh;let t="default"in sa.default?sa.default.default:sa.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,Yu.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var tc=Ce(ec(),1);var Oh=Object.defineProperty,Ph=(n,e,t)=>e in n?Oh(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ih=(n,e,t)=>(Ph(n,typeof e!="symbol"?e+"":e,t),t);function Th(n,e){let t=Array.from({length:n.length},(r,s)=>({start:s,end:s+1}));for(;t.length>1;){let r=null;for(let s=0;s<t.length-1;s++){let a=n.slice(t[s].start,t[s+1].end),i=e.get(a.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,s])}if(r!=null){let s=r[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function Ch(n,e){return n.length===1?[e.get(n.join(","))]:Th(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Sh(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Di=class{constructor(n,e){_t(this,"specialTokens");_t(this,"inverseSpecialTokens");_t(this,"patStr");_t(this,"textEncoder",new TextEncoder);_t(this,"textDecoder",new TextDecoder("utf-8"));_t(this,"rankMap",new Map);_t(this,"textMap",new Map);this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{let[a,i,...o]=s.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(let[r,s]of Object.entries(t)){let a=tc.default.toByteArray(r);this.rankMap.set(a.join(","),s),this.textMap.set(s,a)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,a])=>(r[a]=this.textEncoder.encode(s),r),{})}encode(n,e=[],t="all"){var c;let r=new RegExp(this.patStr,"ug"),s=Di.specialTokenRegex(Object.keys(this.specialTokens)),a=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){let l=Di.specialTokenRegex([...o]),d=n.match(l);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let u=0;for(;;){let l=null,d=u;for(;s.lastIndex=d,l=s.exec(n),!(l==null||i.has(l[0]));)d=l.index+1;let h=(c=l==null?void 0:l.index)!=null?c:n.length;for(let p of n.substring(u,h).matchAll(r)){let y=this.textEncoder.encode(p[0]),m=this.rankMap.get(y.join(","));if(m!=null){a.push(m);continue}a.push(...Ch(y,this.rankMap))}if(l==null)break;let f=this.specialTokens[l[0]];a.push(f),u=l.index+l[0].length}return a}decode(n){var a;let e=[],t=0;for(let i=0;i<n.length;++i){let o=n[i],u=(a=this.textMap.get(o))!=null?a:this.inverseSpecialTokens[o];u!=null&&(e.push(u),t+=u.length)}let r=new Uint8Array(t),s=0;for(let i of e)r.set(i,s),s+=i.length;return this.textDecoder.decode(r)}},ia=Di;Ih(ia,"specialTokenRegex",n=>new RegExp(n.map(e=>Sh(e)).join("|"),"g"));function Fi(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}var oa={},kh=new nt({});async function Nh(n){return n in oa||(oa[n]=kh.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new ia(e)).catch(e=>{throw delete oa[n],e})),await oa[n]}async function rc(n){return Nh(Fi(n))}var F;(function(n){n.assertEqual=s=>s;function e(s){}n.assertIs=e;function t(s){throw new Error}n.assertNever=t,n.arrayToEnum=s=>{let a={};for(let i of s)a[i]=i;return a},n.getValidEnumValues=s=>{let a=n.objectKeys(s).filter(o=>typeof s[s[o]]!="number"),i={};for(let o of a)i[o]=s[o];return n.objectValues(i)},n.objectValues=s=>n.objectKeys(s).map(function(a){return s[a]}),n.objectKeys=typeof Object.keys=="function"?s=>Object.keys(s):s=>{let a=[];for(let i in s)Object.prototype.hasOwnProperty.call(s,i)&&a.push(i);return a},n.find=(s,a)=>{for(let i of s)if(a(i))return i},n.isInteger=typeof Number.isInteger=="function"?s=>Number.isInteger(s):s=>typeof s=="number"&&isFinite(s)&&Math.floor(s)===s;function r(s,a=" | "){return s.map(i=>typeof i=="string"?`'${i}'`:i).join(a)}n.joinValues=r,n.jsonStringifyReplacer=(s,a)=>typeof a=="bigint"?a.toString():a})(F||(F={}));var Ui;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(Ui||(Ui={}));var v=F.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),xt=n=>{switch(typeof n){case"undefined":return v.undefined;case"string":return v.string;case"number":return isNaN(n)?v.nan:v.number;case"boolean":return v.boolean;case"function":return v.function;case"bigint":return v.bigint;case"symbol":return v.symbol;case"object":return Array.isArray(n)?v.array:n===null?v.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?v.promise:typeof Map!="undefined"&&n instanceof Map?v.map:typeof Set!="undefined"&&n instanceof Set?v.set:typeof Date!="undefined"&&n instanceof Date?v.date:v.object;default:return v.unknown}},b=F.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Rh=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:"),we=class extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){let t=e||function(a){return a.message},r={_errors:[]},s=a=>{for(let i of a.issues)if(i.code==="invalid_union")i.unionErrors.map(s);else if(i.code==="invalid_return_type")s(i.returnTypeError);else if(i.code==="invalid_arguments")s(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){let c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return s(this),r}toString(){return this.message}get message(){return JSON.stringify(this.issues,F.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};we.create=n=>new we(n);var Gn=(n,e)=>{let t;switch(n.code){case b.invalid_type:n.received===v.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case b.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,F.jsonStringifyReplacer)}`;break;case b.unrecognized_keys:t=`Unrecognized key(s) in object: ${F.joinValues(n.keys,", ")}`;break;case b.invalid_union:t="Invalid input";break;case b.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${F.joinValues(n.options)}`;break;case b.invalid_enum_value:t=`Invalid enum value. Expected ${F.joinValues(n.options)}, received '${n.received}'`;break;case b.invalid_arguments:t="Invalid function arguments";break;case b.invalid_return_type:t="Invalid function return type";break;case b.invalid_date:t="Invalid date";break;case b.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:F.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case b.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case b.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case b.custom:t="Invalid input";break;case b.invalid_intersection_types:t="Intersection results could not be merged";break;case b.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case b.not_finite:t="Number must be finite";break;default:t=e.defaultError,F.assertNever(n)}return{message:t}},ac=Gn;function jh(n){ac=n}function ca(){return ac}var la=n=>{let{data:e,path:t,errorMaps:r,issueData:s}=n,a=[...t,...s.path||[]],i={...s,path:a},o="",u=r.filter(c=>!!c).slice().reverse();for(let c of u)o=c(i,{data:e,defaultError:o}).message;return{...s,path:a,message:s.message||o}},$h=[];function A(n,e){let t=la({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,ca(),Gn].filter(r=>!!r)});n.common.issues.push(t)}var ie=class n{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let s of t){if(s.status==="aborted")return I;s.status==="dirty"&&e.dirty(),r.push(s.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let s of t)r.push({key:await s.key,value:await s.value});return n.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let s of t){let{key:a,value:i}=s;if(a.status==="aborted"||i.status==="aborted")return I;a.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),a.value!=="__proto__"&&(typeof i.value!="undefined"||s.alwaysSet)&&(r[a.value]=i.value)}return{status:e.value,value:r}}},I=Object.freeze({status:"aborted"}),ic=n=>({status:"dirty",value:n}),le=n=>({status:"valid",value:n}),Bi=n=>n.status==="aborted",Ki=n=>n.status==="dirty",Zn=n=>n.status==="valid",da=n=>typeof Promise!="undefined"&&n instanceof Promise,E;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(E||(E={}));var Te=class{constructor(e,t,r,s){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=s}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},nc=(n,e)=>{if(Zn(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new we(n.common.issues);return this._error=t,this._error}}};function k(n){if(!n)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:s}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:s}:{errorMap:(i,o)=>i.code!=="invalid_type"?{message:o.defaultError}:typeof o.data=="undefined"?{message:r!=null?r:o.defaultError}:{message:t!=null?t:o.defaultError},description:s}}var N=class{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return xt(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:xt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new ie,ctx:{common:e.parent.common,data:e.data,parsedType:xt(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(da(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let s={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:xt(e)},a=this._parseSync({data:e,path:s.path,parent:s});return nc(s,a)}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:xt(e)},s=this._parse({data:e,path:r.path,parent:r}),a=await(da(s)?s:Promise.resolve(s));return nc(r,a)}refine(e,t){let r=s=>typeof t=="string"||typeof t=="undefined"?{message:t}:typeof t=="function"?t(s):t;return this._refinement((s,a)=>{let i=e(s),o=()=>a.addIssue({code:b.custom,...r(s)});return typeof Promise!="undefined"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,s)=>e(r)?!0:(s.addIssue(typeof t=="function"?t(r,s):t),!1))}_refinement(e){return new ve({schema:this,typeName:g.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Re.create(this,this._def)}nullable(){return it.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return at.create(this,this._def)}promise(){return Pt.create(this,this._def)}or(e){return dr.create([this,e],this._def)}and(e){return hr.create(this,e,this._def)}transform(e){return new ve({...k(this._def),schema:this,typeName:g.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new yr({...k(this._def),innerType:this,defaultValue:t,typeName:g.ZodDefault})}brand(){return new ma({typeName:g.ZodBranded,type:this,...k(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new un({...k(this._def),innerType:this,catchValue:t,typeName:g.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return Wn.create(this,e)}readonly(){return ln.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Lh=/^c[^\s-]{8,}$/i,Mh=/^[a-z][a-z0-9]*$/,Dh=/^[0-9A-HJKMNP-TV-Z]{26}$/,Fh=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,zh=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Uh="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",zi,Bh=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,Kh=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Hh=n=>n.precision?n.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}Z$`):n.precision===0?n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function qh(n,e){return!!((e==="v4"||!e)&&Bh.test(n)||(e==="v6"||!e)&&Kh.test(n))}var Et=class n extends N{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==v.string){let a=this._getOrReturnCtx(e);return A(a,{code:b.invalid_type,expected:v.string,received:a.parsedType}),I}let r=new ie,s;for(let a of this._def.checks)if(a.kind==="min")e.data.length<a.value&&(s=this._getOrReturnCtx(e,s),A(s,{code:b.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="max")e.data.length>a.value&&(s=this._getOrReturnCtx(e,s),A(s,{code:b.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!1,message:a.message}),r.dirty());else if(a.kind==="length"){let i=e.data.length>a.value,o=e.data.length<a.value;(i||o)&&(s=this._getOrReturnCtx(e,s),i?A(s,{code:b.too_big,maximum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}):o&&A(s,{code:b.too_small,minimum:a.value,type:"string",inclusive:!0,exact:!0,message:a.message}),r.dirty())}else if(a.kind==="email")zh.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"email",code:b.invalid_string,message:a.message}),r.dirty());else if(a.kind==="emoji")zi||(zi=new RegExp(Uh,"u")),zi.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"emoji",code:b.invalid_string,message:a.message}),r.dirty());else if(a.kind==="uuid")Fh.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"uuid",code:b.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid")Lh.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"cuid",code:b.invalid_string,message:a.message}),r.dirty());else if(a.kind==="cuid2")Mh.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"cuid2",code:b.invalid_string,message:a.message}),r.dirty());else if(a.kind==="ulid")Dh.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"ulid",code:b.invalid_string,message:a.message}),r.dirty());else if(a.kind==="url")try{new URL(e.data)}catch(i){s=this._getOrReturnCtx(e,s),A(s,{validation:"url",code:b.invalid_string,message:a.message}),r.dirty()}else a.kind==="regex"?(a.regex.lastIndex=0,a.regex.test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"regex",code:b.invalid_string,message:a.message}),r.dirty())):a.kind==="trim"?e.data=e.data.trim():a.kind==="includes"?e.data.includes(a.value,a.position)||(s=this._getOrReturnCtx(e,s),A(s,{code:b.invalid_string,validation:{includes:a.value,position:a.position},message:a.message}),r.dirty()):a.kind==="toLowerCase"?e.data=e.data.toLowerCase():a.kind==="toUpperCase"?e.data=e.data.toUpperCase():a.kind==="startsWith"?e.data.startsWith(a.value)||(s=this._getOrReturnCtx(e,s),A(s,{code:b.invalid_string,validation:{startsWith:a.value},message:a.message}),r.dirty()):a.kind==="endsWith"?e.data.endsWith(a.value)||(s=this._getOrReturnCtx(e,s),A(s,{code:b.invalid_string,validation:{endsWith:a.value},message:a.message}),r.dirty()):a.kind==="datetime"?Hh(a).test(e.data)||(s=this._getOrReturnCtx(e,s),A(s,{code:b.invalid_string,validation:"datetime",message:a.message}),r.dirty()):a.kind==="ip"?qh(e.data,a.version)||(s=this._getOrReturnCtx(e,s),A(s,{validation:"ip",code:b.invalid_string,message:a.message}),r.dirty()):F.assertNever(a);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(s=>e.test(s),{validation:t,code:b.invalid_string,...E.errToObj(r)})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...E.errToObj(e)})}url(e){return this._addCheck({kind:"url",...E.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...E.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...E.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...E.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...E.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...E.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...E.errToObj(e)})}datetime(e){var t;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)=="undefined"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,...E.errToObj(e==null?void 0:e.message)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...E.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...E.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...E.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...E.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...E.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...E.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...E.errToObj(t)})}nonempty(e){return this.min(1,E.errToObj(e))}trim(){return new n({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};Et.create=n=>{var e;return new Et({checks:[],typeName:g.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...k(n)})};function Vh(n,e){let t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,s=t>r?t:r,a=parseInt(n.toFixed(s).replace(".","")),i=parseInt(e.toFixed(s).replace(".",""));return a%i/Math.pow(10,s)}var ar=class n extends N{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==v.number){let a=this._getOrReturnCtx(e);return A(a,{code:b.invalid_type,expected:v.number,received:a.parsedType}),I}let r,s=new ie;for(let a of this._def.checks)a.kind==="int"?F.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),A(r,{code:b.invalid_type,expected:"integer",received:"float",message:a.message}),s.dirty()):a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:b.too_small,minimum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:b.too_big,maximum:a.value,type:"number",inclusive:a.inclusive,exact:!1,message:a.message}),s.dirty()):a.kind==="multipleOf"?Vh(e.data,a.value)!==0&&(r=this._getOrReturnCtx(e,r),A(r,{code:b.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):a.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),A(r,{code:b.not_finite,message:a.message}),s.dirty()):F.assertNever(a);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,s){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(s)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:E.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:E.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:E.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:E.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&F.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};ar.create=n=>new ar({checks:[],typeName:g.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...k(n)});var ir=class n extends N{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==v.bigint){let a=this._getOrReturnCtx(e);return A(a,{code:b.invalid_type,expected:v.bigint,received:a.parsedType}),I}let r,s=new ie;for(let a of this._def.checks)a.kind==="min"?(a.inclusive?e.data<a.value:e.data<=a.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:b.too_small,type:"bigint",minimum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="max"?(a.inclusive?e.data>a.value:e.data>=a.value)&&(r=this._getOrReturnCtx(e,r),A(r,{code:b.too_big,type:"bigint",maximum:a.value,inclusive:a.inclusive,message:a.message}),s.dirty()):a.kind==="multipleOf"?e.data%a.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),A(r,{code:b.not_multiple_of,multipleOf:a.value,message:a.message}),s.dirty()):F.assertNever(a);return{status:s.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,s){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(s)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};ir.create=n=>{var e;return new ir({checks:[],typeName:g.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...k(n)})};var or=class extends N{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==v.boolean){let r=this._getOrReturnCtx(e);return A(r,{code:b.invalid_type,expected:v.boolean,received:r.parsedType}),I}return le(e.data)}};or.create=n=>new or({typeName:g.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...k(n)});var ur=class n extends N{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==v.date){let a=this._getOrReturnCtx(e);return A(a,{code:b.invalid_type,expected:v.date,received:a.parsedType}),I}if(isNaN(e.data.getTime())){let a=this._getOrReturnCtx(e);return A(a,{code:b.invalid_date}),I}let r=new ie,s;for(let a of this._def.checks)a.kind==="min"?e.data.getTime()<a.value&&(s=this._getOrReturnCtx(e,s),A(s,{code:b.too_small,message:a.message,inclusive:!0,exact:!1,minimum:a.value,type:"date"}),r.dirty()):a.kind==="max"?e.data.getTime()>a.value&&(s=this._getOrReturnCtx(e,s),A(s,{code:b.too_big,message:a.message,inclusive:!0,exact:!1,maximum:a.value,type:"date"}),r.dirty()):F.assertNever(a);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:E.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:E.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};ur.create=n=>new ur({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:g.ZodDate,...k(n)});var nn=class extends N{_parse(e){if(this._getType(e)!==v.symbol){let r=this._getOrReturnCtx(e);return A(r,{code:b.invalid_type,expected:v.symbol,received:r.parsedType}),I}return le(e.data)}};nn.create=n=>new nn({typeName:g.ZodSymbol,...k(n)});var cr=class extends N{_parse(e){if(this._getType(e)!==v.undefined){let r=this._getOrReturnCtx(e);return A(r,{code:b.invalid_type,expected:v.undefined,received:r.parsedType}),I}return le(e.data)}};cr.create=n=>new cr({typeName:g.ZodUndefined,...k(n)});var lr=class extends N{_parse(e){if(this._getType(e)!==v.null){let r=this._getOrReturnCtx(e);return A(r,{code:b.invalid_type,expected:v.null,received:r.parsedType}),I}return le(e.data)}};lr.create=n=>new lr({typeName:g.ZodNull,...k(n)});var Ot=class extends N{constructor(){super(...arguments),this._any=!0}_parse(e){return le(e.data)}};Ot.create=n=>new Ot({typeName:g.ZodAny,...k(n)});var st=class extends N{constructor(){super(...arguments),this._unknown=!0}_parse(e){return le(e.data)}};st.create=n=>new st({typeName:g.ZodUnknown,...k(n)});var je=class extends N{_parse(e){let t=this._getOrReturnCtx(e);return A(t,{code:b.invalid_type,expected:v.never,received:t.parsedType}),I}};je.create=n=>new je({typeName:g.ZodNever,...k(n)});var sn=class extends N{_parse(e){if(this._getType(e)!==v.undefined){let r=this._getOrReturnCtx(e);return A(r,{code:b.invalid_type,expected:v.void,received:r.parsedType}),I}return le(e.data)}};sn.create=n=>new sn({typeName:g.ZodVoid,...k(n)});var at=class n extends N{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),s=this._def;if(t.parsedType!==v.array)return A(t,{code:b.invalid_type,expected:v.array,received:t.parsedType}),I;if(s.exactLength!==null){let i=t.data.length>s.exactLength.value,o=t.data.length<s.exactLength.value;(i||o)&&(A(t,{code:i?b.too_big:b.too_small,minimum:o?s.exactLength.value:void 0,maximum:i?s.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:s.exactLength.message}),r.dirty())}if(s.minLength!==null&&t.data.length<s.minLength.value&&(A(t,{code:b.too_small,minimum:s.minLength.value,type:"array",inclusive:!0,exact:!1,message:s.minLength.message}),r.dirty()),s.maxLength!==null&&t.data.length>s.maxLength.value&&(A(t,{code:b.too_big,maximum:s.maxLength.value,type:"array",inclusive:!0,exact:!1,message:s.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>s.type._parseAsync(new Te(t,i,t.path,o)))).then(i=>ie.mergeArray(r,i));let a=[...t.data].map((i,o)=>s.type._parseSync(new Te(t,i,t.path,o)));return ie.mergeArray(r,a)}get element(){return this._def.type}min(e,t){return new n({...this._def,minLength:{value:e,message:E.toString(t)}})}max(e,t){return new n({...this._def,maxLength:{value:e,message:E.toString(t)}})}length(e,t){return new n({...this._def,exactLength:{value:e,message:E.toString(t)}})}nonempty(e){return this.min(1,e)}};at.create=(n,e)=>new at({type:n,minLength:null,maxLength:null,exactLength:null,typeName:g.ZodArray,...k(e)});function rn(n){if(n instanceof me){let e={};for(let t in n.shape){let r=n.shape[t];e[t]=Re.create(rn(r))}return new me({...n._def,shape:()=>e})}else return n instanceof at?new at({...n._def,type:rn(n.element)}):n instanceof Re?Re.create(rn(n.unwrap())):n instanceof it?it.create(rn(n.unwrap())):n instanceof qe?qe.create(n.items.map(e=>rn(e))):n}var me=class n extends N{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=F.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==v.object){let c=this._getOrReturnCtx(e);return A(c,{code:b.invalid_type,expected:v.object,received:c.parsedType}),I}let{status:r,ctx:s}=this._processInputParams(e),{shape:a,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof je&&this._def.unknownKeys==="strip"))for(let c in s.data)i.includes(c)||o.push(c);let u=[];for(let c of i){let l=a[c],d=s.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new Te(s,d,s.path,c)),alwaysSet:c in s.data})}if(this._def.catchall instanceof je){let c=this._def.unknownKeys;if(c==="passthrough")for(let l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:s.data[l]}});else if(c==="strict")o.length>0&&(A(s,{code:b.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let c=this._def.catchall;for(let l of o){let d=s.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new Te(s,d,s.path,l)),alwaysSet:l in s.data})}}return s.common.async?Promise.resolve().then(async()=>{let c=[];for(let l of u){let d=await l.key;c.push({key:d,value:await l.value,alwaysSet:l.alwaysSet})}return c}).then(c=>ie.mergeObjectSync(r,c)):ie.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return E.errToObj,new n({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var s,a,i,o;let u=(i=(a=(s=this._def).errorMap)===null||a===void 0?void 0:a.call(s,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=E.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new n({...this._def,unknownKeys:"strip"})}passthrough(){return new n({...this._def,unknownKeys:"passthrough"})}extend(e){return new n({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new n({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:g.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new n({...this._def,catchall:e})}pick(e){let t={};return F.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}omit(e){let t={};return F.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}deepPartial(){return rn(this)}partial(e){let t={};return F.objectKeys(this.shape).forEach(r=>{let s=this.shape[r];e&&!e[r]?t[r]=s:t[r]=s.optional()}),new n({...this._def,shape:()=>t})}required(e){let t={};return F.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let a=this.shape[r];for(;a instanceof Re;)a=a._def.innerType;t[r]=a}}),new n({...this._def,shape:()=>t})}keyof(){return oc(F.objectKeys(this.shape))}};me.create=(n,e)=>new me({shape:()=>n,unknownKeys:"strip",catchall:je.create(),typeName:g.ZodObject,...k(e)});me.strictCreate=(n,e)=>new me({shape:()=>n,unknownKeys:"strict",catchall:je.create(),typeName:g.ZodObject,...k(e)});me.lazycreate=(n,e)=>new me({shape:n,unknownKeys:"strip",catchall:je.create(),typeName:g.ZodObject,...k(e)});var dr=class extends N{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function s(a){for(let o of a)if(o.result.status==="valid")return o.result;for(let o of a)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let i=a.map(o=>new we(o.ctx.common.issues));return A(t,{code:b.invalid_union,unionErrors:i}),I}if(t.common.async)return Promise.all(r.map(async a=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await a._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(s);{let a,i=[];for(let u of r){let c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!a&&(a={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(a)return t.common.issues.push(...a.ctx.common.issues),a.result;let o=i.map(u=>new we(u));return A(t,{code:b.invalid_union,unionErrors:o}),I}}get options(){return this._def.options}};dr.create=(n,e)=>new dr({options:n,typeName:g.ZodUnion,...k(e)});var ua=n=>n instanceof fr?ua(n.schema):n instanceof ve?ua(n.innerType()):n instanceof pr?[n.value]:n instanceof mr?n.options:n instanceof gr?Object.keys(n.enum):n instanceof yr?ua(n._def.innerType):n instanceof cr?[void 0]:n instanceof lr?[null]:null,ha=class n extends N{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==v.object)return A(t,{code:b.invalid_type,expected:v.object,received:t.parsedType}),I;let r=this.discriminator,s=t.data[r],a=this.optionsMap.get(s);return a?t.common.async?a._parseAsync({data:t.data,path:t.path,parent:t}):a._parseSync({data:t.data,path:t.path,parent:t}):(A(t,{code:b.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),I)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let s=new Map;for(let a of t){let i=ua(a.shape[e]);if(!i)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of i){if(s.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);s.set(o,a)}}return new n({typeName:g.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:s,...k(r)})}};function Hi(n,e){let t=xt(n),r=xt(e);if(n===e)return{valid:!0,data:n};if(t===v.object&&r===v.object){let s=F.objectKeys(e),a=F.objectKeys(n).filter(o=>s.indexOf(o)!==-1),i={...n,...e};for(let o of a){let u=Hi(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===v.array&&r===v.array){if(n.length!==e.length)return{valid:!1};let s=[];for(let a=0;a<n.length;a++){let i=n[a],o=e[a],u=Hi(i,o);if(!u.valid)return{valid:!1};s.push(u.data)}return{valid:!0,data:s}}else return t===v.date&&r===v.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}var hr=class extends N{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),s=(a,i)=>{if(Bi(a)||Bi(i))return I;let o=Hi(a.value,i.value);return o.valid?((Ki(a)||Ki(i))&&t.dirty(),{status:t.value,value:o.data}):(A(r,{code:b.invalid_intersection_types}),I)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([a,i])=>s(a,i)):s(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};hr.create=(n,e,t)=>new hr({left:n,right:e,typeName:g.ZodIntersection,...k(t)});var qe=class n extends N{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.array)return A(r,{code:b.invalid_type,expected:v.array,received:r.parsedType}),I;if(r.data.length<this._def.items.length)return A(r,{code:b.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),I;!this._def.rest&&r.data.length>this._def.items.length&&(A(r,{code:b.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let a=[...r.data].map((i,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new Te(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(a).then(i=>ie.mergeArray(t,i)):ie.mergeArray(t,a)}get items(){return this._def.items}rest(e){return new n({...this._def,rest:e})}};qe.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new qe({items:n,typeName:g.ZodTuple,rest:null,...k(e)})};var fa=class n extends N{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.object)return A(r,{code:b.invalid_type,expected:v.object,received:r.parsedType}),I;let s=[],a=this._def.keyType,i=this._def.valueType;for(let o in r.data)s.push({key:a._parse(new Te(r,o,r.path,o)),value:i._parse(new Te(r,r.data[o],r.path,o))});return r.common.async?ie.mergeObjectAsync(t,s):ie.mergeObjectSync(t,s)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof N?new n({keyType:e,valueType:t,typeName:g.ZodRecord,...k(r)}):new n({keyType:Et.create(),valueType:e,typeName:g.ZodRecord,...k(t)})}},an=class extends N{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.map)return A(r,{code:b.invalid_type,expected:v.map,received:r.parsedType}),I;let s=this._def.keyType,a=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:s._parse(new Te(r,o,r.path,[c,"key"])),value:a._parse(new Te(r,u,r.path,[c,"value"]))}));if(r.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of i){let c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return I;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of i){let c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return I;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}};an.create=(n,e,t)=>new an({valueType:e,keyType:n,typeName:g.ZodMap,...k(t)});var on=class n extends N{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.set)return A(r,{code:b.invalid_type,expected:v.set,received:r.parsedType}),I;let s=this._def;s.minSize!==null&&r.data.size<s.minSize.value&&(A(r,{code:b.too_small,minimum:s.minSize.value,type:"set",inclusive:!0,exact:!1,message:s.minSize.message}),t.dirty()),s.maxSize!==null&&r.data.size>s.maxSize.value&&(A(r,{code:b.too_big,maximum:s.maxSize.value,type:"set",inclusive:!0,exact:!1,message:s.maxSize.message}),t.dirty());let a=this._def.valueType;function i(u){let c=new Set;for(let l of u){if(l.status==="aborted")return I;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}let o=[...r.data.values()].map((u,c)=>a._parse(new Te(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new n({...this._def,minSize:{value:e,message:E.toString(t)}})}max(e,t){return new n({...this._def,maxSize:{value:e,message:E.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};on.create=(n,e)=>new on({valueType:n,minSize:null,maxSize:null,typeName:g.ZodSet,...k(e)});var pa=class n extends N{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==v.function)return A(t,{code:b.invalid_type,expected:v.function,received:t.parsedType}),I;function r(o,u){return la({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,ca(),Gn].filter(c=>!!c),issueData:{code:b.invalid_arguments,argumentsError:u}})}function s(o,u){return la({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,ca(),Gn].filter(c=>!!c),issueData:{code:b.invalid_return_type,returnTypeError:u}})}let a={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Pt){let o=this;return le(async function(...u){let c=new we([]),l=await o._def.args.parseAsync(u,a).catch(f=>{throw c.addIssue(r(u,f)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,a).catch(f=>{throw c.addIssue(s(d,f)),c})})}else{let o=this;return le(function(...u){let c=o._def.args.safeParse(u,a);if(!c.success)throw new we([r(u,c.error)]);let l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,a);if(!d.success)throw new we([s(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new n({...this._def,args:qe.create(e).rest(st.create())})}returns(e){return new n({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new n({args:e||qe.create([]).rest(st.create()),returns:t||st.create(),typeName:g.ZodFunction,...k(r)})}},fr=class extends N{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};fr.create=(n,e)=>new fr({getter:n,typeName:g.ZodLazy,...k(e)});var pr=class extends N{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return A(t,{received:t.data,code:b.invalid_literal,expected:this._def.value}),I}return{status:"valid",value:e.data}}get value(){return this._def.value}};pr.create=(n,e)=>new pr({value:n,typeName:g.ZodLiteral,...k(e)});function oc(n,e){return new mr({values:n,typeName:g.ZodEnum,...k(e)})}var mr=class n extends N{_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return A(t,{expected:F.joinValues(r),received:t.parsedType,code:b.invalid_type}),I}if(this._def.values.indexOf(e.data)===-1){let t=this._getOrReturnCtx(e),r=this._def.values;return A(t,{received:t.data,code:b.invalid_enum_value,options:r}),I}return le(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e){return n.create(e)}exclude(e){return n.create(this.options.filter(t=>!e.includes(t)))}};mr.create=oc;var gr=class extends N{_parse(e){let t=F.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==v.string&&r.parsedType!==v.number){let s=F.objectValues(t);return A(r,{expected:F.joinValues(s),received:r.parsedType,code:b.invalid_type}),I}if(t.indexOf(e.data)===-1){let s=F.objectValues(t);return A(r,{received:r.data,code:b.invalid_enum_value,options:s}),I}return le(e.data)}get enum(){return this._def.values}};gr.create=(n,e)=>new gr({values:n,typeName:g.ZodNativeEnum,...k(e)});var Pt=class extends N{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==v.promise&&t.common.async===!1)return A(t,{code:b.invalid_type,expected:v.promise,received:t.parsedType}),I;let r=t.parsedType===v.promise?t.data:Promise.resolve(t.data);return le(r.then(s=>this._def.type.parseAsync(s,{path:t.path,errorMap:t.common.contextualErrorMap})))}};Pt.create=(n,e)=>new Pt({type:n,typeName:g.ZodPromise,...k(e)});var ve=class extends N{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===g.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),s=this._def.effect||null,a={addIssue:i=>{A(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(a.addIssue=a.addIssue.bind(a),s.type==="preprocess"){let i=s.transform(r.data,a);return r.common.issues.length?{status:"dirty",value:r.data}:r.common.async?Promise.resolve(i).then(o=>this._def.schema._parseAsync({data:o,path:r.path,parent:r})):this._def.schema._parseSync({data:i,path:r.path,parent:r})}if(s.type==="refinement"){let i=o=>{let u=s.refinement(o,a);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){let o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?I:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?I:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(s.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!Zn(i))return i;let o=s.transform(i.value,a);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>Zn(i)?Promise.resolve(s.transform(i.value,a)).then(o=>({status:t.value,value:o})):i);F.assertNever(s)}};ve.create=(n,e,t)=>new ve({schema:n,typeName:g.ZodEffects,effect:e,...k(t)});ve.createWithPreprocess=(n,e,t)=>new ve({schema:e,effect:{type:"preprocess",transform:n},typeName:g.ZodEffects,...k(t)});var Re=class extends N{_parse(e){return this._getType(e)===v.undefined?le(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Re.create=(n,e)=>new Re({innerType:n,typeName:g.ZodOptional,...k(e)});var it=class extends N{_parse(e){return this._getType(e)===v.null?le(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};it.create=(n,e)=>new it({innerType:n,typeName:g.ZodNullable,...k(e)});var yr=class extends N{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===v.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};yr.create=(n,e)=>new yr({innerType:n,typeName:g.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...k(e)});var un=class extends N{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},s=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return da(s)?s.then(a=>({status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new we(r.common.issues)},input:r.data})})):{status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new we(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};un.create=(n,e)=>new un({innerType:n,typeName:g.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...k(e)});var cn=class extends N{_parse(e){if(this._getType(e)!==v.nan){let r=this._getOrReturnCtx(e);return A(r,{code:b.invalid_type,expected:v.nan,received:r.parsedType}),I}return{status:"valid",value:e.data}}};cn.create=n=>new cn({typeName:g.ZodNaN,...k(n)});var Gh=Symbol("zod_brand"),ma=class extends N{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},Wn=class n extends N{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let a=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?I:a.status==="dirty"?(t.dirty(),ic(a.value)):this._def.out._parseAsync({data:a.value,path:r.path,parent:r})})();{let s=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?I:s.status==="dirty"?(t.dirty(),{status:"dirty",value:s.value}):this._def.out._parseSync({data:s.value,path:r.path,parent:r})}}static create(e,t){return new n({in:e,out:t,typeName:g.ZodPipeline})}},ln=class extends N{_parse(e){let t=this._def.innerType._parse(e);return Zn(t)&&(t.value=Object.freeze(t.value)),t}};ln.create=(n,e)=>new ln({innerType:n,typeName:g.ZodReadonly,...k(e)});var uc=(n,e={},t)=>n?Ot.create().superRefine((r,s)=>{var a,i;if(!n(r)){let o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(a=o.fatal)!==null&&a!==void 0?a:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;s.addIssue({code:"custom",...c,fatal:u})}}):Ot.create(),Zh={object:me.lazycreate},g;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(g||(g={}));var Wh=(n,e={message:`Input not instance of ${n.name}`})=>uc(t=>t instanceof n,e),cc=Et.create,lc=ar.create,Jh=cn.create,Yh=ir.create,dc=or.create,Xh=ur.create,Qh=nn.create,ef=cr.create,tf=lr.create,rf=Ot.create,nf=st.create,sf=je.create,af=sn.create,of=at.create,uf=me.create,cf=me.strictCreate,lf=dr.create,df=ha.create,hf=hr.create,ff=qe.create,pf=fa.create,mf=an.create,gf=on.create,yf=pa.create,bf=fr.create,_f=pr.create,wf=mr.create,vf=gr.create,Af=Pt.create,sc=ve.create,xf=Re.create,Ef=it.create,Of=ve.createWithPreprocess,Pf=Wn.create,If=()=>cc().optional(),Tf=()=>lc().optional(),Cf=()=>dc().optional(),Sf={string:n=>Et.create({...n,coerce:!0}),number:n=>ar.create({...n,coerce:!0}),boolean:n=>or.create({...n,coerce:!0}),bigint:n=>ir.create({...n,coerce:!0}),date:n=>ur.create({...n,coerce:!0})},kf=I,ot=Object.freeze({__proto__:null,defaultErrorMap:Gn,setErrorMap:jh,getErrorMap:ca,makeIssue:la,EMPTY_PATH:$h,addIssueToContext:A,ParseStatus:ie,INVALID:I,DIRTY:ic,OK:le,isAborted:Bi,isDirty:Ki,isValid:Zn,isAsync:da,get util(){return F},get objectUtil(){return Ui},ZodParsedType:v,getParsedType:xt,ZodType:N,ZodString:Et,ZodNumber:ar,ZodBigInt:ir,ZodBoolean:or,ZodDate:ur,ZodSymbol:nn,ZodUndefined:cr,ZodNull:lr,ZodAny:Ot,ZodUnknown:st,ZodNever:je,ZodVoid:sn,ZodArray:at,ZodObject:me,ZodUnion:dr,ZodDiscriminatedUnion:ha,ZodIntersection:hr,ZodTuple:qe,ZodRecord:fa,ZodMap:an,ZodSet:on,ZodFunction:pa,ZodLazy:fr,ZodLiteral:pr,ZodEnum:mr,ZodNativeEnum:gr,ZodPromise:Pt,ZodEffects:ve,ZodTransformer:ve,ZodOptional:Re,ZodNullable:it,ZodDefault:yr,ZodCatch:un,ZodNaN:cn,BRAND:Gh,ZodBranded:ma,ZodPipeline:Wn,ZodReadonly:ln,custom:uc,Schema:N,ZodSchema:N,late:Zh,get ZodFirstPartyTypeKind(){return g},coerce:Sf,any:rf,array:of,bigint:Yh,boolean:dc,date:Xh,discriminatedUnion:df,effect:sc,enum:wf,function:yf,instanceof:Wh,intersection:hf,lazy:bf,literal:_f,map:mf,nan:Jh,nativeEnum:vf,never:sf,null:tf,nullable:Ef,number:lc,object:uf,oboolean:Cf,onumber:Tf,optional:xf,ostring:If,pipeline:Pf,preprocess:Of,promise:Af,record:pf,set:gf,strictObject:cf,string:cc,symbol:Qh,transformer:sc,tuple:ff,undefined:ef,union:lf,unknown:nf,void:af,NEVER:kf,ZodIssueCode:b,quotelessJson:Rh,ZodError:we});var mo=Ce(Xs(),1);var ga,Nf=new Uint8Array(16);function qi(){if(!ga&&(ga=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!ga))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return ga(Nf)}var hc=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Rf(n){return typeof n=="string"&&hc.test(n)}var Jn=Rf;var re=[];for(let n=0;n<256;++n)re.push((n+256).toString(16).slice(1));function fc(n,e=0){return re[n[e+0]]+re[n[e+1]]+re[n[e+2]]+re[n[e+3]]+"-"+re[n[e+4]]+re[n[e+5]]+"-"+re[n[e+6]]+re[n[e+7]]+"-"+re[n[e+8]]+re[n[e+9]]+"-"+re[n[e+10]]+re[n[e+11]]+re[n[e+12]]+re[n[e+13]]+re[n[e+14]]+re[n[e+15]]}var jf=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Vi={randomUUID:jf};function $f(n,e,t){if(Vi.randomUUID&&!e&&!n)return Vi.randomUUID();n=n||{};let r=n.random||(n.rng||qi)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=r[s];return e}return fc(r)}var de=$f;var Gi=class{},br=class n extends Gi{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,xi(this.constructor)]}constructor(e){var t,r,s,a,i;super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:U("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=(t=e.ignoreLLM)!=null?t:this.ignoreLLM,this.ignoreChain=(r=e.ignoreChain)!=null?r:this.ignoreChain,this.ignoreAgent=(s=e.ignoreAgent)!=null?s:this.ignoreAgent,this.ignoreRetriever=(a=e.ignoreRetriever)!=null?a:this.ignoreRetriever,this.awaitHandlers=(i=e._awaitHandler)!=null?i:this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return Se.prototype.toJSON.call(this)}toJSONNotImplemented(){return Se.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:de()}),Object.assign(this,e)}}return new t}};var Wi=Ce(bc(),1);function Zi(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function Mf(n){return n.replace(/[-:.]/g,"")}function Df(n,e){return Mf(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}var $e=class extends br{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var s;let t=Df(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){let a=this.runMap.get(r.parent_run_id);a&&(this._addChildRun(a,r),a.child_execution_order=Math.max(a.child_execution_order,r.child_execution_order),r.trace_id=a.trace_id,a.dotted_order!==void 0&&(r.dotted_order=[a.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((s=this.onRunCreate)==null?void 0:s.call(this,r))}async _endTrace(e){var r;let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,s,a,i,o,u){var f;let c=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleChatModelStart(e,t,r,s,a,i,o,u){var f;let c=this._getExecutionOrder(s),l=Date.now(),d=o?{...a,metadata:o}:a,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return await this._startTrace(h),await((f=this.onLLMStart)==null?void 0:f.call(this,h)),h}async handleLLMEnd(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,s,a,i,o,u){var h;let c=this._getExecutionOrder(s),l=Date.now(),d={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o!=null?o:"chain",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(d),await((h=this.onChainStart)==null?void 0:h.call(this,d)),d}async handleChainEnd(e,t,r,s,a){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=Zi(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Zi(a.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,s,a){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(a==null?void 0:a.inputs)!==void 0&&(i.inputs=Zi(a.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleToolStart(e,t,r,s,a,i,o){var d;let u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(l),await((d=this.onToolStart)==null?void 0:d.call(this,l)),l}async handleToolEnd(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;let s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentAction)==null?void 0:a.call(this,r))}async handleAgentEnd(e,t){var s;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}async handleRetrieverStart(e,t,r,s,a,i,o){var d;let u=this._getExecutionOrder(s),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:s,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:a||[]};return await this._startTrace(l),await((d=this.onRetrieverStart)==null?void 0:d.call(this,l)),l}async handleRetrieverEnd(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var s;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,t,r,s,a,i){var u;let o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}};function he(n,e){return`${n.open}${e}${n.close}`}function Le(n,e){try{return JSON.stringify(n,null,2)}catch(t){return e}}function It(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:ge}=Wi.default,Yn=class extends $e{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let s=this.runMap.get(r.parent_run_id);if(s)t.push(s),r=s;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((s,a,i)=>{let o=`${s.execution_order}:${s.run_type}:${s.name}`;return a===i.length-1?he(Wi.default.bold,o):o}).join(" > ");return he(ge.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Le(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.cyan,"[chain/end]")} [${t}] [${It(e)}] Exiting Chain run with output: ${Le(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.red,"[chain/error]")} [${t}] [${It(e)}] Chain run errored with error: ${Le(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${he(ge.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Le(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.cyan,"[llm/end]")} [${t}] [${It(e)}] Exiting LLM run with output: ${Le(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.red,"[llm/error]")} [${t}] [${It(e)}] LLM run errored with error: ${Le(e.error,"[error]")}`)}onToolStart(e){var r;let t=this.getBreadcrumbs(e);console.log(`${he(ge.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,s;let t=this.getBreadcrumbs(e);console.log(`${he(ge.cyan,"[tool/end]")} [${t}] [${It(e)}] Exiting Tool run with output: "${(s=(r=e.outputs)==null?void 0:r.output)==null?void 0:s.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.red,"[tool/error]")} [${t}] [${It(e)}] Tool run errored with error: ${Le(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Le(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.cyan,"[retriever/end]")} [${t}] [${It(e)}] Exiting Retriever run with output: ${Le(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${he(ge.red,"[retriever/error]")} [${t}] [${It(e)}] Retriever run errored with error: ${Le(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${he(ge.blue,"[agent/action]")} [${r}] Agent selected action: ${Le(t.actions[t.actions.length-1],"[action]")}`)}};var _c=Ce(Xs(),1),ya=Ce(na(),1),Ff=[400,401,403,404,405,406,407,408],zf=[409],Xn=class{constructor(e){var r,s;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(s=e.maxRetries)!=null?s:6;let t="default"in ya.default?ya.default.default:ya.default;this.queue=new t({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,_c.default)(()=>e(...t).catch(s=>{throw s instanceof Error?s:new Error(s)}),{async onFailedAttempt(s){if(s.message.startsWith("Cancel")||s.message.startsWith("TimeoutError")||s.message.startsWith("AbortError")||(s==null?void 0:s.code)==="ECONNABORTED")throw s;let a=s==null?void 0:s.response,i=a==null?void 0:a.status;if(i){if(Ff.includes(+i))throw s;if(zf.includes(+i))return;r&&await r(a)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,a)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{a(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};function Ji(n){return typeof(n==null?void 0:n._getType)=="function"}function Yi(n){let e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var ut,Uf=()=>typeof window!="undefined"&&typeof window.document!="undefined",Bf=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Kf=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),wc=()=>typeof Deno!="undefined",Hf=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!wc(),qf=()=>ut||(Uf()?ut="browser":Hf()?ut="node":Bf()?ut="webworker":Kf()?ut="jsdom":wc()?ut="deno":ut="other",ut),Xi;async function eo(){if(Xi===void 0){let n=qf(),e=Gf();Xi={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:ba,...e}}return Xi}function vc(){let n=Vf()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,s]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof s=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=s:e[r]=s);return e}function Vf(){try{return typeof process!="undefined"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch(n){return}}function ct(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:void 0}catch(t){return}}var Qi;function Gf(){if(Qi!==void 0)return Qi;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=ct(t);r!==void 0&&(e[t]=r)}return Qi=e,e}async function Ac(n){let e=await eo(),t=vc();return n.map(r=>{var i,o;let s=(i=r.extra)!=null?i:{},a=s.metadata;return r.extra={...s,runtime:{...e,...s==null?void 0:s.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:(o=r.revision_id)!=null?o:t.revision_id}:{},...a}},r})}var Zf=()=>{let n=ct("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},Wf=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},Tt=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function Jf(n){let e=[];for await(let t of n)e.push(t);return e}function to(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function q(n){if(!Jn(n))throw new Error(`Invalid UUID: ${n}`)}var Yf=async n=>{var e;if((n==null?void 0:n.status)===429){let t=parseInt((e=n.headers.get("retry-after"))!=null?e:"30",10)*1e3;if(t>0)return await new Promise(r=>setTimeout(r,t)),!0}return!1},ro=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},Xf=20971520,dn=class n{constructor(e={}){var r,s,a,i,o,u,c,l,d,h,f;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new ro}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=Zf(),this.apiUrl=(s=to((r=e.apiUrl)!=null?r:t.apiUrl))!=null?s:"",this.apiKey=to((a=e.apiKey)!=null?a:t.apiKey),this.webUrl=to((i=e.webUrl)!=null?i:t.webUrl),this.timeout_ms=(o=e.timeout_ms)!=null?o:12e3,this.caller=new Xn((u=e.callerOptions)!=null?u:{}),this.batchIngestCaller=new Xn({...(c=e.callerOptions)!=null?c:{},onFailedResponseHook:Yf}),this.hideInputs=(l=e.hideInputs)!=null?l:t.hideInputs,this.hideOutputs=(d=e.hideOutputs)!=null?d:t.hideOutputs,this.autoBatchTracing=(h=e.autoBatchTracing)!=null?h:this.autoBatchTracing,this.pendingAutoBatchedRunLimit=(f=e.pendingAutoBatchedRunLimit)!=null?f:this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){var a;let e=ct("LANGCHAIN_API_KEY"),t=(a=ct("LANGCHAIN_ENDPOINT"))!=null?a:"https://api.smith.langchain.com",r=ct("LANGCHAIN_HIDE_INPUTS")==="true",s=ct("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:s}}getHostUrl(){return this.webUrl?this.webUrl:Wf(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){let e={"User-Agent":`langsmith-js/${ba}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){var i;let r=(i=t==null?void 0:t.toString())!=null?i:"",s=`${this.apiUrl}${e}?${r}`,a=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);return a}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));let a=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<s))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",s="runs"){let a=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(a)})).json();if(!o||!o[s])break;yield o[s];let u=o.cursors;if(!u||!u.next)break;a.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let s of e)this.sampledPostUuids.has(s.id)&&(r.push(s),this.sampledPostUuids.delete(s.id));return r}else{let r=[];for(let s of e)Math.random()<this.tracingSampleRate&&(r.push(s),this.sampledPostUuids.add(s.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let s=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),s}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async createRun(e){var o;if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let s=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:(o=e.start_time)!=null?o:Date.now()});if(this.autoBatchTracing&&s.trace_id!==void 0&&s.dotted_order!==void 0){this.processRunOperation({action:"create",item:s}).catch(console.error);return}let a=await Ac([s]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(a[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){var c,l,d,h,f;if(e===void 0&&t===void 0)return;let r=(c=e==null?void 0:e.map(p=>this.prepareRunCreateOrUpdateInputs(p)))!=null?c:[],s=(l=t==null?void 0:t.map(p=>this.prepareRunCreateOrUpdateInputs(p)))!=null?l:[];if(r.length>0&&s.length>0){let p=r.reduce((m,_)=>(_.id&&(m[_.id]=_),m),{}),y=[];for(let m of s)m.id!==void 0&&p[m.id]?p[m.id]={...p[m.id],...m}:y.push(m);r=Object.values(p),s=y}let a={post:this._filterForSampling(r),patch:this._filterForSampling(s,!0)};if(!a.post.length&&!a.patch.length)return;if(r=await Ac(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let p of a.post)await this.createRun(p);for(let p of a.patch)p.id!==void 0&&await this.updateRun(p.id,p);return}let i=(f=(h=(d=this.serverInfo)==null?void 0:d.batch_ingest_config)==null?void 0:h.size_limit_bytes)!=null?f:Xf,o={post:[],patch:[]},u=0;for(let p of["post","patch"]){let y=p,m=a[y].reverse(),_=m.pop();for(;_!==void 0;){let w=JSON.stringify(_);u>0&&u+w.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=w.length,o[y].push(_),_=m.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(r,"batch create run")}async updateRun(e,t){q(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let s={...this.headers,"Content-Type":"application/json"},a=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:s,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(a,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){q(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let s;t.session_id?s=t.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:ct("LANGCHAIN_PROJECT")||"default"})).id;let a=await this._getTenantId();return`${this.getHostUrl()}/o/${a}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){let s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await Jf(this.listRuns({id:e.child_run_ids})),r={},s={};t.sort((a,i)=>{var o,u;return((o=a==null?void 0:a.dotted_order)!=null?o:"").localeCompare((u=i==null?void 0:i.dotted_order)!=null?u:"")});for(let a of t){if(a.parent_run_id===null||a.parent_run_id===void 0)throw new Error(`Child run ${a.id} has no parent`);a.parent_run_id in r||(r[a.parent_run_id]=[]),r[a.parent_run_id].push(a),s[a.id]=a}e.child_runs=r[e.id]||[];for(let a in r)a!==e.id&&(s[a].child_runs=r[a]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:s,traceId:a,referenceExampleId:i,startTime:o,executionOrder:u,runType:c,error:l,id:d,query:h,filter:f,traceFilter:p,treeFilter:y,limit:m}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let $=Array.isArray(r)?r:[r],D=await Promise.all($.map(L=>this.readProject({projectName:L}).then(C=>C.id)));_.push(...D)}let w={session:_.length?_:null,run_type:c,reference_example:i,query:h,filter:f,trace_filter:p,tree_filter:y,execution_order:u,parent_run:s,start_time:o?o.toISOString():null,error:l,id:d,limit:m,trace:a};for await(let $ of this._getCursorPaginatedList("/runs/query",w))yield*$}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||de()};q(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(a===null||!("share_token"in a))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${a.share_token}/r`}async unshareRun(e){q(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(t,"unshare run")}async readRunSharedLink(e){q(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return q(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),q(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};q(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async unshareDataset(e){q(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(t,"unshare dataset")}async readSharedDataset(e){return q(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:s=!1,projectExtra:a=null,referenceDatasetId:i=null}){let o=s?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=a||{};r&&(c.metadata=r);let l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);let d=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),h=await d.json();if(!d.ok)throw new Error(`Failed to create session ${e}: ${d.status} ${d.statusText}`);return h}async updateProject(e,{name:t=null,description:r=null,metadata:s=null,projectExtra:a=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=a;s&&(u={...u||{},metadata:s});let c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return d}async hasProject({projectId:e,projectName:t}){let r="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)q(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");let a=await this.caller.call(fetch,`${this.apiUrl}${r}?${s}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await a.json();return a.ok?Array.isArray(i)?i.length>0:!0:!1}catch(i){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let s="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)q(e),s+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&a.append("include_stats",r.toString());let i=await this._get(s,a),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:s,referenceDatasetName:a,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),s!==void 0)o.append("reference_dataset",s);else if(a!==void 0){let u=await this.readDataset({datasetName:a});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,q(r);let s=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(s,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:s,description:a,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),s.forEach(h=>{c.append("output_keys",h)}),a&&c.append("description",a),i&&c.append("data_type",i),o&&c.append("name",o);let l=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok){let h=await l.json();throw h.detail&&h.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:r}={}){let s={name:e,description:t};r&&(s.data_type=r);let a=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok){let o=await a.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${a.status} ${a.statusText}`)}return await a.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",s=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)q(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");let a=await this._get(r,s),i;if(Array.isArray(a)){if(a.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=a[0]}else i=a;return i}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:s}){let a=e;if(a===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(a!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");a===void 0&&(a=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof s=="string"?s:s.toISOString()});return await this._get(`/datasets/${a}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:s,datasetNameContains:a}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);s!==void 0&&o.append("name",s),a!==void 0&&o.append("name_contains",a);for await(let u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)q(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");let a=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!a.ok)throw new Error(`Failed to delete ${r}: ${a.status} ${a.statusText}`);await a.json()}async createExample(e,t,{datasetId:r,datasetName:s,createdAt:a,exampleId:i}){let o=r;if(o===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:s})).id);let u=a||new Date,c={dataset_id:o,inputs:e,outputs:t,created_at:u==null?void 0:u.toISOString(),id:i},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){let{inputs:t,outputs:r,sourceRunIds:s,exampleIds:a,datasetId:i,datasetName:o}=e,u=i;if(u===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:o})).id);let c=t.map((h,f)=>({dataset_id:u,inputs:h,outputs:r?r[f]:void 0,id:a?a[f]:void 0,source_run_id:s?s[f]:void 0})),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let s=e.map(i=>Ji(i)?Yi(i):i),a=Ji(t)?Yi(t):t;return this.createExample({input:s},{output:a},r)}async readExample(e){q(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:s,inlineS3Urls:a}={}){let i;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)i=e;else if(t!==void 0)i=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let o=new URLSearchParams({dataset:i}),u=s?typeof s=="string"?s:s==null?void 0:s.toISOString():void 0;u&&o.append("as_of",u);let c=a!=null?a:!0;if(o.append("inline_s3_urls",c.toString()),r!==void 0)for(let l of r)o.append("id",l);for await(let l of this._getPaginated("/examples",o))yield*l}async deleteExample(e){q(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){q(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:s,referenceExample:a}={loadChildRuns:!1}){var l;let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,a),u=r!=null?r:{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});let c=(l=o.targetRunId)!=null?l:i.id;return await this.createFeedback(c,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:r,value:s,correction:a,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d}){var m;let h={type:u!=null?u:"api",metadata:o!=null?o:{}};c!==void 0&&(h==null?void 0:h.metadata)!==void 0&&!h.metadata.__run&&(h.metadata.__run={run_id:c}),(h==null?void 0:h.metadata)!==void 0&&((m=h.metadata.__run)==null?void 0:m.run_id)!==void 0&&q(h.metadata.__run.run_id);let f={id:l!=null?l:de(),run_id:e,key:t,score:r,value:s,correction:a,comment:i,feedback_source:h,feedbackConfig:d},p=`${this.apiUrl}/feedback`,y=await this.caller.call(fetch,p,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(f),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await Tt(y,"create feedback"),f}async updateFeedback(e,{score:t,value:r,correction:s,comment:a}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),s!=null&&(i.correction=s),a!=null&&(i.comment=a),q(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await Tt(o,"update feedback")}async readFeedback(e){q(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){q(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let s=new URLSearchParams;if(e&&s.append("run",e.join(",")),t)for(let a of t)s.append("key",a);if(r)for(let a of r)s.append("source",a);for await(let a of this._getPaginated("/feedback",s))yield*a}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:s}={}){let a={run_id:e,feedback_key:t,feedback_config:s};return r?typeof r=="string"?a.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(a.expires_in=r):a.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){q(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}};var ba="0.1.14";var Qn=class extends $e{constructor(e={}){var a;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:s}=e;this.projectName=(a=r!=null?r:U("LANGCHAIN_PROJECT"))!=null?a:U("LANGCHAIN_SESSION"),this.exampleId=t,this.client=s!=null?s:new dn({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await ju()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}};async function xc(){return new Qn}var _a=Ce(na(),1),no;function Qf(){let n="default"in _a.default?_a.default.default:_a.default;return new n({autoStart:!0,concurrency:1})}async function ee(n,e){e===!0?await n():(typeof no=="undefined"&&(no=Qf()),no.add(n))}U("LANGCHAIN_TRACING_V2")==="true"&&U("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);function Ec(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var so=class{setHandler(e){return this.setHandlers([e])}},hn=class{constructor(e,t,r,s,a,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleText: ${s}`)}},t.awaitHandlers)))}},ao=class extends hn{getChild(e){let t=new te(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${s}`)}},t.awaitHandlers)))}},wa=class extends hn{async handleLLMNewToken(e,t,r,s,a,i){await Promise.all(this.handlers.map(o=>ee(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t!=null?t:{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${s}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${s}`)}},t.awaitHandlers)))}},io=class extends hn{getChild(e){let t=new te(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,s,a){await Promise.all(this.handlers.map(i=>ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainError: ${u}`)}},i.awaitHandlers)))}async handleChainEnd(e,t,r,s,a){await Promise.all(this.handlers.map(i=>ee(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,a))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`)}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${s}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${s}`)}},t.awaitHandlers)))}},oo=class extends hn{getChild(e){let t=new te(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${s}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${s}`)}},t.awaitHandlers)))}},te=class n extends so{constructor(e,t){var r,s,a,i,o,u;super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(r=t==null?void 0:t.handlers)!=null?r:this.handlers,this.inheritableHandlers=(s=t==null?void 0:t.inheritableHandlers)!=null?s:this.inheritableHandlers,this.tags=(a=t==null?void 0:t.tags)!=null?a:this.tags,this.inheritableTags=(i=t==null?void 0:t.inheritableTags)!=null?i:this.inheritableTags,this.metadata=(o=t==null?void 0:t.metadata)!=null?o:this.metadata,this.inheritableMetadata=(u=t==null?void 0:t.inheritableMetadata)!=null?u:this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{let l=de();return await Promise.all(this.handlers.map(d=>ee(async()=>{var h;if(!d.ignoreLLM)try{await((h=d.handleLLMStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,a,this.tags,this.metadata,u))}catch(f){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${f}`)}},d.awaitHandlers))),new wa(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,s=void 0,a=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{let l=de();return await Promise.all(this.handlers.map(d=>ee(async()=>{var h,f;if(!d.ignoreLLM)try{if(d.handleChatModelStart)await((h=d.handleChatModelStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,a,this.tags,this.metadata,u));else if(d.handleLLMStart){let p=tn(c);await((f=d.handleLLMStart)==null?void 0:f.call(d,e,[p],l,this._parentRunId,a,this.tags,this.metadata,u))}}catch(p){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${p}`)}},d.awaitHandlers))),new wa(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=de(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ee(async()=>{var c;if(!u.ignoreChain)try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`)}},u.awaitHandlers))),new io(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=de(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ee(async()=>{var c;if(!u.ignoreAgent)try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`)}},u.awaitHandlers))),new oo(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=de(),s=void 0,a=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ee(async()=>{var c;if(!u.ignoreRetriever)try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`)}},u.awaitHandlers))),new ao(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let s of this.handlers){let a=this.inheritableHandlers.includes(s);r.addHandler(s,a)}for(let s of this.tags){let a=this.inheritableTags.includes(s);r.addTags([s],a)}for(let s of Object.keys(this.metadata)){let a=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},a)}for(let s of e)r.handlers.filter(a=>a.name==="console_callback_handler").some(a=>a.name===s.name)||r.addHandler(s,t);return r}static fromHandlers(e){class t extends br{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:de()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,s,a,i,o){var h,f;let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers((h=e==null?void 0:e.map(es))!=null?h:[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(es):t==null?void 0:t.handlers,!1));let c=U("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=U("LANGCHAIN_TRACING_V2")==="true",d=l||((f=U("LANGCHAIN_TRACING"))!=null?f:!1);if(c||d){if(u||(u=new n),c&&!u.handlers.some(p=>p.name===Yn.prototype.name)){let p=new Yn;u.addHandler(p,!0)}d&&!u.handlers.some(p=>p.name==="langchain_tracer")&&l&&u.addHandler(await xc(),!0)}return(r||s)&&u&&(u.addTags(r!=null?r:[]),u.addTags(s!=null?s:[],!1)),(a||i)&&u&&(u.addMetadata(a!=null?a:{}),u.addMetadata(i!=null?i:{},!1)),u}};function es(n){return"name"in n?n:br.fromMethods(n)}var uo={};_i(uo,{JsonPatchError:()=>Z,_areEquals:()=>rs,applyOperation:()=>wr,applyPatch:()=>Ct,applyReducer:()=>np,deepClone:()=>tp,getValueByPointer:()=>Oa,validate:()=>Pc,validator:()=>Pa});var ep=Object.prototype.hasOwnProperty;function Aa(n,e){return ep.call(n,e)}function xa(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Aa(n,t)&&e.push(t);return e}function oe(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Ea(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Ve(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function ts(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function va(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(va(n[t]))return!0}else if(typeof n=="object"){let t=xa(n),r=t.length;for(var e=0;e<r;e++)if(va(n[t[e]]))return!0}}return!1}function Oc(n,e){let t=[n];for(let r in e){let s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s!="undefined"&&t.push(`${r}: ${s}`)}return t.join(`
`)}var _r=class extends Error{constructor(e,t,r,s,a){super(Oc(e,{name:t,index:r,operation:s,tree:a})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.setPrototypeOf(this,new.target.prototype),this.message=Oc(e,{name:t,index:r,operation:s,tree:a})}};var Z=_r,tp=oe,fn={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Oa(t,this.path);r&&(r=oe(r));let s=wr(t,{op:"remove",path:this.from}).removed;return wr(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=Oa(t,this.from);return wr(t,{op:"add",path:this.path,value:oe(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:rs(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},rp={add:function(n,e,t){return Ea(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:fn.move,copy:fn.copy,test:fn.test,_get:fn._get};function Oa(n,e){if(e=="")return n;var t={op:"_get",path:e};return wr(n,t),t.value}function wr(n,e,t=!1,r=!0,s=!0,a=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):Pa(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Oa(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=rs(n,e.value),i.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new Z("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",a,e,n);return i}}else{r||(n=oe(n));let o=(e.path||"").split("/"),u=n,c=1,l=o.length,d,h,f;for(typeof t=="function"?f=t:f=Pa;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=ts(h)),s&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&f(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!Ea(h))throw new Z("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",a,e,n);Ea(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new Z("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",a,e,n);let p=rp[e.op].call(e,u,h,n);if(p.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return p}}else if(c>=l){let p=fn[e.op].call(e,u,h,n);if(p.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",a,e,n);return p}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new Z("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",a,e,n)}}}function Ct(n,e,t,r=!0,s=!0){if(t&&!Array.isArray(e))throw new Z("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=oe(n));let a=new Array(e.length);for(let i=0,o=e.length;i<o;i++)a[i]=wr(n,e[i],t,!0,s,i),n=a[i].newDocument;return a.newDocument=n,a}function np(n,e,t){let r=wr(n,e);if(r.test===!1)throw new Z("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function Pa(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new Z("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(fn[n.op]){if(typeof n.path!="string")throw new Z("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new Z('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new Z("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new Z("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&va(n.value))throw new Z("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,a=r.split("/").length;if(s!==a+1&&s!==a)throw new Z("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new Z("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Pc([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new Z("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new Z("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Pc(n,e,t){try{if(!Array.isArray(n))throw new Z("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Ct(oe(e),oe(n),t||!0);else{t=t||Pa;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof Z)return s;throw s}}function rs(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,a,i;if(t&&r){if(a=n.length,a!=e.length)return!1;for(s=a;s--!==0;)if(!rs(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(a=o.length,a!==Object.keys(e).length)return!1;for(s=a;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=a;s--!==0;)if(i=o[s],!rs(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}function Ic(n,e,t,r,s){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var a=xa(e),i=xa(n),o=!1,u=!1,c=i.length-1;c>=0;c--){var l=i[c],d=n[l];if(Aa(e,l)&&!(e[l]===void 0&&d!==void 0&&Array.isArray(e)===!1)){var h=e[l];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?Ic(d,h,t,r+"/"+Ve(l),s):d!==h&&(o=!0,s&&t.push({op:"test",path:r+"/"+Ve(l),value:oe(d)}),t.push({op:"replace",path:r+"/"+Ve(l),value:oe(h)}))}else Array.isArray(n)===Array.isArray(e)?(s&&t.push({op:"test",path:r+"/"+Ve(l),value:oe(d)}),t.push({op:"remove",path:r+"/"+Ve(l)}),u=!0):(s&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&a.length==i.length))for(var c=0;c<a.length;c++){var l=a[c];!Aa(n,l)&&e[l]!==void 0&&t.push({op:"add",path:r+"/"+Ve(l),value:oe(e[l])})}}}function Ia(n,e,t=!1){var r=[];return Ic(n,e,r,"",t),r}var Mb={...uo,JsonPatchError:_r,deepClone:oe,escapePathComponent:Ve,unescapePathComponent:ts};var Ge=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return s();function s(){return t.read().then(({done:a,value:i})=>{if(a){r.close();return}return r.enqueue(i),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:s}=await e.next();s&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function co(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){let a=await n.next();for(let i of t)i.push(a)}else{if(s[0].done)return;yield s.shift().value}})}function Ze(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,s]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Ze(t[r],s):t[r]=s;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var lt=class{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,s)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,s):this.firstResult.then(a=>r(void 0),s)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function Tc(n,e,t,...r){let s=new lt(e,t),a=await s.setup;return{output:n(s,a,...r),setup:a}}var Me=class{constructor(e){var t;Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=(t=e.ops)!=null?t:[]}concat(e){let t=this.ops.concat(e.ops),r=Ct({},t);return new ns({ops:t,state:r[r.length-1].newDocument})}},ns=class n extends Me{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=Ct(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=Ct({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}};async function Cc(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function Sc(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function sp(n){return n!==void 0&&n.message!==void 0}var ss=class extends $e{constructor(e){var t,r;super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(r=e==null?void 0:e._schemaFormat)!=null?r:this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ge.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var s;if(e.id===this.rootId)return!1;let t=(s=e.tags)!=null?s:[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(a=>{var i;return(i=this.includeTags)==null?void 0:i.includes(a)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(a=>{var i;return!((i=this.excludeTags)!=null&&i.includes(a))})),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let s=this.keyMapByRunId[e];s&&await this.writer.write(new Me({ops:[{op:"add",path:`/logs/${s}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var s,a,i;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Me({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:(s=e.tags)!=null?s:[],metadata:(i=(a=e.extra)==null?void 0:a.metadata)!=null?i:{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Cc(e,this._schemaFormat)),await this.writer.write(new Me({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Cc(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Sc(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let s=new Me({ops:r});await this.writer.write(s)}finally{if(e.id===this.rootId){let t=new Me({ops:[{op:"replace",path:"/final_output",value:await Sc(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let s=this.keyMapByRunId[e.id];if(s===void 0)return;let a=e.inputs.messages!==void 0,i;a?sp(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new tt(t):i=t;let o=new Me({ops:[{op:"add",path:`/logs/${s}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${s}/streamed_output/-`,value:i}]});await this.writer.write(o)}};var lo=class{getStore(){}run(e,t){t()}},ho=class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new lo}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}},as=new ho;var Ta=25;async function We(n){return te.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function fo(...n){var t,r,s;let e={};for(let a of n.filter(i=>!!i))for(let i of Object.keys(a))if(i==="metadata")e[i]={...e[i],...a[i]};else if(i==="tags"){let o=(t=e[i])!=null?t:[];e[i]=[...new Set(o.concat((r=a[i])!=null?r:[]))]}else if(i==="configurable")e[i]={...e[i],...a[i]};else if(i==="callbacks"){let o=e.callbacks,u=a.callbacks;if(Array.isArray(u))if(!o)e.callbacks=u;else if(Array.isArray(o))e.callbacks=o.concat(u);else{let c=o.copy();for(let l of u)c.addHandler(es(l),!0);e.callbacks=c}else if(u)if(!o)e.callbacks=u;else if(Array.isArray(o)){let c=u.copy();for(let l of o)c.addHandler(es(l),!0);e.callbacks=c}else e.callbacks=new te(u._parentRunId,{handlers:o.handlers.concat(u.handlers),inheritableHandlers:o.inheritableHandlers.concat(u.inheritableHandlers),tags:Array.from(new Set(o.tags.concat(u.tags))),inheritableTags:Array.from(new Set(o.inheritableTags.concat(u.inheritableTags))),metadata:{...o.metadata,...u.metadata}})}else{let o=i;e[o]=(s=a[o])!=null?s:e[o]}return e}var ap=new Set(["string","number","boolean"]);function B(n){var r;let e=n!=null?n:as.getInstance().getStore(),t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(t={...t,...e}),e!=null&&e.configurable)for(let s of Object.keys(e.configurable))ap.has(typeof e.configurable[s])&&!((r=t.metadata)!=null&&r[s])&&(t.metadata||(t.metadata={}),t.metadata[s]=e.configurable[s]);return t}function ne(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:s,configurable:a}={}){let i=B(n);return e!==void 0&&(delete i.runName,i.callbacks=e),r!==void 0&&(i.recursionLimit=r),t!==void 0&&(i.maxConcurrency=t),s!==void 0&&(i.runName=s),a!==void 0&&(i.configurable={...i.configurable,...a}),i}var is=class extends $e{constructor({config:e,onStart:t,onEnd:r,onError:s}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function Sa(n){return n?n.lc_runnable:!1}var Ca=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){var a;let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,s=(a=e.tags)!=null?a:[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||s.some(i=>{var o;return(o=this.includeTags)==null?void 0:o.includes(i)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&s.every(i=>{var o;return!((o=this.excludeTags)!=null&&o.includes(i))})),r}};function po(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function M(n,e,t,r,s){n[e]=t,po(n,e,r,s)}var kc={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"string",mapStrategy:"entries",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},Nc=n=>typeof n=="string"?{...kc,name:n}:{...kc,...n};function Rc(){return{}}function jc(n,e){var r,s;let t={type:"array"};return((s=(r=n.type)==null?void 0:r._def)==null?void 0:s.typeName)!==g.ZodAny&&(t.items=P(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&M(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&M(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(M(t,"minItems",n.exactLength.value,n.exactLength.message,e),M(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function $c(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?M(t,"minimum",r.value,r.message,e):M(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),M(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?M(t,"maximum",r.value,r.message,e):M(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),M(t,"maximum",r.value,r.message,e));break;case"multipleOf":M(t,"multipleOf",r.value,r.message,e);break}return t}function Lc(){return{type:"boolean"}}function Mc(n,e){return P(n.type._def,e)}var Dc=(n,e)=>P(n.innerType._def,e);function Fc(n,e){return e.dateStrategy=="integer"?ip(n,e):{type:"string",format:"date-time"}}var ip=(n,e)=>{let t={type:"integer",format:"unix-time"};for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"&&M(t,"minimum",r.value,r.message,e);break;case"max":e.target==="jsonSchema7"&&M(t,"maximum",r.value,r.message,e);break}return t};function zc(n,e){return{...P(n.innerType._def,e),default:n.defaultValue()}}function Uc(n,e){return e.effectStrategy==="input"?P(n.schema._def,e):{}}function Bc(n){return{type:"string",enum:n.values}}var op=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Kc(n,e){let t=[P(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),P(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(a=>!!a),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,s=[];return t.forEach(a=>{if(op(a))s.push(...a.allOf),a.unevaluatedProperties===void 0&&(r=void 0);else{let i=a;if("additionalProperties"in a&&a.additionalProperties===!1){let{additionalProperties:o,...u}=a;i=u}else r=void 0;s.push(i)}}),s.length?{allOf:s,...r}:void 0}function Hc(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var os={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function ka(n,e){let t={type:"string"};function r(s){return e.patternStrategy==="escape"?up(s):s}if(n.checks)for(let s of n.checks)switch(s.kind){case"min":M(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e);break;case"max":M(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"email":switch(e.emailStrategy){case"format:email":vr(t,"email",s.message,e);break;case"format:idn-email":vr(t,"idn-email",s.message,e);break;case"pattern:zod":dt(t,os.email,s.message,e);break}break;case"url":vr(t,"uri",s.message,e);break;case"uuid":vr(t,"uuid",s.message,e);break;case"regex":dt(t,s.regex.source,s.message,e);break;case"cuid":dt(t,os.cuid,s.message,e);break;case"cuid2":dt(t,os.cuid2,s.message,e);break;case"startsWith":dt(t,"^"+r(s.value),s.message,e);break;case"endsWith":dt(t,r(s.value)+"$",s.message,e);break;case"datetime":vr(t,"date-time",s.message,e);break;case"length":M(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,s.value):s.value,s.message,e),M(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,s.value):s.value,s.message,e);break;case"includes":{dt(t,r(s.value),s.message,e);break}case"ip":{s.version!=="v6"&&vr(t,"ipv4",s.message,e),s.version!=="v4"&&vr(t,"ipv6",s.message,e);break}case"emoji":dt(t,os.emoji,s.message,e);break;case"ulid":{dt(t,os.ulid,s.message,e);break}case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var up=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),vr=(n,e,t,r)=>{var s;n.format||(s=n.anyOf)!=null&&s.some(a=>a.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):M(n,"format",e,t,r)},dt=(n,e,t,r)=>{var s;n.pattern||(s=n.allOf)!=null&&s.some(a=>a.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:e,...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):M(n,"pattern",e,t,r)};function Na(n,e){var r,s,a,i,o;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===g.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((u,c)=>{var l;return{...u,[c]:(l=P(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]}))!=null?l:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(s=P(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?s:{}};if(e.target==="openApi3")return t;if(((a=n.keyType)==null?void 0:a._def.typeName)===g.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let u=Object.entries(ka(n.keyType._def,e)).reduce((c,[l,d])=>l==="type"?c:{...c,[l]:d},{});return{...t,propertyNames:u}}else if(((o=n.keyType)==null?void 0:o._def.typeName)===g.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function qc(n,e){if(e.mapStrategy==="record")return Na(n,e);let t=P(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=P(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Vc(n){let e=n.values,r=Object.keys(n.values).filter(a=>typeof e[e[a]]!="number").map(a=>e[a]),s=Array.from(new Set(r.map(a=>typeof a)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}function Gc(){return{not:{}}}function Zc(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var us={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function Jc(n,e){if(e.target==="openApi3")return Wc(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in us&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((s,a)=>{let i=us[a._def.typeName];return i&&!s.includes(i)?[...s,i]:s},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((s,a)=>{let i=typeof a._def.value;switch(i){case"string":case"number":case"boolean":return[...s,i];case"bigint":return[...s,"integer"];case"object":if(a._def.value===null)return[...s,"null"];case"symbol":case"undefined":case"function":default:return s}},[]);if(r.length===t.length){let s=r.filter((a,i,o)=>o.indexOf(a)===i);return{type:s.length>1?s:s[0],enum:t.reduce((a,i)=>a.includes(i._def.value)?a:[...a,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,s)=>[...r,...s._def.values.filter(a=>!r.includes(a))],[])};return Wc(n,e)}var Wc=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,s)=>P(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${s}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function Yc(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:us[n.innerType._def.typeName],nullable:!0}:{type:[us[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=P(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=P(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Xc(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",po(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?M(t,"minimum",r.value,r.message,e):M(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),M(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?M(t,"maximum",r.value,r.message,e):M(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),M(t,"maximum",r.value,r.message,e));break;case"multipleOf":M(t,"multipleOf",r.value,r.message,e);break}return t}function Qc(n,e){var r;let t={type:"object",...Object.entries(n.shape()).reduce((s,[a,i])=>{if(i===void 0||i._def===void 0)return s;let o=P(i._def,{...e,currentPath:[...e.currentPath,"properties",a],propertyPath:[...e.currentPath,"properties",a]});return o===void 0?s:{properties:{...s.properties,[a]:o},required:i.isOptional()?s.required:[...s.required,a]}},{properties:{},required:[]}),additionalProperties:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=P(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0};return t.required.length||delete t.required,t}var el=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return P(n.innerType._def,e);let t=P(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var tl=(n,e)=>{if(e.pipeStrategy==="input")return P(n.in._def,e);if(e.pipeStrategy==="output")return P(n.out._def,e);let t=P(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=P(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(s=>s!==void 0)}};function rl(n,e){return P(n.type._def,e)}function nl(n,e){let r={type:"array",uniqueItems:!0,items:P(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&M(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&M(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function sl(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>P(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:P(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>P(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function al(){return{not:{}}}function il(){return{}}var ol=(n,e)=>P(n.innerType._def,e);function P(n,e,t=!1){let r=e.seen.get(n);if(r&&!t){let i=cp(r,e);if(i!==void 0)return i}let s={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,s);let a=dp(n,n.typeName,e);return a&&hp(n,e,a),s.jsonSchema=a,a}var cp=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:lp(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},lp=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},dp=(n,e,t)=>{switch(e){case g.ZodString:return ka(n,t);case g.ZodNumber:return Xc(n,t);case g.ZodObject:return Qc(n,t);case g.ZodBigInt:return $c(n,t);case g.ZodBoolean:return Lc();case g.ZodDate:return Fc(n,t);case g.ZodUndefined:return al();case g.ZodNull:return Zc(t);case g.ZodArray:return jc(n,t);case g.ZodUnion:case g.ZodDiscriminatedUnion:return Jc(n,t);case g.ZodIntersection:return Kc(n,t);case g.ZodTuple:return sl(n,t);case g.ZodRecord:return Na(n,t);case g.ZodLiteral:return Hc(n,t);case g.ZodEnum:return Bc(n);case g.ZodNativeEnum:return Vc(n);case g.ZodNullable:return Yc(n,t);case g.ZodOptional:return el(n,t);case g.ZodMap:return qc(n,t);case g.ZodSet:return nl(n,t);case g.ZodLazy:return P(n.getter()._def,t);case g.ZodPromise:return rl(n,t);case g.ZodNaN:case g.ZodNever:return Gc();case g.ZodEffects:return Uc(n,t);case g.ZodAny:return Rc();case g.ZodUnknown:return il();case g.ZodDefault:return zc(n,t);case g.ZodBranded:return Mc(n,t);case g.ZodReadonly:return ol(n,t);case g.ZodCatch:return Dc(n,t);case g.ZodPipeline:return tl(n,t);case g.ZodFunction:case g.ZodVoid:case g.ZodSymbol:return;default:return(r=>{})(e)}},hp=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var ul=n=>{let e=Nc(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,s])=>[s._def,{def:s._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};var Je=(n,e)=>{var o;let t=ul(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[c,l])=>{var d;return{...u,[c]:(d=P(l._def,{...t,currentPath:[...t.basePath,t.definitionPath,c]},!0))!=null?d:{}}},{}):void 0,s=typeof e=="string"?e:e==null?void 0:e.name,a=(o=P(n._def,s===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,s]},!1))!=null?o:{},i=s===void 0?r?{...a,[t.definitionPath]:r}:a:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,s].join("/"),[t.definitionPath]:{...r,[s]:a}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i};function fp(n){return Sa(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Je(n.data.schema),title:n.data.name}}}var cs=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=Jn(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...fp(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||de(),s={id:r,data:e};return this.nodes[r]=s,s}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let s={source:e.id,target:t.id,data:r};return this.edges.push(s),s}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}};function se(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var H=class extends Se{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){var r,s;let t=(s=(r=this.name)!=null?r:this.constructor.lc_name())!=null?s:this.constructor.name;return e?`${t}${e}`:t}bind(e){return new St({bound:this,kwargs:e,config:{}})}map(){return new Ra({bound:this})}withRetry(e){return new ja({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new St({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new $a({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(B)}return Array.from({length:t},()=>B(e))}async batch(e,t,r){var u,c;let s=this._getOptionsList(t!=null?t:{},e.length),a=(c=(u=s[0])==null?void 0:u.maxConcurrency)!=null?c:r==null?void 0:r.maxConcurrency,i=new nt({maxConcurrency:a,onFailedAttempt:l=>{throw l}}),o=e.map((l,d)=>i.call(async()=>{try{return await this.invoke(l,s[d])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=new lt(this._streamIterator(e,B(t)));return await r.setup,Ge.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){let t=B({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){var u;let s=B(r),a=await We(s),i=await(a==null?void 0:a.handleChainStart(this.toJSON(),se(t,"input"),void 0,s==null?void 0:s.runType,void 0,void 0,(u=s==null?void 0:s.runName)!=null?u:this.getName())),o;try{o=await e.call(this,t,s,i)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(se(o,"output"))),o}async _batchWithConfig(e,t,r,s){let a=this._getOptionsList(r!=null?r:{},t.length),i=await Promise.all(a.map(We)),o=await Promise.all(i.map((c,l)=>{var d;return c==null?void 0:c.handleChainStart(this.toJSON(),se(t[l],"input"),void 0,a[l].runType,void 0,void 0,(d=a[l].runName)!=null?d:this.getName())})),u;try{u=await e.call(this,t,a,o,s)}catch(c){throw await Promise.all(o.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(o.map(c=>c==null?void 0:c.handleChainEnd(se(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let s,a=!0,i,o=!0,u=B(r),c=await We(u);async function*l(){for await(let h of e){if(a)if(s===void 0)s=h;else try{s=Ze(s,h)}catch(f){s=void 0,a=!1}yield h}}let d;try{let h=await Tc(t.bind(this),l(),async()=>{var m;return c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},void 0,u==null?void 0:u.runType,void 0,void 0,(m=u==null?void 0:u.runName)!=null?m:this.getName())},u);d=h.setup;let f=m=>m.name==="log_stream_tracer",p=d==null?void 0:d.handlers.find(f),y=h.output;p!==void 0&&d!==void 0&&(y=await p.tapOutputIterable(d.runId,h.output));for await(let m of y)if(yield m,o)if(i===void 0)i=m;else try{i=Ze(i,m)}catch(_){i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:se(s,"input")})),h}await(d==null?void 0:d.handleChainEnd(i!=null?i:{},void 0,void 0,void 0,{inputs:se(s,"input")}))}getGraph(e){let t=new cs,r=t.addNode({name:`${this.getName()}Input`,schema:ot.any()}),s=t.addNode(this),a=t.addNode({name:`${this.getName()}Output`,schema:ot.any()});return t.addEdge(r,s),t.addEdge(s,a),t}pipe(e){return new pn({first:this,last:ht(e)})}pick(e){return this.pipe(new La(e))}assign(e){return this.pipe(new mn(new kt({steps:e})))}async*transform(e,t){let r;for await(let s of e)r===void 0?r=s:r=Ze(r,s);yield*this._streamIterator(r,B(t))}async*streamLog(e,t,r){let s=new ss({...r,autoClose:!1,_schemaFormat:"original"}),a=B(t);yield*this._streamLog(e,s,a)}async*_streamLog(e,t,r){let{callbacks:s}=r;if(s===void 0)r.callbacks=[t];else if(Array.isArray(s))r.callbacks=s.concat([t]);else{let u=s.copy();u.inheritableHandlers.push(t),r.callbacks=u}let a=this.stream(e,r);async function i(){try{let u=await a;for await(let c of u){let l=new Me({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}async*streamEvents(e,t,r){var p,y,m;if(t.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let s,a=!1,i=B(t),o=(p=i.tags)!=null?p:[],u=(y=i.metadata)!=null?y:{},c=(m=i.runName)!=null?m:this.getName(),l=new ss({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new Ca({...r}),h=this._streamLog(e,l,i);for await(let _ of h){if(s?s=s.concat(_):s=ns.fromRunLogPatch(_),s.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!a){a=!0;let L={...s.state},C={run_id:L.id,event:`on_${L.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(C,L.type)&&(yield C)}let w=_.ops.filter(L=>L.path.startsWith("/logs/")).map(L=>L.path.split("/")[2]),$=[...new Set(w)];for(let L of $){let C,K={},S=s.state.logs[L];if(S.end_time===void 0?S.streamed_output.length>0?C="stream":C="start":C="end",C==="start")S.inputs!==void 0&&(K.input=S.inputs);else if(C==="end")S.inputs!==void 0&&(K.input=S.inputs),K.output=S.final_output;else if(C==="stream"){let z=S.streamed_output.length;if(z!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${z} instead. Encountered in: "${S.name}"`);K={chunk:S.streamed_output[0]},S.streamed_output=[]}yield{event:`on_${S.type}_${C}`,name:S.name,run_id:S.id,tags:S.tags,metadata:S.metadata,data:K}}let{state:D}=s;if(D.streamed_output.length>0){let L=D.streamed_output.length;if(L!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${L} instead. Encountered in: "${D.name}"`);let C={chunk:D.streamed_output[0]};D.streamed_output=[];let K={event:`on_${D.type}_stream`,run_id:D.id,tags:o,metadata:u,name:c,data:C};d.includeEvent(K,D.type)&&(yield K)}}let f=s==null?void 0:s.state;if(f!==void 0){let _={event:`on_${f.type}_end`,name:c,run_id:f.id,tags:o,metadata:u,data:{output:f.final_output}};d.includeEvent(_,f.type)&&(yield _)}}static isRunnable(e){return Sa(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new St({bound:this,config:{},configFactories:[s=>({callbacks:[new is({config:s,onStart:e,onEnd:t,onError:r})]})]})}},St=class n extends H{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=fo(this.config,...e);return fo(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(B(t),this.kwargs))}async batch(e,t,r){let s=Array.isArray(t)?await Promise.all(t.map(async a=>this._mergeConfig(B(a),this.kwargs))):await this._mergeConfig(B(t),this.kwargs);return this.bound.batch(e,s,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(B(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(B(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(B(t),this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(B(t),this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&H.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new is({config:s,onStart:e,onEnd:t,onError:r})]})]})}},Ra=class n extends H{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,ne(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},ja=class extends St{static lc_name(){return"RunnableRetry"}constructor(e){var t,r;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=(t=e.maxAttemptNumber)!=null?t:this.maxAttemptNumber,this.onFailedAttempt=(r=e.onFailedAttempt)!=null?r:this.onFailedAttempt}_patchConfigForRetry(e,t,r){let s=e>1?`retry:attempt:${e}`:void 0;return ne(t,{callbacks:r==null?void 0:r.getChild(s)})}async _invoke(e,t,r){return(0,mo.default)(s=>super.invoke(e,this._patchConfigForRetry(s,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,s){let a={};try{await(0,mo.default)(async i=>{let o=e.map((h,f)=>f).filter(h=>a[h.toString()]===void 0||a[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(u,c,{...s,returnExceptions:!0}),d;for(let h=0;h<l.length;h+=1){let f=l[h],p=o[h];f instanceof Error&&d===void 0&&(d=f),a[p.toString()]=f}if(d)throw d;return l},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((s==null?void 0:s.returnExceptions)!==!0)throw i}return Object.keys(a).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>a[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},pn=class n extends H{static lc_name(){return"RunnableSequence"}constructor(e){var t;super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=(t=e.middle)!=null?t:this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=B(t),s=await We(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),se(e,"input"),void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),i=e,o;try{let u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1)i=await u[c].invoke(i,ne(r,{callbacks:a==null?void 0:a.getChild(`seq:step:${c+1}`)}));o=await this.last.invoke(i,ne(r,{callbacks:a==null?void 0:a.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await(a==null?void 0:a.handleChainError(u)),u}return await(a==null?void 0:a.handleChainEnd(se(o,"output"))),o}async batch(e,t,r){let s=this._getOptionsList(t!=null?t:{},e.length),a=await Promise.all(s.map(We)),i=await Promise.all(a.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),se(e[c],"input"),void 0,void 0,void 0,void 0,s[c].runName))),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((l,d)=>{let h=l==null?void 0:l.getChild(`seq:step:${u+1}`);return ne(s[d],{callbacks:h})}),r)}catch(u){throw await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(u))),u}return await Promise.all(i.map(u=>u==null?void 0:u.handleChainEnd(se(o,"output")))),o}async*_streamIterator(e,t){let r=await We(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),se(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),a=[this.first,...this.middle,this.last],i=!0,o;async function*u(){yield e}try{let c=a[0].transform(u(),ne(t,{callbacks:s==null?void 0:s.getChild("seq:step:1")}));for(let l=1;l<a.length;l+=1)c=await a[l].transform(c,ne(t,{callbacks:s==null?void 0:s.getChild(`seq:step:${l+1}`)}));for await(let l of c)if(yield l,i)if(o===void 0)o=l;else try{o=Ze(o,l)}catch(d){o=void 0,i=!1}}catch(c){throw await(s==null?void 0:s.handleChainError(c)),c}await(s==null?void 0:s.handleChainEnd(se(o,"output")))}getGraph(e){let t=new cs,r=null;return this.steps.forEach((s,a)=>{let i=s.getGraph(e);a!==0&&i.trimFirstNode(),a!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${s} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){var t;return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:(t=this.name)!=null?t:e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:ht(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&H.isRunnable(e)}static from([e,...t],r){return new n({first:ht(e),middle:t.slice(0,-1).map(ht),last:ht(t[t.length-1]),name:r})}},kt=class n extends H{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=ht(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=B(t),s=await We(r),a=await(s==null?void 0:s.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,ne(r,{callbacks:a==null?void 0:a.getChild(`map:key:${o}`)}))}))}catch(o){throw await(a==null?void 0:a.handleChainError(o)),o}return await(a==null?void 0:a.handleChainEnd(i)),i}async*_transform(e,t,r){let s={...this.steps},a=co(e,Object.keys(s).length),i=new Map(Object.entries(s).map(([o,u],c)=>{let l=u.transform(a[c],ne(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){let{key:o,result:u,gen:c}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,c.next().then(l=>({key:o,gen:c,result:l}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let s=new lt(this.transform(r(),t));return await s.setup,Ge.fromAsyncGenerator(s)}},ls=class n extends H{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((s,a)=>{var o;let i=ne(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((o=t==null?void 0:t.recursionLimit)!=null?o:Ta)-1});as.getInstance().run(i,async()=>{var u;try{let c=await this.func(e,{...i,config:i});if(c&&H.isRunnable(c)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");c=await c.invoke(e,{...i,recursionLimit:((u=i.recursionLimit)!=null?u:Ta)-1})}s(c)}catch(c){a(c)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){var i;let s;for await(let o of e)if(s===void 0)s=o;else try{s=Ze(s,o)}catch(u){s=o}let a=await new Promise((o,u)=>{as.getInstance().run(r,async()=>{try{let c=await this.func(s,{...r,config:r});o(c)}catch(c){u(c)}})});if(a&&H.isRunnable(a)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");let o=await a.stream(s,ne(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((i=r==null?void 0:r.recursionLimit)!=null?i:Ta)-1}));for await(let u of o)yield u}else yield a}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let s=new lt(this.transform(r(),t));return await s.setup,Ge.fromAsyncGenerator(s)}};var $a=class extends H{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=await te.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),se(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),a;for(let i of this.runnables())try{let o=await i.invoke(e,ne(t,{callbacks:s==null?void 0:s.getChild()}));return await(s==null?void 0:s.handleChainEnd(se(o,"output"))),o}catch(o){a===void 0&&(a=o)}throw a===void 0?new Error("No error stored at end of fallback."):(await(s==null?void 0:s.handleChainError(a)),a)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");let s=this._getOptionsList(t!=null?t:{},e.length),a=await Promise.all(s.map(u=>te.configure(u==null?void 0:u.callbacks,void 0,u==null?void 0:u.tags,void 0,u==null?void 0:u.metadata))),i=await Promise.all(a.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),se(e[c],"input"),void 0,void 0,void 0,void 0,s[c].runName))),o;for(let u of this.runnables())try{let c=await u.batch(e,i.map((l,d)=>ne(s[d],{callbacks:l==null?void 0:l.getChild()})),r);return await Promise.all(i.map((l,d)=>l==null?void 0:l.handleChainEnd(se(c[d],"output")))),c}catch(c){o===void 0&&(o=c)}throw o?(await Promise.all(i.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function ht(n){if(typeof n=="function")return new ls({func:n});if(H.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=ht(r);return new kt({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var mn=class extends H{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof kt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let s=this.mapper.getStepsKeys(),[a,i]=co(e),o=this.mapper.transform(i,ne(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(let c of a){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);let l=Object.fromEntries(Object.entries(c).filter(([d])=>!s.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(let c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let s=new lt(this.transform(r(),t));return await s.setup,Ge.fromAsyncGenerator(s)}},La=class extends H{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let s=new lt(this.transform(r(),t));return await s.setup,Ge.fromAsyncGenerator(s)}};var pp=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n;var mp=()=>!1,ds=class extends H{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){var t,r,s;super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=(t=e.verbose)!=null?t:mp(),this.callbacks=e.callbacks,this.tags=(r=e.tags)!=null?r:[],this.metadata=(s=e.metadata)!=null?s:{}}},hs=class extends ds{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e!=null?e:t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=Vs.global():this.cache=void 0,this.caller=new nt(r!=null?r:{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await rc("modelName"in this?pp(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Zs(e):Array.isArray(e)?new Ws(e.map(Yt)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){let t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(t).filter(([a,i])=>i!==void 0).map(([a,i])=>`${a}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var gn=class n extends hs{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r!=null&&r.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let s=n._convertInputToPromptValue(e).toChatMessages(),[a,i]=this._separateRunnableConfigFromCallOptions(t),o=await te.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},c=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),[s],void 0,void 0,u,void 0,void 0,a.runName)),l;try{for await(let d of this._streamResponseChunks(s,i,c==null?void 0:c[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,l?l=l.concat(d):l=d}catch(d){throw await Promise.all((c!=null?c:[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((c!=null?c:[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[l]]})))}}async _generateUncached(e,t,r){var h;let s=e.map(f=>f.map(Yt)),a=await te.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},o=await(a==null?void 0:a.handleChatModelStart(this.toJSON(),s,void 0,void 0,i,void 0,void 0,r.runName)),u=await Promise.allSettled(s.map((f,p)=>this._generate(f,{...t,promptIndex:p},o==null?void 0:o[p]))),c=[],l=[];await Promise.all(u.map(async(f,p)=>{var y,m;if(f.status==="fulfilled"){let _=f.value;for(let w of _.generations)w.message.response_metadata={...w.generationInfo,...w.message.response_metadata};return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),c[p]=_.generations,l[p]=_.llmOutput,(y=o==null?void 0:o[p])==null?void 0:y.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((m=o==null?void 0:o[p])==null?void 0:m.handleLLMError(f.reason)),Promise.reject(f.reason)}));let d={generations:c,llmOutput:l.length?(h=this._combineLLMOutput)==null?void 0:h.call(this,...l):void 0};return Object.defineProperty(d,qs,{value:o?{runIds:o==null?void 0:o.map(f=>f.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:s,handledOptions:a}){let i=e.map(y=>y.map(Yt)),o=await te.configure(a.callbacks,this.callbacks,a.tags,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),u={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1,cached:!0},c=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),i,void 0,void 0,u,void 0,void 0,a.runName)),l=[],h=(await Promise.allSettled(i.map(async(y,m)=>{let _=n._convertInputToPromptValue(y).toString(),w=await t.lookup(_,r);return w==null&&l.push(m),w}))).map((y,m)=>({result:y,runManager:c==null?void 0:c[m]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),f=[];await Promise.all(h.map(async({result:y,runManager:m},_)=>{if(y.status==="fulfilled"){let w=y.value;return f[_]=w,w.length&&await(m==null?void 0:m.handleLLMNewToken(w[0].text)),m==null?void 0:m.handleLLMEnd({generations:[w]})}else return await(m==null?void 0:m.handleLLMError(y.reason)),Promise.reject(y.reason)}));let p={generations:f,missingPromptIndices:l};return Object.defineProperty(p,qs,{value:c?{runIds:c==null?void 0:c.map(y=>y.runId)}:void 0,configurable:!0}),p}async generate(e,t,r){var f,p;let s;Array.isArray(t)?s={stop:t}:s=t;let a=e.map(y=>y.map(Yt)),[i,o]=this._separateRunnableConfigFromCallOptions(s);if(i.callbacks=(f=i.callbacks)!=null?f:r,!this.cache)return this._generateUncached(a,o,i);let{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d}=await this._generateCached({messages:a,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i}),h={};if(d.length>0){let y=await this._generateUncached(d.map(m=>a[m]),o,i);await Promise.all(y.generations.map(async(m,_)=>{let w=d[_];l[w]=m;let $=n._convertInputToPromptValue(a[w]).toString();return u.update($,c,m)})),h=(p=y.llmOutput)!=null?p:{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let s=e.map(a=>a.toChatMessages());return this.generate(s,t,r)}async call(e,t,r){return(await this.generate([e.map(Yt)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let s=e.toChatMessages();return this.call(s,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let s=new _e(e),a=await this.call([s],t,r);if(typeof a.content!="string")throw new Error("Cannot use predict when output is not a string.");return a.content}};function gp(n){var t;let e=n._getType();return vt.isInstance(n)?n.role:(t=n.name)!=null?t:e}function yp(n){switch(n){case"ai":case"model":return"model";case"system":case"human":return"user";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function bp(n,e){return typeof n=="string"?[{text:n}]:n.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){if(!e)throw new Error("This model does not support images");if(typeof t.image_url!="string")throw new Error("Please provide image as base64 encoded data URL");let[r,s]=t.image_url.split(",");if(!r.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");let[a,i]=r.replace(/^data:/,"").split(";");if(i!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:s,mimeType:a}}}throw new Error(`Unknown content type ${t.type}`)})}function go(n,e){return n.reduce((t,r,s)=>{if(!Jt(r))throw new Error("Unsupported message input");let a=gp(r);if(a==="system"&&s!==0)throw new Error("System message should be the first one");let i=yp(a),o=t.content[t.content.length];if(!t.mergeWithPreviousContent&&o&&o.role===i)throw new Error("Google Generative AI requires alternate messages between authors");let u=bp(r.content,e);if(t.mergeWithPreviousContent){let l=t.content[t.content.length-1];if(!l)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return l.parts.push(...u),{mergeWithPreviousContent:!1,content:t.content}}let c={role:i,parts:u};return{mergeWithPreviousContent:a==="system",content:[...t.content,c]}},{content:[],mergeWithPreviousContent:!1}).content}function cl(n){var i,o;if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};let[e]=n.candidates,{content:t,...r}=e,s=(o=(i=t==null?void 0:t.parts[0])==null?void 0:i.text)!=null?o:"";return{generations:[{text:s,message:new Oe({content:s,name:t?t.role:void 0,additional_kwargs:r}),generationInfo:r}]}}function ll(n){var a,i;if(!n.candidates||n.candidates.length===0)return null;let[e]=n.candidates,{content:t,...r}=e,s=(i=(a=t==null?void 0:t.parts[0])==null?void 0:a.text)!=null?i:"";return new rt({text:s,message:new tt({content:s,name:t?t.role:void 0,additional_kwargs:{}}),generationInfo:r})}var Ma=class extends gn{static lc_name(){return"googlegenerativeai"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get _isMultimodalModel(){return this.modelName.includes("vision")}constructor(e){var t,r,s,a,i,o,u,c,l,d;if(super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=(r=(t=e==null?void 0:e.modelName)==null?void 0:t.replace(/^models\//,""))!=null?r:this.modelName,this.maxOutputTokens=(s=e==null?void 0:e.maxOutputTokens)!=null?s:this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=(a=e==null?void 0:e.temperature)!=null?a:this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=(i=e==null?void 0:e.topP)!=null?i:this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=(o=e==null?void 0:e.topK)!=null?o:this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=(u=e==null?void 0:e.stopSequences)!=null?u:this.stopSequences,this.apiKey=(c=e==null?void 0:e.apiKey)!=null?c:U("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=(l=e==null?void 0:e.safetySettings)!=null?l:this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(f=>f.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=(d=e==null?void 0:e.streaming)!=null?d:this.streaming,this.client=new Hn(this.apiKey).getGenerativeModel({model:this.modelName,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK}})}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}async _generate(e,t,r){var o,u,c;let s=go(e,this._isMultimodalModel);if(this.streaming){let l={},d=this._streamResponseChunks(e,t,r),h={};for await(let p of d){let y=(u=(o=p.generationInfo)==null?void 0:o.completion)!=null?u:0;h[y]===void 0?h[y]=p:h[y]=h[y].concat(p)}return{generations:Object.entries(h).sort(([p],[y])=>parseInt(p,10)-parseInt(y,10)).map(([p,y])=>y),llmOutput:{estimatedTokenUsage:l}}}let a=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var d;let l;try{l=await this.client.generateContent({contents:s})}catch(h){throw(d=h.message)!=null&&d.includes("400 Bad Request")&&(h.status=400),h}return l}),i=cl(a.response);return await(r==null?void 0:r.handleLLMNewToken((c=i.generations[0].text)!=null?c:"")),i}async*_streamResponseChunks(e,t,r){var i;let s=go(e,this._isMultimodalModel),a=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{let{stream:o}=await this.client.generateContentStream({contents:s});return o});for await(let o of a){let u=ll(o);u&&(yield u,await(r==null?void 0:r.handleLLMNewToken((i=u.text)!=null?i:"")))}}};var Ar="4.29.2";var hl=!1,xr,yo,wp,vp,Ap,bo,xp,Da,_o,wo,vo,Fa,Ao;function fl(n,e={auto:!1}){if(hl)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(xr)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${xr}'\``);hl=e.auto,xr=n.kind,yo=n.fetch,wp=n.Request,vp=n.Response,Ap=n.Headers,bo=n.FormData,xp=n.Blob,Da=n.File,_o=n.ReadableStream,wo=n.getMultipartRequestOptions,vo=n.getDefaultAgent,Fa=n.fileFromPath,Ao=n.isFsReadStream}var za=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function pl({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,r,s,a;try{t=fetch,r=Request,s=Response,a=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:a,FormData:typeof FormData!="undefined"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob!="undefined"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File!="undefined"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream!="undefined"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new za(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}xr||fl(pl(),{auto:!0});var xo={};_i(xo,{APIConnectionError:()=>ft,APIConnectionTimeoutError:()=>pt,APIError:()=>J,APIUserAbortError:()=>W,AuthenticationError:()=>bn,BadRequestError:()=>yn,ConflictError:()=>vn,InternalServerError:()=>En,NotFoundError:()=>wn,OpenAIError:()=>T,PermissionDeniedError:()=>_n,RateLimitError:()=>xn,UnprocessableEntityError:()=>An});var T=class extends Error{},J=class n extends T{constructor(e,t,r,s){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=s;let a=t;this.error=a,this.code=a==null?void 0:a.code,this.param=a==null?void 0:a.param,this.type=a==null?void 0:a.type}static makeMessage(e,t,r){let s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e)return new ft({cause:Ua(t)});let a=t==null?void 0:t.error;return e===400?new yn(e,a,r,s):e===401?new bn(e,a,r,s):e===403?new _n(e,a,r,s):e===404?new wn(e,a,r,s):e===409?new vn(e,a,r,s):e===422?new An(e,a,r,s):e===429?new xn(e,a,r,s):e>=500?new En(e,a,r,s):new n(e,a,r,s)}},W=class extends J{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},ft=class extends J{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},pt=class extends ft{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},yn=class extends J{constructor(){super(...arguments),this.status=400}},bn=class extends J{constructor(){super(...arguments),this.status=401}},_n=class extends J{constructor(){super(...arguments),this.status=403}},wn=class extends J{constructor(){super(...arguments),this.status=404}},vn=class extends J{constructor(){super(...arguments),this.status=409}},An=class extends J{constructor(){super(...arguments),this.status=422}},xn=class extends J{constructor(){super(...arguments),this.status=429}},En=class extends J{};var mt=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1,s=new Eo;async function*a(){if(!e.body)throw t.abort(),new T("Attempted to iterate over a response with no body");let o=new On,u=ml(e.body);for await(let c of u)for(let l of o.decode(c)){let d=s.decode(l);d&&(yield d)}for(let c of o.flush()){let l=s.decode(c);l&&(yield l)}}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(let u of a())if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null){let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(c&&c.error)throw new J(void 0,c.error,void 0,void 0);yield c}else{let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(u.event=="error")throw new J(void 0,c.error,c.message,void 0);yield{event:u.event,data:c}}}o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||t.abort()}}return new n(i,t)}static fromReadableStream(e,t){let r=!1;async function*s(){let i=new On,o=ml(e);for await(let u of o)for(let c of i.decode(u))yield c;for(let u of i.flush())yield u}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of s())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(a,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),s=a=>({next:()=>{if(a.length===0){let i=r.next();e.push(i),t.push(i)}return a.shift()}});return[new n(()=>s(e),this.controller),new n(()=>s(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new _o({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{let{value:a,done:i}=await t.next();if(i)return s.close();let o=r.encode(JSON.stringify(a)+`
`);s.enqueue(o)}catch(a){s.error(a)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}},Eo=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let a={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],a}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=Op(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}},On=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),s=t.split(n.NEWLINE_REGEXP);return r&&s.pop(),s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){var t;if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer!="undefined"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new T(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder!="undefined"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return(t=this.textDecoder)!=null||(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new T(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new T("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};On.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]);On.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function Op(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function ml(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var gl=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Pp=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&yl(n),yl=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Ip=n=>Pp(n)||gl(n)||Ao(n);async function Io(n,e,t={}){var s,a,i;if(n=await n,gl(n)){let o=await n.blob();return e||(e=(s=new URL(n.url).pathname.split(/[\\/]/).pop())!=null?s:"unknown_file"),new Da([o],e,t)}let r=await Tp(n);if(e||(e=(a=Sp(n))!=null?a:"unknown_file"),!t.type){let o=(i=r[0])==null?void 0:i.type;typeof o=="string"&&(t={...t,type:o})}return new Da(r,e,t)}async function Tp(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(yl(n))e.push(await n.arrayBuffer());else if(kp(n))for await(let r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${Cp(n)}`);return e}function Cp(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Sp(n){var e;return Oo(n.name)||Oo(n.filename)||((e=Oo(n.path))==null?void 0:e.split(/[\\/]/).pop())}var Oo=n=>{if(typeof n=="string")return n;if(typeof Buffer!="undefined"&&n instanceof Buffer)return String(n)},kp=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",To=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var Ye=async n=>{let e=await bl(n.body);return wo(e,n)},bl=async n=>{let e=new bo;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Po(e,t,r))),e};var Po=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Ip(t)){let r=await Io(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Po(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>Po(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Rp=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},jp=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ba;async function Al(n){let{response:e}=n;if(n.options.stream)return Pn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):mt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){let a=await e.json();return Pn("response",e.status,e.url,e.headers,a),a}let s=await e.text();return Pn("response",e.status,e.url,e.headers,s),s}var Ha=class n extends Promise{constructor(e,t=Al){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},qa=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:s,fetch:a}){this.baseURL=e,this.maxRetries=Co("maxRetries",t),this.timeout=Co("timeout",r),this.httpAgent=s,this.fetch=a!=null?a:yo}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Fp(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Kp()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer!="undefined")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder!="undefined")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){var p,y,m,_,w,$;let{method:t,path:r,query:s,headers:a={}}=e,i=To(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(r,s);"timeout"in e&&Co("timeout",e.timeout);let c=(p=e.timeout)!=null?p:this.timeout,l=(m=(y=e.httpAgent)!=null?y:this.httpAgent)!=null?m:vo(u),d=c+1e3;typeof((_=l==null?void 0:l.options)==null?void 0:_.timeout)=="number"&&d>((w=l.options.timeout)!=null?w:0)&&(l.options.timeout=d),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),a[this.idempotencyHeader]=e.idempotencyKey);let h=this.buildHeaders({options:e,headers:a,contentLength:o});return{req:{method:t,...i&&{body:i},headers:h,...l&&{agent:l},signal:($=e.signal)!=null?$:null},url:u,timeout:c}}buildHeaders({options:e,headers:t,contentLength:r}){let s={};r&&(s["content-length"]=r);let a=this.defaultHeaders(e);return vl(s,a),vl(s,t),To(e.body)&&xr!=="node"&&delete s["content-type"],this.validateHeaders(s,t),s}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return J.generate(e,t,r,s)}request(e,t=null){return new Ha(this.makeRequest(e,t))}async makeRequest(e,t){var l,d,h;let r=await e;t==null&&(t=(l=r.maxRetries)!=null?l:this.maxRetries),await this.prepareOptions(r);let{req:s,url:a,timeout:i}=this.buildRequest(r);if(await this.prepareRequest(s,{url:a,options:r}),Pn("request",a,r,s.headers),(d=r.signal)!=null&&d.aborted)throw new W;let o=new AbortController,u=await this.fetchWithTimeout(a,s,i,o).catch(Ua);if(u instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new W;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new pt:new ft({cause:u})}let c=$p(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let w=`retrying, ${t} attempts remaining`;return Pn(`response (error; ${w})`,u.status,a,c),this.retryRequest(r,t,c)}let f=await u.text().catch(w=>Ua(w).message),p=zp(f),y=p?void 0:f;throw Pn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,a,c,y),this.makeStatusError(u.status,p,y,c)}return{response:u,options:r,controller:o}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new So(this,r,e)}buildURL(e,t){let r=Bp(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return xl(s)||(t={...s,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r!="undefined").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new T(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){let{signal:a,...i}=t||{};a&&a.addEventListener("abort",()=>s.abort());let o=setTimeout(()=>s.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){var o;let s,a=r==null?void 0:r["retry-after-ms"];if(a){let u=parseFloat(a);Number.isNaN(u)||(s=u)}let i=r==null?void 0:r["retry-after"];if(i&&!s){let u=parseFloat(i);Number.isNaN(u)?s=Date.parse(i)-Date.now():s=u*1e3}if(!(s&&0<=s&&s<60*1e3)){let u=(o=e.maxRetries)!=null?o:this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,u)}return await ko(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let a=t-e,i=Math.min(.5*Math.pow(2,a),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Ar}`}},fs=class{constructor(e,t,r,s){Ba.set(this,void 0),Rp(this,Ba,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new T("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[s,a]of r)e.url.searchParams.set(s,a);t.query=void 0,t.path=e.url.toString()}return await jp(this,Ba,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Ba=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},So=class extends Ha{constructor(e,t,r){super(t,async s=>new r(e,s.response,await Al(s),s.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},$p=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),Lp={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},Y=n=>typeof n=="object"&&n!==null&&!xl(n)&&Object.keys(n).every(e=>El(Lp,e)),Mp=()=>{if(typeof Deno!="undefined"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ar,"X-Stainless-OS":wl(Deno.build.os),"X-Stainless-Arch":_l(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ar,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ar,"X-Stainless-OS":wl(process.platform),"X-Stainless-Arch":_l(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=Dp();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ar,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Ar,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function Dp(){if(typeof navigator=="undefined"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let s=r[1]||0,a=r[2]||0,i=r[3]||0;return{browser:e,version:`${s}.${a}.${i}`}}}return null}var _l=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",wl=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Ka,Fp=()=>Ka!=null?Ka:Ka=Mp(),zp=n=>{try{return JSON.parse(n)}catch(e){return}},Up=new RegExp("^(?:[a-z]+:)?//","i"),Bp=n=>Up.test(n),ko=n=>new Promise(e=>setTimeout(e,n)),Co=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new T(`${n} must be an integer`);if(e<0)throw new T(`${n} must be a positive integer`);return e},Ua=n=>n instanceof Error?n:new Error(n);var Va=n=>{var e,t,r,s,a,i;if(typeof process!="undefined")return(r=(t=(e=process.env)==null?void 0:e[n])==null?void 0:t.trim())!=null?r:void 0;if(typeof Deno!="undefined")return(i=(a=(s=Deno.env)==null?void 0:s.get)==null?void 0:a.call(s,n))==null?void 0:i.trim()};function xl(n){if(!n)return!0;for(let e in n)return!1;return!0}function El(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function vl(n,e){for(let t in e){if(!El(e,t))continue;let r=t.toLowerCase();if(!r)continue;let s=e[t];s===null?delete n[r]:s!==void 0&&(n[r]=s)}}function Pn(n,...e){typeof process!="undefined"&&process.env.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}var Kp=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Ol=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined";function No(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var Nt=class extends fs{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){return null}nextPageInfo(){return null}},X=class extends fs{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[]}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;let e=this.getPaginatedItems();if(!e.length)return null;let t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}};var O=class{constructor(e){this._client=e}};var Er=class extends O{create(e,t){var r;return this._client.post("/chat/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};Er||(Er={});var Rt=class extends O{constructor(){super(...arguments),this.completions=new Er(this._client)}};(function(n){n.Completions=Er})(Rt||(Rt={}));var Or=class extends O{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};Or||(Or={});var Pr=class extends O{create(e,t){return this._client.post("/audio/transcriptions",Ye({body:e,...t}))}};Pr||(Pr={});var Ir=class extends O{create(e,t){return this._client.post("/audio/translations",Ye({body:e,...t}))}};Ir||(Ir={});var jt=class extends O{constructor(){super(...arguments),this.transcriptions=new Pr(this._client),this.translations=new Ir(this._client),this.speech=new Or(this._client)}};(function(n){n.Transcriptions=Pr,n.Translations=Ir,n.Speech=Or})(jt||(jt={}));var Tr=class extends O{create(e,t,r){return this._client.post(`/assistants/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/assistants/${e}/files`,Cr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}},Cr=class extends X{};(function(n){n.AssistantFilesPage=Cr})(Tr||(Tr={}));var Sr=class extends O{constructor(){super(...arguments),this.files=new Tr(this._client)}create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/assistants",kr,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}},kr=class extends X{};(function(n){n.AssistantsPage=kr,n.Files=Tr,n.AssistantFilesPage=Cr})(Sr||(Sr={}));function Ro(n){return typeof n.parse=="function"}var $t=n=>(n==null?void 0:n.role)==="assistant",jo=n=>(n==null?void 0:n.role)==="function",$o=n=>(n==null?void 0:n.role)==="tool";var De=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},j=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ue,Ga,Za,ps,ms,Wa,gs,gt,ys,Ja,Ya,In,Lo,Xa,Mo,Do,Fo,zo,Sl,Uo,Cl=10,Tn=class{constructor(){ue.add(this),this.controller=new AbortController,Ga.set(this,void 0),Za.set(this,()=>{}),ps.set(this,()=>{}),ms.set(this,void 0),Wa.set(this,()=>{}),gs.set(this,()=>{}),gt.set(this,{}),this._chatCompletions=[],this.messages=[],ys.set(this,!1),Ja.set(this,!1),Ya.set(this,!1),In.set(this,!1),zo.set(this,e=>{if(De(this,Ja,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new W),e instanceof W)return De(this,Ya,!0,"f"),this._emit("abort",e);if(e instanceof T)return this._emit("error",e);if(e instanceof Error){let t=new T(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new T(String(e)))}),De(this,Ga,new Promise((e,t)=>{De(this,Za,e,"f"),De(this,ps,t,"f")}),"f"),De(this,ms,new Promise((e,t)=>{De(this,Wa,e,"f"),De(this,gs,t,"f")}),"f"),j(this,Ga,"f").catch(()=>{}),j(this,ms,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},j(this,zo,"f"))},0)}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(jo(e)||$o(e))&&e.content)this._emit("functionCallResult",e.content);else if($t(e)&&e.function_call)this._emit("functionCall",e.function_call);else if($t(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||(j(this,Za,"f").call(this),this._emit("connect"))}get ended(){return j(this,ys,"f")}get errored(){return j(this,Ja,"f")}get aborted(){return j(this,Ya,"f")}abort(){this.controller.abort()}on(e,t){return(j(this,gt,"f")[e]||(j(this,gt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=j(this,gt,"f")[e];if(!r)return this;let s=r.findIndex(a=>a.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(j(this,gt,"f")[e]||(j(this,gt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{De(this,In,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){De(this,In,!0,"f"),await j(this,ms,"f")}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new T("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),j(this,ue,"m",Lo).call(this)}async finalMessage(){return await this.done(),j(this,ue,"m",Xa).call(this)}async finalFunctionCall(){return await this.done(),j(this,ue,"m",Mo).call(this)}async finalFunctionCallResult(){return await this.done(),j(this,ue,"m",Do).call(this)}async totalUsage(){return await this.done(),j(this,ue,"m",Fo).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(j(this,ys,"f"))return;e==="end"&&(De(this,ys,!0,"f"),j(this,Wa,"f").call(this));let r=j(this,gt,"f")[e];if(r&&(j(this,gt,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!j(this,In,"f")&&!(r!=null&&r.length)&&Promise.reject(s),j(this,ps,"f").call(this,s),j(this,gs,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!j(this,In,"f")&&!(r!=null&&r.length)&&Promise.reject(s),j(this,ps,"f").call(this,s),j(this,gs,"f").call(this,s),this._emit("end")}}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=j(this,ue,"m",Xa).call(this);t&&this._emit("finalMessage",t);let r=j(this,ue,"m",Lo).call(this);r&&this._emit("finalContent",r);let s=j(this,ue,"m",Mo).call(this);s&&this._emit("finalFunctionCall",s);let a=j(this,ue,"m",Do).call(this);a!=null&&this._emit("finalFunctionCallResult",a),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",j(this,ue,"m",Fo).call(this))}async _createChatCompletion(e,t,r){let s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),j(this,ue,"m",Sl).call(this,t);let a=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(a)}async _runChatCompletion(e,t,r){for(let s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;let s="function",{function_call:a="auto",stream:i,...o}=t,u=typeof a!="string"&&(a==null?void 0:a.name),{maxChatCompletions:c=Cl}=r||{},l={};for(let f of t.functions)l[f.name||f.function.name]=f;let d=t.functions.map(f=>({name:f.name||f.function.name,parameters:f.parameters,description:f.description}));for(let f of t.messages)this._addMessage(f,!1);for(let f=0;f<c;++f){let y=(h=(await this._createChatCompletion(e,{...o,function_call:a,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!y)throw new T("missing message in ChatCompletion response");if(!y.function_call)return;let{name:m,arguments:_}=y.function_call,w=l[m];if(w){if(u&&u!==m){let C=`Invalid function_call: ${JSON.stringify(m)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,name:m,content:C});continue}}else{let C=`Invalid function_call: ${JSON.stringify(m)}. Available options are: ${d.map(K=>JSON.stringify(K.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:m,content:C});continue}let $;try{$=Ro(w)?await w.parse(_):_}catch(C){this._addMessage({role:s,name:m,content:C instanceof Error?C.message:String(C)});continue}let D=await w.function($,this),L=j(this,ue,"m",Uo).call(this,D);if(this._addMessage({role:s,name:m,content:L}),u)return}}async _runTools(e,t,r){var h,f;let s="tool",{tool_choice:a="auto",stream:i,...o}=t,u=typeof a!="string"&&((h=a==null?void 0:a.function)==null?void 0:h.name),{maxChatCompletions:c=Cl}=r||{},l={};for(let p of t.tools)p.type==="function"&&(l[p.function.name||p.function.function.name]=p.function);let d="tools"in t?t.tools.map(p=>p.type==="function"?{type:"function",function:{name:p.function.name||p.function.function.name,parameters:p.function.parameters,description:p.function.description}}:p):void 0;for(let p of t.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){let m=(f=(await this._createChatCompletion(e,{...o,tool_choice:a,tools:d,messages:[...this.messages]},r)).choices[0])==null?void 0:f.message;if(!m)throw new T("missing message in ChatCompletion response");if(!m.tool_calls)return;for(let _ of m.tool_calls){if(_.type!=="function")continue;let w=_.id,{name:$,arguments:D}=_.function,L=l[$];if(L){if(u&&u!==$){let z=`Invalid tool_call: ${JSON.stringify($)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:s,tool_call_id:w,content:z});continue}}else{let z=`Invalid tool_call: ${JSON.stringify($)}. Available options are: ${d.map(et=>JSON.stringify(et.function.name)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:w,content:z});continue}let C;try{C=Ro(L)?await L.parse(D):D}catch(z){let et=z instanceof Error?z.message:String(z);this._addMessage({role:s,tool_call_id:w,content:et});continue}let K=await L.function(C,this),S=j(this,ue,"m",Uo).call(this,K);if(this._addMessage({role:s,tool_call_id:w,content:S}),u)return}}}};Ga=new WeakMap,Za=new WeakMap,ps=new WeakMap,ms=new WeakMap,Wa=new WeakMap,gs=new WeakMap,gt=new WeakMap,ys=new WeakMap,Ja=new WeakMap,Ya=new WeakMap,In=new WeakMap,zo=new WeakMap,ue=new WeakSet,Lo=function(){var e;return(e=j(this,ue,"m",Xa).call(this).content)!=null?e:null},Xa=function(){var t;let e=this.messages.length;for(;e-- >0;){let r=this.messages[e];if($t(r))return{...r,content:(t=r.content)!=null?t:null}}throw new T("stream ended without producing a ChatCompletionMessage with role=assistant")},Mo=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){let s=this.messages[r];if($t(s)&&(s!=null&&s.function_call))return s.function_call;if($t(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(t=s.tool_calls.at(-1))==null?void 0:t.function}},Do=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(jo(t)&&t.content!=null||$o(t)&&t.content!=null&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(a=>a.type==="function"&&a.id===t.tool_call_id))}))return t.content}},Fo=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Sl=function(e){if(e.n!=null&&e.n>1)throw new T("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},Uo=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var bs=class n extends Tn{static runFunctions(e,t,r){let s=new n,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,a)),s}static runTools(e,t,r){let s=new n,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,a)),s}_addMessage(e){super._addMessage(e),$t(e)&&e.content&&this._emit("content",e.content)}};var Fe=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Bo=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},Xe,Lt,Ko,Ho,Qa,kl,Cn=class n extends Tn{constructor(){super(...arguments),Xe.add(this),Lt.set(this,void 0)}get currentChatCompletionSnapshot(){return Fe(this,Lt,"f")}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let s=new n;return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){var i;let s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Fe(this,Xe,"m",Ko).call(this);let a=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let o of a)Fe(this,Xe,"m",Ho).call(this,o);if((i=a.controller.signal)!=null&&i.aborted)throw new W;return this._addChatCompletion(Fe(this,Xe,"m",Qa).call(this))}async _fromReadableStream(e,t){var i;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Fe(this,Xe,"m",Ko).call(this),this._connected();let s=mt.fromReadableStream(e,this.controller),a;for await(let o of s)a&&a!==o.id&&this._addChatCompletion(Fe(this,Xe,"m",Qa).call(this)),Fe(this,Xe,"m",Ho).call(this,o),a=o.id;if((i=s.controller.signal)!=null&&i.aborted)throw new W;return this._addChatCompletion(Fe(this,Xe,"m",Qa).call(this))}[(Lt=new WeakMap,Xe=new WeakSet,Ko=function(){this.ended||Bo(this,Lt,void 0,"f")},Ho=function(t){var i,o,u;if(this.ended)return;let r=Fe(this,Xe,"m",kl).call(this,t);this._emit("chunk",t,r);let s=(o=(i=t.choices[0])==null?void 0:i.delta)==null?void 0:o.content,a=(u=r.choices[0])==null?void 0:u.message;s!=null&&(a==null?void 0:a.role)==="assistant"&&(a!=null&&a.content)&&this._emit("content",s,a.content)},Qa=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");let t=Fe(this,Lt,"f");if(!t)throw new T("request ended without sending any chunks");return Bo(this,Lt,void 0,"f"),Wp(t)},kl=function(t){var c,l,d,h;var r,s,a;let i=Fe(this,Lt,"f"),{choices:o,...u}=t;i?Object.assign(i,u):i=Bo(this,Lt,{...u,choices:[]},"f");for(let{delta:f,finish_reason:p,index:y,logprobs:m=null,..._}of t.choices){let w=i.choices[y];if(w||(w=i.choices[y]={finish_reason:p,index:y,message:{},logprobs:m,..._}),m)if(!w.logprobs)w.logprobs=Object.assign({},m);else{let{content:S,...z}=m;Object.assign(w.logprobs,z),S&&((c=(r=w.logprobs).content)!=null||(r.content=[]),w.logprobs.content.push(...S))}if(p&&(w.finish_reason=p),Object.assign(w,_),!f)continue;let{content:$,function_call:D,role:L,tool_calls:C,...K}=f;if(Object.assign(w.message,K),$&&(w.message.content=(w.message.content||"")+$),L&&(w.message.role=L),D&&(w.message.function_call?(D.name&&(w.message.function_call.name=D.name),D.arguments&&((l=(s=w.message.function_call).arguments)!=null||(s.arguments=""),w.message.function_call.arguments+=D.arguments)):w.message.function_call=D),C){w.message.tool_calls||(w.message.tool_calls=[]);for(let{index:S,id:z,type:et,function:Ee,...Rs}of C){let Ke=(d=(a=w.message.tool_calls)[S])!=null?d:a[S]={};Object.assign(Ke,Rs),z&&(Ke.id=z),et&&(Ke.type=et),Ee&&((h=Ke.function)!=null||(Ke.function={arguments:""})),Ee!=null&&Ee.name&&(Ke.function.name=Ee.name),Ee!=null&&Ee.arguments&&(Ke.function.arguments+=Ee.arguments)}}}return i},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",s=>{let a=t.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let a of t)a.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let a of t)a.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new mt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function Wp(n){let{id:e,choices:t,created:r,model:s,system_fingerprint:a,...i}=n;return{...i,id:e,choices:t.map(({message:o,finish_reason:u,index:c,logprobs:l,...d})=>{if(!u)throw new T(`missing finish_reason for choice ${c}`);let{content:h=null,function_call:f,tool_calls:p,...y}=o,m=o.role;if(!m)throw new T(`missing role for choice ${c}`);if(f){let{arguments:_,name:w}=f;if(_==null)throw new T(`missing function_call.arguments for choice ${c}`);if(!w)throw new T(`missing function_call.name for choice ${c}`);return{...d,message:{content:h,function_call:{arguments:_,name:w},role:m},finish_reason:u,index:c,logprobs:l}}return p?{...d,index:c,finish_reason:u,logprobs:l,message:{...y,role:m,content:h,tool_calls:p.map((_,w)=>{let{function:$,type:D,id:L,...C}=_,{arguments:K,name:S,...z}=$||{};if(L==null)throw new T(`missing choices[${c}].tool_calls[${w}].id
${ei(n)}`);if(D==null)throw new T(`missing choices[${c}].tool_calls[${w}].type
${ei(n)}`);if(S==null)throw new T(`missing choices[${c}].tool_calls[${w}].function.name
${ei(n)}`);if(K==null)throw new T(`missing choices[${c}].tool_calls[${w}].function.arguments
${ei(n)}`);return{...C,id:L,type:D,function:{...z,name:S,arguments:K}}})}}:{...d,message:{...y,content:h,role:m},finish_reason:u,index:c,logprobs:l}}),created:r,model:s,object:"chat.completion",...a?{system_fingerprint:a}:{}}}function ei(n){return JSON.stringify(n)}var _s=class n extends Cn{static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let s=new n,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,a)),s}static runTools(e,t,r){let s=new n,a={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,a)),s}};var ws=class extends O{runFunctions(e,t){return e.stream?_s.runFunctions(this._client.chat.completions,e,t):bs.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?_s.runTools(this._client.chat.completions,e,t):bs.runTools(this._client.chat.completions,e,t)}stream(e,t){return Cn.createChatCompletion(this._client.chat.completions,e,t)}};var Nr=class extends O{constructor(){super(...arguments),this.completions=new ws(this._client)}};(function(n){n.Completions=ws})(Nr||(Nr={}));var ze=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},V=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ti,ri,vs,As,ni,xs,yt,Es,si,ai,Sn,qo,ii=class{constructor(){this.controller=new AbortController,ti.set(this,void 0),ri.set(this,()=>{}),vs.set(this,()=>{}),As.set(this,void 0),ni.set(this,()=>{}),xs.set(this,()=>{}),yt.set(this,{}),Es.set(this,!1),si.set(this,!1),ai.set(this,!1),Sn.set(this,!1),qo.set(this,e=>{if(ze(this,si,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new W),e instanceof W)return ze(this,ai,!0,"f"),this._emit("abort",e);if(e instanceof T)return this._emit("error",e);if(e instanceof Error){let t=new T(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new T(String(e)))}),ze(this,ti,new Promise((e,t)=>{ze(this,ri,e,"f"),ze(this,vs,t,"f")}),"f"),ze(this,As,new Promise((e,t)=>{ze(this,ni,e,"f"),ze(this,xs,t,"f")}),"f"),V(this,ti,"f").catch(()=>{}),V(this,As,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emit("end")},V(this,qo,"f"))},0)}_addRun(e){return e}_connected(){this.ended||(V(this,ri,"f").call(this),this._emit("connect"))}get ended(){return V(this,Es,"f")}get errored(){return V(this,si,"f")}get aborted(){return V(this,ai,"f")}abort(){this.controller.abort()}on(e,t){return(V(this,yt,"f")[e]||(V(this,yt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=V(this,yt,"f")[e];if(!r)return this;let s=r.findIndex(a=>a.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(V(this,yt,"f")[e]||(V(this,yt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{ze(this,Sn,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){ze(this,Sn,!0,"f"),await V(this,As,"f")}_emit(e,...t){if(V(this,Es,"f"))return;e==="end"&&(ze(this,Es,!0,"f"),V(this,ni,"f").call(this));let r=V(this,yt,"f")[e];if(r&&(V(this,yt,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){let s=t[0];!V(this,Sn,"f")&&!(r!=null&&r.length)&&Promise.reject(s),V(this,vs,"f").call(this,s),V(this,xs,"f").call(this,s),this._emit("end");return}if(e==="error"){let s=t[0];!V(this,Sn,"f")&&!(r!=null&&r.length)&&Promise.reject(s),V(this,vs,"f").call(this,s),V(this,xs,"f").call(this,s),this._emit("end")}}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,s){return await this._createAssistantStream(t,e,r,s)}async _runToolAssistantStream(e,t,r,s,a){return await this._createToolAssistantStream(r,e,t,s,a)}async _createThreadAssistantStream(e,t,r){let s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let a=await e.createAndRun({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addRun(a)}async _createToolAssistantStream(e,t,r,s,a){let i=a==null?void 0:a.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o=await e.submitToolOutputs(t,r,{...s,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addRun(o)}async _createAssistantStream(e,t,r,s){let a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let i=await e.create(t,{...r,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addRun(i)}};ti=new WeakMap,ri=new WeakMap,vs=new WeakMap,As=new WeakMap,ni=new WeakMap,xs=new WeakMap,yt=new WeakMap,Es=new WeakMap,si=new WeakMap,ai=new WeakMap,Sn=new WeakMap,qo=new WeakMap;var x=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Ae=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},fe,Vo,Qe,oi,Ue,jr,kn,Rr,hi,xe,ui,ci,Os,li,di,Nl,Rl,jl,$l,Ll,Ml,Dl,bt=class n extends ii{constructor(){super(...arguments),fe.add(this),Vo.set(this,[]),Qe.set(this,{}),oi.set(this,{}),Ue.set(this,void 0),jr.set(this,void 0),kn.set(this,void 0),Rr.set(this,void 0),hi.set(this,void 0),xe.set(this,void 0),ui.set(this,void 0),ci.set(this,void 0),Os.set(this,void 0)}[(Vo=new WeakMap,Qe=new WeakMap,oi=new WeakMap,Ue=new WeakMap,jr=new WeakMap,kn=new WeakMap,Rr=new WeakMap,hi=new WeakMap,xe=new WeakMap,ui=new WeakMap,ci=new WeakMap,Os=new WeakMap,fe=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",s=>{let a=t.shift();a?a.resolve(s):e.push(s)}),this.on("end",()=>{r=!0;for(let s of t)s.resolve(void 0);t.length=0}),this.on("abort",s=>{r=!0;for(let a of t)a.reject(s);t.length=0}),this.on("error",s=>{r=!0;for(let a of t)a.reject(s);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((a,i)=>t.push({resolve:a,reject:i})).then(a=>a?{value:a,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new mt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,s,a){let i=new n;return i._run(()=>i._runToolAssistantStream(e,t,r,s,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,s,a){var c;let i=a==null?void 0:a.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...s,stream:!0},u=await e.submitToolOutputs(t,r,o,{...a,signal:this.controller.signal});this._connected();for await(let l of u)x(this,fe,"m",li).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new W;return this._addRun(x(this,fe,"m",di).call(this))}static createThreadAssistantStream(e,t,r){let s=new n;return s._run(()=>s._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}static createAssistantStream(e,t,r,s){let a=new n;return a._run(()=>a._runAssistantStream(e,t,r,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),a}currentEvent(){return x(this,ui,"f")}currentRun(){return x(this,ci,"f")}currentMessageSnapshot(){return x(this,Ue,"f")}currentRunStepSnapshot(){return x(this,Os,"f")}async finalRunSteps(){return await this.done(),Object.values(x(this,Qe,"f"))}async finalMessages(){return await this.done(),Object.values(x(this,oi,"f"))}async finalRun(){if(await this.done(),!x(this,jr,"f"))throw Error("Final run was not received.");return x(this,jr,"f")}async _createThreadAssistantStream(e,t,r){var o;let s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let a={...t,stream:!0},i=await e.createAndRun(a,{...r,signal:this.controller.signal});this._connected();for await(let u of i)x(this,fe,"m",li).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new W;return this._addRun(x(this,fe,"m",di).call(this))}async _createAssistantStream(e,t,r,s){var u;let a=s==null?void 0:s.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},o=await e.create(t,i,{...s,signal:this.controller.signal});this._connected();for await(let c of o)x(this,fe,"m",li).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new W;return this._addRun(x(this,fe,"m",di).call(this))}static accumulateDelta(e,t){for(let[r,s]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=s;continue}let a=e[r];if(a==null){e[r]=s;continue}if(r==="index"||r==="type"){e[r]=s;continue}if(typeof a=="string"&&typeof s=="string")a+=s;else if(typeof a=="number"&&typeof s=="number")a+=s;else if(No(a)&&No(s))a=this.accumulateDelta(a,s);else if(Array.isArray(a)&&Array.isArray(s)){if(a.every(i=>typeof i=="string"||typeof i=="number")){a.push(...s);continue}}else throw Error(`Unhandled record type: ${r}, deltaValue: ${s}, accValue: ${a}`);e[r]=a}return e}};li=function(e){if(!this.ended)switch(Ae(this,ui,e,"f"),x(this,fe,"m",jl).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":x(this,fe,"m",Dl).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":x(this,fe,"m",Rl).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":x(this,fe,"m",Nl).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},di=function(){if(this.ended)throw new T("stream has ended, this shouldn't happen");if(!x(this,jr,"f"))throw Error("Final run has been been received");return x(this,jr,"f")},Nl=function(e){let[t,r]=x(this,fe,"m",Ll).call(this,e,x(this,Ue,"f"));Ae(this,Ue,t,"f"),x(this,oi,"f")[t.id]=t;for(let s of r){let a=t.content[s.index];(a==null?void 0:a.type)=="text"&&this._emit("textCreated",a.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let s of e.data.delta.content){if(s.type=="text"&&s.text){let a=s.text,i=t.content[s.index];if(i&&i.type=="text")this._emit("textDelta",a,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(s.index!=x(this,kn,"f")){if(x(this,Rr,"f"))switch(x(this,Rr,"f").type){case"text":this._emit("textDone",x(this,Rr,"f").text,x(this,Ue,"f"));break;case"image_file":this._emit("imageFileDone",x(this,Rr,"f").image_file,x(this,Ue,"f"));break}Ae(this,kn,s.index,"f")}Ae(this,Rr,t.content[s.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(x(this,kn,"f")!==void 0){let s=e.data.content[x(this,kn,"f")];if(s)switch(s.type){case"image_file":this._emit("imageFileDone",s.image_file,x(this,Ue,"f"));break;case"text":this._emit("textDone",s.text,x(this,Ue,"f"));break}}x(this,Ue,"f")&&this._emit("messageDone",e.data),Ae(this,Ue,void 0,"f")}},Rl=function(e){let t=x(this,fe,"m",$l).call(this,e);switch(Ae(this,Os,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let a of r.step_details.tool_calls)a.index==x(this,hi,"f")?this._emit("toolCallDelta",a,t.step_details.tool_calls[a.index]):(x(this,xe,"f")&&this._emit("toolCallDone",x(this,xe,"f")),Ae(this,hi,a.index,"f"),Ae(this,xe,t.step_details.tool_calls[a.index],"f"),x(this,xe,"f")&&this._emit("toolCallCreated",x(this,xe,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Ae(this,Os,void 0,"f"),e.data.step_details.type=="tool_calls"&&x(this,xe,"f")&&(this._emit("toolCallDone",x(this,xe,"f")),Ae(this,xe,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},jl=function(e){x(this,Vo,"f").push(e),this._emit("event",e)},$l=function(e){switch(e.event){case"thread.run.step.created":return x(this,Qe,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=x(this,Qe,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let s=bt.accumulateDelta(t,r.delta);x(this,Qe,"f")[e.data.id]=s}return x(this,Qe,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":x(this,Qe,"f")[e.data.id]=e.data;break}if(x(this,Qe,"f")[e.data.id])return x(this,Qe,"f")[e.data.id];throw new Error("No snapshot available")},Ll=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let s=e.data;if(s.delta.content)for(let a of s.delta.content)if(a.index in t.content){let i=t.content[a.index];t.content[a.index]=x(this,fe,"m",Ml).call(this,a,i)}else t.content[a.index]=a,r.push(a);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},Ml=function(e,t){return bt.accumulateDelta(t,e)},Dl=function(e){switch(Ae(this,ci,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Ae(this,jr,e.data,"f"),x(this,xe,"f")&&(this._emit("toolCallDone",x(this,xe,"f")),Ae(this,xe,void 0,"f"));break;case"thread.run.cancelling":break}};var $r=class extends O{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/messages/${t}/files/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return Y(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/messages/${t}/files`,Lr,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}},Lr=class extends X{};(function(n){n.MessageFilesPage=Lr})($r||($r={}));var Mr=class extends O{constructor(){super(...arguments),this.files=new $r(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Dr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}},Dr=class extends X{};(function(n){n.MessagesPage=Dr,n.Files=$r,n.MessageFilesPage=Lr})(Mr||(Mr={}));var Fr=class extends O{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return Y(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,zr,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}},zr=class extends X{};(function(n){n.RunStepsPage=zr})(Fr||(Fr={}));var Ur=class extends O{constructor(){super(...arguments),this.steps=new Fr(this._client)}create(e,t,r){var s;return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers},stream:(s=t.stream)!=null?s:!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return Y(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Br,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}createAndStream(e,t,r){return bt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,s){var a;return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers},stream:(a=r.stream)!=null?a:!1})}submitToolOutputsStream(e,t,r,s){return bt.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,s)}},Br=class extends X{};(function(n){n.RunsPage=Br,n.Steps=Fr,n.RunStepsPage=zr})(Ur||(Ur={}));var Kr=class extends O{constructor(){super(...arguments),this.runs=new Ur(this._client),this.messages=new Mr(this._client)}create(e={},t){return Y(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}createAndRun(e,t){var r;return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers},stream:(r=e.stream)!=null?r:!1})}createAndRunStream(e,t){return bt.createThreadAssistantStream(e,this._client.beta.threads,t)}};(function(n){n.Runs=Ur,n.RunsPage=Br,n.Messages=Mr,n.MessagesPage=Dr})(Kr||(Kr={}));var Mt=class extends O{constructor(){super(...arguments),this.chat=new Nr(this._client),this.assistants=new Sr(this._client),this.threads=new Kr(this._client)}};(function(n){n.Chat=Nr,n.Assistants=Sr,n.AssistantsPage=kr,n.Threads=Kr})(Mt||(Mt={}));var Dt=class extends O{create(e,t){var r;return this._client.post("/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};Dt||(Dt={});var Ft=class extends O{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};Ft||(Ft={});var zt=class extends O{create(e,t){return this._client.post("/files",Ye({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/files",Ut,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let s=new Set(["processed","error","deleted"]),a=Date.now(),i=await this.retrieve(e);for(;!i.status||!s.has(i.status);)if(await ko(t),i=await this.retrieve(e),Date.now()-a>r)throw new pt({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}},Ut=class extends Nt{};(function(n){n.FileObjectsPage=Ut})(zt||(zt={}));var Hr=class extends O{create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return Y(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",qr,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return Y(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Vr,{query:t,...r})}},qr=class extends X{},Vr=class extends X{};(function(n){n.FineTuningJobsPage=qr,n.FineTuningJobEventsPage=Vr})(Hr||(Hr={}));var Bt=class extends O{constructor(){super(...arguments),this.jobs=new Hr(this._client)}};(function(n){n.Jobs=Hr,n.FineTuningJobsPage=qr,n.FineTuningJobEventsPage=Vr})(Bt||(Bt={}));var Kt=class extends O{createVariation(e,t){return this._client.post("/images/variations",Ye({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Ye({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};Kt||(Kt={});var Ht=class extends O{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",qt,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},qt=class extends Nt{};(function(n){n.ModelsPage=qt})(Ht||(Ht={}));var Vt=class extends O{create(e,t){return this._client.post("/moderations",{body:e,...t})}};Vt||(Vt={});var Hl,G=class extends qa{constructor({baseURL:e=Va("OPENAI_BASE_URL"),apiKey:t=Va("OPENAI_API_KEY"),organization:r=(a=>(a=Va("OPENAI_ORG_ID"))!=null?a:null)(),...s}={}){var o;if(t===void 0)throw new T("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let i={apiKey:t,organization:r,...s,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Ol())throw new T(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:(o=i.timeout)!=null?o:6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Dt(this),this.chat=new Rt(this),this.embeddings=new Ft(this),this.files=new zt(this),this.images=new Kt(this),this.audio=new jt(this),this.moderations=new Vt(this),this.models=new Ht(this),this.fineTuning=new Bt(this),this.beta=new Mt(this),this._options=i,this.apiKey=t,this.organization=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};Hl=G;G.OpenAI=Hl;G.OpenAIError=T;G.APIError=J;G.APIConnectionError=ft;G.APIConnectionTimeoutError=pt;G.APIUserAbortError=W;G.NotFoundError=wn;G.ConflictError=vn;G.RateLimitError=xn;G.BadRequestError=yn;G.AuthenticationError=bn;G.InternalServerError=En;G.PermissionDeniedError=_n;G.UnprocessableEntityError=An;var{OpenAIError:H0,APIError:q0,APIConnectionError:V0,APIConnectionTimeoutError:ql,APIUserAbortError:Vl,NotFoundError:G0,ConflictError:Z0,RateLimitError:W0,BadRequestError:J0,AuthenticationError:Y0,InternalServerError:X0,PermissionDeniedError:Q0,UnprocessableEntityError:eE}=xo;(function(n){n.toFile=Io,n.fileFromPath=Fa,n.Page=Nt,n.CursorPage=X,n.Completions=Dt,n.Chat=Rt,n.Embeddings=Ft,n.Files=zt,n.FileObjectsPage=Ut,n.Images=Kt,n.Audio=jt,n.Moderations=Vt,n.Models=Ht,n.ModelsPage=qt,n.FineTuning=Bt,n.Beta=Mt})(G||(G={}));function Gl(n){return{name:n.name,description:n.description,parameters:Je(n.schema)}}function Go(n){return{type:"function",function:Gl(n)}}var Gr=class extends H{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=B(t);return this.func&&await this.func(e,r),this._callWithConfig(s=>Promise.resolve(s),e,r)}async*transform(e,t){let r=B(t),s,a=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,a)if(s===void 0)s=i;else try{s=Ze(s,i)}catch(o){s=void 0,a=!1}this.func&&s!==void 0&&await this.func(s,r)}static assign(e){return new mn(new kt({steps:e}))}};var Nn=class extends H{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,s)=>this.parseResult([{text:r}],s==null?void 0:s.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,s)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],s==null?void 0:s.callbacks),e,{...t,runType:"parser"})}},Rn=class extends Nn{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},Zr=class extends Error{constructor(e,t,r,s=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=s,s&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};function Ps(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let s=0;s<r;s++)if(!Ps(n[s],e[s]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),s=Object.keys(e);if(r.length!==s.length)return!1;for(let i of r)if(!Ps(n[i],e[i]))return!1;return!0}return n===e}var FE=typeof self!="undefined"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var nm=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,sm=[0,31,28,31,30,31,30,31,31,30,31,30,31],am=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,im=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,om=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,um=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,cm=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,lm=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,dm=/^(?:\/(?:[^~/]|~0|~1)*)*$/,hm=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,fm=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,pm=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,mm=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,gm=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,ym=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,bm=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(s=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(s))},_m=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,wm=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,vm=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function ye(n){return n.test.bind(n)}var Am={date:Zl,time:Wl.bind(void 0,!1),"date-time":Pm,duration:vm,uri:Cm,"uri-reference":ye(om),"uri-template":ye(um),url:ye(cm),email:bm,hostname:ye(im),ipv4:ye(_m),ipv6:ye(wm),regex:km,uuid:ye(lm),"json-pointer":ye(dm),"json-pointer-uri-fragment":ye(hm),"relative-json-pointer":ye(fm)},xm={...Am,date:ye(pm),time:ye(mm),"date-time":ye(gm),"uri-reference":ye(ym)};function Em(n){return n%4===0&&(n%100!==0||n%400===0)}function Zl(n){let e=n.match(nm);if(!e)return!1;let t=+e[1],r=+e[2],s=+e[3];return r>=1&&r<=12&&s>=1&&s<=(r==2&&Em(t)?29:sm[r])}function Wl(n,e){let t=e.match(am);if(!t)return!1;let r=+t[1],s=+t[2],a=+t[3],i=!!t[5];return(r<=23&&s<=59&&a<=59||r==23&&s==59&&a==60)&&(!n||i)}var Om=/t|\s/i;function Pm(n){let e=n.split(Om);return e.length==2&&Zl(e[0])&&Wl(!0,e[1])}var Im=/\/|:/,Tm=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function Cm(n){return Im.test(n)&&Tm.test(n)}var Sm=/[^\\]\\Z/;function km(n){if(Sm.test(n))return!1;try{return new RegExp(n),!0}catch(e){return!1}}var jn=class extends Rn{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Is=class extends jn{constructor(e){var t;super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(t=e==null?void 0:e.diff)!=null?t:this.diff}async*_transform(e){let t,r;for await(let s of e){if(typeof s!="string"&&typeof s.content!="string")throw new Error("Cannot handle non-string output.");let a;if(Au(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new rt({message:s,text:s.content})}else if(Jt(s)){if(typeof s.content!="string")throw new Error("Cannot handle non-string message output.");a=new rt({message:s.toChunk(),text:s.content})}else a=new At({text:s});r===void 0?r=a:r=r.concat(a);let i=await this.parsePartialResult([r]);i!=null&&!Ps(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}};var fi=class extends Rn{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=ot.object(Object.fromEntries(Object.entries(e).map(([r,s])=>[r,ot.string().describe(s)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Je(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new Zr(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};var pi=class extends Is{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Ia(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return Jl(e[0].text)}async parse(e){return Jl(e,JSON.parse)}getFormatInstructions(){return""}};function Jl(n,e=Rm){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Rm(n){if(typeof n=="undefined")return null;try{return JSON.parse(n)}catch(a){}let e="",t=[],r=!1,s=!1;for(let a of n){if(r)a==='"'&&!s?r=!1:a===`
`&&!s?a="\\n":a==="\\"?s=!s:s=!1;else if(a==='"')r=!0,s=!1;else if(a==="{")t.push("}");else if(a==="[")t.push("]");else if(a==="}"||a==="]")if(t&&t[t.length-1]===a)t.pop();else return null;e+=a}r&&(e+='"');for(let a=t.length-1;a>=0;a-=1)e+=t[a];try{return JSON.parse(e)}catch(a){return null}}var Zo=class extends Nn{static lc_name(){return"JsonOutputToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(t=e==null?void 0:e.returnId)!=null?t:this.returnId}async parseResult(e){let t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);let r=JSON.parse(JSON.stringify(t)),s=[];for(let a of r)if(a.function!==void 0){let i={type:a.function.name,args:JSON.parse(a.function.arguments)};this.returnId&&(i.id=a.id),Object.defineProperty(i,"name",{get(){return this.type}}),Object.defineProperty(i,"arguments",{get(){return this.args}}),s.push(i)}return s}},Ts=class extends Nn{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=(t=e.returnSingle)!=null?t:this.returnSingle,this.initialParser=new Zo(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new Zr(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName),s=r;return this.returnId||(s=r.map(i=>i.args)),this.returnSingle?this._validateResult(s[0]):await Promise.all(s.map(i=>this._validateResult(i)))}};function Cs(n){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:a}=n;if(r&&s&&e)return`${s}/${e}`;if(r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return a}function Ss(n){let e;return n.constructor.name===ql.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===Vl.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function jm(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function Yl(n){var t;let e=["namespace functions {",""];for(let r of n)r.description&&e.push(`// ${r.description}`),Object.keys((t=r.parameters.properties)!=null?t:{}).length>0?(e.push(`type ${r.name} = (_: {`),e.push(Xl(r.parameters,0)),e.push("}) => any;")):e.push(`type ${r.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Xl(n,e){var r,s;let t=[];for(let[a,i]of Object.entries((r=n.properties)!=null?r:{}))i.description&&e<2&&t.push(`// ${i.description}`),(s=n.required)!=null&&s.includes(a)?t.push(`${a}: ${mi(i,e)},`):t.push(`${a}?: ${mi(i,e)},`);return t.map(a=>" ".repeat(e)+a).join(`
`)}function mi(n,e){if(jm(n))return n.anyOf.map(t=>mi(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Xl(n,e+2),"}"].join(`
`);case"array":return n.items?`${mi(n.items,e)}[]`:"any[]";default:return""}}function $m(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function td(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!vt.isInstance(n))throw new Error("Invalid generic chat message");return $m(n)}default:throw new Error(`Unknown message type: ${e}`)}}function Lm(n){var e;switch(n.role){case"assistant":return new Oe(n.content||"",{function_call:n.function_call,tool_calls:n.tool_calls});default:return new vt(n.content||"",(e=n.role)!=null?e:"unknown")}}function Mm(n,e){var a,i;let t=(a=n.role)!=null?a:e,r=(i=n.content)!=null?i:"",s;return n.function_call?s={function_call:n.function_call}:n.tool_calls?s={tool_calls:n.tool_calls}:s={},t==="user"?new Dn({content:r}):t==="assistant"?new tt({content:r,additional_kwargs:s}):t==="system"?new Fn({content:r}):t==="function"?new zn({content:r,additional_kwargs:s,name:n.name}):t==="tool"?new Fs({content:r,additional_kwargs:s,tool_call_id:n.tool_call_id}):new Un({content:r,role:t})}function Ql(n){return n.map(e=>({role:td(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}var ks=class extends gn{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,s,a,i,o,u,c,l,d,h,f,p,y,m,_,w,$,D,L,C,K,S,z,et,Ee,Rs,Ke;if(super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(r=e==null?void 0:e.openAIApiKey)!=null?r:U("OPENAI_API_KEY"),this.azureOpenAIApiKey=(s=e==null?void 0:e.azureOpenAIApiKey)!=null?s:U("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(a=e==null?void 0:e.azureOpenAIApiInstanceName)!=null?a:U("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(i=e==null?void 0:e.azureOpenAIApiDeploymentName)!=null?i:U("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(o=e==null?void 0:e.azureOpenAIApiVersion)!=null?o:U("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(u=e==null?void 0:e.azureOpenAIBasePath)!=null?u:U("AZURE_OPENAI_BASE_PATH"),this.organization=(l=(c=e==null?void 0:e.configuration)==null?void 0:c.organization)!=null?l:U("OPENAI_ORGANIZATION"),this.modelName=(d=e==null?void 0:e.modelName)!=null?d:this.modelName,this.modelKwargs=(h=e==null?void 0:e.modelKwargs)!=null?h:{},this.timeout=e==null?void 0:e.timeout,this.temperature=(f=e==null?void 0:e.temperature)!=null?f:this.temperature,this.topP=(p=e==null?void 0:e.topP)!=null?p:this.topP,this.frequencyPenalty=(y=e==null?void 0:e.frequencyPenalty)!=null?y:this.frequencyPenalty,this.presencePenalty=(m=e==null?void 0:e.presencePenalty)!=null?m:this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(_=e==null?void 0:e.n)!=null?_:this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.user=e==null?void 0:e.user,this.streaming=(w=e==null?void 0:e.streaming)!=null?w:!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=($=this.openAIApiKey)!=null?$:""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:(L=t==null?void 0:t.basePath)!=null?L:(D=e==null?void 0:e.configuration)==null?void 0:D.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:(z=(C=t==null?void 0:t.baseOptions)==null?void 0:C.headers)!=null?z:(S=(K=e==null?void 0:e.configuration)==null?void 0:K.baseOptions)==null?void 0:S.headers,defaultQuery:(Ke=(et=t==null?void 0:t.baseOptions)==null?void 0:et.params)!=null?Ke:(Rs=(Ee=e==null?void 0:e.configuration)==null?void 0:Ee.baseOptions)==null?void 0:Rs.params,...t,...e==null?void 0:e.configuration}}invocationParams(e){var s;function t(a){return a!==void 0&&a.every(i=>Array.isArray(i.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(s=e==null?void 0:e.stop)!=null?s:this.stop,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:t(e==null?void 0:e.tools)?e==null?void 0:e.tools.map(Go):e==null?void 0:e.tools,tool_choice:e==null?void 0:e.tool_choice,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var u,c,l,d,h;let s=Ql(e),a={...this.invocationParams(t),messages:s,stream:!0},i,o=await this.completionWithRetry(a,t);for await(let f of o){let p=f==null?void 0:f.choices[0];if(!p)continue;let{delta:y}=p;if(!y)continue;let m=Mm(y,i);i=(u=y.role)!=null?u:i;let _={prompt:(c=t.promptIndex)!=null?c:0,completion:(l=p.index)!=null?l:0};if(typeof m.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let w={..._};p.finish_reason!==void 0&&(w.finish_reason=p.finish_reason),this.logprobs&&(w.logprobs=p.logprobs);let $=new rt({message:m,text:m.content,generationInfo:w});yield $,r==null||r.handleLLMNewToken((d=$.text)!=null?d:"",_,void 0,void 0,void 0,{chunk:$})}if((h=t.signal)!=null&&h.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,u,c,l,d,h,f,p,y,m;let s={},a=this.invocationParams(t),i=Ql(e);if(a.stream){let _=this._streamResponseChunks(e,t,r),w={};for await(let S of _){S.message.response_metadata={...S.generationInfo,...S.message.response_metadata};let z=(u=(o=S.generationInfo)==null?void 0:o.completion)!=null?u:0;w[z]===void 0?w[z]=S:w[z]=w[z].concat(S)}let $=Object.entries(w).sort(([S],[z])=>parseInt(S,10)-parseInt(z,10)).map(([S,z])=>z),{functions:D,function_call:L}=this.invocationParams(t),C=await this.getEstimatedTokenCountFromPrompt(e,D,L),K=await this.getNumTokensFromGenerations($);return s.promptTokens=C,s.completionTokens=K,s.totalTokens=C+K,{generations:$,llmOutput:{estimatedTokenUsage:s}}}else{let _=await this.completionWithRetry({...a,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:w,prompt_tokens:$,total_tokens:D}=(c=_==null?void 0:_.usage)!=null?c:{};w&&(s.completionTokens=((l=s.completionTokens)!=null?l:0)+w),$&&(s.promptTokens=((d=s.promptTokens)!=null?d:0)+$),D&&(s.totalTokens=((h=s.totalTokens)!=null?h:0)+D);let L=[];for(let C of(f=_==null?void 0:_.choices)!=null?f:[]){let S={text:(y=(p=C.message)==null?void 0:p.content)!=null?y:"",message:Lm((m=C.message)!=null?m:{role:"assistant"})};S.generationInfo={...C.finish_reason?{finish_reason:C.finish_reason}:{},...C.logprobs?{logprobs:C.logprobs}:{}},L.push(S)}return{generations:L,llmOutput:{tokenUsage:s}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let a=Yl(t);s+=await this.getNumTokens(a),s+=9}return t&&e.find(a=>a._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async getNumTokensFromMessages(e){let t=0,r=0,s=0;this.modelName==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);let a=await Promise.all(e.map(async i=>{var h,f,p,y,m,_;let o=await this.getNumTokens(i.content),u=await this.getNumTokens(td(i)),c=i.name!==void 0?s+await this.getNumTokens(i.name):0,l=o+r+u+c,d=i;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(f=d==null?void 0:d.additional_kwargs.function_call)!=null&&f.name&&(l+=await this.getNumTokens((p=d.additional_kwargs.function_call)==null?void 0:p.name)),(y=d.additional_kwargs.function_call)!=null&&y.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((m=d.additional_kwargs.function_call)==null?void 0:m.arguments)))}catch(w){console.error("Error parsing function arguments",w,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((_=d.additional_kwargs.function_call)==null?void 0:_.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:a}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw Ss(s)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=Cs(r),a={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};a.baseURL||delete a.baseURL,this.client=new G(a)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>{var s,a,i;return r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=(s=r.tokenUsage.completionTokens)!=null?s:0,t.tokenUsage.promptTokens+=(a=r.tokenUsage.promptTokens)!=null?a:0,t.tokenUsage.totalTokens+=(i=r.tokenUsage.totalTokens)!=null?i:0),t},{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var h;let r,s,a,i;Dm(e)?(r=e.schema,s=e.name,a=e.method,i=e.includeRaw):(r=e,s=t==null?void 0:t.name,a=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw);let o,u;if(a==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),ed(r)?u=fi.fromZodSchema(r):u=new pi;else{let f=s!=null?s:"extract";if(ed(r)){let p=Je(r);o=this.bind({tools:[{type:"function",function:{name:f,description:p.description,parameters:p}}],tool_choice:{type:"function",function:{name:f}}}),u=new Ts({returnSingle:!0,keyName:f,zodSchema:r})}else{let p;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(p=r,f=r.name):p={name:f,description:(h=r.description)!=null?h:"",parameters:r},o=this.bind({tools:[{type:"function",function:p}],tool_choice:{type:"function",function:{name:f}}}),u=new Ts({returnSingle:!0,keyName:f})}}if(!i)return o.pipe(u);let c=Gr.assign({parsed:(f,p)=>u.invoke(f.raw,p)}),l=Gr.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return pn.from([{raw:o},d])}};function ed(n){return typeof(n==null?void 0:n.parse)=="function"}function Dm(n){return n!==void 0&&typeof n.schema=="object"}var Wo=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}},Jo=class extends ds{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e!=null?e:{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,B(t))}async call(e,t,r){let s;try{s=await this.schema.parseAsync(e)}catch(c){throw new Wo("Received tool input did not match expected schema",JSON.stringify(e))}let a=Ec(t),i=await te.configure(a.callbacks,this.callbacks,a.tags||r,this.tags,a.metadata,this.metadata,{verbose:this.verbose}),o=await(i==null?void 0:i.handleToolStart(this.toJSON(),typeof s=="string"?s:JSON.stringify(s),void 0,void 0,void 0,void 0,a.runName)),u;try{u=await this._call(s,o,a)}catch(c){throw await(o==null?void 0:o.handleToolError(c)),c}return await(o==null?void 0:o.handleToolEnd(u)),u}},gi=class extends Jo{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:ot.object({input:ot.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};var Yo=class extends gi{static lc_name(){return"DallEAPIWrapper"}constructor(e){var a,i,o,u,c,l,d,h;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=(a=e==null?void 0:e.openAIApiKey)!=null?a:U("OPENAI_API_KEY"),r=(i=e==null?void 0:e.organization)!=null?i:U("OPENAI_ORGANIZATION"),s={apiKey:t,organization:r,dangerouslyAllowBrowser:!0};this.client=new G(s),this.modelName=(o=e==null?void 0:e.modelName)!=null?o:this.modelName,this.style=(u=e==null?void 0:e.style)!=null?u:this.style,this.quality=(c=e==null?void 0:e.quality)!=null?c:this.quality,this.n=(l=e==null?void 0:e.n)!=null?l:this.n,this.size=(d=e==null?void 0:e.size)!=null?d:this.size,this.responseFormat=(h=e==null?void 0:e.responseFormat)!=null?h:this.responseFormat,this.user=e==null?void 0:e.user}async _call(e){let t=await this.client.images.generate({model:this.modelName,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user}),r="";return this.responseFormat==="url"?[r]=t.data.map(s=>s.url).filter(s=>s!=="undefined"):[r]=t.data.map(s=>s.b64_json).filter(s=>s!=="undefined"),r}};Object.defineProperty(Yo,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var Wr={},rd=n=>{Wr[n]&&delete Wr[n]},$n=n=>{switch(!0){case n.modelName.contains("gpt"):Wr[n.modelName]||(Wr[n.modelName]=new ks({openAIApiKey:n.apiKey,modelName:n.modelName,maxRetries:2,timeout:5e3}));break;case n.modelName.contains("gemini"):Wr[n.modelName]||(Wr[n.modelName]=new Ma({apiKey:n.apiKey,modelName:n.modelName,topK:n.topK,topP:n.topP,temperature:n.temperature,maxRetries:2,safetySettings:[{category:Xt.HARM_CATEGORY_DANGEROUS_CONTENT,threshold:Qt.BLOCK_NONE},{category:Xt.HARM_CATEGORY_HARASSMENT,threshold:Qt.BLOCK_NONE},{category:Xt.HARM_CATEGORY_HATE_SPEECH,threshold:Qt.BLOCK_NONE},{category:Xt.HARM_CATEGORY_SEXUALLY_EXPLICIT,threshold:Qt.BLOCK_NONE}]}));break}return Wr[n.modelName]};var Fm=(n,e,t)=>{if(e.modelName.contains("gpt"))return n.unshift(new Wt(t));if(e.modelName.contains("gemini"))return n.unshift(new _e(t))},zm=n=>{let e=[],t;for(let r of n)t&&t._getType()===r._getType()?t.content+=`
"""
`+r.content:(e.push(r),t=r);return e},Um=async(n,e,t)=>{let r=t.getData();return Object.prototype.hasOwnProperty.call(r,"role")&&r.role==="ai"?t:t.text===""?(t.setData({...t.getData(),role:"ai"}),t):Qr(n,t,{},{role:"ai"},{label:e.modelName})},Bm=async(n,e,t,r)=>{let s=await Eu(t);return Fm(s,e,n),s[s.length-1]._getType()==="ai"&&s.splice(-1),s=zm(s),s},Km=async(n,e,t,r)=>{let s=$n(n);if(!s){new yi.Notice("Model not found");return}try{let a=await s.stream(e,{}),i="";for await(let o of a)i+=o.content,await t.setText(i);t.setData({...t.getData(),status:"generated"})}catch(a){await t.setText("Error: "+a.message)}},Hm="#2d9bd2",nd=async(n,e,t,r)=>{let s=await Um(t,e,r);await s.setText("Generating..."),s.setData({...s.getData(),status:"generating",model:e.modelName}),s.color=Hm;let a=[];try{a=await Bm(n,e,r,t)}catch(i){new yi.Notice("Failed to prepare conversation"),await s.setText("Error: "+i.message);return}try{await Km(e,a,s,t)}catch(i){new yi.Notice("Failed to generate content"),await s.setText("Error: "+i.message);return}await t.requestSave(),await t.requestFrame()};var sd=async(n,e,t="right")=>{let r=n.getLeavesOfType(e);if(r.length>0){n.revealLeaf(r[0]);return}let s=await qm(n,e,t);s&&n.revealLeaf(s)},qm=async(n,e,t="right")=>{let r=null;switch(t){case"left":r=n.getLeftLeaf(!1);break;case"center":r=n.getLeaf(!1);break;case"right":default:r=n.getRightLeaf(!1);break}return await(r==null?void 0:r.setViewState({type:e,active:!0})),r};var Xo=require("obsidian");var ad=async(n,e)=>{var i;let t=await Us(e);if(!t){new Xo.Notice("No content found in the selected node");return}let r=t.split(`
`).filter(o=>o.trim()!=="");if(r.length===0){new Xo.Notice("No list items found in the selected node");return}let s=n.getEdgesForNode(e).filter(o=>o.to.node.id===e.id),a=[];for(let o of r){let u=await Qr(n,e,{text:o});for(let c of s)a.push({label:(i=c.label)!=null?i:"",id:Mn(16),fromNode:c.from.node.id,fromSide:c.from.side,toNode:u.id,toSide:c.to.side})}a.length>0&&await au(n,a),n.removeNode(e)};var Jr=require("obsidian");var Gt=require("obsidian");var Ns=class extends Gt.Modal{constructor(e,t){super(e),this.model={...t}}onOpen(){let{contentEl:e}=this;new Gt.Setting(e).setName("Model name").addDropdown(a=>a.onChange(async i=>{this.model.modelName=i}).addOptions({"gpt-4-0125-preview":"gpt-4-0125-preview","gpt-4-turbo-preview":"gpt-4-turbo-preview","gemini-1.0-pro-001":"gemini-1.0-pro-001"}).setValue(this.model.modelName)),new Gt.Setting(e).setName("API Key").addText(a=>a.setValue(this.model.apiKey).onChange(async i=>{this.model.apiKey=i}));let t=new Gt.Setting(e).setName("Advanced settings").setDesc("Only change if you know what you are doing");new Gt.Setting(t.settingEl).setName("Temperature").setDesc("").addSlider(a=>{var i,o;return a.setLimits(0,1,.1).setValue((o=(i=this.model)==null?void 0:i.temperature)!=null?o:.5).onChange(async u=>{this.model.temperature=u===0?.1:u})});let r=new Gt.Setting(e).setClass("hidden"),s=e.createDiv("modal-button-container");s.createEl("button",{text:"Test connection",cls:"mod-cta"}).addEventListener("click",async()=>{r.settingEl.classList.remove("hidden"),r.setName("Send a test question...");let a=$n(this.model),i="Very short explain about LLMs temperature parameter, 1 sentence.";try{let o=await a.invoke(i);r.setName("Success").setDesc(`Question: ${i}

AI Response: ${o.content}`)}catch(o){r.setName("Error").setDesc(`Error: ${o.message}`)}}),s.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",async()=>{this.onSaveCb&&this.onSaveCb.call(this,this.model),this.close()}),s.createEl("button",{text:"Cancel",cls:"mod-cta"}).addEventListener("click",()=>{this.close()})}onSave(e){return this.onSaveCb=e,this}};var Qo=class extends Jr.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new Jr.Setting(e).setName("Models").setDesc("Currently we support OpenAI GPT, Google Gemini").setHeading().addButton(t=>{t.setButtonText("Add model").onClick(()=>{new Ns(this.app,{modelName:"",apiKey:""}).setTitle("Add model").onSave(async r=>{this.plugin.settings.models.push(r),await this.plugin.saveSettings(),this.display()}).open()})}),this.plugin.settings.models.forEach((t,r)=>{let s=new Jr.Setting(e);r>0&&s.addExtraButton(a=>{a.setIcon("arrow-up").onClick(()=>{let i=this.plugin.settings.models[r-1];this.plugin.settings.models[r-1]=this.plugin.settings.models[r],this.plugin.settings.models[r]=i,this.plugin.saveSettings(),this.display()}).setTooltip("Set as default")}),s.addExtraButton(a=>{a.setIcon("trash").setTooltip("Remove").onClick(async()=>{this.plugin.settings.models.splice(r,1),await this.plugin.saveSettings(),this.display()})}).setName(`${t.modelName}${r===0?" (default)":""}`).addExtraButton(a=>{a.setIcon("edit").onClick(()=>{new Ns(this.app,t).setTitle("Edit model").onSave(async i=>{this.plugin.settings.models[r]=i,this.plugin.events.trigger("model-update",i),await this.plugin.saveSettings(),this.display()}).open()})})}),new Jr.Setting(e).setName("System prompt").setDesc("The system prompt sent with each request to the API.").setClass("auto-flow").addTextArea(t=>{t.inputEl.rows=6,t.setValue(this.plugin.settings.systemPrompt),t.onChange(async r=>{this.plugin.settings.systemPrompt=r,await this.plugin.saveSettings()})}),new Jr.Setting(e).setName("Follow me on Twitter").setDesc("@duocdev").addButton(t=>{t.setCta(),t.setButtonText("Document").onClick(()=>{window.open("https://useai.aiocean.io/")})}).addButton(t=>{t.setCta(),t.setButtonText("Follow for update").onClick(()=>{window.open("https://twitter.com/duocdev")})}).addButton(t=>{t.setCta(),t.setButtonText("Bug report").onClick(()=>{window.open("https://aiocean.atlassian.net/servicedesk/customer/portal/5")})}).addButton(t=>{t.buttonEl.outerHTML="<a href='https://paypal.me/duocnguyen' target='_blank'><img style='border:0px;height:35px;' src='https://cdn.ko-fi.com/cdn/kofi3.png?v=3' /></a>"})}},id=Qo;var Vm=`
You are a critical-thinking assistant bot.
Consider the intent of my questions before responding.
Do not restate my information unless I ask for it.
Do not include caveats or disclaimers.
Use step-by-step reasoning. Be brief.`,od={models:[],systemPrompt:Vm,debug:!1};var bi=class extends Be.Plugin{constructor(e,t,r){super(e,t),this.events=new js}async onload(){await this.loadSettings(),this.addSettingTab(new id(this.app,this)),this.registerCommands(),this.patchObsidian(),this.registerEvents(),this.registerView(Ls,e=>new $s(e,this)),this.addRibbonIcon("lucide-sparkles","AI Assistant",async()=>{await sd(this.app.workspace,Ls)})}registerEvents(){this.registerEvent(this.events.on("canvas:node-menu",(e,t,r)=>{if(e.menuEl.querySelector(".gpt-menu-item"))return;let s=r.getData();if((s==null?void 0:s.status)==="generating")return;let a=createEl("button","clickable-icon gpt-menu-item");(0,Be.setTooltip)(a,(s==null?void 0:s.role)==="ai"?"Regenerate":"Ask question with AI",{placement:"top"}),(0,Be.setIcon)(a,(s==null?void 0:s.role)==="ai"?"refresh-ccw":"lucide-sparkles"),a.addEventListener("click",async()=>{this.events.trigger("canvas:node-menu:ask-question",t,r)}),e.menuEl.appendChild(a);let i=createEl("button","clickable-icon gpt-menu-item");(0,Be.setTooltip)(i,"add user node",{placement:"top"}),(0,Be.setIcon)(i,"message-square"),i.addEventListener("click",async()=>{await ou(this.app)}),e.menuEl.appendChild(i)})),this.registerEvent(this.events.on("canvas:node-menu:ask-question",async(e,t)=>{if(this.settings.models.length===0){new Be.Notice("API key or model is not set. Please set the API key and model in the settings");return}let r=e.getEdgesForNode(t).filter(a=>a.to.node.id===t.id).first(),s;(r==null?void 0:r.label)!==void 0&&(r==null?void 0:r.label)!==""&&(s=this.settings.models.find(a=>a.modelName.startsWith(r.label))),s||(s=this.settings.models[0]),await nd(this.settings.systemPrompt,s,e,t)})),this.registerEvent(this.events.on("model-update",async e=>{rd(e.modelName)})),this.registerEvent(this.events.on("canvas:split-node",async(e,t)=>{await ad(e,t)}))}patchObsidian(){Ms(this)||this.app.workspace.onLayoutReady(()=>{if(Ms(this))return;let e=this.app.workspace.on("layout-change",()=>{Ms(this)&&this.app.workspace.offref(e)});this.registerEvent(e)})}async loadSettings(){this.settings=Object.assign({},od,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}registerCommands(){[{id:"split-list-to-note",name:"Split list to notes",icon:"lucide-list",checkCallback:t=>{let r=Yr(this.app);if(!r)return!1;let s=r.selection;if(s.size!==1)return!1;let a=s.values().next().value;return t||this.events.trigger("canvas:split-node",r,a),!0}},{id:"continue-writing",name:"Continue writing",editorCallback:async(t,r)=>{let s=this.settings.models[0],a=$n(s),i=t.getValue();console.log(t);try{let o=await a.stream(i,{});for await(let u of o)t.replaceRange(u.content,t.getCursor()),t.refresh()}catch(o){new Be.Notice("Error generating content")}}}].forEach(t=>this.addCommand(t))}};
/*! Bundled license information:

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2023 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2023 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)
*/
