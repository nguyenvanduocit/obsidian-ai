var ph=Object.create;var Hn=Object.defineProperty;var fh=Object.getOwnPropertyDescriptor;var mh=Object.getOwnPropertyNames;var gh=Object.getPrototypeOf,yh=Object.prototype.hasOwnProperty;var bh=(n,e,t)=>e in n?Hn(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var _e=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports),ji=(n,e)=>{for(var t in e)Hn(n,t,{get:e[t],enumerable:!0})},xu=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of mh(e))!yh.call(n,a)&&a!==t&&Hn(n,a,{get:()=>e[a],enumerable:!(r=fh(e,a))||r.enumerable});return n};var je=(n,e,t)=>(t=n!=null?ph(gh(n)):{},xu(e||!n||!n.__esModule?Hn(t,"default",{value:n,enumerable:!0}):t,n)),_h=n=>xu(Hn({},"__esModule",{value:!0}),n);var Pt=(n,e,t)=>(bh(n,typeof e!="symbol"?e+"":e,t),t);var Cu=_e((wy,Tu)=>{"use strict";Tu.exports=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e=="undefined"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()}});var Mu=_e((vy,Di)=>{"use strict";var vh=/[\p{Lu}]/u,xh=/[\p{Ll}]/u,Su=/^[\p{Lu}](?![\p{Lu}])/gu,Ru=/([\p{Alpha}\p{N}_]|$)/u,ju=/[_.\- ]+/,Ah=new RegExp("^"+ju.source),ku=new RegExp(ju.source+Ru.source,"gu"),Nu=new RegExp("\\d+"+Ru.source,"gu"),Eh=(n,e,t)=>{let r=!1,a=!1,s=!1;for(let i=0;i<n.length;i++){let o=n[i];r&&vh.test(o)?(n=n.slice(0,i)+"-"+n.slice(i),r=!1,s=a,a=!0,i++):a&&s&&xh.test(o)?(n=n.slice(0,i-1)+"-"+n.slice(i-1),s=a,a=!1,r=!0):(r=e(o)===o&&t(o)!==o,s=a,a=t(o)===o&&e(o)!==o)}return n},Ph=(n,e)=>(Su.lastIndex=0,n.replace(Su,t=>e(t))),Oh=(n,e)=>(ku.lastIndex=0,Nu.lastIndex=0,n.replace(ku,(t,r)=>e(r)).replace(Nu,t=>e(t))),$u=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(s=>s.trim()).filter(s=>s.length).join("-"):n=n.trim(),n.length===0)return"";let t=e.locale===!1?s=>s.toLowerCase():s=>s.toLocaleLowerCase(e.locale),r=e.locale===!1?s=>s.toUpperCase():s=>s.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Eh(n,t,r)),n=n.replace(Ah,""),e.preserveConsecutiveUppercase?n=Ph(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Oh(n,r))};Di.exports=$u;Di.exports.default=$u});var tc=_e((Ky,ec)=>{function Ce(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}ec.exports=Ce;Ce.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};Ce.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};Ce.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};Ce.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};Ce.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};Ce.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};Ce.prototype.start=Ce.prototype.try;Ce.prototype.errors=function(){return this._errors};Ce.prototype.attempts=function(){return this._attempts};Ce.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var a=this._errors[r],s=a.message,i=(n[s]||0)+1;n[s]=i,i>=t&&(e=a,t=i)}return e}});var rc=_e(cr=>{var ep=tc();cr.operation=function(n){var e=cr.timeouts(n);return new ep(e,{forever:n&&(n.forever||n.retries===1/0),unref:n&&n.unref,maxRetryTime:n&&n.maxRetryTime})};cr.timeouts=function(n){if(n instanceof Array)return[].concat(n);var e={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var t in n)e[t]=n[t];if(e.minTimeout>e.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var r=[],a=0;a<e.retries;a++)r.push(this.createTimeout(a,e));return n&&n.forever&&!r.length&&r.push(this.createTimeout(a,e)),r.sort(function(s,i){return s-i}),r};cr.createTimeout=function(n,e){var t=e.randomize?Math.random()+1:1,r=Math.round(t*Math.max(e.minTimeout,1)*Math.pow(e.factor,n));return r=Math.min(r,e.maxTimeout),r};cr.wrap=function(n,e,t){if(e instanceof Array&&(t=e,e=null),!t){t=[];for(var r in n)typeof n[r]=="function"&&t.push(r)}for(var a=0;a<t.length;a++){var s=t[a],i=n[s];n[s]=function(u){var c=cr.operation(e),l=Array.prototype.slice.call(arguments,1),d=l.pop();l.push(function(h){c.retry(h)||(h&&(arguments[0]=c.mainError()),d.apply(this,arguments))}),c.attempt(function(){u.apply(n,l)})}.bind(n,i),n[s].options=e}}});var ac=_e((Vy,nc)=>{nc.exports=rc()});var ns=_e((Zy,rs)=>{"use strict";var tp=ac(),rp=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"],ts=class extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}},np=(n,e,t)=>{let r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},ap=n=>rp.includes(n),sc=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};let a=tp.operation(e);a.attempt(async s=>{try{t(await n(s))}catch(i){if(!(i instanceof Error)){r(new TypeError(`Non-error was thrown: "${i}". You should only throw errors.`));return}if(i instanceof ts)a.stop(),r(i.originalError);else if(i instanceof TypeError&&!ap(i.message))a.stop(),r(i);else{np(i,s,e);try{await e.onFailedAttempt(i)}catch(o){r(o);return}a.retry(i)||r(a.mainError())}}})});rs.exports=sc;rs.exports.default=sc;rs.exports.AbortError=ts});var oc=_e((Gy,Vi)=>{"use strict";var sp=Object.prototype.hasOwnProperty,fe="~";function Xn(){}Object.create&&(Xn.prototype=Object.create(null),new Xn().__proto__||(fe=!1));function ip(n,e,t){this.fn=n,this.context=e,this.once=t||!1}function ic(n,e,t,r,a){if(typeof t!="function")throw new TypeError("The listener must be a function");var s=new ip(t,r||n,a),i=fe?fe+e:e;return n._events[i]?n._events[i].fn?n._events[i]=[n._events[i],s]:n._events[i].push(s):(n._events[i]=s,n._eventsCount++),n}function as(n,e){--n._eventsCount===0?n._events=new Xn:delete n._events[e]}function le(){this._events=new Xn,this._eventsCount=0}le.prototype.eventNames=function(){var e=[],t,r;if(this._eventsCount===0)return e;for(r in t=this._events)sp.call(t,r)&&e.push(fe?r.slice(1):r);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(t)):e};le.prototype.listeners=function(e){var t=fe?fe+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var a=0,s=r.length,i=new Array(s);a<s;a++)i[a]=r[a].fn;return i};le.prototype.listenerCount=function(e){var t=fe?fe+e:e,r=this._events[t];return r?r.fn?1:r.length:0};le.prototype.emit=function(e,t,r,a,s,i){var o=fe?fe+e:e;if(!this._events[o])return!1;var u=this._events[o],c=arguments.length,l,d;if(u.fn){switch(u.once&&this.removeListener(e,u.fn,void 0,!0),c){case 1:return u.fn.call(u.context),!0;case 2:return u.fn.call(u.context,t),!0;case 3:return u.fn.call(u.context,t,r),!0;case 4:return u.fn.call(u.context,t,r,a),!0;case 5:return u.fn.call(u.context,t,r,a,s),!0;case 6:return u.fn.call(u.context,t,r,a,s,i),!0}for(d=1,l=new Array(c-1);d<c;d++)l[d-1]=arguments[d];u.fn.apply(u.context,l)}else{var h=u.length,p;for(d=0;d<h;d++)switch(u[d].once&&this.removeListener(e,u[d].fn,void 0,!0),c){case 1:u[d].fn.call(u[d].context);break;case 2:u[d].fn.call(u[d].context,t);break;case 3:u[d].fn.call(u[d].context,t,r);break;case 4:u[d].fn.call(u[d].context,t,r,a);break;default:if(!l)for(p=1,l=new Array(c-1);p<c;p++)l[p-1]=arguments[p];u[d].fn.apply(u[d].context,l)}}return!0};le.prototype.on=function(e,t,r){return ic(this,e,t,r,!1)};le.prototype.once=function(e,t,r){return ic(this,e,t,r,!0)};le.prototype.removeListener=function(e,t,r,a){var s=fe?fe+e:e;if(!this._events[s])return this;if(!t)return as(this,s),this;var i=this._events[s];if(i.fn)i.fn===t&&(!a||i.once)&&(!r||i.context===r)&&as(this,s);else{for(var o=0,u=[],c=i.length;o<c;o++)(i[o].fn!==t||a&&!i[o].once||r&&i[o].context!==r)&&u.push(i[o]);u.length?this._events[s]=u.length===1?u[0]:u:as(this,s)}return this};le.prototype.removeAllListeners=function(e){var t;return e?(t=fe?fe+e:e,this._events[t]&&as(this,t)):(this._events=new Xn,this._eventsCount=0),this};le.prototype.off=le.prototype.removeListener;le.prototype.addListener=le.prototype.on;le.prefixed=fe;le.EventEmitter=le;typeof Vi!="undefined"&&(Vi.exports=le)});var cc=_e((Wy,uc)=>{"use strict";uc.exports=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})))});var dc=_e((Jy,is)=>{"use strict";var op=cc(),ss=class extends Error{constructor(e){super(e),this.name="TimeoutError"}},lc=(n,e,t)=>new Promise((r,a)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}let s=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(u){a(u)}return}let i=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new ss(i);typeof n.cancel=="function"&&n.cancel(),a(o)},e);op(n.then(r,a),()=>{clearTimeout(s)})});is.exports=lc;is.exports.default=lc;is.exports.TimeoutError=ss});var hc=_e(Zi=>{"use strict";Object.defineProperty(Zi,"__esModule",{value:!0});function up(n,e,t){let r=0,a=n.length;for(;a>0;){let s=a/2|0,i=r+s;t(n[i],e)<=0?(r=++i,a-=s+1):a=s}return r}Zi.default=up});var pc=_e(Wi=>{"use strict";Object.defineProperty(Wi,"__esModule",{value:!0});var cp=hc(),Gi=class{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);let r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}let a=cp.default(this._queue,r,(s,i)=>i.priority-s.priority);this._queue.splice(a,0,r)}dequeue(){let e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}};Wi.default=Gi});var us=_e(Yi=>{"use strict";Object.defineProperty(Yi,"__esModule",{value:!0});var lp=oc(),fc=dc(),dp=pc(),os=()=>{},hp=new fc.TimeoutError,Ji=class extends lp{constructor(e){var t,r,a,s;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=os,this._resolveIdle=os,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:dp.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(s=(a=e.interval)===null||a===void 0?void 0:a.toString())!==null&&s!==void 0?s:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=os,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=os,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){let e=Date.now();if(this._intervalId===void 0){let t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){let e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){let t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,a)=>{let s=async()=>{this._pendingCount++,this._intervalCount++;try{let i=this._timeout===void 0&&t.timeout===void 0?e():fc.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&a(hp)});r(await i)}catch(i){a(i)}this._next()};this._queue.enqueue(s,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{let t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{let t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}};Yi.default=Ji});var bc=_e(ls=>{"use strict";ls.byteLength=gp;ls.toByteArray=bp;ls.fromByteArray=vp;var We=[],Se=[],mp=typeof Uint8Array!="undefined"?Uint8Array:Array,Xi="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(lr=0,gc=Xi.length;lr<gc;++lr)We[lr]=Xi[lr],Se[Xi.charCodeAt(lr)]=lr;var lr,gc;Se[45]=62;Se[95]=63;function yc(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function gp(n){var e=yc(n),t=e[0],r=e[1];return(t+r)*3/4-r}function yp(n,e,t){return(e+t)*3/4-t}function bp(n){var e,t=yc(n),r=t[0],a=t[1],s=new mp(yp(n,r,a)),i=0,o=a>0?r-4:r,u;for(u=0;u<o;u+=4)e=Se[n.charCodeAt(u)]<<18|Se[n.charCodeAt(u+1)]<<12|Se[n.charCodeAt(u+2)]<<6|Se[n.charCodeAt(u+3)],s[i++]=e>>16&255,s[i++]=e>>8&255,s[i++]=e&255;return a===2&&(e=Se[n.charCodeAt(u)]<<2|Se[n.charCodeAt(u+1)]>>4,s[i++]=e&255),a===1&&(e=Se[n.charCodeAt(u)]<<10|Se[n.charCodeAt(u+1)]<<4|Se[n.charCodeAt(u+2)]>>2,s[i++]=e>>8&255,s[i++]=e&255),s}function _p(n){return We[n>>18&63]+We[n>>12&63]+We[n>>6&63]+We[n&63]}function wp(n,e,t){for(var r,a=[],s=e;s<t;s+=3)r=(n[s]<<16&16711680)+(n[s+1]<<8&65280)+(n[s+2]&255),a.push(_p(r));return a.join("")}function vp(n){for(var e,t=n.length,r=t%3,a=[],s=16383,i=0,o=t-r;i<o;i+=s)a.push(wp(n,i,i+s>o?o:i+s));return r===1?(e=n[t-1],a.push(We[e>>2]+We[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],a.push(We[e>>10]+We[e>>4&63]+We[e<<2&63]+"=")),a.join("")}});var Mc=_e((Ob,$c)=>{"use strict";var Rc=(n=0)=>e=>`\x1B[${38+n};5;${e}m`,jc=(n=0)=>(e,t,r)=>`\x1B[${38+n};2;${e};${t};${r}m`;function Rf(){let n=new Map,e={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};e.color.gray=e.color.blackBright,e.bgColor.bgGray=e.bgColor.bgBlackBright,e.color.grey=e.color.blackBright,e.bgColor.bgGrey=e.bgColor.bgBlackBright;for(let[t,r]of Object.entries(e)){for(let[a,s]of Object.entries(r))e[a]={open:`\x1B[${s[0]}m`,close:`\x1B[${s[1]}m`},r[a]=e[a],n.set(s[0],s[1]);Object.defineProperty(e,t,{value:r,enumerable:!1})}return Object.defineProperty(e,"codes",{value:n,enumerable:!1}),e.color.close="\x1B[39m",e.bgColor.close="\x1B[49m",e.color.ansi256=Rc(),e.color.ansi16m=jc(),e.bgColor.ansi256=Rc(10),e.bgColor.ansi16m=jc(10),Object.defineProperties(e,{rgbToAnsi256:{value:(t,r,a)=>t===r&&r===a?t<8?16:t>248?231:Math.round((t-8)/247*24)+232:16+36*Math.round(t/255*5)+6*Math.round(r/255*5)+Math.round(a/255*5),enumerable:!1},hexToRgb:{value:t=>{let r=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(t.toString(16));if(!r)return[0,0,0];let{colorString:a}=r.groups;a.length===3&&(a=a.split("").map(i=>i+i).join(""));let s=Number.parseInt(a,16);return[s>>16&255,s>>8&255,s&255]},enumerable:!1},hexToAnsi256:{value:t=>e.rgbToAnsi256(...e.hexToRgb(t)),enumerable:!1}}),e}Object.defineProperty($c,"exports",{enumerable:!0,get:Rf})});var oy={};ji(oy,{default:()=>Ri});module.exports=_h(oy);var Ze=require("obsidian");var Au=require("obsidian"),$i=class extends Au.Modal{},Ha;function Eu(n,e){Ha||(Ha=new $i(n)),Ha.setContent(e),Ha.open()}var Pu=require("obsidian"),wh=[{title:"Keyword report",prompt:"Create a keyword report and SEO content plan from 1 keyword."},{title:"TL;DR",prompt:"Condense selected text, article, email into a TLDR for quick understanding and time-saving."},{title:"Grammarly",prompt:"Correct spelling and text grammar."},{title:"SILO structure",prompt:"Create a SILO structure for a website from a list of keywords."},{title:"FAQ & answers writer",prompt:"Generate FAQ list with answers from the given product or service description."},{title:"Key takeaways",prompt:"Summarize the key takeaways from the given content."}],Mi=class extends Pu.SuggestModal{getSuggestions(e){return wh.filter(t=>t.title.toLowerCase().includes(e.toLowerCase())||t.prompt.toLowerCase().includes(e.toLowerCase()))}renderSuggestion(e,t){t.createEl("div",{text:e.title}),t.createEl("small",{text:e.prompt})}setChooseSuggestionCallback(e){this.onChooseSuggestion=e}onChooseSuggestion(e,t){this.onChooseSuggestion&&this.onChooseSuggestion.call(this,e)}},Ka,Ou=(n,e)=>{Ka||(Ka=new Mi(n)),Ka.setChooseSuggestionCallback(e),Ka.open()};var Iu=require("obsidian"),qa=class extends Iu.Events{constructor(){super()}on(e,t){return super.on(e,t)}trigger(e,...t){return super.trigger(e,...t)}};var Ne=require("obsidian");var q={container:"_container_jyj1d_1",header:"_header_jyj1d_7",title:"_title_jyj1d_18",actions:"_actions_jyj1d_21",inputContainer:"_inputContainer_jyj1d_32",textInput:"_textInput_jyj1d_43",focus:"_focus_jyj1d_60",controls:"_controls_jyj1d_63",attachments:"_attachments_jyj1d_77",messageItem:"_messageItem_jyj1d_82",systemMessage:"_systemMessage_jyj1d_93",humanMessage:"_humanMessage_jyj1d_98",aiMessage:"_aiMessage_jyj1d_101"};var Du=je(Cu(),1),Ih=je(Mu(),1);function Lu(n,e){return(e==null?void 0:e[n])||(0,Du.default)(n)}function Fu(n,e,t){let r={};for(let a in n)Object.hasOwn(n,a)&&(r[e(a,t)]=n[a]);return r}function zu(n){return Array.isArray(n)?[...n]:{...n}}function Th(n,e){let t=zu(n);for(let[r,a]of Object.entries(e)){let[s,...i]=r.split(".").reverse(),o=t;for(let u of i.reverse()){if(o[u]===void 0)break;o[u]=zu(o[u]),o=o[u]}o[s]!==void 0&&(o[s]={lc:1,type:"secret",id:[a]})}return t}function Li(n){let e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}var $e=class n{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Li(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof n||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();let e={},t={},r=Object.keys(this.lc_kwargs).reduce((a,s)=>(a[s]=s in this?this[s]:this.lc_kwargs[s],a),{});for(let a=Object.getPrototypeOf(this);a;a=Object.getPrototypeOf(a))Object.assign(e,Reflect.get(a,"lc_aliases",this)),Object.assign(t,Reflect.get(a,"lc_secrets",this)),Object.assign(r,Reflect.get(a,"lc_attributes",this));return Object.keys(t).forEach(a=>{let s=this,i=r,[o,...u]=a.split(".").reverse();for(let c of u.reverse()){if(!(c in s)||s[c]===void 0)return;(!(c in i)||i[c]===void 0)&&(typeof s[c]=="object"&&s[c]!=null?i[c]={}:Array.isArray(s[c])&&(i[c]=[])),s=s[c],i=i[c]}o in s&&s[o]!==void 0&&(i[o]=i[o]||s[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Fu(Object.keys(t).length?Th(r,t):r,Lu,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}};function sn(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}var er=class extends $e{get lc_aliases(){return{additional_kwargs:"additional_kwargs",response_metadata:"response_metadata"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t,response_metadata:{}}),e.additional_kwargs||(e.additional_kwargs={}),e.response_metadata||(e.response_metadata={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"response_metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs,this.response_metadata=e.response_metadata}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){let e=this._getType();if(e==="human")return new Kn({...this});if(e==="ai")return new st({...this});if(e==="system")return new qn({...this});if(e==="function")return new Vn({...this});if(It.isInstance(this))return new Zn({...this});throw new Error("Unknown message type.")}};function Uu(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}function Ae(n,e){var r,a;let t={...n};for(let[s,i]of Object.entries(e))if(t[s]==null)t[s]=i;else{if(i==null)continue;if(typeof t[s]!=typeof i||Array.isArray(t[s])!==Array.isArray(i))throw new Error(`field[${s}] already exists in the message chunk, but with a different type.`);if(typeof t[s]=="string")t[s]=t[s]+i;else if(!Array.isArray(t[s])&&typeof t[s]=="object")t[s]=Ae(t[s],i);else if(s==="tool_calls"&&Uu(t[s])&&Uu(i))for(let o of i)((r=t[s])==null?void 0:r[o.index])!==void 0?t[s]=(a=t[s])==null?void 0:a.map((u,c)=>{var l,d,h;return c!==o.index?u:{...u,...o,function:{name:(l=o.function.name)!=null?l:u.function.name,arguments:((d=u.function.arguments)!=null?d:"")+((h=o.function.arguments)!=null?h:"")}}}):t[s][o.index]=o;else if(Array.isArray(t[s]))t[s]=t[s].concat(i);else{if(t[s]===i)continue;console.warn(`field[${s}] already exists in this message chunk and value has unsupported type.`)}}return t}var Ot=class extends er{},se=class extends er{static lc_name(){return"HumanMessage"}_getType(){return"human"}},Kn=class n extends Ot{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new n({content:sn(this.content,e.content),additional_kwargs:Ae(this.additional_kwargs,e.additional_kwargs),response_metadata:Ae(this.response_metadata,e.response_metadata)})}},ce=class extends er{static lc_name(){return"AIMessage"}_getType(){return"ai"}},st=class n extends Ot{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new n({content:sn(this.content,e.content),additional_kwargs:Ae(this.additional_kwargs,e.additional_kwargs),response_metadata:Ae(this.response_metadata,e.response_metadata)})}},tr=class extends er{static lc_name(){return"SystemMessage"}_getType(){return"system"}},qn=class n extends Ot{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new n({content:sn(this.content,e.content),additional_kwargs:Ae(this.additional_kwargs,e.additional_kwargs),response_metadata:Ae(this.response_metadata,e.response_metadata)})}};var Vn=class n extends Ot{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){var t;return new n({content:sn(this.content,e.content),additional_kwargs:Ae(this.additional_kwargs,e.additional_kwargs),response_metadata:Ae(this.response_metadata,e.response_metadata),name:(t=this.name)!=null?t:""})}};var Va=class n extends Ot{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new n({content:sn(this.content,e.content),additional_kwargs:Ae(this.additional_kwargs,e.additional_kwargs),response_metadata:Ae(this.response_metadata,e.response_metadata),tool_call_id:this.tool_call_id})}},It=class n extends er{static lc_name(){return"ChatMessage"}static _chatMessageClass(){return n}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}};function rr(n){return typeof(n==null?void 0:n._getType)=="function"}function Bu(n){return rr(n)&&typeof n.concat=="function"}function nr(n){if(typeof n=="string")return new se(n);if(rr(n))return n;let[e,t]=n;if(e==="human"||e==="user")return new se({content:t});if(e==="ai"||e==="assistant")return new ce({content:t});if(e==="system")return new tr({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}var Zn=class n extends Ot{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new n({content:sn(this.content,e.content),additional_kwargs:Ae(this.additional_kwargs,e.additional_kwargs),response_metadata:Ae(this.response_metadata,e.response_metadata),role:this.role})}};function on(n,e="Human",t="AI"){let r=[];for(let a of n){let s;if(a._getType()==="human")s=e;else if(a._getType()==="ai")s=t;else if(a._getType()==="system")s="System";else if(a._getType()==="function")s="Function";else if(a._getType()==="tool")s="Tool";else if(a._getType()==="generic")s=a.role;else throw new Error(`Got unsupported message type: ${a._getType()}`);let i=a.name?`${a.name}, `:"";r.push(`${s}: ${i}${a.content}`)}return r.join(`
`)}var ar;(function(n){n.HARM_CATEGORY_UNSPECIFIED="HARM_CATEGORY_UNSPECIFIED",n.HARM_CATEGORY_HATE_SPEECH="HARM_CATEGORY_HATE_SPEECH",n.HARM_CATEGORY_SEXUALLY_EXPLICIT="HARM_CATEGORY_SEXUALLY_EXPLICIT",n.HARM_CATEGORY_HARASSMENT="HARM_CATEGORY_HARASSMENT",n.HARM_CATEGORY_DANGEROUS_CONTENT="HARM_CATEGORY_DANGEROUS_CONTENT"})(ar||(ar={}));var sr;(function(n){n.HARM_BLOCK_THRESHOLD_UNSPECIFIED="HARM_BLOCK_THRESHOLD_UNSPECIFIED",n.BLOCK_LOW_AND_ABOVE="BLOCK_LOW_AND_ABOVE",n.BLOCK_MEDIUM_AND_ABOVE="BLOCK_MEDIUM_AND_ABOVE",n.BLOCK_ONLY_HIGH="BLOCK_ONLY_HIGH",n.BLOCK_NONE="BLOCK_NONE"})(sr||(sr={}));var Hu;(function(n){n.HARM_PROBABILITY_UNSPECIFIED="HARM_PROBABILITY_UNSPECIFIED",n.NEGLIGIBLE="NEGLIGIBLE",n.LOW="LOW",n.MEDIUM="MEDIUM",n.HIGH="HIGH"})(Hu||(Hu={}));var Ku;(function(n){n.BLOCKED_REASON_UNSPECIFIED="BLOCKED_REASON_UNSPECIFIED",n.SAFETY="SAFETY",n.OTHER="OTHER"})(Ku||(Ku={}));var Za;(function(n){n.FINISH_REASON_UNSPECIFIED="FINISH_REASON_UNSPECIFIED",n.STOP="STOP",n.MAX_TOKENS="MAX_TOKENS",n.SAFETY="SAFETY",n.RECITATION="RECITATION",n.OTHER="OTHER"})(Za||(Za={}));var qu;(function(n){n.TASK_TYPE_UNSPECIFIED="TASK_TYPE_UNSPECIFIED",n.RETRIEVAL_QUERY="RETRIEVAL_QUERY",n.RETRIEVAL_DOCUMENT="RETRIEVAL_DOCUMENT",n.SEMANTIC_SIMILARITY="SEMANTIC_SIMILARITY",n.CLASSIFICATION="CLASSIFICATION",n.CLUSTERING="CLUSTERING"})(qu||(qu={}));var ir=class extends Error{constructor(e){super(`[GoogleGenerativeAI Error]: ${e}`)}},Ga=class extends ir{constructor(e,t){super(e),this.response=t}};var Ch="https://generativelanguage.googleapis.com",Sh="v1",kh="0.1.3",Nh="genai-js",or;(function(n){n.GENERATE_CONTENT="generateContent",n.STREAM_GENERATE_CONTENT="streamGenerateContent",n.COUNT_TOKENS="countTokens",n.EMBED_CONTENT="embedContent",n.BATCH_EMBED_CONTENTS="batchEmbedContents"})(or||(or={}));var ur=class{constructor(e,t,r,a){this.model=e,this.task=t,this.apiKey=r,this.stream=a}toString(){let e=`${Ch}/${Sh}/models/${this.model}:${this.task}`;return this.stream&&(e+="?alt=sse"),e}};function Rh(){return`${Nh}/${kh}`}async function Yn(n,e){let t;try{if(t=await fetch(n.toString(),{method:"POST",headers:{"Content-Type":"application/json","x-goog-api-client":Rh(),"x-goog-api-key":n.apiKey},body:e}),!t.ok){let r="";try{let a=await t.json();r=a.error.message,a.error.details&&(r+=` ${JSON.stringify(a.error.details)}`)}catch(a){}throw new Error(`[${t.status} ${t.statusText}] ${r}`)}}catch(r){let a=new ir(`Error fetching from ${n.toString()}: ${r.message}`);throw a.stack=r.stack,a}return t}function Bi(n){return n.text=()=>{if(n.candidates&&n.candidates.length>0){if(n.candidates.length>1&&console.warn(`This response had ${n.candidates.length} candidates. Returning text from the first candidate only. Access response.candidates directly to use the other candidates.`),Gu(n.candidates[0]))throw new Ga(`${Wa(n)}`,n);return jh(n)}else if(n.promptFeedback)throw new Ga(`Text not available. ${Wa(n)}`,n);return""},n}function jh(n){var e,t,r,a;return!((a=(r=(t=(e=n.candidates)===null||e===void 0?void 0:e[0].content)===null||t===void 0?void 0:t.parts)===null||r===void 0?void 0:r[0])===null||a===void 0)&&a.text?n.candidates[0].content.parts[0].text:""}var $h=[Za.RECITATION,Za.SAFETY];function Gu(n){return!!n.finishReason&&$h.includes(n.finishReason)}function Wa(n){var e,t,r;let a="";if((!n.candidates||n.candidates.length===0)&&n.promptFeedback)a+="Response was blocked",!((e=n.promptFeedback)===null||e===void 0)&&e.blockReason&&(a+=` due to ${n.promptFeedback.blockReason}`),!((t=n.promptFeedback)===null||t===void 0)&&t.blockReasonMessage&&(a+=`: ${n.promptFeedback.blockReasonMessage}`);else if(!((r=n.candidates)===null||r===void 0)&&r[0]){let s=n.candidates[0];Gu(s)&&(a+=`Candidate was blocked due to ${s.finishReason}`,s.finishMessage&&(a+=`: ${s.finishMessage}`))}return a}function Wn(n){return this instanceof Wn?(this.v=n,this):new Wn(n)}function Mh(n,e,t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r=t.apply(n,e||[]),a,s=[];return a={},i("next"),i("throw"),i("return"),a[Symbol.asyncIterator]=function(){return this},a;function i(h){r[h]&&(a[h]=function(p){return new Promise(function(m,y){s.push([h,p,m,y])>1||o(h,p)})})}function o(h,p){try{u(r[h](p))}catch(m){d(s[0][3],m)}}function u(h){h.value instanceof Wn?Promise.resolve(h.value.v).then(c,l):d(s[0][2],h)}function c(h){o("next",h)}function l(h){o("throw",h)}function d(h,p){h(p),s.shift(),s.length&&o(s[0][0],s[0][1])}}var Vu=/^data\: (.*)(?:\n\n|\r\r|\r\n\r\n)/;function Dh(n){let e=n.body.pipeThrough(new TextDecoderStream("utf8",{fatal:!0})),t=zh(e),[r,a]=t.tee();return{stream:Fh(r),response:Lh(a)}}async function Lh(n){let e=[],t=n.getReader();for(;;){let{done:r,value:a}=await t.read();if(r)return Bi(Uh(e));e.push(a)}}function Fh(n){return Mh(this,arguments,function*(){let t=n.getReader();for(;;){let{value:r,done:a}=yield Wn(t.read());if(a)break;yield yield Wn(Bi(r))}})}function zh(n){let e=n.getReader();return new ReadableStream({start(r){let a="";return s();function s(){return e.read().then(({value:i,done:o})=>{if(o){if(a.trim()){r.error(new ir("Failed to parse stream"));return}r.close();return}a+=i;let u=a.match(Vu),c;for(;u;){try{c=JSON.parse(u[1])}catch(l){r.error(new ir(`Error parsing JSON response: "${u[1]}"`));return}r.enqueue(c),a=a.substring(u[0].length),u=a.match(Vu)}return s()})}}})}function Uh(n){let e=n[n.length-1],t={promptFeedback:e==null?void 0:e.promptFeedback};for(let r of n)if(r.candidates)for(let a of r.candidates){let s=a.index;if(t.candidates||(t.candidates=[]),t.candidates[s]||(t.candidates[s]={index:a.index}),t.candidates[s].citationMetadata=a.citationMetadata,t.candidates[s].finishReason=a.finishReason,t.candidates[s].finishMessage=a.finishMessage,t.candidates[s].safetyRatings=a.safetyRatings,a.content&&a.content.parts){t.candidates[s].content||(t.candidates[s].content={role:a.content.role||"user",parts:[{text:""}]});for(let i of a.content.parts)i.text&&(t.candidates[s].content.parts[0].text+=i.text)}}return t}async function Wu(n,e,t){let r=new ur(e,or.STREAM_GENERATE_CONTENT,n,!0),a=await Yn(r,JSON.stringify(t));return Dh(a)}async function Ju(n,e,t){let r=new ur(e,or.GENERATE_CONTENT,n,!1),s=await(await Yn(r,JSON.stringify(t))).json();return{response:Bi(s)}}function Gn(n,e){let t=[];if(typeof n=="string")t=[{text:n}];else for(let r of n)typeof r=="string"?t.push({text:r}):t.push(r);return{role:e,parts:t}}function Fi(n){return n.contents?n:{contents:[Gn(n,"user")]}}function Bh(n){return typeof n=="string"||Array.isArray(n)?{content:Gn(n,"user")}:n}var Zu="SILENT_ERROR",zi=class{constructor(e,t,r){this.model=t,this.params=r,this._history=[],this._sendPromise=Promise.resolve(),this._apiKey=e,r!=null&&r.history&&(this._history=r.history.map(a=>{if(!a.role)throw new Error("Missing role for history item: "+JSON.stringify(a));return Gn(a.parts,a.role)}))}async getHistory(){return await this._sendPromise,this._history}async sendMessage(e){var t,r;await this._sendPromise;let a=Gn(e,"user"),s={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,contents:[...this._history,a]},i;return this._sendPromise=this._sendPromise.then(()=>Ju(this._apiKey,this.model,s)).then(o=>{var u;if(o.response.candidates&&o.response.candidates.length>0){this._history.push(a);let c=Object.assign({parts:[],role:"model"},(u=o.response.candidates)===null||u===void 0?void 0:u[0].content);this._history.push(c)}else{let c=Wa(o.response);c&&console.warn(`sendMessage() was unsuccessful. ${c}. Inspect response object for details.`)}i=o}),await this._sendPromise,i}async sendMessageStream(e){var t,r;await this._sendPromise;let a=Gn(e,"user"),s={safetySettings:(t=this.params)===null||t===void 0?void 0:t.safetySettings,generationConfig:(r=this.params)===null||r===void 0?void 0:r.generationConfig,contents:[...this._history,a]},i=Wu(this._apiKey,this.model,s);return this._sendPromise=this._sendPromise.then(()=>i).catch(o=>{throw new Error(Zu)}).then(o=>o.response).then(o=>{if(o.candidates&&o.candidates.length>0){this._history.push(a);let u=Object.assign({},o.candidates[0].content);u.role||(u.role="model"),this._history.push(u)}else{let u=Wa(o);u&&console.warn(`sendMessageStream() was unsuccessful. ${u}. Inspect response object for details.`)}}).catch(o=>{o.message!==Zu&&console.error(o)}),i}};async function Hh(n,e,t){let r=new ur(e,or.COUNT_TOKENS,n,!1);return(await Yn(r,JSON.stringify(Object.assign(Object.assign({},t),{model:e})))).json()}async function Kh(n,e,t){let r=new ur(e,or.EMBED_CONTENT,n,!1);return(await Yn(r,JSON.stringify(t))).json()}async function qh(n,e,t){let r=new ur(e,or.BATCH_EMBED_CONTENTS,n,!1),a=t.requests.map(i=>Object.assign(Object.assign({},i),{model:`models/${e}`}));return(await Yn(r,JSON.stringify({requests:a}))).json()}var Ui=class{constructor(e,t){var r;this.apiKey=e,t.model.startsWith("models/")?this.model=(r=t.model.split("models/"))===null||r===void 0?void 0:r[1]:this.model=t.model,this.generationConfig=t.generationConfig||{},this.safetySettings=t.safetySettings||[]}async generateContent(e){let t=Fi(e);return Ju(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings},t))}async generateContentStream(e){let t=Fi(e);return Wu(this.apiKey,this.model,Object.assign({generationConfig:this.generationConfig,safetySettings:this.safetySettings},t))}startChat(e){return new zi(this.apiKey,this.model,e)}async countTokens(e){let t=Fi(e);return Hh(this.apiKey,this.model,t)}async embedContent(e){let t=Bh(e);return Kh(this.apiKey,this.model,t)}async batchEmbedContents(e){return qh(this.apiKey,this.model,e)}};var Jn=class{constructor(e){this.apiKey=e}getGenerativeModel(e){if(!e.model)throw new ir("Must provide a model name. Example: genai.getGenerativeModel({ model: 'my-model-name' })");return new Ui(this.apiKey,e)}};var Vh=()=>typeof window!="undefined"&&typeof window.document!="undefined",Zh=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",Gh=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Yu=()=>typeof Deno!="undefined",Wh=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!Yu(),Jh=()=>{let n;return Vh()?n="browser":Wh()?n="node":Zh()?n="webworker":Gh()?n="jsdom":Yu()?n="deno":n="other",n},Hi;async function Xu(){return Hi===void 0&&(Hi={library:"langchain-js",runtime:Jh()}),Hi}function H(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:void 0}catch(t){return}}var Ja="__run",Tt=class n{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}},it=class n extends Tt{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new n({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}};var Yh=typeof window=="object"?window:{},j="0123456789abcdef".split(""),Xh=[-2147483648,8388608,32768,128],Me=[24,16,8,0];var re=[];function De(n){n?(re[0]=re[16]=re[1]=re[2]=re[3]=re[4]=re[5]=re[6]=re[7]=re[8]=re[9]=re[10]=re[11]=re[12]=re[13]=re[14]=re[15]=0,this.blocks=re):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}De.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===Yh.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,a,s=n.length||0,i=this.blocks;r<s;){if(this.hashed&&(this.hashed=!1,i[0]=this.block,i[16]=i[1]=i[2]=i[3]=i[4]=i[5]=i[6]=i[7]=i[8]=i[9]=i[10]=i[11]=i[12]=i[13]=i[14]=i[15]=0),e)for(a=this.start;r<s&&a<64;++r)i[a>>2]|=n[r]<<Me[a++&3];else for(a=this.start;r<s&&a<64;++r)t=n.charCodeAt(r),t<128?i[a>>2]|=t<<Me[a++&3]:t<2048?(i[a>>2]|=(192|t>>6)<<Me[a++&3],i[a>>2]|=(128|t&63)<<Me[a++&3]):t<55296||t>=57344?(i[a>>2]|=(224|t>>12)<<Me[a++&3],i[a>>2]|=(128|t>>6&63)<<Me[a++&3],i[a>>2]|=(128|t&63)<<Me[a++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),i[a>>2]|=(240|t>>18)<<Me[a++&3],i[a>>2]|=(128|t>>12&63)<<Me[a++&3],i[a>>2]|=(128|t>>6&63)<<Me[a++&3],i[a>>2]|=(128|t&63)<<Me[a++&3]);this.lastByteIndex=a,this.bytes+=a-this.start,a>=64?(this.block=i[16],this.start=a-64,this.hash(),this.hashed=!0):this.start=a}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};De.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=Xh[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};De.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4,s,i,o,u=this.blocks;for(i=16;i<80;++i)o=u[i-3]^u[i-8]^u[i-14]^u[i-16],u[i]=o<<1|o>>>31;for(i=0;i<20;i+=5)s=e&t|~e&r,o=n<<5|n>>>27,a=o+s+a+1518500249+u[i]<<0,e=e<<30|e>>>2,s=n&e|~n&t,o=a<<5|a>>>27,r=o+s+r+1518500249+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|~a&e,o=r<<5|r>>>27,t=o+s+t+1518500249+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|~r&n,o=t<<5|t>>>27,e=o+s+e+1518500249+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|~t&a,o=e<<5|e>>>27,n=o+s+n+1518500249+u[i+4]<<0,t=t<<30|t>>>2;for(;i<40;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a+1859775393+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r+1859775393+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t+1859775393+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e+1859775393+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n+1859775393+u[i+4]<<0,t=t<<30|t>>>2;for(;i<60;i+=5)s=e&t|e&r|t&r,o=n<<5|n>>>27,a=o+s+a-1894007588+u[i]<<0,e=e<<30|e>>>2,s=n&e|n&t|e&t,o=a<<5|a>>>27,r=o+s+r-1894007588+u[i+1]<<0,n=n<<30|n>>>2,s=a&n|a&e|n&e,o=r<<5|r>>>27,t=o+s+t-1894007588+u[i+2]<<0,a=a<<30|a>>>2,s=r&a|r&n|a&n,o=t<<5|t>>>27,e=o+s+e-1894007588+u[i+3]<<0,r=r<<30|r>>>2,s=t&r|t&a|r&a,o=e<<5|e>>>27,n=o+s+n-1894007588+u[i+4]<<0,t=t<<30|t>>>2;for(;i<80;i+=5)s=e^t^r,o=n<<5|n>>>27,a=o+s+a-899497514+u[i]<<0,e=e<<30|e>>>2,s=n^e^t,o=a<<5|a>>>27,r=o+s+r-899497514+u[i+1]<<0,n=n<<30|n>>>2,s=a^n^e,o=r<<5|r>>>27,t=o+s+t-899497514+u[i+2]<<0,a=a<<30|a>>>2,s=r^a^n,o=t<<5|t>>>27,e=o+s+e-899497514+u[i+3]<<0,r=r<<30|r>>>2,s=t^r^a,o=e<<5|e>>>27,n=o+s+n-899497514+u[i+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+a<<0};De.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return j[n>>28&15]+j[n>>24&15]+j[n>>20&15]+j[n>>16&15]+j[n>>12&15]+j[n>>8&15]+j[n>>4&15]+j[n&15]+j[e>>28&15]+j[e>>24&15]+j[e>>20&15]+j[e>>16&15]+j[e>>12&15]+j[e>>8&15]+j[e>>4&15]+j[e&15]+j[t>>28&15]+j[t>>24&15]+j[t>>20&15]+j[t>>16&15]+j[t>>12&15]+j[t>>8&15]+j[t>>4&15]+j[t&15]+j[r>>28&15]+j[r>>24&15]+j[r>>20&15]+j[r>>16&15]+j[r>>12&15]+j[r>>8&15]+j[r>>4&15]+j[r&15]+j[a>>28&15]+j[a>>24&15]+j[a>>20&15]+j[a>>16&15]+j[a>>12&15]+j[a>>8&15]+j[a>>4&15]+j[a&15]};De.prototype.toString=De.prototype.hex;De.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,a=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,a>>24&255,a>>16&255,a>>8&255,a&255]};De.prototype.array=De.prototype.digest;De.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};var Ki=n=>new De(!0).update(n).hex();var Qu=(...n)=>Ki(n.join("_"));var qi=class{},Qh=new Map,Ya=class n extends qi{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e!=null?e:new Map}lookup(e,t){var r;return Promise.resolve((r=this.cache.get(Qu(e,t)))!=null?r:null)}async update(e,t,r){this.cache.set(Qu(e,t),r)}static global(){return new n(Qh)}};var Xa=class extends $e{},Qa=class extends Xa{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new se(this.value)]}},es=class extends Xa{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return on(this.messages)}toChatMessages(){return this.messages}};var mc=je(ns(),1),cs=je(us(),1),pp=[400,401,402,403,404,405,406,407,409],fp=n=>{var t,r,a;if(n.message.startsWith("Cancel")||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;let e=(r=(t=n==null?void 0:n.response)==null?void 0:t.status)!=null?r:n==null?void 0:n.status;if(e&&pp.includes(+e))throw n;if(((a=n==null?void 0:n.error)==null?void 0:a.code)==="insufficient_quota"){let s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}},ot=class{constructor(e){var r,a,s;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(a=e.maxRetries)!=null?a:6,this.onFailedAttempt=(s=e.onFailedAttempt)!=null?s:fp;let t="default"in cs.default?cs.default.default:cs.default;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>(0,mc.default)(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var _c=je(bc(),1);var xp=Object.defineProperty,Ap=(n,e,t)=>e in n?xp(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ep=(n,e,t)=>(Ap(n,typeof e!="symbol"?e+"":e,t),t);function Pp(n,e){let t=Array.from({length:n.length},(r,a)=>({start:a,end:a+1}));for(;t.length>1;){let r=null;for(let a=0;a<t.length-1;a++){let s=n.slice(t[a].start,t[a+1].end),i=e.get(s.join(","));i!=null&&(r==null||i<r[0])&&(r=[i,a])}if(r!=null){let a=r[1];t[a]={start:t[a].start,end:t[a+1].end},t.splice(a+1,1)}else break}return t}function Op(n,e){return n.length===1?[e.get(n.join(","))]:Pp(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Ip(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var Qi=class{constructor(n,e){Pt(this,"specialTokens");Pt(this,"inverseSpecialTokens");Pt(this,"patStr");Pt(this,"textEncoder",new TextEncoder);Pt(this,"textDecoder",new TextDecoder("utf-8"));Pt(this,"rankMap",new Map);Pt(this,"textMap",new Map);this.patStr=n.pat_str;let t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,a)=>{let[s,i,...o]=a.split(" "),u=Number.parseInt(i,10);return o.forEach((c,l)=>r[c]=u+l),r},{});for(let[r,a]of Object.entries(t)){let s=_c.default.toByteArray(r);this.rankMap.set(s.join(","),a),this.textMap.set(a,s)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[a,s])=>(r[s]=this.textEncoder.encode(a),r),{})}encode(n,e=[],t="all"){var c;let r=new RegExp(this.patStr,"ug"),a=Qi.specialTokenRegex(Object.keys(this.specialTokens)),s=[],i=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!i.has(l)):t);if(o.size>0){let l=Qi.specialTokenRegex([...o]),d=n.match(l);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let u=0;for(;;){let l=null,d=u;for(;a.lastIndex=d,l=a.exec(n),!(l==null||i.has(l[0]));)d=l.index+1;let h=(c=l==null?void 0:l.index)!=null?c:n.length;for(let m of n.substring(u,h).matchAll(r)){let y=this.textEncoder.encode(m[0]),g=this.rankMap.get(y.join(","));if(g!=null){s.push(g);continue}s.push(...Op(y,this.rankMap))}if(l==null)break;let p=this.specialTokens[l[0]];s.push(p),u=l.index+l[0].length}return s}decode(n){var s;let e=[],t=0;for(let i=0;i<n.length;++i){let o=n[i],u=(s=this.textMap.get(o))!=null?s:this.inverseSpecialTokens[o];u!=null&&(e.push(u),t+=u.length)}let r=new Uint8Array(t),a=0;for(let i of e)r.set(i,a),a+=i.length;return this.textDecoder.decode(r)}},ds=Qi;Ep(ds,"specialTokenRegex",n=>new RegExp(n.map(e=>Ip(e)).join("|"),"g"));function eo(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-instruct-0914":case"gpt-3.5-turbo-instruct":case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"gpt-3.5-turbo-0125":case"gpt-4-turbo-preview":case"gpt-4-0125-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}var hs={},Tp=new ot({});async function Cp(n){return n in hs||(hs[n]=Tp.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new ds(e)).catch(e=>{throw delete hs[n],e})),await hs[n]}async function wc(n){return Cp(eo(n))}var U;(function(n){n.assertEqual=a=>a;function e(a){}n.assertIs=e;function t(a){throw new Error}n.assertNever=t,n.arrayToEnum=a=>{let s={};for(let i of a)s[i]=i;return s},n.getValidEnumValues=a=>{let s=n.objectKeys(a).filter(o=>typeof a[a[o]]!="number"),i={};for(let o of s)i[o]=a[o];return n.objectValues(i)},n.objectValues=a=>n.objectKeys(a).map(function(s){return a[s]}),n.objectKeys=typeof Object.keys=="function"?a=>Object.keys(a):a=>{let s=[];for(let i in a)Object.prototype.hasOwnProperty.call(a,i)&&s.push(i);return s},n.find=(a,s)=>{for(let i of a)if(s(i))return i},n.isInteger=typeof Number.isInteger=="function"?a=>Number.isInteger(a):a=>typeof a=="number"&&isFinite(a)&&Math.floor(a)===a;function r(a,s=" | "){return a.map(i=>typeof i=="string"?`'${i}'`:i).join(s)}n.joinValues=r,n.jsonStringifyReplacer=(a,s)=>typeof s=="bigint"?s.toString():s})(U||(U={}));var ro;(function(n){n.mergeShapes=(e,t)=>({...e,...t})})(ro||(ro={}));var v=U.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),Ct=n=>{switch(typeof n){case"undefined":return v.undefined;case"string":return v.string;case"number":return isNaN(n)?v.nan:v.number;case"boolean":return v.boolean;case"function":return v.function;case"bigint":return v.bigint;case"symbol":return v.symbol;case"object":return Array.isArray(n)?v.array:n===null?v.null:n.then&&typeof n.then=="function"&&n.catch&&typeof n.catch=="function"?v.promise:typeof Map!="undefined"&&n instanceof Map?v.map:typeof Set!="undefined"&&n instanceof Set?v.set:typeof Date!="undefined"&&n instanceof Date?v.date:v.object;default:return v.unknown}},b=U.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]),Sp=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:"),Ee=class extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};let t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){let t=e||function(s){return s.message},r={_errors:[]},a=s=>{for(let i of s.issues)if(i.code==="invalid_union")i.unionErrors.map(a);else if(i.code==="invalid_return_type")a(i.returnTypeError);else if(i.code==="invalid_arguments")a(i.argumentsError);else if(i.path.length===0)r._errors.push(t(i));else{let o=r,u=0;for(;u<i.path.length;){let c=i.path[u];u===i.path.length-1?(o[c]=o[c]||{_errors:[]},o[c]._errors.push(t(i))):o[c]=o[c]||{_errors:[]},o=o[c],u++}}};return a(this),r}toString(){return this.message}get message(){return JSON.stringify(this.issues,U.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){let t={},r=[];for(let a of this.issues)a.path.length>0?(t[a.path[0]]=t[a.path[0]]||[],t[a.path[0]].push(e(a))):r.push(e(a));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}};Ee.create=n=>new Ee(n);var Qn=(n,e)=>{let t;switch(n.code){case b.invalid_type:n.received===v.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case b.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,U.jsonStringifyReplacer)}`;break;case b.unrecognized_keys:t=`Unrecognized key(s) in object: ${U.joinValues(n.keys,", ")}`;break;case b.invalid_union:t="Invalid input";break;case b.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${U.joinValues(n.options)}`;break;case b.invalid_enum_value:t=`Invalid enum value. Expected ${U.joinValues(n.options)}, received '${n.received}'`;break;case b.invalid_arguments:t="Invalid function arguments";break;case b.invalid_return_type:t="Invalid function return type";break;case b.invalid_date:t="Invalid date";break;case b.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:U.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case b.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case b.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case b.custom:t="Invalid input";break;case b.invalid_intersection_types:t="Intersection results could not be merged";break;case b.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case b.not_finite:t="Number must be finite";break;default:t=e.defaultError,U.assertNever(n)}return{message:t}},Ac=Qn;function kp(n){Ac=n}function fs(){return Ac}var ms=n=>{let{data:e,path:t,errorMaps:r,issueData:a}=n,s=[...t,...a.path||[]],i={...a,path:s},o="",u=r.filter(c=>!!c).slice().reverse();for(let c of u)o=c(i,{data:e,defaultError:o}).message;return{...a,path:s,message:a.message||o}},Np=[];function x(n,e){let t=ms({issueData:e,data:n.data,path:n.path,errorMaps:[n.common.contextualErrorMap,n.schemaErrorMap,fs(),Qn].filter(r=>!!r)});n.common.issues.push(t)}var de=class n{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(e,t){let r=[];for(let a of t){if(a.status==="aborted")return T;a.status==="dirty"&&e.dirty(),r.push(a.value)}return{status:e.value,value:r}}static async mergeObjectAsync(e,t){let r=[];for(let a of t)r.push({key:await a.key,value:await a.value});return n.mergeObjectSync(e,r)}static mergeObjectSync(e,t){let r={};for(let a of t){let{key:s,value:i}=a;if(s.status==="aborted"||i.status==="aborted")return T;s.status==="dirty"&&e.dirty(),i.status==="dirty"&&e.dirty(),s.value!=="__proto__"&&(typeof i.value!="undefined"||a.alwaysSet)&&(r[s.value]=i.value)}return{status:e.value,value:r}}},T=Object.freeze({status:"aborted"}),Ec=n=>({status:"dirty",value:n}),me=n=>({status:"valid",value:n}),no=n=>n.status==="aborted",ao=n=>n.status==="dirty",ea=n=>n.status==="valid",gs=n=>typeof Promise!="undefined"&&n instanceof Promise,E;(function(n){n.errToObj=e=>typeof e=="string"?{message:e}:e||{},n.toString=e=>typeof e=="string"?e:e==null?void 0:e.message})(E||(E={}));var ke=class{constructor(e,t,r,a){this._cachedPath=[],this.parent=e,this.data=t,this._path=r,this._key=a}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}},vc=(n,e)=>{if(ea(e))return{success:!0,data:e.value};if(!n.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;let t=new Ee(n.common.issues);return this._error=t,this._error}}};function N(n){if(!n)return{};let{errorMap:e,invalid_type_error:t,required_error:r,description:a}=n;if(e&&(t||r))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return e?{errorMap:e,description:a}:{errorMap:(i,o)=>i.code!=="invalid_type"?{message:o.defaultError}:typeof o.data=="undefined"?{message:r!=null?r:o.defaultError}:{message:t!=null?t:o.defaultError},description:a}}var R=class{constructor(e){this.spa=this.safeParseAsync,this._def=e,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(e){return Ct(e.data)}_getOrReturnCtx(e,t){return t||{common:e.parent.common,data:e.data,parsedType:Ct(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}_processInputParams(e){return{status:new de,ctx:{common:e.parent.common,data:e.data,parsedType:Ct(e.data),schemaErrorMap:this._def.errorMap,path:e.path,parent:e.parent}}}_parseSync(e){let t=this._parse(e);if(gs(t))throw new Error("Synchronous parse encountered promise.");return t}_parseAsync(e){let t=this._parse(e);return Promise.resolve(t)}parse(e,t){let r=this.safeParse(e,t);if(r.success)return r.data;throw r.error}safeParse(e,t){var r;let a={common:{issues:[],async:(r=t==null?void 0:t.async)!==null&&r!==void 0?r:!1,contextualErrorMap:t==null?void 0:t.errorMap},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ct(e)},s=this._parseSync({data:e,path:a.path,parent:a});return vc(a,s)}async parseAsync(e,t){let r=await this.safeParseAsync(e,t);if(r.success)return r.data;throw r.error}async safeParseAsync(e,t){let r={common:{issues:[],contextualErrorMap:t==null?void 0:t.errorMap,async:!0},path:(t==null?void 0:t.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:e,parsedType:Ct(e)},a=this._parse({data:e,path:r.path,parent:r}),s=await(gs(a)?a:Promise.resolve(a));return vc(r,s)}refine(e,t){let r=a=>typeof t=="string"||typeof t=="undefined"?{message:t}:typeof t=="function"?t(a):t;return this._refinement((a,s)=>{let i=e(a),o=()=>s.addIssue({code:b.custom,...r(a)});return typeof Promise!="undefined"&&i instanceof Promise?i.then(u=>u?!0:(o(),!1)):i?!0:(o(),!1)})}refinement(e,t){return this._refinement((r,a)=>e(r)?!0:(a.addIssue(typeof t=="function"?t(r,a):t),!1))}_refinement(e){return new Pe({schema:this,typeName:f.ZodEffects,effect:{type:"refinement",refinement:e}})}superRefine(e){return this._refinement(e)}optional(){return Le.create(this,this._def)}nullable(){return lt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return ct.create(this,this._def)}promise(){return Nt.create(this,this._def)}or(e){return yr.create([this,e],this._def)}and(e){return br.create(this,e,this._def)}transform(e){return new Pe({...N(this._def),schema:this,typeName:f.ZodEffects,effect:{type:"transform",transform:e}})}default(e){let t=typeof e=="function"?e:()=>e;return new Ar({...N(this._def),innerType:this,defaultValue:t,typeName:f.ZodDefault})}brand(){return new ws({typeName:f.ZodBranded,type:this,...N(this._def)})}catch(e){let t=typeof e=="function"?e:()=>e;return new pn({...N(this._def),innerType:this,catchValue:t,typeName:f.ZodCatch})}describe(e){let t=this.constructor;return new t({...this._def,description:e})}pipe(e){return ta.create(this,e)}readonly(){return mn.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}},Rp=/^c[^\s-]{8,}$/i,jp=/^[a-z][a-z0-9]*$/,$p=/^[0-9A-HJKMNP-TV-Z]{26}$/,Mp=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,Dp=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,Lp="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",to,Fp=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,zp=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,Up=n=>n.precision?n.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${n.precision}}Z$`):n.precision===0?n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):n.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function Bp(n,e){return!!((e==="v4"||!e)&&Fp.test(n)||(e==="v6"||!e)&&zp.test(n))}var St=class n extends R{_parse(e){if(this._def.coerce&&(e.data=String(e.data)),this._getType(e)!==v.string){let s=this._getOrReturnCtx(e);return x(s,{code:b.invalid_type,expected:v.string,received:s.parsedType}),T}let r=new de,a;for(let s of this._def.checks)if(s.kind==="min")e.data.length<s.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:b.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="max")e.data.length>s.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:b.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!1,message:s.message}),r.dirty());else if(s.kind==="length"){let i=e.data.length>s.value,o=e.data.length<s.value;(i||o)&&(a=this._getOrReturnCtx(e,a),i?x(a,{code:b.too_big,maximum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}):o&&x(a,{code:b.too_small,minimum:s.value,type:"string",inclusive:!0,exact:!0,message:s.message}),r.dirty())}else if(s.kind==="email")Dp.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"email",code:b.invalid_string,message:s.message}),r.dirty());else if(s.kind==="emoji")to||(to=new RegExp(Lp,"u")),to.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"emoji",code:b.invalid_string,message:s.message}),r.dirty());else if(s.kind==="uuid")Mp.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"uuid",code:b.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid")Rp.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"cuid",code:b.invalid_string,message:s.message}),r.dirty());else if(s.kind==="cuid2")jp.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"cuid2",code:b.invalid_string,message:s.message}),r.dirty());else if(s.kind==="ulid")$p.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"ulid",code:b.invalid_string,message:s.message}),r.dirty());else if(s.kind==="url")try{new URL(e.data)}catch(i){a=this._getOrReturnCtx(e,a),x(a,{validation:"url",code:b.invalid_string,message:s.message}),r.dirty()}else s.kind==="regex"?(s.regex.lastIndex=0,s.regex.test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"regex",code:b.invalid_string,message:s.message}),r.dirty())):s.kind==="trim"?e.data=e.data.trim():s.kind==="includes"?e.data.includes(s.value,s.position)||(a=this._getOrReturnCtx(e,a),x(a,{code:b.invalid_string,validation:{includes:s.value,position:s.position},message:s.message}),r.dirty()):s.kind==="toLowerCase"?e.data=e.data.toLowerCase():s.kind==="toUpperCase"?e.data=e.data.toUpperCase():s.kind==="startsWith"?e.data.startsWith(s.value)||(a=this._getOrReturnCtx(e,a),x(a,{code:b.invalid_string,validation:{startsWith:s.value},message:s.message}),r.dirty()):s.kind==="endsWith"?e.data.endsWith(s.value)||(a=this._getOrReturnCtx(e,a),x(a,{code:b.invalid_string,validation:{endsWith:s.value},message:s.message}),r.dirty()):s.kind==="datetime"?Up(s).test(e.data)||(a=this._getOrReturnCtx(e,a),x(a,{code:b.invalid_string,validation:"datetime",message:s.message}),r.dirty()):s.kind==="ip"?Bp(e.data,s.version)||(a=this._getOrReturnCtx(e,a),x(a,{validation:"ip",code:b.invalid_string,message:s.message}),r.dirty()):U.assertNever(s);return{status:r.value,value:e.data}}_regex(e,t,r){return this.refinement(a=>e.test(a),{validation:t,code:b.invalid_string,...E.errToObj(r)})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}email(e){return this._addCheck({kind:"email",...E.errToObj(e)})}url(e){return this._addCheck({kind:"url",...E.errToObj(e)})}emoji(e){return this._addCheck({kind:"emoji",...E.errToObj(e)})}uuid(e){return this._addCheck({kind:"uuid",...E.errToObj(e)})}cuid(e){return this._addCheck({kind:"cuid",...E.errToObj(e)})}cuid2(e){return this._addCheck({kind:"cuid2",...E.errToObj(e)})}ulid(e){return this._addCheck({kind:"ulid",...E.errToObj(e)})}ip(e){return this._addCheck({kind:"ip",...E.errToObj(e)})}datetime(e){var t;return typeof e=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:e}):this._addCheck({kind:"datetime",precision:typeof(e==null?void 0:e.precision)=="undefined"?null:e==null?void 0:e.precision,offset:(t=e==null?void 0:e.offset)!==null&&t!==void 0?t:!1,...E.errToObj(e==null?void 0:e.message)})}regex(e,t){return this._addCheck({kind:"regex",regex:e,...E.errToObj(t)})}includes(e,t){return this._addCheck({kind:"includes",value:e,position:t==null?void 0:t.position,...E.errToObj(t==null?void 0:t.message)})}startsWith(e,t){return this._addCheck({kind:"startsWith",value:e,...E.errToObj(t)})}endsWith(e,t){return this._addCheck({kind:"endsWith",value:e,...E.errToObj(t)})}min(e,t){return this._addCheck({kind:"min",value:e,...E.errToObj(t)})}max(e,t){return this._addCheck({kind:"max",value:e,...E.errToObj(t)})}length(e,t){return this._addCheck({kind:"length",value:e,...E.errToObj(t)})}nonempty(e){return this.min(1,E.errToObj(e))}trim(){return new n({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new n({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(e=>e.kind==="datetime")}get isEmail(){return!!this._def.checks.find(e=>e.kind==="email")}get isURL(){return!!this._def.checks.find(e=>e.kind==="url")}get isEmoji(){return!!this._def.checks.find(e=>e.kind==="emoji")}get isUUID(){return!!this._def.checks.find(e=>e.kind==="uuid")}get isCUID(){return!!this._def.checks.find(e=>e.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(e=>e.kind==="cuid2")}get isULID(){return!!this._def.checks.find(e=>e.kind==="ulid")}get isIP(){return!!this._def.checks.find(e=>e.kind==="ip")}get minLength(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxLength(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};St.create=n=>{var e;return new St({checks:[],typeName:f.ZodString,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...N(n)})};function Hp(n,e){let t=(n.toString().split(".")[1]||"").length,r=(e.toString().split(".")[1]||"").length,a=t>r?t:r,s=parseInt(n.toFixed(a).replace(".","")),i=parseInt(e.toFixed(a).replace(".",""));return s%i/Math.pow(10,a)}var dr=class n extends R{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(e){if(this._def.coerce&&(e.data=Number(e.data)),this._getType(e)!==v.number){let s=this._getOrReturnCtx(e);return x(s,{code:b.invalid_type,expected:v.number,received:s.parsedType}),T}let r,a=new de;for(let s of this._def.checks)s.kind==="int"?U.isInteger(e.data)||(r=this._getOrReturnCtx(e,r),x(r,{code:b.invalid_type,expected:"integer",received:"float",message:s.message}),a.dirty()):s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:b.too_small,minimum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:b.too_big,maximum:s.value,type:"number",inclusive:s.inclusive,exact:!1,message:s.message}),a.dirty()):s.kind==="multipleOf"?Hp(e.data,s.value)!==0&&(r=this._getOrReturnCtx(e,r),x(r,{code:b.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):s.kind==="finite"?Number.isFinite(e.data)||(r=this._getOrReturnCtx(e,r),x(r,{code:b.not_finite,message:s.message}),a.dirty()):U.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}int(e){return this._addCheck({kind:"int",message:E.toString(e)})}positive(e){return this._addCheck({kind:"min",value:0,inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:0,inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:0,inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:0,inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}finite(e){return this._addCheck({kind:"finite",message:E.toString(e)})}safe(e){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:E.toString(e)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:E.toString(e)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}get isInt(){return!!this._def.checks.find(e=>e.kind==="int"||e.kind==="multipleOf"&&U.isInteger(e.value))}get isFinite(){let e=null,t=null;for(let r of this._def.checks){if(r.kind==="finite"||r.kind==="int"||r.kind==="multipleOf")return!0;r.kind==="min"?(t===null||r.value>t)&&(t=r.value):r.kind==="max"&&(e===null||r.value<e)&&(e=r.value)}return Number.isFinite(t)&&Number.isFinite(e)}};dr.create=n=>new dr({checks:[],typeName:f.ZodNumber,coerce:(n==null?void 0:n.coerce)||!1,...N(n)});var hr=class n extends R{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(e){if(this._def.coerce&&(e.data=BigInt(e.data)),this._getType(e)!==v.bigint){let s=this._getOrReturnCtx(e);return x(s,{code:b.invalid_type,expected:v.bigint,received:s.parsedType}),T}let r,a=new de;for(let s of this._def.checks)s.kind==="min"?(s.inclusive?e.data<s.value:e.data<=s.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:b.too_small,type:"bigint",minimum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="max"?(s.inclusive?e.data>s.value:e.data>=s.value)&&(r=this._getOrReturnCtx(e,r),x(r,{code:b.too_big,type:"bigint",maximum:s.value,inclusive:s.inclusive,message:s.message}),a.dirty()):s.kind==="multipleOf"?e.data%s.value!==BigInt(0)&&(r=this._getOrReturnCtx(e,r),x(r,{code:b.not_multiple_of,multipleOf:s.value,message:s.message}),a.dirty()):U.assertNever(s);return{status:a.value,value:e.data}}gte(e,t){return this.setLimit("min",e,!0,E.toString(t))}gt(e,t){return this.setLimit("min",e,!1,E.toString(t))}lte(e,t){return this.setLimit("max",e,!0,E.toString(t))}lt(e,t){return this.setLimit("max",e,!1,E.toString(t))}setLimit(e,t,r,a){return new n({...this._def,checks:[...this._def.checks,{kind:e,value:t,inclusive:r,message:E.toString(a)}]})}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}positive(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:E.toString(e)})}negative(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:E.toString(e)})}nonpositive(e){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:E.toString(e)})}nonnegative(e){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:E.toString(e)})}multipleOf(e,t){return this._addCheck({kind:"multipleOf",value:e,message:E.toString(t)})}get minValue(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e}get maxValue(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e}};hr.create=n=>{var e;return new hr({checks:[],typeName:f.ZodBigInt,coerce:(e=n==null?void 0:n.coerce)!==null&&e!==void 0?e:!1,...N(n)})};var pr=class extends R{_parse(e){if(this._def.coerce&&(e.data=!!e.data),this._getType(e)!==v.boolean){let r=this._getOrReturnCtx(e);return x(r,{code:b.invalid_type,expected:v.boolean,received:r.parsedType}),T}return me(e.data)}};pr.create=n=>new pr({typeName:f.ZodBoolean,coerce:(n==null?void 0:n.coerce)||!1,...N(n)});var fr=class n extends R{_parse(e){if(this._def.coerce&&(e.data=new Date(e.data)),this._getType(e)!==v.date){let s=this._getOrReturnCtx(e);return x(s,{code:b.invalid_type,expected:v.date,received:s.parsedType}),T}if(isNaN(e.data.getTime())){let s=this._getOrReturnCtx(e);return x(s,{code:b.invalid_date}),T}let r=new de,a;for(let s of this._def.checks)s.kind==="min"?e.data.getTime()<s.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:b.too_small,message:s.message,inclusive:!0,exact:!1,minimum:s.value,type:"date"}),r.dirty()):s.kind==="max"?e.data.getTime()>s.value&&(a=this._getOrReturnCtx(e,a),x(a,{code:b.too_big,message:s.message,inclusive:!0,exact:!1,maximum:s.value,type:"date"}),r.dirty()):U.assertNever(s);return{status:r.value,value:new Date(e.data.getTime())}}_addCheck(e){return new n({...this._def,checks:[...this._def.checks,e]})}min(e,t){return this._addCheck({kind:"min",value:e.getTime(),message:E.toString(t)})}max(e,t){return this._addCheck({kind:"max",value:e.getTime(),message:E.toString(t)})}get minDate(){let e=null;for(let t of this._def.checks)t.kind==="min"&&(e===null||t.value>e)&&(e=t.value);return e!=null?new Date(e):null}get maxDate(){let e=null;for(let t of this._def.checks)t.kind==="max"&&(e===null||t.value<e)&&(e=t.value);return e!=null?new Date(e):null}};fr.create=n=>new fr({checks:[],coerce:(n==null?void 0:n.coerce)||!1,typeName:f.ZodDate,...N(n)});var cn=class extends R{_parse(e){if(this._getType(e)!==v.symbol){let r=this._getOrReturnCtx(e);return x(r,{code:b.invalid_type,expected:v.symbol,received:r.parsedType}),T}return me(e.data)}};cn.create=n=>new cn({typeName:f.ZodSymbol,...N(n)});var mr=class extends R{_parse(e){if(this._getType(e)!==v.undefined){let r=this._getOrReturnCtx(e);return x(r,{code:b.invalid_type,expected:v.undefined,received:r.parsedType}),T}return me(e.data)}};mr.create=n=>new mr({typeName:f.ZodUndefined,...N(n)});var gr=class extends R{_parse(e){if(this._getType(e)!==v.null){let r=this._getOrReturnCtx(e);return x(r,{code:b.invalid_type,expected:v.null,received:r.parsedType}),T}return me(e.data)}};gr.create=n=>new gr({typeName:f.ZodNull,...N(n)});var kt=class extends R{constructor(){super(...arguments),this._any=!0}_parse(e){return me(e.data)}};kt.create=n=>new kt({typeName:f.ZodAny,...N(n)});var ut=class extends R{constructor(){super(...arguments),this._unknown=!0}_parse(e){return me(e.data)}};ut.create=n=>new ut({typeName:f.ZodUnknown,...N(n)});var Fe=class extends R{_parse(e){let t=this._getOrReturnCtx(e);return x(t,{code:b.invalid_type,expected:v.never,received:t.parsedType}),T}};Fe.create=n=>new Fe({typeName:f.ZodNever,...N(n)});var ln=class extends R{_parse(e){if(this._getType(e)!==v.undefined){let r=this._getOrReturnCtx(e);return x(r,{code:b.invalid_type,expected:v.void,received:r.parsedType}),T}return me(e.data)}};ln.create=n=>new ln({typeName:f.ZodVoid,...N(n)});var ct=class n extends R{_parse(e){let{ctx:t,status:r}=this._processInputParams(e),a=this._def;if(t.parsedType!==v.array)return x(t,{code:b.invalid_type,expected:v.array,received:t.parsedType}),T;if(a.exactLength!==null){let i=t.data.length>a.exactLength.value,o=t.data.length<a.exactLength.value;(i||o)&&(x(t,{code:i?b.too_big:b.too_small,minimum:o?a.exactLength.value:void 0,maximum:i?a.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:a.exactLength.message}),r.dirty())}if(a.minLength!==null&&t.data.length<a.minLength.value&&(x(t,{code:b.too_small,minimum:a.minLength.value,type:"array",inclusive:!0,exact:!1,message:a.minLength.message}),r.dirty()),a.maxLength!==null&&t.data.length>a.maxLength.value&&(x(t,{code:b.too_big,maximum:a.maxLength.value,type:"array",inclusive:!0,exact:!1,message:a.maxLength.message}),r.dirty()),t.common.async)return Promise.all([...t.data].map((i,o)=>a.type._parseAsync(new ke(t,i,t.path,o)))).then(i=>de.mergeArray(r,i));let s=[...t.data].map((i,o)=>a.type._parseSync(new ke(t,i,t.path,o)));return de.mergeArray(r,s)}get element(){return this._def.type}min(e,t){return new n({...this._def,minLength:{value:e,message:E.toString(t)}})}max(e,t){return new n({...this._def,maxLength:{value:e,message:E.toString(t)}})}length(e,t){return new n({...this._def,exactLength:{value:e,message:E.toString(t)}})}nonempty(e){return this.min(1,e)}};ct.create=(n,e)=>new ct({type:n,minLength:null,maxLength:null,exactLength:null,typeName:f.ZodArray,...N(e)});function un(n){if(n instanceof we){let e={};for(let t in n.shape){let r=n.shape[t];e[t]=Le.create(un(r))}return new we({...n._def,shape:()=>e})}else return n instanceof ct?new ct({...n._def,type:un(n.element)}):n instanceof Le?Le.create(un(n.unwrap())):n instanceof lt?lt.create(un(n.unwrap())):n instanceof Je?Je.create(n.items.map(e=>un(e))):n}var we=class n extends R{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;let e=this._def.shape(),t=U.objectKeys(e);return this._cached={shape:e,keys:t}}_parse(e){if(this._getType(e)!==v.object){let c=this._getOrReturnCtx(e);return x(c,{code:b.invalid_type,expected:v.object,received:c.parsedType}),T}let{status:r,ctx:a}=this._processInputParams(e),{shape:s,keys:i}=this._getCached(),o=[];if(!(this._def.catchall instanceof Fe&&this._def.unknownKeys==="strip"))for(let c in a.data)i.includes(c)||o.push(c);let u=[];for(let c of i){let l=s[c],d=a.data[c];u.push({key:{status:"valid",value:c},value:l._parse(new ke(a,d,a.path,c)),alwaysSet:c in a.data})}if(this._def.catchall instanceof Fe){let c=this._def.unknownKeys;if(c==="passthrough")for(let l of o)u.push({key:{status:"valid",value:l},value:{status:"valid",value:a.data[l]}});else if(c==="strict")o.length>0&&(x(a,{code:b.unrecognized_keys,keys:o}),r.dirty());else if(c!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{let c=this._def.catchall;for(let l of o){let d=a.data[l];u.push({key:{status:"valid",value:l},value:c._parse(new ke(a,d,a.path,l)),alwaysSet:l in a.data})}}return a.common.async?Promise.resolve().then(async()=>{let c=[];for(let l of u){let d=await l.key;c.push({key:d,value:await l.value,alwaysSet:l.alwaysSet})}return c}).then(c=>de.mergeObjectSync(r,c)):de.mergeObjectSync(r,u)}get shape(){return this._def.shape()}strict(e){return E.errToObj,new n({...this._def,unknownKeys:"strict",...e!==void 0?{errorMap:(t,r)=>{var a,s,i,o;let u=(i=(s=(a=this._def).errorMap)===null||s===void 0?void 0:s.call(a,t,r).message)!==null&&i!==void 0?i:r.defaultError;return t.code==="unrecognized_keys"?{message:(o=E.errToObj(e).message)!==null&&o!==void 0?o:u}:{message:u}}}:{}})}strip(){return new n({...this._def,unknownKeys:"strip"})}passthrough(){return new n({...this._def,unknownKeys:"passthrough"})}extend(e){return new n({...this._def,shape:()=>({...this._def.shape(),...e})})}merge(e){return new n({unknownKeys:e._def.unknownKeys,catchall:e._def.catchall,shape:()=>({...this._def.shape(),...e._def.shape()}),typeName:f.ZodObject})}setKey(e,t){return this.augment({[e]:t})}catchall(e){return new n({...this._def,catchall:e})}pick(e){let t={};return U.objectKeys(e).forEach(r=>{e[r]&&this.shape[r]&&(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}omit(e){let t={};return U.objectKeys(this.shape).forEach(r=>{e[r]||(t[r]=this.shape[r])}),new n({...this._def,shape:()=>t})}deepPartial(){return un(this)}partial(e){let t={};return U.objectKeys(this.shape).forEach(r=>{let a=this.shape[r];e&&!e[r]?t[r]=a:t[r]=a.optional()}),new n({...this._def,shape:()=>t})}required(e){let t={};return U.objectKeys(this.shape).forEach(r=>{if(e&&!e[r])t[r]=this.shape[r];else{let s=this.shape[r];for(;s instanceof Le;)s=s._def.innerType;t[r]=s}}),new n({...this._def,shape:()=>t})}keyof(){return Pc(U.objectKeys(this.shape))}};we.create=(n,e)=>new we({shape:()=>n,unknownKeys:"strip",catchall:Fe.create(),typeName:f.ZodObject,...N(e)});we.strictCreate=(n,e)=>new we({shape:()=>n,unknownKeys:"strict",catchall:Fe.create(),typeName:f.ZodObject,...N(e)});we.lazycreate=(n,e)=>new we({shape:n,unknownKeys:"strip",catchall:Fe.create(),typeName:f.ZodObject,...N(e)});var yr=class extends R{_parse(e){let{ctx:t}=this._processInputParams(e),r=this._def.options;function a(s){for(let o of s)if(o.result.status==="valid")return o.result;for(let o of s)if(o.result.status==="dirty")return t.common.issues.push(...o.ctx.common.issues),o.result;let i=s.map(o=>new Ee(o.ctx.common.issues));return x(t,{code:b.invalid_union,unionErrors:i}),T}if(t.common.async)return Promise.all(r.map(async s=>{let i={...t,common:{...t.common,issues:[]},parent:null};return{result:await s._parseAsync({data:t.data,path:t.path,parent:i}),ctx:i}})).then(a);{let s,i=[];for(let u of r){let c={...t,common:{...t.common,issues:[]},parent:null},l=u._parseSync({data:t.data,path:t.path,parent:c});if(l.status==="valid")return l;l.status==="dirty"&&!s&&(s={result:l,ctx:c}),c.common.issues.length&&i.push(c.common.issues)}if(s)return t.common.issues.push(...s.ctx.common.issues),s.result;let o=i.map(u=>new Ee(u));return x(t,{code:b.invalid_union,unionErrors:o}),T}}get options(){return this._def.options}};yr.create=(n,e)=>new yr({options:n,typeName:f.ZodUnion,...N(e)});var ps=n=>n instanceof _r?ps(n.schema):n instanceof Pe?ps(n.innerType()):n instanceof wr?[n.value]:n instanceof vr?n.options:n instanceof xr?Object.keys(n.enum):n instanceof Ar?ps(n._def.innerType):n instanceof mr?[void 0]:n instanceof gr?[null]:null,ys=class n extends R{_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==v.object)return x(t,{code:b.invalid_type,expected:v.object,received:t.parsedType}),T;let r=this.discriminator,a=t.data[r],s=this.optionsMap.get(a);return s?t.common.async?s._parseAsync({data:t.data,path:t.path,parent:t}):s._parseSync({data:t.data,path:t.path,parent:t}):(x(t,{code:b.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[r]}),T)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(e,t,r){let a=new Map;for(let s of t){let i=ps(s.shape[e]);if(!i)throw new Error(`A discriminator value for key \`${e}\` could not be extracted from all schema options`);for(let o of i){if(a.has(o))throw new Error(`Discriminator property ${String(e)} has duplicate value ${String(o)}`);a.set(o,s)}}return new n({typeName:f.ZodDiscriminatedUnion,discriminator:e,options:t,optionsMap:a,...N(r)})}};function so(n,e){let t=Ct(n),r=Ct(e);if(n===e)return{valid:!0,data:n};if(t===v.object&&r===v.object){let a=U.objectKeys(e),s=U.objectKeys(n).filter(o=>a.indexOf(o)!==-1),i={...n,...e};for(let o of s){let u=so(n[o],e[o]);if(!u.valid)return{valid:!1};i[o]=u.data}return{valid:!0,data:i}}else if(t===v.array&&r===v.array){if(n.length!==e.length)return{valid:!1};let a=[];for(let s=0;s<n.length;s++){let i=n[s],o=e[s],u=so(i,o);if(!u.valid)return{valid:!1};a.push(u.data)}return{valid:!0,data:a}}else return t===v.date&&r===v.date&&+n==+e?{valid:!0,data:n}:{valid:!1}}var br=class extends R{_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=(s,i)=>{if(no(s)||no(i))return T;let o=so(s.value,i.value);return o.valid?((ao(s)||ao(i))&&t.dirty(),{status:t.value,value:o.data}):(x(r,{code:b.invalid_intersection_types}),T)};return r.common.async?Promise.all([this._def.left._parseAsync({data:r.data,path:r.path,parent:r}),this._def.right._parseAsync({data:r.data,path:r.path,parent:r})]).then(([s,i])=>a(s,i)):a(this._def.left._parseSync({data:r.data,path:r.path,parent:r}),this._def.right._parseSync({data:r.data,path:r.path,parent:r}))}};br.create=(n,e,t)=>new br({left:n,right:e,typeName:f.ZodIntersection,...N(t)});var Je=class n extends R{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.array)return x(r,{code:b.invalid_type,expected:v.array,received:r.parsedType}),T;if(r.data.length<this._def.items.length)return x(r,{code:b.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),T;!this._def.rest&&r.data.length>this._def.items.length&&(x(r,{code:b.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),t.dirty());let s=[...r.data].map((i,o)=>{let u=this._def.items[o]||this._def.rest;return u?u._parse(new ke(r,i,r.path,o)):null}).filter(i=>!!i);return r.common.async?Promise.all(s).then(i=>de.mergeArray(t,i)):de.mergeArray(t,s)}get items(){return this._def.items}rest(e){return new n({...this._def,rest:e})}};Je.create=(n,e)=>{if(!Array.isArray(n))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Je({items:n,typeName:f.ZodTuple,rest:null,...N(e)})};var bs=class n extends R{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.object)return x(r,{code:b.invalid_type,expected:v.object,received:r.parsedType}),T;let a=[],s=this._def.keyType,i=this._def.valueType;for(let o in r.data)a.push({key:s._parse(new ke(r,o,r.path,o)),value:i._parse(new ke(r,r.data[o],r.path,o))});return r.common.async?de.mergeObjectAsync(t,a):de.mergeObjectSync(t,a)}get element(){return this._def.valueType}static create(e,t,r){return t instanceof R?new n({keyType:e,valueType:t,typeName:f.ZodRecord,...N(r)}):new n({keyType:St.create(),valueType:e,typeName:f.ZodRecord,...N(t)})}},dn=class extends R{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.map)return x(r,{code:b.invalid_type,expected:v.map,received:r.parsedType}),T;let a=this._def.keyType,s=this._def.valueType,i=[...r.data.entries()].map(([o,u],c)=>({key:a._parse(new ke(r,o,r.path,[c,"key"])),value:s._parse(new ke(r,u,r.path,[c,"value"]))}));if(r.common.async){let o=new Map;return Promise.resolve().then(async()=>{for(let u of i){let c=await u.key,l=await u.value;if(c.status==="aborted"||l.status==="aborted")return T;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}})}else{let o=new Map;for(let u of i){let c=u.key,l=u.value;if(c.status==="aborted"||l.status==="aborted")return T;(c.status==="dirty"||l.status==="dirty")&&t.dirty(),o.set(c.value,l.value)}return{status:t.value,value:o}}}};dn.create=(n,e,t)=>new dn({valueType:e,keyType:n,typeName:f.ZodMap,...N(t)});var hn=class n extends R{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.parsedType!==v.set)return x(r,{code:b.invalid_type,expected:v.set,received:r.parsedType}),T;let a=this._def;a.minSize!==null&&r.data.size<a.minSize.value&&(x(r,{code:b.too_small,minimum:a.minSize.value,type:"set",inclusive:!0,exact:!1,message:a.minSize.message}),t.dirty()),a.maxSize!==null&&r.data.size>a.maxSize.value&&(x(r,{code:b.too_big,maximum:a.maxSize.value,type:"set",inclusive:!0,exact:!1,message:a.maxSize.message}),t.dirty());let s=this._def.valueType;function i(u){let c=new Set;for(let l of u){if(l.status==="aborted")return T;l.status==="dirty"&&t.dirty(),c.add(l.value)}return{status:t.value,value:c}}let o=[...r.data.values()].map((u,c)=>s._parse(new ke(r,u,r.path,c)));return r.common.async?Promise.all(o).then(u=>i(u)):i(o)}min(e,t){return new n({...this._def,minSize:{value:e,message:E.toString(t)}})}max(e,t){return new n({...this._def,maxSize:{value:e,message:E.toString(t)}})}size(e,t){return this.min(e,t).max(e,t)}nonempty(e){return this.min(1,e)}};hn.create=(n,e)=>new hn({valueType:n,minSize:null,maxSize:null,typeName:f.ZodSet,...N(e)});var _s=class n extends R{constructor(){super(...arguments),this.validate=this.implement}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==v.function)return x(t,{code:b.invalid_type,expected:v.function,received:t.parsedType}),T;function r(o,u){return ms({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,fs(),Qn].filter(c=>!!c),issueData:{code:b.invalid_arguments,argumentsError:u}})}function a(o,u){return ms({data:o,path:t.path,errorMaps:[t.common.contextualErrorMap,t.schemaErrorMap,fs(),Qn].filter(c=>!!c),issueData:{code:b.invalid_return_type,returnTypeError:u}})}let s={errorMap:t.common.contextualErrorMap},i=t.data;if(this._def.returns instanceof Nt){let o=this;return me(async function(...u){let c=new Ee([]),l=await o._def.args.parseAsync(u,s).catch(p=>{throw c.addIssue(r(u,p)),c}),d=await Reflect.apply(i,this,l);return await o._def.returns._def.type.parseAsync(d,s).catch(p=>{throw c.addIssue(a(d,p)),c})})}else{let o=this;return me(function(...u){let c=o._def.args.safeParse(u,s);if(!c.success)throw new Ee([r(u,c.error)]);let l=Reflect.apply(i,this,c.data),d=o._def.returns.safeParse(l,s);if(!d.success)throw new Ee([a(l,d.error)]);return d.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...e){return new n({...this._def,args:Je.create(e).rest(ut.create())})}returns(e){return new n({...this._def,returns:e})}implement(e){return this.parse(e)}strictImplement(e){return this.parse(e)}static create(e,t,r){return new n({args:e||Je.create([]).rest(ut.create()),returns:t||ut.create(),typeName:f.ZodFunction,...N(r)})}},_r=class extends R{get schema(){return this._def.getter()}_parse(e){let{ctx:t}=this._processInputParams(e);return this._def.getter()._parse({data:t.data,path:t.path,parent:t})}};_r.create=(n,e)=>new _r({getter:n,typeName:f.ZodLazy,...N(e)});var wr=class extends R{_parse(e){if(e.data!==this._def.value){let t=this._getOrReturnCtx(e);return x(t,{received:t.data,code:b.invalid_literal,expected:this._def.value}),T}return{status:"valid",value:e.data}}get value(){return this._def.value}};wr.create=(n,e)=>new wr({value:n,typeName:f.ZodLiteral,...N(e)});function Pc(n,e){return new vr({values:n,typeName:f.ZodEnum,...N(e)})}var vr=class n extends R{_parse(e){if(typeof e.data!="string"){let t=this._getOrReturnCtx(e),r=this._def.values;return x(t,{expected:U.joinValues(r),received:t.parsedType,code:b.invalid_type}),T}if(this._def.values.indexOf(e.data)===-1){let t=this._getOrReturnCtx(e),r=this._def.values;return x(t,{received:t.data,code:b.invalid_enum_value,options:r}),T}return me(e.data)}get options(){return this._def.values}get enum(){let e={};for(let t of this._def.values)e[t]=t;return e}get Values(){let e={};for(let t of this._def.values)e[t]=t;return e}get Enum(){let e={};for(let t of this._def.values)e[t]=t;return e}extract(e){return n.create(e)}exclude(e){return n.create(this.options.filter(t=>!e.includes(t)))}};vr.create=Pc;var xr=class extends R{_parse(e){let t=U.getValidEnumValues(this._def.values),r=this._getOrReturnCtx(e);if(r.parsedType!==v.string&&r.parsedType!==v.number){let a=U.objectValues(t);return x(r,{expected:U.joinValues(a),received:r.parsedType,code:b.invalid_type}),T}if(t.indexOf(e.data)===-1){let a=U.objectValues(t);return x(r,{received:r.data,code:b.invalid_enum_value,options:a}),T}return me(e.data)}get enum(){return this._def.values}};xr.create=(n,e)=>new xr({values:n,typeName:f.ZodNativeEnum,...N(e)});var Nt=class extends R{unwrap(){return this._def.type}_parse(e){let{ctx:t}=this._processInputParams(e);if(t.parsedType!==v.promise&&t.common.async===!1)return x(t,{code:b.invalid_type,expected:v.promise,received:t.parsedType}),T;let r=t.parsedType===v.promise?t.data:Promise.resolve(t.data);return me(r.then(a=>this._def.type.parseAsync(a,{path:t.path,errorMap:t.common.contextualErrorMap})))}};Nt.create=(n,e)=>new Nt({type:n,typeName:f.ZodPromise,...N(e)});var Pe=class extends R{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===f.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(e){let{status:t,ctx:r}=this._processInputParams(e),a=this._def.effect||null,s={addIssue:i=>{x(r,i),i.fatal?t.abort():t.dirty()},get path(){return r.path}};if(s.addIssue=s.addIssue.bind(s),a.type==="preprocess"){let i=a.transform(r.data,s);return r.common.issues.length?{status:"dirty",value:r.data}:r.common.async?Promise.resolve(i).then(o=>this._def.schema._parseAsync({data:o,path:r.path,parent:r})):this._def.schema._parseSync({data:i,path:r.path,parent:r})}if(a.type==="refinement"){let i=o=>{let u=a.refinement(o,s);if(r.common.async)return Promise.resolve(u);if(u instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return o};if(r.common.async===!1){let o=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});return o.status==="aborted"?T:(o.status==="dirty"&&t.dirty(),i(o.value),{status:t.value,value:o.value})}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(o=>o.status==="aborted"?T:(o.status==="dirty"&&t.dirty(),i(o.value).then(()=>({status:t.value,value:o.value}))))}if(a.type==="transform")if(r.common.async===!1){let i=this._def.schema._parseSync({data:r.data,path:r.path,parent:r});if(!ea(i))return i;let o=a.transform(i.value,s);if(o instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:t.value,value:o}}else return this._def.schema._parseAsync({data:r.data,path:r.path,parent:r}).then(i=>ea(i)?Promise.resolve(a.transform(i.value,s)).then(o=>({status:t.value,value:o})):i);U.assertNever(a)}};Pe.create=(n,e,t)=>new Pe({schema:n,typeName:f.ZodEffects,effect:e,...N(t)});Pe.createWithPreprocess=(n,e,t)=>new Pe({schema:e,effect:{type:"preprocess",transform:n},typeName:f.ZodEffects,...N(t)});var Le=class extends R{_parse(e){return this._getType(e)===v.undefined?me(void 0):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};Le.create=(n,e)=>new Le({innerType:n,typeName:f.ZodOptional,...N(e)});var lt=class extends R{_parse(e){return this._getType(e)===v.null?me(null):this._def.innerType._parse(e)}unwrap(){return this._def.innerType}};lt.create=(n,e)=>new lt({innerType:n,typeName:f.ZodNullable,...N(e)});var Ar=class extends R{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return t.parsedType===v.undefined&&(r=this._def.defaultValue()),this._def.innerType._parse({data:r,path:t.path,parent:t})}removeDefault(){return this._def.innerType}};Ar.create=(n,e)=>new Ar({innerType:n,typeName:f.ZodDefault,defaultValue:typeof e.default=="function"?e.default:()=>e.default,...N(e)});var pn=class extends R{_parse(e){let{ctx:t}=this._processInputParams(e),r={...t,common:{...t.common,issues:[]}},a=this._def.innerType._parse({data:r.data,path:r.path,parent:{...r}});return gs(a)?a.then(s=>({status:"valid",value:s.status==="valid"?s.value:this._def.catchValue({get error(){return new Ee(r.common.issues)},input:r.data})})):{status:"valid",value:a.status==="valid"?a.value:this._def.catchValue({get error(){return new Ee(r.common.issues)},input:r.data})}}removeCatch(){return this._def.innerType}};pn.create=(n,e)=>new pn({innerType:n,typeName:f.ZodCatch,catchValue:typeof e.catch=="function"?e.catch:()=>e.catch,...N(e)});var fn=class extends R{_parse(e){if(this._getType(e)!==v.nan){let r=this._getOrReturnCtx(e);return x(r,{code:b.invalid_type,expected:v.nan,received:r.parsedType}),T}return{status:"valid",value:e.data}}};fn.create=n=>new fn({typeName:f.ZodNaN,...N(n)});var Kp=Symbol("zod_brand"),ws=class extends R{_parse(e){let{ctx:t}=this._processInputParams(e),r=t.data;return this._def.type._parse({data:r,path:t.path,parent:t})}unwrap(){return this._def.type}},ta=class n extends R{_parse(e){let{status:t,ctx:r}=this._processInputParams(e);if(r.common.async)return(async()=>{let s=await this._def.in._parseAsync({data:r.data,path:r.path,parent:r});return s.status==="aborted"?T:s.status==="dirty"?(t.dirty(),Ec(s.value)):this._def.out._parseAsync({data:s.value,path:r.path,parent:r})})();{let a=this._def.in._parseSync({data:r.data,path:r.path,parent:r});return a.status==="aborted"?T:a.status==="dirty"?(t.dirty(),{status:"dirty",value:a.value}):this._def.out._parseSync({data:a.value,path:r.path,parent:r})}}static create(e,t){return new n({in:e,out:t,typeName:f.ZodPipeline})}},mn=class extends R{_parse(e){let t=this._def.innerType._parse(e);return ea(t)&&(t.value=Object.freeze(t.value)),t}};mn.create=(n,e)=>new mn({innerType:n,typeName:f.ZodReadonly,...N(e)});var Oc=(n,e={},t)=>n?kt.create().superRefine((r,a)=>{var s,i;if(!n(r)){let o=typeof e=="function"?e(r):typeof e=="string"?{message:e}:e,u=(i=(s=o.fatal)!==null&&s!==void 0?s:t)!==null&&i!==void 0?i:!0,c=typeof o=="string"?{message:o}:o;a.addIssue({code:"custom",...c,fatal:u})}}):kt.create(),qp={object:we.lazycreate},f;(function(n){n.ZodString="ZodString",n.ZodNumber="ZodNumber",n.ZodNaN="ZodNaN",n.ZodBigInt="ZodBigInt",n.ZodBoolean="ZodBoolean",n.ZodDate="ZodDate",n.ZodSymbol="ZodSymbol",n.ZodUndefined="ZodUndefined",n.ZodNull="ZodNull",n.ZodAny="ZodAny",n.ZodUnknown="ZodUnknown",n.ZodNever="ZodNever",n.ZodVoid="ZodVoid",n.ZodArray="ZodArray",n.ZodObject="ZodObject",n.ZodUnion="ZodUnion",n.ZodDiscriminatedUnion="ZodDiscriminatedUnion",n.ZodIntersection="ZodIntersection",n.ZodTuple="ZodTuple",n.ZodRecord="ZodRecord",n.ZodMap="ZodMap",n.ZodSet="ZodSet",n.ZodFunction="ZodFunction",n.ZodLazy="ZodLazy",n.ZodLiteral="ZodLiteral",n.ZodEnum="ZodEnum",n.ZodEffects="ZodEffects",n.ZodNativeEnum="ZodNativeEnum",n.ZodOptional="ZodOptional",n.ZodNullable="ZodNullable",n.ZodDefault="ZodDefault",n.ZodCatch="ZodCatch",n.ZodPromise="ZodPromise",n.ZodBranded="ZodBranded",n.ZodPipeline="ZodPipeline",n.ZodReadonly="ZodReadonly"})(f||(f={}));var Vp=(n,e={message:`Input not instance of ${n.name}`})=>Oc(t=>t instanceof n,e),Ic=St.create,Tc=dr.create,Zp=fn.create,Gp=hr.create,Cc=pr.create,Wp=fr.create,Jp=cn.create,Yp=mr.create,Xp=gr.create,Qp=kt.create,ef=ut.create,tf=Fe.create,rf=ln.create,nf=ct.create,af=we.create,sf=we.strictCreate,of=yr.create,uf=ys.create,cf=br.create,lf=Je.create,df=bs.create,hf=dn.create,pf=hn.create,ff=_s.create,mf=_r.create,gf=wr.create,yf=vr.create,bf=xr.create,_f=Nt.create,xc=Pe.create,wf=Le.create,vf=lt.create,xf=Pe.createWithPreprocess,Af=ta.create,Ef=()=>Ic().optional(),Pf=()=>Tc().optional(),Of=()=>Cc().optional(),If={string:n=>St.create({...n,coerce:!0}),number:n=>dr.create({...n,coerce:!0}),boolean:n=>pr.create({...n,coerce:!0}),bigint:n=>hr.create({...n,coerce:!0}),date:n=>fr.create({...n,coerce:!0})},Tf=T,dt=Object.freeze({__proto__:null,defaultErrorMap:Qn,setErrorMap:kp,getErrorMap:fs,makeIssue:ms,EMPTY_PATH:Np,addIssueToContext:x,ParseStatus:de,INVALID:T,DIRTY:Ec,OK:me,isAborted:no,isDirty:ao,isValid:ea,isAsync:gs,get util(){return U},get objectUtil(){return ro},ZodParsedType:v,getParsedType:Ct,ZodType:R,ZodString:St,ZodNumber:dr,ZodBigInt:hr,ZodBoolean:pr,ZodDate:fr,ZodSymbol:cn,ZodUndefined:mr,ZodNull:gr,ZodAny:kt,ZodUnknown:ut,ZodNever:Fe,ZodVoid:ln,ZodArray:ct,ZodObject:we,ZodUnion:yr,ZodDiscriminatedUnion:ys,ZodIntersection:br,ZodTuple:Je,ZodRecord:bs,ZodMap:dn,ZodSet:hn,ZodFunction:_s,ZodLazy:_r,ZodLiteral:wr,ZodEnum:vr,ZodNativeEnum:xr,ZodPromise:Nt,ZodEffects:Pe,ZodTransformer:Pe,ZodOptional:Le,ZodNullable:lt,ZodDefault:Ar,ZodCatch:pn,ZodNaN:fn,BRAND:Kp,ZodBranded:ws,ZodPipeline:ta,ZodReadonly:mn,custom:Oc,Schema:R,ZodSchema:R,late:qp,get ZodFirstPartyTypeKind(){return f},coerce:If,any:Qp,array:nf,bigint:Gp,boolean:Cc,date:Wp,discriminatedUnion:uf,effect:xc,enum:yf,function:ff,instanceof:Vp,intersection:cf,lazy:mf,literal:gf,map:hf,nan:Zp,nativeEnum:bf,never:tf,null:Xp,nullable:vf,number:Tc,object:af,oboolean:Of,onumber:Pf,optional:wf,ostring:Ef,pipeline:Af,preprocess:xf,promise:_f,record:df,set:pf,strictObject:sf,string:Ic,symbol:Jp,transformer:xc,tuple:lf,undefined:Yp,union:of,unknown:ef,void:rf,NEVER:Tf,ZodIssueCode:b,quotelessJson:Sp,ZodError:Ee});var So=je(ns(),1);var vs,Cf=new Uint8Array(16);function io(){if(!vs&&(vs=typeof crypto!="undefined"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!vs))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return vs(Cf)}var Sc=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function Sf(n){return typeof n=="string"&&Sc.test(n)}var ra=Sf;var ie=[];for(let n=0;n<256;++n)ie.push((n+256).toString(16).slice(1));function kc(n,e=0){return ie[n[e+0]]+ie[n[e+1]]+ie[n[e+2]]+ie[n[e+3]]+"-"+ie[n[e+4]]+ie[n[e+5]]+"-"+ie[n[e+6]]+ie[n[e+7]]+"-"+ie[n[e+8]]+ie[n[e+9]]+"-"+ie[n[e+10]]+ie[n[e+11]]+ie[n[e+12]]+ie[n[e+13]]+ie[n[e+14]]+ie[n[e+15]]}var kf=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),oo={randomUUID:kf};function Nf(n,e,t){if(oo.randomUUID&&!e&&!n)return oo.randomUUID();n=n||{};let r=n.random||(n.rng||io)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let a=0;a<16;++a)e[t+a]=r[a];return e}return kc(r)}var ge=Nf;var uo=class{},Er=class n extends uo{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Li(this.constructor)]}constructor(e){var t,r,a,s,i;super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:H("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=(t=e.ignoreLLM)!=null?t:this.ignoreLLM,this.ignoreChain=(r=e.ignoreChain)!=null?r:this.ignoreChain,this.ignoreAgent=(a=e.ignoreAgent)!=null?a:this.ignoreAgent,this.ignoreRetriever=(s=e.ignoreRetriever)!=null?s:this.ignoreRetriever,this.awaitHandlers=(i=e._awaitHandler)!=null?i:this.awaitHandlers)}copy(){return new this.constructor(this)}toJSON(){return $e.prototype.toJSON.call(this)}toJSONNotImplemented(){return $e.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends n{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ge()}),Object.assign(this,e)}}return new t}};var lo=je(Mc(),1);function co(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function jf(n){return n.replace(/[-:.]/g,"")}function $f(n,e){return jf(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}var ze=class extends Er{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}stringifyError(e){return e instanceof Error?e.message+(e!=null&&e.stack?`

${e.stack}`:""):typeof e=="string"?e:`${e}`}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var a;let t=$f(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){let s=this.runMap.get(r.parent_run_id);s&&(this._addChildRun(s,r),s.child_execution_order=Math.max(s.child_execution_order,r.child_execution_order),r.trace_id=s.trace_id,s.dotted_order!==void 0&&(r.dotted_order=[s.dotted_order,t].join(".")))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((a=this.onRunCreate)==null?void 0:a.call(this,r))}async _endTrace(e){var r;let t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){let t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,a,s,i,o,u){var p;let c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{prompts:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return await this._startTrace(h),await((p=this.onLLMStart)==null?void 0:p.call(this,h)),h}async handleChatModelStart(e,t,r,a,s,i,o,u){var p;let c=this._getExecutionOrder(a),l=Date.now(),d=o?{...s,metadata:o}:s,h={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{messages:t},execution_order:c,child_runs:[],child_execution_order:c,run_type:"llm",extra:d!=null?d:{},tags:i||[]};return await this._startTrace(h),await((p=this.onLLMStart)==null?void 0:p.call(this,h)),h}async handleLLMEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onLLMError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,a,s,i,o,u){var h;let c=this._getExecutionOrder(a),l=Date.now(),d={id:r,name:u!=null?u:e.id[e.id.length-1],parent_run_id:a,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:t,execution_order:c,child_execution_order:c,run_type:o!=null?o:"chain",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(d),await((h=this.onChainStart)==null?void 0:h.call(this,d)),d}async handleChainEnd(e,t,r,a,s){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.outputs=co(e,"output"),i.events.push({name:"end",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=co(s.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleChainError(e,t,r,a,s){var o;let i=this.runMap.get(t);if(!i)throw new Error("No chain run to end.");return i.end_time=Date.now(),i.error=this.stringifyError(e),i.events.push({name:"error",time:new Date(i.end_time).toISOString()}),(s==null?void 0:s.inputs)!==void 0&&(i.inputs=co(s.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,i)),await this._endTrace(i),i}async handleToolStart(e,t,r,a,s,i,o){var d;let u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{input:t},execution_order:u,child_execution_order:u,run_type:"tool",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(l),await((d=this.onToolStart)==null?void 0:d.call(this,l)),l}async handleToolEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onToolEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onToolError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var s;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;let a=r;a.actions=a.actions||[],a.actions.push(e),a.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentAction)==null?void 0:s.call(this,r))}async handleAgentEnd(e,t){var a;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((a=this.onAgentEnd)==null?void 0:a.call(this,r)))}async handleRetrieverStart(e,t,r,a,s,i,o){var d;let u=this._getExecutionOrder(a),c=Date.now(),l={id:r,name:o!=null?o:e.id[e.id.length-1],parent_run_id:a,start_time:c,serialized:e,events:[{name:"start",time:new Date(c).toISOString()}],inputs:{query:t},execution_order:u,child_execution_order:u,run_type:"retriever",child_runs:[],extra:i?{metadata:i}:{},tags:s||[]};return await this._startTrace(l),await((d=this.onRetrieverStart)==null?void 0:d.call(this,l)),l}async handleRetrieverEnd(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverEnd)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var a;let r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=this.stringifyError(e),r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((a=this.onRetrieverError)==null?void 0:a.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var a;let r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((a=this.onText)==null?void 0:a.call(this,r)))}async handleLLMNewToken(e,t,r,a,s,i){var u;let o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:i==null?void 0:i.chunk}}),await((u=this.onLLMNewToken)==null?void 0:u.call(this,o,e,{chunk:i==null?void 0:i.chunk})),o}};function ye(n,e){return`${n.open}${e}${n.close}`}function Ue(n,e){try{return JSON.stringify(n,null,2)}catch(t){return e}}function Rt(n){if(!n.end_time)return"";let e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}var{color:ve}=lo.default,na=class extends ze{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){let t=[],r=e;for(;r.parent_run_id;){let a=this.runMap.get(r.parent_run_id);if(a)t.push(a),r=a;else break}return t}getBreadcrumbs(e){let r=[...this.getParents(e).reverse(),e].map((a,s,i)=>{let o=`${a.execution_order}:${a.run_type}:${a.name}`;return s===i.length-1?ye(lo.default.bold,o):o}).join(" > ");return ye(ve.grey,r)}onChainStart(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Ue(e.inputs,"[inputs]")}`)}onChainEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.cyan,"[chain/end]")} [${t}] [${Rt(e)}] Exiting Chain run with output: ${Ue(e.outputs,"[outputs]")}`)}onChainError(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.red,"[chain/error]")} [${t}] [${Rt(e)}] Chain run errored with error: ${Ue(e.error,"[error]")}`)}onLLMStart(e){let t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(a=>a.trim())}:e.inputs;console.log(`${ye(ve.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Ue(r,"[inputs]")}`)}onLLMEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.cyan,"[llm/end]")} [${t}] [${Rt(e)}] Exiting LLM run with output: ${Ue(e.outputs,"[response]")}`)}onLLMError(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.red,"[llm/error]")} [${t}] [${Rt(e)}] LLM run errored with error: ${Ue(e.error,"[error]")}`)}onToolStart(e){var r;let t=this.getBreadcrumbs(e);console.log(`${ye(ve.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,a;let t=this.getBreadcrumbs(e);console.log(`${ye(ve.cyan,"[tool/end]")} [${t}] [${Rt(e)}] Exiting Tool run with output: "${(a=(r=e.outputs)==null?void 0:r.output)==null?void 0:a.trim()}"`)}onToolError(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.red,"[tool/error]")} [${t}] [${Rt(e)}] Tool run errored with error: ${Ue(e.error,"[error]")}`)}onRetrieverStart(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Ue(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.cyan,"[retriever/end]")} [${t}] [${Rt(e)}] Exiting Retriever run with output: ${Ue(e.outputs,"[outputs]")}`)}onRetrieverError(e){let t=this.getBreadcrumbs(e);console.log(`${ye(ve.red,"[retriever/error]")} [${t}] [${Rt(e)}] Retriever run errored with error: ${Ue(e.error,"[error]")}`)}onAgentAction(e){let t=e,r=this.getBreadcrumbs(e);console.log(`${ye(ve.blue,"[agent/action]")} [${r}] Agent selected action: ${Ue(t.actions[t.actions.length-1],"[action]")}`)}};var Dc=je(ns(),1),xs=je(us(),1),Mf=[400,401,403,404,405,406,407,408],Df=[409],aa=class{constructor(e){var r,a;Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedResponseHook",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=(r=e.maxConcurrency)!=null?r:1/0,this.maxRetries=(a=e.maxRetries)!=null?a:6;let t="default"in xs.default?xs.default.default:xs.default;this.queue=new t({concurrency:this.maxConcurrency}),this.onFailedResponseHook=e==null?void 0:e.onFailedResponseHook}call(e,...t){let r=this.onFailedResponseHook;return this.queue.add(()=>(0,Dc.default)(()=>e(...t).catch(a=>{throw a instanceof Error?a:new Error(a)}),{async onFailedAttempt(a){if(a.message.startsWith("Cancel")||a.message.startsWith("TimeoutError")||a.message.startsWith("AbortError")||(a==null?void 0:a.code)==="ECONNABORTED")throw a;let s=a==null?void 0:a.response,i=s==null?void 0:s.status;if(i){if(Mf.includes(+i))throw a;if(Df.includes(+i))return;r&&await r(s)}},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((a,s)=>{var i;(i=e.signal)==null||i.addEventListener("abort",()=>{s(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};function ho(n){return typeof(n==null?void 0:n._getType)=="function"}function po(n){let e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var ht,Lf=()=>typeof window!="undefined"&&typeof window.document!="undefined",Ff=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",zf=()=>typeof window!="undefined"&&window.name==="nodejs"||typeof navigator!="undefined"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),Lc=()=>typeof Deno!="undefined",Uf=()=>typeof process!="undefined"&&typeof process.versions!="undefined"&&typeof process.versions.node!="undefined"&&!Lc(),Bf=()=>ht||(Lf()?ht="browser":Uf()?ht="node":Ff()?ht="webworker":zf()?ht="jsdom":Lc()?ht="deno":ht="other",ht),fo;async function go(){if(fo===void 0){let n=Bf(),e=Kf();fo={library:"langsmith",runtime:n,sdk:"langsmith-js",sdk_version:As,...e}}return fo}function Fc(){let n=Hf()||{},e={},t=["LANGCHAIN_API_KEY","LANGCHAIN_ENDPOINT","LANGCHAIN_TRACING_V2","LANGCHAIN_PROJECT","LANGCHAIN_SESSION"];for(let[r,a]of Object.entries(n))r.startsWith("LANGCHAIN_")&&typeof a=="string"&&!t.includes(r)&&!r.toLowerCase().includes("key")&&!r.toLowerCase().includes("secret")&&!r.toLowerCase().includes("token")&&(r==="LANGCHAIN_REVISION_ID"?e.revision_id=a:e[r]=a);return e}function Hf(){try{return typeof process!="undefined"&&process.env?Object.entries(process.env).reduce((n,[e,t])=>(n[e]=String(t),n),{}):void 0}catch(n){return}}function pt(n){var e;try{return typeof process!="undefined"?(e=process.env)==null?void 0:e[n]:void 0}catch(t){return}}var mo;function Kf(){if(mo!==void 0)return mo;let n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(let t of n){let r=pt(t);r!==void 0&&(e[t]=r)}return mo=e,e}async function zc(n){let e=await go(),t=Fc();return n.map(r=>{var i,o;let a=(i=r.extra)!=null?i:{},s=a.metadata;return r.extra={...a,runtime:{...e,...a==null?void 0:a.runtime},metadata:{...t,...t.revision_id||r.revision_id?{revision_id:(o=r.revision_id)!=null?o:t.revision_id}:{},...s}},r})}var qf=()=>{let n=pt("LANGCHAIN_TRACING_SAMPLING_RATE");if(n===void 0)return;let e=parseFloat(n);if(e<0||e>1)throw new Error(`LANGCHAIN_TRACING_SAMPLING_RATE must be between 0 and 1 if set. Got: ${e}`);return e},Vf=n=>{let t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},jt=async(n,e)=>{let t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function Zf(n){let e=[];for await(let t of n)e.push(t);return e}function yo(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function G(n){if(!ra(n))throw new Error(`Invalid UUID: ${n}`)}var Gf=async n=>{var e;if((n==null?void 0:n.status)===429){let t=parseInt((e=n.headers.get("retry-after"))!=null?e:"30",10)*1e3;if(t>0)return await new Promise(r=>setTimeout(r,t)),!0}return!1},bo=class{constructor(){Object.defineProperty(this,"items",{enumerable:!0,configurable:!0,writable:!0,value:[]})}get size(){return this.items.length}push(e){return new Promise(t=>{this.items.push([e,t])})}pop(e){if(e<1)throw new Error("Number of items to pop off may not be less than 1.");let t=[];for(;t.length<e&&this.items.length;){let r=this.items.shift();if(r)t.push(r);else break}return[t.map(r=>r[0]),()=>t.forEach(r=>r[1]())]}},Wf=20971520,gn=class n{constructor(e={}){var r,a,s,i,o,u,c,l,d,h,p;Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"batchIngestCaller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"hideInputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"hideOutputs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tracingSampleRate",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sampledPostUuids",{enumerable:!0,configurable:!0,writable:!0,value:new Set}),Object.defineProperty(this,"autoBatchTracing",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"batchEndpointSupported",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchQueue",{enumerable:!0,configurable:!0,writable:!0,value:new bo}),Object.defineProperty(this,"pendingAutoBatchedRunLimit",{enumerable:!0,configurable:!0,writable:!0,value:100}),Object.defineProperty(this,"autoBatchTimeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"autoBatchInitialDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:250}),Object.defineProperty(this,"autoBatchAggregationDelayMs",{enumerable:!0,configurable:!0,writable:!0,value:50}),Object.defineProperty(this,"serverInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fetchOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=n.getDefaultClientConfig();this.tracingSampleRate=qf(),this.apiUrl=(a=yo((r=e.apiUrl)!=null?r:t.apiUrl))!=null?a:"",this.apiKey=yo((s=e.apiKey)!=null?s:t.apiKey),this.webUrl=yo((i=e.webUrl)!=null?i:t.webUrl),this.timeout_ms=(o=e.timeout_ms)!=null?o:12e3,this.caller=new aa((u=e.callerOptions)!=null?u:{}),this.batchIngestCaller=new aa({...(c=e.callerOptions)!=null?c:{},onFailedResponseHook:Gf}),this.hideInputs=(l=e.hideInputs)!=null?l:t.hideInputs,this.hideOutputs=(d=e.hideOutputs)!=null?d:t.hideOutputs,this.autoBatchTracing=(h=e.autoBatchTracing)!=null?h:this.autoBatchTracing,this.pendingAutoBatchedRunLimit=(p=e.pendingAutoBatchedRunLimit)!=null?p:this.pendingAutoBatchedRunLimit,this.fetchOptions=e.fetchOptions||{}}static getDefaultClientConfig(){var s;let e=pt("LANGCHAIN_API_KEY"),t=(s=pt("LANGCHAIN_ENDPOINT"))!=null?s:"https://api.smith.langchain.com",r=pt("LANGCHAIN_HIDE_INPUTS")==="true",a=pt("LANGCHAIN_HIDE_OUTPUTS")==="true";return{apiUrl:t,apiKey:e,webUrl:void 0,hideInputs:r,hideOutputs:a}}getHostUrl(){return this.webUrl?this.webUrl:Vf(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")&&!this.apiUrl.split(".",1)[0].endsWith("api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){let e={"User-Agent":`langsmith-js/${As}`};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}processInputs(e){return this.hideInputs===!1?e:this.hideInputs===!0?{}:typeof this.hideInputs=="function"?this.hideInputs(e):e}processOutputs(e){return this.hideOutputs===!1?e:this.hideOutputs===!0?{}:typeof this.hideOutputs=="function"?this.hideOutputs(e):e}prepareRunCreateOrUpdateInputs(e){let t={...e};return t.inputs!==void 0&&(t.inputs=this.processInputs(t.inputs)),t.outputs!==void 0&&(t.outputs=this.processOutputs(t.outputs)),t}async _getResponse(e,t){var i;let r=(i=t==null?void 0:t.toString())!=null?i:"",a=`${this.apiUrl}${e}?${r}`,s=await this.caller.call(fetch,a,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to fetch ${e}: ${s.status} ${s.statusText}`);return s}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0,a=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(a));let s=`${this.apiUrl}${e}?${t}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);let o=await i.json();if(o.length===0||(yield o,o.length<a))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",a="runs"){let s=t?{...t}:{};for(;;){let o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:{...this.headers,"Content-Type":"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions,body:JSON.stringify(s)})).json();if(!o||!o[a])break;yield o[a];let u=o.cursors;if(!u||!u.next)break;s.cursor=u.next}}_filterForSampling(e,t=!1){if(this.tracingSampleRate===void 0)return e;if(t){let r=[];for(let a of e)this.sampledPostUuids.has(a.id)&&(r.push(a),this.sampledPostUuids.delete(a.id));return r}else{let r=[];for(let a of e)Math.random()<this.tracingSampleRate&&(r.push(a),this.sampledPostUuids.add(a.id));return r}}async drainAutoBatchQueue(){for(;this.autoBatchQueue.size>=0;){let[e,t]=this.autoBatchQueue.pop(this.pendingAutoBatchedRunLimit);if(!e.length){t();return}try{await this.batchIngestRuns({runCreates:e.filter(r=>r.action==="create").map(r=>r.item),runUpdates:e.filter(r=>r.action==="update").map(r=>r.item)})}finally{t()}}}async processRunOperation(e,t){let r=this.autoBatchTimeout;clearTimeout(this.autoBatchTimeout),this.autoBatchTimeout=void 0;let a=this.autoBatchQueue.push(e);return(t||this.autoBatchQueue.size>this.pendingAutoBatchedRunLimit)&&await this.drainAutoBatchQueue(),this.autoBatchQueue.size>0&&(this.autoBatchTimeout=setTimeout(()=>{this.autoBatchTimeout=void 0,this.drainAutoBatchQueue().catch(console.error)},r?this.autoBatchAggregationDelayMs:this.autoBatchInitialDelayMs)),a}async _getServerInfo(){let e=await fetch(`${this.apiUrl}/info`,{method:"GET",headers:{Accept:"application/json"},signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!e.ok)throw await e.text(),new Error("Failed to retrieve server info.");return e.json()}async batchEndpointIsSupported(){try{this.serverInfo=await this._getServerInfo()}catch(e){return!1}return!0}async createRun(e){var o;if(!this._filterForSampling([e]).length)return;let t={...this.headers,"Content-Type":"application/json"},r=e.project_name;delete e.project_name;let a=this.prepareRunCreateOrUpdateInputs({session_name:r,...e,start_time:(o=e.start_time)!=null?o:Date.now()});if(this.autoBatchTracing&&a.trace_id!==void 0&&a.dotted_order!==void 0){this.processRunOperation({action:"create",item:a}).catch(console.error);return}let s=await zc([a]),i=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(s[0]),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(i,"create run")}async batchIngestRuns({runCreates:e,runUpdates:t}){var c,l,d,h,p;if(e===void 0&&t===void 0)return;let r=(c=e==null?void 0:e.map(m=>this.prepareRunCreateOrUpdateInputs(m)))!=null?c:[],a=(l=t==null?void 0:t.map(m=>this.prepareRunCreateOrUpdateInputs(m)))!=null?l:[];if(r.length>0&&a.length>0){let m=r.reduce((g,_)=>(_.id&&(g[_.id]=_),g),{}),y=[];for(let g of a)g.id!==void 0&&m[g.id]?m[g.id]={...m[g.id],...g}:y.push(g);r=Object.values(m),a=y}let s={post:this._filterForSampling(r),patch:this._filterForSampling(a,!0)};if(!s.post.length&&!s.patch.length)return;if(r=await zc(r),this.batchEndpointSupported===void 0&&(this.batchEndpointSupported=await this.batchEndpointIsSupported()),!this.batchEndpointSupported){this.autoBatchTracing=!1;for(let m of s.post)await this.createRun(m);for(let m of s.patch)m.id!==void 0&&await this.updateRun(m.id,m);return}let i=(p=(h=(d=this.serverInfo)==null?void 0:d.batch_ingest_config)==null?void 0:h.size_limit_bytes)!=null?p:Wf,o={post:[],patch:[]},u=0;for(let m of["post","patch"]){let y=m,g=s[y].reverse(),_=g.pop();for(;_!==void 0;){let w=JSON.stringify(_);u>0&&u+w.length>i&&(await this._postBatchIngestRuns(JSON.stringify(o)),u=0,o.post=[],o.patch=[]),u+=w.length,o[y].push(_),_=g.pop()}}(o.post.length>0||o.patch.length>0)&&await this._postBatchIngestRuns(JSON.stringify(o))}async _postBatchIngestRuns(e){let t={...this.headers,"Content-Type":"application/json",Accept:"application/json"},r=await this.batchIngestCaller.call(fetch,`${this.apiUrl}/runs/batch`,{method:"POST",headers:t,body:e,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(r,"batch create run")}async updateRun(e,t){G(e),t.inputs&&(t.inputs=this.processInputs(t.inputs)),t.outputs&&(t.outputs=this.processOutputs(t.outputs));let r={...t,id:e};if(!this._filterForSampling([r],!0).length)return;if(this.autoBatchTracing&&r.trace_id!==void 0&&r.dotted_order!==void 0){if(t.end_time!==void 0&&r.parent_run_id===void 0){await this.processRunOperation({action:"update",item:r},!0);return}else this.processRunOperation({action:"update",item:r}).catch(console.error);return}let a={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:a,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){G(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let a;t.session_id?a=t.session_id:r!=null&&r.projectName?a=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?a=r==null?void 0:r.projectId:a=(await this.readProject({projectName:pt("LANGCHAIN_PROJECT")||"default"})).id;let s=await this._getTenantId();return`${this.getHostUrl()}/o/${s}/projects/p/${a}/r/${t.id}?poll=true`}else if(e!==void 0){let a=await this.readRun(e);if(!a.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${a.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){let t=await Zf(this.listRuns({id:e.child_run_ids})),r={},a={};t.sort((s,i)=>{var o,u;return((o=s==null?void 0:s.dotted_order)!=null?o:"").localeCompare((u=i==null?void 0:i.dotted_order)!=null?u:"")});for(let s of t){if(s.parent_run_id===null||s.parent_run_id===void 0)throw new Error(`Child run ${s.id} has no parent`);s.parent_run_id in r||(r[s.parent_run_id]=[]),r[s.parent_run_id].push(s),a[s.id]=s}e.child_runs=r[e.id]||[];for(let s in r)s!==e.id&&(a[s].child_runs=r[s]);return e}async*listRuns(e){let{projectId:t,projectName:r,parentRunId:a,traceId:s,referenceExampleId:i,startTime:o,executionOrder:u,runType:c,error:l,id:d,query:h,filter:p,traceFilter:m,treeFilter:y,limit:g}=e,_=[];if(t&&(_=Array.isArray(t)?t:[t]),r){let M=Array.isArray(r)?r:[r],z=await Promise.all(M.map(D=>this.readProject({projectName:D}).then(S=>S.id)));_.push(...z)}let w={session:_.length?_:null,run_type:c,reference_example:i,query:h,filter:p,trace_filter:m,tree_filter:y,execution_order:u,parent_run:a,start_time:o?o.toISOString():null,error:l,id:d,limit:g,trace:s};for await(let M of this._getCursorPaginatedList("/runs/query",w))yield*M}async shareRun(e,{shareId:t}={}){let r={run_id:e,share_token:t||ge()};G(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(s===null||!("share_token"in s))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${s.share_token}/r`}async unshareRun(e){G(e);let t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(t,"unshare run")}async readRunSharedLink(e){G(e);let r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){let r=new URLSearchParams({share_token:e});if(t!==void 0)for(let i of t)r.append("id",i);return G(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),G(e);let a=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return a.url=`${this.getHostUrl()}/public/${a.share_token}/d`,a}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);let r={dataset_id:e};G(e);let s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async unshareDataset(e){G(e);let t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(t,"unshare dataset")}async readSharedDataset(e){return G(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:a=!1,projectExtra:s=null,referenceDatasetId:i=null}){let o=a?"?upsert=true":"",u=`${this.apiUrl}/sessions${o}`,c=s||{};r&&(c.metadata=r);let l={name:e,extra:c,description:t};i!==null&&(l.reference_dataset_id=i);let d=await this.caller.call(fetch,u,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),h=await d.json();if(!d.ok)throw new Error(`Failed to create session ${e}: ${d.status} ${d.statusText}`);return h}async updateProject(e,{name:t=null,description:r=null,metadata:a=null,projectExtra:s=null,endTime:i=null}){let o=`${this.apiUrl}/sessions/${e}`,u=s;a&&(u={...u||{},metadata:a});let c={name:t,extra:u,description:r,end_time:i?new Date(i).toISOString():null},l=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions}),d=await l.json();if(!l.ok)throw new Error(`Failed to update project ${e}: ${l.status} ${l.statusText}`);return d}async hasProject({projectId:e,projectName:t}){let r="/sessions",a=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)G(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide projectName or projectId");let s=await this.caller.call(fetch,`${this.apiUrl}${r}?${a}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});try{let i=await s.json();return s.ok?Array.isArray(i)?i.length>0:!0:!1}catch(i){return!1}}async readProject({projectId:e,projectName:t,includeStats:r}){let a="/sessions",s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)G(e),a+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");r!==void 0&&s.append("include_stats",r.toString());let i=await this._get(a,s),o;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);o=i[0]}else o=i;return o}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;let e=new URLSearchParams({limit:"1"});for await(let t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:a,referenceDatasetName:s,referenceFree:i}={}){let o=new URLSearchParams;if(e!==void 0)for(let u of e)o.append("id",u);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),a!==void 0)o.append("reference_dataset",a);else if(s!==void 0){let u=await this.readDataset({datasetName:s});o.append("reference_dataset",u.id)}i!==void 0&&o.append("reference_free",i.toString());for await(let u of this._getPaginated("/sessions",o))yield*u}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,G(r);let a=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(a,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:a,description:s,dataType:i,name:o}){let u=`${this.apiUrl}/datasets/upload`,c=new FormData;c.append("file",e,t),r.forEach(h=>{c.append("input_keys",h)}),a.forEach(h=>{c.append("output_keys",h)}),s&&c.append("description",s),i&&c.append("data_type",i),o&&c.append("name",o);let l=await this.caller.call(fetch,u,{method:"POST",headers:this.headers,body:c,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok){let h=await l.json();throw h.detail&&h.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${l.status} ${l.statusText}`)}return await l.json()}async createDataset(e,{description:t,dataType:r}={}){let a={name:e,description:t};r&&(a.data_type=r);let s=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok){let o=await s.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${s.status} ${s.statusText}`)}return await s.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets",a=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)G(e),r+=`/${e}`;else if(t!==void 0)a.append("name",t);else throw new Error("Must provide datasetName or datasetId");let s=await this._get(r,a),i;if(Array.isArray(s)){if(s.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);i=s[0]}else i=s;return i}async diffDatasetVersions({datasetId:e,datasetName:t,fromVersion:r,toVersion:a}){let s=e;if(s===void 0&&t===void 0)throw new Error("Must provide either datasetName or datasetId");if(s!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");s===void 0&&(s=(await this.readDataset({datasetName:t})).id);let i=new URLSearchParams({from_version:typeof r=="string"?r:r.toISOString(),to_version:typeof a=="string"?a:a.toISOString()});return await this._get(`/datasets/${s}/versions/diff`,i)}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){let r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:a,datasetNameContains:s}={}){let i="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(let u of r)o.append("id",u);a!==void 0&&o.append("name",a),s!==void 0&&o.append("name_contains",s);for await(let u of this._getPaginated(i,o))yield*u}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",a=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(a=(await this.readDataset({datasetName:t})).id),a!==void 0)G(a),r+=`/${a}`;else throw new Error("Must provide datasetName or datasetId");let s=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!s.ok)throw new Error(`Failed to delete ${r}: ${s.status} ${s.statusText}`);await s.json()}async createExample(e,t,{datasetId:r,datasetName:a,createdAt:s,exampleId:i}){let o=r;if(o===void 0&&a===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&a!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:a})).id);let u=s||new Date,c={dataset_id:o,inputs:e,outputs:t,created_at:u==null?void 0:u.toISOString(),id:i},l=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create example: ${l.status} ${l.statusText}`);return await l.json()}async createExamples(e){let{inputs:t,outputs:r,sourceRunIds:a,exampleIds:s,datasetId:i,datasetName:o}=e,u=i;if(u===void 0&&o===void 0)throw new Error("Must provide either datasetName or datasetId");if(u!==void 0&&o!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");u===void 0&&(u=(await this.readDataset({datasetName:o})).id);let c=t.map((h,p)=>({dataset_id:u,inputs:h,outputs:r?r[p]:void 0,id:s?s[p]:void 0,source_run_id:a?a[p]:void 0})),l=await this.caller.call(fetch,`${this.apiUrl}/examples/bulk`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(c),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!l.ok)throw new Error(`Failed to create examples: ${l.status} ${l.statusText}`);return await l.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){let a=e.map(i=>ho(i)?po(i):i),s=ho(t)?po(t):t;return this.createExample({input:a},{output:s},r)}async readExample(e){G(e);let t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r,asOf:a,inlineS3Urls:s}={}){let i;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)i=e;else if(t!==void 0)i=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");let o=new URLSearchParams({dataset:i}),u=a?typeof a=="string"?a:a==null?void 0:a.toISOString():void 0;u&&o.append("as_of",u);let c=s!=null?s:!0;if(o.append("inline_s3_urls",c.toString()),r!==void 0)for(let l of r)o.append("id",l);for await(let l of this._getPaginated("/examples",o))yield*l}async deleteExample(e){G(e);let t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){G(e);let r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:a,referenceExample:s}={loadChildRuns:!1}){var l;let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:a});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);i.reference_example_id!==null&&i.reference_example_id!==void 0&&(s=await this.readExample(i.reference_example_id));let o=await t.evaluateRun(i,s),u=r!=null?r:{};o.evaluatorInfo&&(u={...u,...o.evaluatorInfo});let c=(l=o.targetRunId)!=null?l:i.id;return await this.createFeedback(c,o.key,{score:o==null?void 0:o.score,value:o==null?void 0:o.value,comment:o==null?void 0:o.comment,correction:o==null?void 0:o.correction,sourceInfo:u,feedbackSourceType:"model",sourceRunId:o==null?void 0:o.sourceRunId})}async createFeedback(e,t,{score:r,value:a,correction:s,comment:i,sourceInfo:o,feedbackSourceType:u="api",sourceRunId:c,feedbackId:l,feedbackConfig:d}){var g;let h={type:u!=null?u:"api",metadata:o!=null?o:{}};c!==void 0&&(h==null?void 0:h.metadata)!==void 0&&!h.metadata.__run&&(h.metadata.__run={run_id:c}),(h==null?void 0:h.metadata)!==void 0&&((g=h.metadata.__run)==null?void 0:g.run_id)!==void 0&&G(h.metadata.__run.run_id);let p={id:l!=null?l:ge(),run_id:e,key:t,score:r,value:a,correction:s,comment:i,feedback_source:h,feedbackConfig:d},m=`${this.apiUrl}/feedback`,y=await this.caller.call(fetch,m,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(p),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});return await jt(y,"create feedback"),p}async updateFeedback(e,{score:t,value:r,correction:a,comment:s}){let i={};t!=null&&(i.score=t),r!=null&&(i.value=r),a!=null&&(i.correction=a),s!=null&&(i.comment=s),G(e);let o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(i),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});await jt(o,"update feedback")}async readFeedback(e){G(e);let t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){G(e);let t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){let a=new URLSearchParams;if(e&&a.append("run",e.join(",")),t)for(let s of t)a.append("key",s);if(r)for(let s of r)a.append("source",s);for await(let s of this._getPaginated("/feedback",a))yield*s}async createPresignedFeedbackToken(e,t,{expiration:r,feedbackConfig:a}={}){let s={run_id:e,feedback_key:t,feedback_config:a};return r?typeof r=="string"?s.expires_at=r:(r!=null&&r.hours||r!=null&&r.minutes||r!=null&&r.days)&&(s.expires_in=r):s.expires_in={hours:3},await(await this.caller.call(fetch,`${this.apiUrl}/feedback/tokens`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms),...this.fetchOptions})).json()}async*listPresignedFeedbackTokens(e){G(e);let t=new URLSearchParams({run_id:e});for await(let r of this._getPaginated("/feedback/tokens",t))yield*r}};var As="0.1.14";var sa=class extends ze{constructor(e={}){var s;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let{exampleId:t,projectName:r,client:a}=e;this.projectName=(s=r!=null?r:H("LANGCHAIN_PROJECT"))!=null?s:H("LANGCHAIN_SESSION"),this.exampleId=t,this.client=a!=null?a:new gn({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await Xu()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async onRunCreate(e){let t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async onRunUpdate(e){let t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs,trace_id:e.trace_id,dotted_order:e.dotted_order,parent_run_id:e.parent_run_id};await this.client.updateRun(e.id,t)}getRun(e){return this.runMap.get(e)}};async function Uc(){return new sa}var Es=je(us(),1),_o;function Jf(){let n="default"in Es.default?Es.default.default:Es.default;return new n({autoStart:!0,concurrency:1})}async function ne(n,e){e===!0?await n():(typeof _o=="undefined"&&(_o=Jf()),_o.add(n))}H("LANGCHAIN_TRACING_V2")==="true"&&H("LANGCHAIN_CALLBACKS_BACKGROUND")!=="true"&&["[WARN]: You have enabled LangSmith tracing without backgrounding callbacks.","[WARN]: If you are not using a serverless environment where you must wait for tracing calls to finish,",'[WARN]: we suggest setting "process.env.LANGCHAIN_CALLBACKS_BACKGROUND=true" to avoid additional latency.'].join(`
`);function Bc(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}var wo=class{setHandler(e){return this.setHandlers([e])}},yn=class{constructor(e,t,r,a,s,i,o,u){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:u})}async handleText(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleText: ${a}`)}},t.awaitHandlers)))}},vo=class extends yn{getChild(e){let t=new ae(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${a}`)}},t.awaitHandlers)))}},Ps=class extends yn{async handleLLMNewToken(e,t,r,a,s,i){await Promise.all(this.handlers.map(o=>ne(async()=>{var u;if(!o.ignoreLLM)try{await((u=o.handleLLMNewToken)==null?void 0:u.call(o,e,t!=null?t:{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${c}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${a}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${a}`)}},t.awaitHandlers)))}},xo=class extends yn{getChild(e){let t=new ae(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,a,s){await Promise.all(this.handlers.map(i=>ne(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainError)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainError: ${u}`)}},i.awaitHandlers)))}async handleChainEnd(e,t,r,a,s){await Promise.all(this.handlers.map(i=>ne(async()=>{var o;if(!i.ignoreChain)try{await((o=i.handleChainEnd)==null?void 0:o.call(i,e,this.runId,this._parentRunId,this.tags,s))}catch(u){console.error(`Error in handler ${i.constructor.name}, handleChainEnd: ${u}`)}},i.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${a}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${a}`)}},t.awaitHandlers)))}},Ao=class extends yn{getChild(e){let t=new ae(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${a}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ne(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(a){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${a}`)}},t.awaitHandlers)))}},ae=class n extends wo{constructor(e,t){var r,a,s,i,o,u;super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(r=t==null?void 0:t.handlers)!=null?r:this.handlers,this.inheritableHandlers=(a=t==null?void 0:t.inheritableHandlers)!=null?a:this.inheritableHandlers,this.tags=(s=t==null?void 0:t.tags)!=null?s:this.tags,this.inheritableTags=(i=t==null?void 0:t.inheritableTags)!=null?i:this.inheritableTags,this.metadata=(o=t==null?void 0:t.metadata)!=null?o:this.metadata,this.inheritableMetadata=(u=t==null?void 0:t.inheritableMetadata)!=null?u:this.inheritableMetadata,this._parentRunId=e}getParentRunId(){return this._parentRunId}async handleLLMStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{let l=ge();return await Promise.all(this.handlers.map(d=>ne(async()=>{var h;if(!d.ignoreLLM)try{await((h=d.handleLLMStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,s,this.tags,this.metadata,u))}catch(p){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${p}`)}},d.awaitHandlers))),new Ps(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,a=void 0,s=void 0,i=void 0,o=void 0,u=void 0){return Promise.all(t.map(async c=>{let l=ge();return await Promise.all(this.handlers.map(d=>ne(async()=>{var h,p;if(!d.ignoreLLM)try{if(d.handleChatModelStart)await((h=d.handleChatModelStart)==null?void 0:h.call(d,e,[c],l,this._parentRunId,s,this.tags,this.metadata,u));else if(d.handleLLMStart){let m=on(c);await((p=d.handleLLMStart)==null?void 0:p.call(d,e,[m],l,this._parentRunId,s,this.tags,this.metadata,u))}}catch(m){console.error(`Error in handler ${d.constructor.name}, handleLLMStart: ${m}`)}},d.awaitHandlers))),new Ps(l,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=ge(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ne(async()=>{var c;if(!u.ignoreChain)try{await((c=u.handleChainStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,a,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleChainStart: ${l}`)}},u.awaitHandlers))),new xo(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=ge(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ne(async()=>{var c;if(!u.ignoreAgent)try{await((c=u.handleToolStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleToolStart: ${l}`)}},u.awaitHandlers))),new Ao(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=ge(),a=void 0,s=void 0,i=void 0,o=void 0){return await Promise.all(this.handlers.map(u=>ne(async()=>{var c;if(!u.ignoreRetriever)try{await((c=u.handleRetrieverStart)==null?void 0:c.call(u,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(l){console.error(`Error in handler ${u.constructor.name}, handleRetrieverStart: ${l}`)}},u.awaitHandlers))),new vo(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(let r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(let t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){let r=new n(this._parentRunId);for(let a of this.handlers){let s=this.inheritableHandlers.includes(a);r.addHandler(a,s)}for(let a of this.tags){let s=this.inheritableTags.includes(a);r.addTags([a],s)}for(let a of Object.keys(this.metadata)){let s=Object.keys(this.inheritableMetadata).includes(a);r.addMetadata({[a]:this.metadata[a]},s)}for(let a of e)r.handlers.filter(s=>s.name==="console_callback_handler").some(s=>s.name===a.name)||r.addHandler(a,t);return r}static fromHandlers(e){class t extends Er{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:ge()}),Object.assign(this,e)}}let r=new this;return r.addHandler(new t),r}static async configure(e,t,r,a,s,i,o){var h,p;let u;(e||t)&&(Array.isArray(e)||!e?(u=new n,u.setHandlers((h=e==null?void 0:e.map(ia))!=null?h:[],!0)):u=e,u=u.copy(Array.isArray(t)?t.map(ia):t==null?void 0:t.handlers,!1));let c=H("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),l=H("LANGCHAIN_TRACING_V2")==="true",d=l||((p=H("LANGCHAIN_TRACING"))!=null?p:!1);if(c||d){if(u||(u=new n),c&&!u.handlers.some(m=>m.name===na.prototype.name)){let m=new na;u.addHandler(m,!0)}d&&!u.handlers.some(m=>m.name==="langchain_tracer")&&l&&u.addHandler(await Uc(),!0)}return(r||a)&&u&&(u.addTags(r!=null?r:[]),u.addTags(a!=null?a:[],!1)),(s||i)&&u&&(u.addMetadata(s!=null?s:{}),u.addMetadata(i!=null?i:{},!1)),u}};function ia(n){return"name"in n?n:Er.fromMethods(n)}var Eo={};ji(Eo,{JsonPatchError:()=>Y,_areEquals:()=>ua,applyOperation:()=>Or,applyPatch:()=>$t,applyReducer:()=>em,deepClone:()=>Xf,getValueByPointer:()=>Ss,validate:()=>Kc,validator:()=>ks});var Yf=Object.prototype.hasOwnProperty;function Is(n,e){return Yf.call(n,e)}function Ts(n){if(Array.isArray(n)){let t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)Is(n,t)&&e.push(t);return e}function he(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function Cs(n){let e=0,t=n.length,r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Ye(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function oa(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function Os(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(Os(n[t]))return!0}else if(typeof n=="object"){let t=Ts(n),r=t.length;for(var e=0;e<r;e++)if(Os(n[t[e]]))return!0}}return!1}function Hc(n,e){let t=[n];for(let r in e){let a=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof a!="undefined"&&t.push(`${r}: ${a}`)}return t.join(`
`)}var Pr=class extends Error{constructor(e,t,r,a,s){super(Hc(e,{name:t,index:r,operation:a,tree:s})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.setPrototypeOf(this,new.target.prototype),this.message=Hc(e,{name:t,index:r,operation:a,tree:s})}};var Y=Pr,Xf=he,bn={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=Ss(t,this.path);r&&(r=he(r));let a=Or(t,{op:"remove",path:this.from}).removed;return Or(t,{op:"add",path:this.path,value:a}),{newDocument:t,removed:r}},copy:function(n,e,t){let r=Ss(t,this.from);return Or(t,{op:"add",path:this.path,value:he(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:ua(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},Qf={add:function(n,e,t){return Cs(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:bn.move,copy:bn.copy,test:bn.test,_get:bn._get};function Ss(n,e){if(e=="")return n;var t={op:"_get",path:e};return Or(n,t),t.value}function Or(n,e,t=!1,r=!0,a=!0,s=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):ks(e,0)),e.path===""){let i={newDocument:n};if(e.op==="add")return i.newDocument=e.value,i;if(e.op==="replace")return i.newDocument=e.value,i.removed=n,i;if(e.op==="move"||e.op==="copy")return i.newDocument=Ss(n,e.from),e.op==="move"&&(i.removed=n),i;if(e.op==="test"){if(i.test=ua(n,e.value),i.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return i.newDocument=n,i}else{if(e.op==="remove")return i.removed=n,i.newDocument=null,i;if(e.op==="_get")return e.value=n,i;if(t)throw new Y("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",s,e,n);return i}}else{r||(n=he(n));let o=(e.path||"").split("/"),u=n,c=1,l=o.length,d,h,p;for(typeof t=="function"?p=t:p=ks;;){if(h=o[c],h&&h.indexOf("~")!=-1&&(h=oa(h)),a&&(h=="__proto__"||h=="prototype"&&c>0&&o[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&d===void 0&&(u[h]===void 0?d=o.slice(0,c).join("/"):c==l-1&&(d=e.path),d!==void 0&&p(e,0,n,d)),c++,Array.isArray(u)){if(h==="-")h=u.length;else{if(t&&!Cs(h))throw new Y("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",s,e,n);Cs(h)&&(h=~~h)}if(c>=l){if(t&&e.op==="add"&&h>u.length)throw new Y("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",s,e,n);let m=Qf[e.op].call(e,u,h,n);if(m.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return m}}else if(c>=l){let m=bn[e.op].call(e,u,h,n);if(m.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",s,e,n);return m}if(u=u[h],t&&c<l&&(!u||typeof u!="object"))throw new Y("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",s,e,n)}}}function $t(n,e,t,r=!0,a=!0){if(t&&!Array.isArray(e))throw new Y("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=he(n));let s=new Array(e.length);for(let i=0,o=e.length;i<o;i++)s[i]=Or(n,e[i],t,!0,a,i),n=s[i].newDocument;return s.newDocument=n,s}function em(n,e,t){let r=Or(n,e);if(r.test===!1)throw new Y("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function ks(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new Y("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(bn[n.op]){if(typeof n.path!="string")throw new Y("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new Y('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new Y("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new Y("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&Os(n.value))throw new Y("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var a=n.path.split("/").length,s=r.split("/").length;if(a!==s+1&&a!==s)throw new Y("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new Y("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var i={op:"_get",path:n.from,value:void 0},o=Kc([i],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new Y("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new Y("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function Kc(n,e,t){try{if(!Array.isArray(n))throw new Y("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)$t(he(e),he(n),t||!0);else{t=t||ks;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(a){if(a instanceof Y)return a;throw a}}function ua(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),a,s,i;if(t&&r){if(s=n.length,s!=e.length)return!1;for(a=s;a--!==0;)if(!ua(n[a],e[a]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(s=o.length,s!==Object.keys(e).length)return!1;for(a=s;a--!==0;)if(!e.hasOwnProperty(o[a]))return!1;for(a=s;a--!==0;)if(i=o[a],!ua(n[i],e[i]))return!1;return!0}return n!==n&&e!==e}function qc(n,e,t,r,a){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var s=Ts(e),i=Ts(n),o=!1,u=!1,c=i.length-1;c>=0;c--){var l=i[c],d=n[l];if(Is(e,l)&&!(e[l]===void 0&&d!==void 0&&Array.isArray(e)===!1)){var h=e[l];typeof d=="object"&&d!=null&&typeof h=="object"&&h!=null&&Array.isArray(d)===Array.isArray(h)?qc(d,h,t,r+"/"+Ye(l),a):d!==h&&(o=!0,a&&t.push({op:"test",path:r+"/"+Ye(l),value:he(d)}),t.push({op:"replace",path:r+"/"+Ye(l),value:he(h)}))}else Array.isArray(n)===Array.isArray(e)?(a&&t.push({op:"test",path:r+"/"+Ye(l),value:he(d)}),t.push({op:"remove",path:r+"/"+Ye(l)}),u=!0):(a&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),o=!0)}if(!(!u&&s.length==i.length))for(var c=0;c<s.length;c++){var l=s[c];!Is(n,l)&&e[l]!==void 0&&t.push({op:"add",path:r+"/"+Ye(l),value:he(e[l])})}}}function Ns(n,e,t=!1){var r=[];return qc(n,e,r,"",t),r}var A_={...Eo,JsonPatchError:Pr,deepClone:he,escapePathComponent:Ye,unescapePathComponent:oa};var Xe=class n extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{let e=await this.reader.read();return e.done?(this.reader.releaseLock(),{done:!0,value:void 0}):{done:!1,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){let e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){let t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){let t=e.getReader();return new n({start(r){return a();function a(){return t.read().then(({done:s,value:i})=>{if(s){r.close();return}return r.enqueue(i),a()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new n({async pull(t){let{value:r,done:a}=await e.next();a&&t.close(),t.enqueue(r)},async cancel(t){await e.return(t)}})}};function Po(n,e=2){let t=Array.from({length:e},()=>[]);return t.map(async function*(a){for(;;)if(a.length===0){let s=await n.next();for(let i of t)i.push(s)}else{if(a[0].done)return;yield a.shift().value}})}function Qe(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){let t={...n};for(let[r,a]of Object.entries(e))r in t&&!Array.isArray(t[r])?t[r]=Qe(t[r],a):t[r]=a;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}var ft=class{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,a)=>{this.firstResult=e.next(),t?this.firstResult.then(t).then(r,a):this.firstResult.then(s=>r(void 0),a)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}};async function Vc(n,e,t,...r){let a=new ft(e,t),s=await a.setup;return{output:n(a,s,...r),setup:s}}var Be=class{constructor(e){var t;Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=(t=e.ops)!=null?t:[]}concat(e){let t=this.ops.concat(e.ops),r=$t({},t);return new ca({ops:t,state:r[r.length-1].newDocument})}},ca=class n extends Be{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){let t=this.ops.concat(e.ops),r=$t(this.state,e.ops);return new n({ops:t,state:r[r.length-1].newDocument})}static fromRunLogPatch(e){let t=$t({},e.ops);return new n({ops:e.ops,state:t[t.length-1].newDocument})}};async function Zc(n,e){if(e==="original")throw new Error("Do not assign inputs with original schema drop the key for now. When inputs are added to streamLog they should be added with standardized schema for streaming events.");let{inputs:t}=n;if(["retriever","llm","prompt"].includes(n.run_type))return t;if(!(Object.keys(t).length===1&&(t==null?void 0:t.input)===""))return t.input}async function Gc(n,e){let{outputs:t}=n;return e==="original"||["retriever","llm","prompt"].includes(n.run_type)?t:t!==void 0&&Object.keys(t).length===1&&(t==null?void 0:t.output)!==void 0?t.output:t}function tm(n){return n!==void 0&&n.message!==void 0}var la=class extends ze{constructor(e){var t,r;super({_awaitHandler:!0,...e}),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_schemaFormat",{enumerable:!0,configurable:!0,writable:!0,value:"original"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(t=e==null?void 0:e.autoClose)!=null?t:!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this._schemaFormat=(r=e==null?void 0:e._schemaFormat)!=null?r:this._schemaFormat,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Xe.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){var a;if(e.id===this.rootId)return!1;let t=(a=e.tags)!=null?a:[],r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async*tapOutputIterable(e,t){for await(let r of t){if(e!==this.rootId){let a=this.keyMapByRunId[e];a&&await this.writer.write(new Be({ops:[{op:"add",path:`/logs/${a}/streamed_output/-`,value:r}]}))}yield r}}async onRunCreate(e){var a,s,i;if(this.rootId===void 0&&(this.rootId=e.id,await this.writer.write(new Be({ops:[{op:"replace",path:"",value:{id:e.id,name:e.name,type:e.run_type,streamed_output:[],final_output:void 0,logs:{}}}]}))),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;let t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;let r={id:e.id,name:e.name,type:e.run_type,tags:(a=e.tags)!=null?a:[],metadata:(i=(s=e.extra)==null?void 0:s.metadata)!=null?i:{},start_time:new Date(e.start_time).toISOString(),streamed_output:[],streamed_output_str:[],final_output:void 0,end_time:void 0};this._schemaFormat==="streaming_events"&&(r.inputs=await Zc(e,this._schemaFormat)),await this.writer.write(new Be({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{let t=this.keyMapByRunId[e.id];if(t===void 0)return;let r=[];this._schemaFormat==="streaming_events"&&r.push({op:"replace",path:`/logs/${t}/inputs`,value:await Zc(e,this._schemaFormat)}),r.push({op:"add",path:`/logs/${t}/final_output`,value:await Gc(e,this._schemaFormat)}),e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});let a=new Be({ops:r});await this.writer.write(a)}finally{if(e.id===this.rootId){let t=new Be({ops:[{op:"replace",path:"/final_output",value:await Gc(e,this._schemaFormat)}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t,r){let a=this.keyMapByRunId[e.id];if(a===void 0)return;let s=e.inputs.messages!==void 0,i;s?tm(r==null?void 0:r.chunk)?i=r==null?void 0:r.chunk:i=new st(t):i=t;let o=new Be({ops:[{op:"add",path:`/logs/${a}/streamed_output_str/-`,value:t},{op:"add",path:`/logs/${a}/streamed_output/-`,value:i}]});await this.writer.write(o)}};var Oo=class{getStore(){}run(e,t){t()}},Io=class{constructor(){Object.defineProperty(this,"asyncLocalStorage",{enumerable:!0,configurable:!0,writable:!0,value:new Oo}),Object.defineProperty(this,"hasBeenInitialized",{enumerable:!0,configurable:!0,writable:!0,value:!1})}getInstance(){return this.asyncLocalStorage}initializeGlobalInstance(e){this.hasBeenInitialized||(this.hasBeenInitialized=!0,this.asyncLocalStorage=e)}},da=new Io;var Rs=25;async function et(n){return ae.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function To(...n){var t,r,a;let e={};for(let s of n.filter(i=>!!i))for(let i of Object.keys(s))if(i==="metadata")e[i]={...e[i],...s[i]};else if(i==="tags"){let o=(t=e[i])!=null?t:[];e[i]=[...new Set(o.concat((r=s[i])!=null?r:[]))]}else if(i==="configurable")e[i]={...e[i],...s[i]};else if(i==="callbacks"){let o=e.callbacks,u=s.callbacks;if(Array.isArray(u))if(!o)e.callbacks=u;else if(Array.isArray(o))e.callbacks=o.concat(u);else{let c=o.copy();for(let l of u)c.addHandler(ia(l),!0);e.callbacks=c}else if(u)if(!o)e.callbacks=u;else if(Array.isArray(o)){let c=u.copy();for(let l of o)c.addHandler(ia(l),!0);e.callbacks=c}else e.callbacks=new ae(u._parentRunId,{handlers:o.handlers.concat(u.handlers),inheritableHandlers:o.inheritableHandlers.concat(u.inheritableHandlers),tags:Array.from(new Set(o.tags.concat(u.tags))),inheritableTags:Array.from(new Set(o.inheritableTags.concat(u.inheritableTags))),metadata:{...o.metadata,...u.metadata}})}else{let o=i;e[o]=(a=s[o])!=null?a:e[o]}return e}var rm=new Set(["string","number","boolean"]);function K(n){var r;let e=n!=null?n:da.getInstance().getStore(),t={tags:[],metadata:{},callbacks:void 0,recursionLimit:25};if(e&&(t={...t,...e}),e!=null&&e.configurable)for(let a of Object.keys(e.configurable))rm.has(typeof e.configurable[a])&&!((r=t.metadata)!=null&&r[a])&&(t.metadata||(t.metadata={}),t.metadata[a]=e.configurable[a]);return t}function oe(n={},{callbacks:e,maxConcurrency:t,recursionLimit:r,runName:a,configurable:s}={}){let i=K(n);return e!==void 0&&(delete i.runName,i.callbacks=e),r!==void 0&&(i.recursionLimit=r),t!==void 0&&(i.maxConcurrency=t),a!==void 0&&(i.runName=a),s!==void 0&&(i.configurable={...i.configurable,...s}),i}var ha=class extends ze{constructor({config:e,onStart:t,onEnd:r,onError:a}){super({_awaitHandler:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=a}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}};function $s(n){return n?n.lc_runnable:!1}var js=class{constructor(e){Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.includeNames=e.includeNames,this.includeTypes=e.includeTypes,this.includeTags=e.includeTags,this.excludeNames=e.excludeNames,this.excludeTypes=e.excludeTypes,this.excludeTags=e.excludeTags}includeEvent(e,t){var s;let r=this.includeNames===void 0&&this.includeTypes===void 0&&this.includeTags===void 0,a=(s=e.tags)!=null?s:[];return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(t)),this.includeTags!==void 0&&(r=r||a.some(i=>{var o;return(o=this.includeTags)==null?void 0:o.includes(i)})),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(t)),this.excludeTags!==void 0&&(r=r&&a.every(i=>{var o;return!((o=this.excludeTags)!=null&&o.includes(i))})),r}};function Co(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function L(n,e,t,r,a){n[e]=t,Co(n,e,r,a)}var Wc={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"string",mapStrategy:"entries",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},Jc=n=>typeof n=="string"?{...Wc,name:n}:{...Wc,...n};function Yc(){return{}}function Xc(n,e){var r,a;let t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==f.ZodAny&&(t.items=O(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&L(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&L(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(L(t,"minItems",n.exactLength.value,n.exactLength.message,e),L(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function Qc(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?L(t,"minimum",r.value,r.message,e):L(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),L(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?L(t,"maximum",r.value,r.message,e):L(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),L(t,"maximum",r.value,r.message,e));break;case"multipleOf":L(t,"multipleOf",r.value,r.message,e);break}return t}function el(){return{type:"boolean"}}function tl(n,e){return O(n.type._def,e)}var rl=(n,e)=>O(n.innerType._def,e);function nl(n,e){return e.dateStrategy=="integer"?nm(n,e):{type:"string",format:"date-time"}}var nm=(n,e)=>{let t={type:"integer",format:"unix-time"};for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"&&L(t,"minimum",r.value,r.message,e);break;case"max":e.target==="jsonSchema7"&&L(t,"maximum",r.value,r.message,e);break}return t};function al(n,e){return{...O(n.innerType._def,e),default:n.defaultValue()}}function sl(n,e){return e.effectStrategy==="input"?O(n.schema._def,e):{}}function il(n){return{type:"string",enum:n.values}}var am=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function ol(n,e){let t=[O(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),O(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(am(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function ul(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var pa={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function Ms(n,e){let t={type:"string"};function r(a){return e.patternStrategy==="escape"?sm(a):a}if(n.checks)for(let a of n.checks)switch(a.kind){case"min":L(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":L(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":Ir(t,"email",a.message,e);break;case"format:idn-email":Ir(t,"idn-email",a.message,e);break;case"pattern:zod":mt(t,pa.email,a.message,e);break}break;case"url":Ir(t,"uri",a.message,e);break;case"uuid":Ir(t,"uuid",a.message,e);break;case"regex":mt(t,a.regex.source,a.message,e);break;case"cuid":mt(t,pa.cuid,a.message,e);break;case"cuid2":mt(t,pa.cuid2,a.message,e);break;case"startsWith":mt(t,"^"+r(a.value),a.message,e);break;case"endsWith":mt(t,r(a.value)+"$",a.message,e);break;case"datetime":Ir(t,"date-time",a.message,e);break;case"length":L(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),L(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{mt(t,r(a.value),a.message,e);break}case"ip":{a.version!=="v6"&&Ir(t,"ipv4",a.message,e),a.version!=="v4"&&Ir(t,"ipv6",a.message,e);break}case"emoji":mt(t,pa.emoji,a.message,e);break;case"ulid":{mt(t,pa.ulid,a.message,e);break}case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var sm=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),Ir=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):L(n,"format",e,t,r)},mt=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:e,...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):L(n,"pattern",e,t,r)};function Ds(n,e){var r,a,s,i,o;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===f.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((u,c)=>{var l;return{...u,[c]:(l=O(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]}))!=null?l:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(a=O(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?a:{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===f.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let u=Object.entries(Ms(n.keyType._def,e)).reduce((c,[l,d])=>l==="type"?c:{...c,[l]:d},{});return{...t,propertyNames:u}}else if(((o=n.keyType)==null?void 0:o._def.typeName)===f.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function cl(n,e){if(e.mapStrategy==="record")return Ds(n,e);let t=O(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=O(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function ll(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function dl(){return{not:{}}}function hl(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var fa={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function fl(n,e){if(e.target==="openApi3")return pl(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in fa&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=fa[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return pl(n,e)}var pl=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>O(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function ml(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:fa[n.innerType._def.typeName],nullable:!0}:{type:[fa[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=O(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=O(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function gl(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",Co(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?L(t,"minimum",r.value,r.message,e):L(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),L(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?L(t,"maximum",r.value,r.message,e):L(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),L(t,"maximum",r.value,r.message,e));break;case"multipleOf":L(t,"multipleOf",r.value,r.message,e);break}return t}function yl(n,e){var r;let t={type:"object",...Object.entries(n.shape()).reduce((a,[s,i])=>{if(i===void 0||i._def===void 0)return a;let o=O(i._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return o===void 0?a:{properties:{...a.properties,[s]:o},required:i.isOptional()?a.required:[...a.required,s]}},{properties:{},required:[]}),additionalProperties:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=O(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0};return t.required.length||delete t.required,t}var bl=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return O(n.innerType._def,e);let t=O(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var _l=(n,e)=>{if(e.pipeStrategy==="input")return O(n.in._def,e);if(e.pipeStrategy==="output")return O(n.out._def,e);let t=O(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=O(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function wl(n,e){return O(n.type._def,e)}function vl(n,e){let r={type:"array",uniqueItems:!0,items:O(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&L(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&L(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function xl(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>O(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:O(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>O(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Al(){return{not:{}}}function El(){return{}}var Pl=(n,e)=>O(n.innerType._def,e);function O(n,e,t=!1){let r=e.seen.get(n);if(r&&!t){let i=im(r,e);if(i!==void 0)return i}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=um(n,n.typeName,e);return s&&cm(n,e,s),a.jsonSchema=s,s}var im=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:om(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},om=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},um=(n,e,t)=>{switch(e){case f.ZodString:return Ms(n,t);case f.ZodNumber:return gl(n,t);case f.ZodObject:return yl(n,t);case f.ZodBigInt:return Qc(n,t);case f.ZodBoolean:return el();case f.ZodDate:return nl(n,t);case f.ZodUndefined:return Al();case f.ZodNull:return hl(t);case f.ZodArray:return Xc(n,t);case f.ZodUnion:case f.ZodDiscriminatedUnion:return fl(n,t);case f.ZodIntersection:return ol(n,t);case f.ZodTuple:return xl(n,t);case f.ZodRecord:return Ds(n,t);case f.ZodLiteral:return ul(n,t);case f.ZodEnum:return il(n);case f.ZodNativeEnum:return ll(n);case f.ZodNullable:return ml(n,t);case f.ZodOptional:return bl(n,t);case f.ZodMap:return cl(n,t);case f.ZodSet:return vl(n,t);case f.ZodLazy:return O(n.getter()._def,t);case f.ZodPromise:return wl(n,t);case f.ZodNaN:case f.ZodNever:return dl();case f.ZodEffects:return sl(n,t);case f.ZodAny:return Yc();case f.ZodUnknown:return El();case f.ZodDefault:return al(n,t);case f.ZodBranded:return tl(n,t);case f.ZodReadonly:return Pl(n,t);case f.ZodCatch:return rl(n,t);case f.ZodPipeline:return _l(n,t);case f.ZodFunction:case f.ZodVoid:case f.ZodSymbol:return;default:return(r=>{})(e)}},cm=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var Ol=n=>{let e=Jc(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};var Tr=(n,e)=>{var o;let t=Ol(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[c,l])=>{var d;return{...u,[c]:(d=O(l._def,{...t,currentPath:[...t.basePath,t.definitionPath,c]},!0))!=null?d:{}}},{}):void 0,a=typeof e=="string"?e:e==null?void 0:e.name,s=(o=O(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1))!=null?o:{},i=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i};function lm(n){return $s(n.data)?{type:"runnable",data:{id:n.data.lc_id,name:n.data.getName()}}:{type:"schema",data:{...Tr(n.data.schema),title:n.data.name}}}var ma=class{constructor(){Object.defineProperty(this,"nodes",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"edges",{enumerable:!0,configurable:!0,writable:!0,value:[]})}toJSON(){let e={};return Object.values(this.nodes).forEach((t,r)=>{e[t.id]=ra(t.id)?r:t.id}),{nodes:Object.values(this.nodes).map(t=>({id:e[t.id],...lm(t)})),edges:this.edges.map(t=>t.data?{source:e[t.source],target:e[t.target],data:t.data}:{source:e[t.source],target:e[t.target]})}}addNode(e,t){if(t!==void 0&&this.nodes[t]!==void 0)throw new Error(`Node with id ${t} already exists`);let r=t||ge(),a={id:r,data:e};return this.nodes[r]=a,a}removeNode(e){delete this.nodes[e.id],this.edges=this.edges.filter(t=>t.source!==e.id&&t.target!==e.id)}addEdge(e,t,r){if(this.nodes[e.id]===void 0)throw new Error(`Source node ${e.id} not in graph`);if(this.nodes[t.id]===void 0)throw new Error(`Target node ${t.id} not in graph`);let a={source:e.id,target:t.id,data:r};return this.edges.push(a),a}firstNode(){let e=new Set(this.edges.map(r=>r.target)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}lastNode(){let e=new Set(this.edges.map(r=>r.source)),t=[];return Object.values(this.nodes).forEach(r=>{e.has(r.id)||t.push(r)}),t[0]}extend(e){Object.entries(e.nodes).forEach(([t,r])=>{this.nodes[t]=r}),this.edges=[...this.edges,...e.edges]}trimFirstNode(){let e=this.firstNode();if(e){let t=this.edges.filter(r=>r.source===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}trimLastNode(){let e=this.lastNode();if(e){let t=this.edges.filter(r=>r.target===e.id);(Object.keys(this.nodes).length===1||t.length===1)&&this.removeNode(e)}}};function ue(n,e){return n&&!Array.isArray(n)&&!(n instanceof Date)&&typeof n=="object"?n:{[e]:n}}var Z=class extends $e{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){var r,a;let t=(a=(r=this.name)!=null?r:this.constructor.lc_name())!=null?a:this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Mt({bound:this,kwargs:e,config:{}})}map(){return new Ls({bound:this})}withRetry(e){return new Fs({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Mt({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new zs({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e.map(K)}return Array.from({length:t},()=>K(e))}async batch(e,t,r){var u,c;let a=this._getOptionsList(t!=null?t:{},e.length),s=(c=(u=a[0])==null?void 0:u.maxConcurrency)!=null?c:r==null?void 0:r.maxConcurrency,i=new ot({maxConcurrency:s,onFailedAttempt:l=>{throw l}}),o=e.map((l,d)=>i.call(async()=>{try{return await this.invoke(l,a[d])}catch(h){if(r!=null&&r.returnExceptions)return h;throw h}}));return Promise.all(o)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){let r=new ft(this._streamIterator(e,K(t)));return await r.setup,Xe.fromAsyncGenerator(r)}_separateRunnableConfigFromCallOptions(e={}){let t=K({callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable,recursionLimit:e.recursionLimit,maxConcurrency:e.maxConcurrency}),r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,delete r.recursionLimit,delete r.maxConcurrency,[t,r]}async _callWithConfig(e,t,r){var u;let a=K(r),s=await et(a),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),ue(t,"input"),void 0,a==null?void 0:a.runType,void 0,void 0,(u=a==null?void 0:a.runName)!=null?u:this.getName())),o;try{o=await e.call(this,t,a,i)}catch(c){throw await(i==null?void 0:i.handleChainError(c)),c}return await(i==null?void 0:i.handleChainEnd(ue(o,"output"))),o}async _batchWithConfig(e,t,r,a){let s=this._getOptionsList(r!=null?r:{},t.length),i=await Promise.all(s.map(et)),o=await Promise.all(i.map((c,l)=>{var d;return c==null?void 0:c.handleChainStart(this.toJSON(),ue(t[l],"input"),void 0,s[l].runType,void 0,void 0,(d=s[l].runName)!=null?d:this.getName())})),u;try{u=await e.call(this,t,s,o,a)}catch(c){throw await Promise.all(o.map(l=>l==null?void 0:l.handleChainError(c))),c}return await Promise.all(o.map(c=>c==null?void 0:c.handleChainEnd(ue(u,"output")))),u}async*_transformStreamWithConfig(e,t,r){let a,s=!0,i,o=!0,u=K(r),c=await et(u);async function*l(){for await(let h of e){if(s)if(a===void 0)a=h;else try{a=Qe(a,h)}catch(p){a=void 0,s=!1}yield h}}let d;try{let h=await Vc(t.bind(this),l(),async()=>{var g;return c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},void 0,u==null?void 0:u.runType,void 0,void 0,(g=u==null?void 0:u.runName)!=null?g:this.getName())},u);d=h.setup;let p=g=>g.name==="log_stream_tracer",m=d==null?void 0:d.handlers.find(p),y=h.output;m!==void 0&&d!==void 0&&(y=await m.tapOutputIterable(d.runId,h.output));for await(let g of y)if(yield g,o)if(i===void 0)i=g;else try{i=Qe(i,g)}catch(_){i=void 0,o=!1}}catch(h){throw await(d==null?void 0:d.handleChainError(h,void 0,void 0,void 0,{inputs:ue(a,"input")})),h}await(d==null?void 0:d.handleChainEnd(i!=null?i:{},void 0,void 0,void 0,{inputs:ue(a,"input")}))}getGraph(e){let t=new ma,r=t.addNode({name:`${this.getName()}Input`,schema:dt.any()}),a=t.addNode(this),s=t.addNode({name:`${this.getName()}Output`,schema:dt.any()});return t.addEdge(r,a),t.addEdge(a,s),t}pipe(e){return new _n({first:this,last:gt(e)})}pick(e){return this.pipe(new Us(e))}assign(e){return this.pipe(new wn(new Dt({steps:e})))}async*transform(e,t){let r;for await(let a of e)r===void 0?r=a:r=Qe(r,a);yield*this._streamIterator(r,K(t))}async*streamLog(e,t,r){let a=new la({...r,autoClose:!1,_schemaFormat:"original"}),s=K(t);yield*this._streamLog(e,a,s)}async*_streamLog(e,t,r){let{callbacks:a}=r;if(a===void 0)r.callbacks=[t];else if(Array.isArray(a))r.callbacks=a.concat([t]);else{let u=a.copy();u.inheritableHandlers.push(t),r.callbacks=u}let s=this.stream(e,r);async function i(){try{let u=await s;for await(let c of u){let l=new Be({ops:[{op:"add",path:"/streamed_output/-",value:c}]});await t.writer.write(l)}}finally{await t.writer.close()}}let o=i();try{for await(let u of t)yield u}finally{await o}}async*streamEvents(e,t,r){var m,y,g;if(t.version!=="v1")throw new Error('Only version "v1" of the events schema is currently supported.');let a,s=!1,i=K(t),o=(m=i.tags)!=null?m:[],u=(y=i.metadata)!=null?y:{},c=(g=i.runName)!=null?g:this.getName(),l=new la({...r,autoClose:!1,_schemaFormat:"streaming_events"}),d=new js({...r}),h=this._streamLog(e,l,i);for await(let _ of h){if(a?a=a.concat(_):a=ca.fromRunLogPatch(_),a.state===void 0)throw new Error('Internal error: "streamEvents" state is missing. Please open a bug report.');if(!s){s=!0;let D={...a.state},S={run_id:D.id,event:`on_${D.type}_start`,name:c,tags:o,metadata:u,data:{input:e}};d.includeEvent(S,D.type)&&(yield S)}let w=_.ops.filter(D=>D.path.startsWith("/logs/")).map(D=>D.path.split("/")[2]),M=[...new Set(w)];for(let D of M){let S,V={},k=a.state.logs[D];if(k.end_time===void 0?k.streamed_output.length>0?S="stream":S="start":S="end",S==="start")k.inputs!==void 0&&(V.input=k.inputs);else if(S==="end")k.inputs!==void 0&&(V.input=k.inputs),V.output=k.final_output;else if(S==="stream"){let B=k.streamed_output.length;if(B!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${B} instead. Encountered in: "${k.name}"`);V={chunk:k.streamed_output[0]},k.streamed_output=[]}yield{event:`on_${k.type}_${S}`,name:k.name,run_id:k.id,tags:k.tags,metadata:k.metadata,data:V}}let{state:z}=a;if(z.streamed_output.length>0){let D=z.streamed_output.length;if(D!==1)throw new Error(`Expected exactly one chunk of streamed output, got ${D} instead. Encountered in: "${z.name}"`);let S={chunk:z.streamed_output[0]};z.streamed_output=[];let V={event:`on_${z.type}_stream`,run_id:z.id,tags:o,metadata:u,name:c,data:S};d.includeEvent(V,z.type)&&(yield V)}}let p=a==null?void 0:a.state;if(p!==void 0){let _={event:`on_${p.type}_end`,name:c,run_id:p.id,tags:o,metadata:u,data:{output:p.final_output}};d.includeEvent(_,p.type)&&(yield _)}}static isRunnable(e){return $s(e)}withListeners({onStart:e,onEnd:t,onError:r}){return new Mt({bound:this,config:{},configFactories:[a=>({callbacks:[new ha({config:a,onStart:e,onEnd:t,onError:r})]})]})}},Mt=class n extends Z{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(...e){let t=To(this.config,...e);return To(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig(K(t),this.kwargs))}async batch(e,t,r){let a=Array.isArray(t)?await Promise.all(t.map(async s=>this._mergeConfig(K(s),this.kwargs))):await this._mergeConfig(K(t),this.kwargs);return this.bound.batch(e,a,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig(K(t),this.kwargs))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig(K(t),this.kwargs))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig(K(t),this.kwargs))}async*streamEvents(e,t,r){yield*this.bound.streamEvents(e,{...await this._mergeConfig(K(t),this.kwargs),version:t.version},r)}static isRunnableBinding(e){return e.bound&&Z.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[a=>({callbacks:[new ha({config:a,onStart:e,onEnd:t,onError:r})]})]})}},Ls=class n extends Z{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new n({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,oe(t,{callbacks:r==null?void 0:r.getChild()}))}withListeners({onStart:e,onEnd:t,onError:r}){return new n({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}},Fs=class extends Mt{static lc_name(){return"RunnableRetry"}constructor(e){var t,r;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=(t=e.maxAttemptNumber)!=null?t:this.maxAttemptNumber,this.onFailedAttempt=(r=e.onFailedAttempt)!=null?r:this.onFailedAttempt}_patchConfigForRetry(e,t,r){let a=e>1?`retry:attempt:${e}`:void 0;return oe(t,{callbacks:r==null?void 0:r.getChild(a)})}async _invoke(e,t,r){return(0,So.default)(a=>super.invoke(e,this._patchConfigForRetry(a,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,a){let s={};try{await(0,So.default)(async i=>{let o=e.map((h,p)=>p).filter(h=>s[h.toString()]===void 0||s[h.toString()]instanceof Error),u=o.map(h=>e[h]),c=o.map(h=>this._patchConfigForRetry(i,t==null?void 0:t[h],r==null?void 0:r[h])),l=await super.batch(u,c,{...a,returnExceptions:!0}),d;for(let h=0;h<l.length;h+=1){let p=l[h],m=o[h];p instanceof Error&&d===void 0&&(d=p),s[m.toString()]=p}if(d)throw d;return l},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(i){if((a==null?void 0:a.returnExceptions)!==!0)throw i}return Object.keys(s).sort((i,o)=>parseInt(i,10)-parseInt(o,10)).map(i=>s[parseInt(i,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}},_n=class n extends Z{static lc_name(){return"RunnableSequence"}constructor(e){var t;super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=(t=e.middle)!=null?t:this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){let r=K(t),a=await et(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),ue(e,"input"),void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),i=e,o;try{let u=[this.first,...this.middle];for(let c=0;c<u.length;c+=1)i=await u[c].invoke(i,oe(r,{callbacks:s==null?void 0:s.getChild(`seq:step:${c+1}`)}));o=await this.last.invoke(i,oe(r,{callbacks:s==null?void 0:s.getChild(`seq:step:${this.steps.length}`)}))}catch(u){throw await(s==null?void 0:s.handleChainError(u)),u}return await(s==null?void 0:s.handleChainEnd(ue(o,"output"))),o}async batch(e,t,r){let a=this._getOptionsList(t!=null?t:{},e.length),s=await Promise.all(a.map(et)),i=await Promise.all(s.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),ue(e[c],"input"),void 0,void 0,void 0,void 0,a[c].runName))),o=e;try{for(let u=0;u<this.steps.length;u+=1)o=await this.steps[u].batch(o,i.map((l,d)=>{let h=l==null?void 0:l.getChild(`seq:step:${u+1}`);return oe(a[d],{callbacks:h})}),r)}catch(u){throw await Promise.all(i.map(c=>c==null?void 0:c.handleChainError(u))),u}return await Promise.all(i.map(u=>u==null?void 0:u.handleChainEnd(ue(o,"output")))),o}async*_streamIterator(e,t){let r=await et(t),a=await(r==null?void 0:r.handleChainStart(this.toJSON(),ue(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),s=[this.first,...this.middle,this.last],i=!0,o;async function*u(){yield e}try{let c=s[0].transform(u(),oe(t,{callbacks:a==null?void 0:a.getChild("seq:step:1")}));for(let l=1;l<s.length;l+=1)c=await s[l].transform(c,oe(t,{callbacks:a==null?void 0:a.getChild(`seq:step:${l+1}`)}));for await(let l of c)if(yield l,i)if(o===void 0)o=l;else try{o=Qe(o,l)}catch(d){o=void 0,i=!1}}catch(c){throw await(a==null?void 0:a.handleChainError(c)),c}await(a==null?void 0:a.handleChainEnd(ue(o,"output")))}getGraph(e){let t=new ma,r=null;return this.steps.forEach((a,s)=>{let i=a.getGraph(e);s!==0&&i.trimFirstNode(),s!==this.steps.length-1&&i.trimLastNode(),t.extend(i);let o=i.firstNode();if(!o)throw new Error(`Runnable ${a} has no first node`);r&&t.addEdge(r,o),r=i.lastNode()}),t}pipe(e){var t;return n.isRunnableSequence(e)?new n({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:(t=this.name)!=null?t:e.name}):new n({first:this.first,middle:[...this.middle,this.last],last:gt(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&Z.isRunnable(e)}static from([e,...t],r){return new n({first:gt(e),middle:t.slice(0,-1).map(gt),last:gt(t[t.length-1]),name:r})}},Dt=class n extends Z{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(let[t,r]of Object.entries(e.steps))this.steps[t]=gt(r)}static from(e){return new n({steps:e})}async invoke(e,t){let r=K(t),a=await et(r),s=await(a==null?void 0:a.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,r==null?void 0:r.runName)),i={};try{await Promise.all(Object.entries(this.steps).map(async([o,u])=>{i[o]=await u.invoke(e,oe(r,{callbacks:s==null?void 0:s.getChild(`map:key:${o}`)}))}))}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){let a={...this.steps},s=Po(e,Object.keys(a).length),i=new Map(Object.entries(a).map(([o,u],c)=>{let l=u.transform(s[c],oe(r,{callbacks:t==null?void 0:t.getChild(`map:key:${o}`)}));return[o,l.next().then(d=>({key:o,gen:l,result:d}))]}));for(;i.size;){let{key:o,result:u,gen:c}=await Promise.race(i.values());i.delete(o),u.done||(yield{[o]:u.value},i.set(o,c.next().then(l=>({key:o,gen:c,result:l}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=new ft(this.transform(r(),t));return await a.setup,Xe.fromAsyncGenerator(a)}},ga=class n extends Z{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new n({func:e})}async _invoke(e,t,r){return new Promise((a,s)=>{var o;let i=oe(t,{callbacks:r==null?void 0:r.getChild(),recursionLimit:((o=t==null?void 0:t.recursionLimit)!=null?o:Rs)-1});da.getInstance().run(i,async()=>{var u;try{let c=await this.func(e,{...i,config:i});if(c&&Z.isRunnable(c)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");c=await c.invoke(e,{...i,recursionLimit:((u=i.recursionLimit)!=null?u:Rs)-1})}a(c)}catch(c){s(c)}})})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){var i;let a;for await(let o of e)if(a===void 0)a=o;else try{a=Qe(a,o)}catch(u){a=o}let s=await new Promise((o,u)=>{da.getInstance().run(r,async()=>{try{let c=await this.func(a,{...r,config:r});o(c)}catch(c){u(c)}})});if(s&&Z.isRunnable(s)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");let o=await s.stream(a,oe(r,{callbacks:t==null?void 0:t.getChild(),recursionLimit:((i=r==null?void 0:r.recursionLimit)!=null?i:Rs)-1}));for await(let u of o)yield u}else yield s}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=new ft(this.transform(r(),t));return await a.setup,Xe.fromAsyncGenerator(a)}};var zs=class extends Z{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(let e of this.fallbacks)yield e}async invoke(e,t){let r=await ae.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),a=await(r==null?void 0:r.handleChainStart(this.toJSON(),ue(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),s;for(let i of this.runnables())try{let o=await i.invoke(e,oe(t,{callbacks:a==null?void 0:a.getChild()}));return await(a==null?void 0:a.handleChainEnd(ue(o,"output"))),o}catch(o){s===void 0&&(s=o)}throw s===void 0?new Error("No error stored at end of fallback."):(await(a==null?void 0:a.handleChainError(s)),s)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");let a=this._getOptionsList(t!=null?t:{},e.length),s=await Promise.all(a.map(u=>ae.configure(u==null?void 0:u.callbacks,void 0,u==null?void 0:u.tags,void 0,u==null?void 0:u.metadata))),i=await Promise.all(s.map((u,c)=>u==null?void 0:u.handleChainStart(this.toJSON(),ue(e[c],"input"),void 0,void 0,void 0,void 0,a[c].runName))),o;for(let u of this.runnables())try{let c=await u.batch(e,i.map((l,d)=>oe(a[d],{callbacks:l==null?void 0:l.getChild()})),r);return await Promise.all(i.map((l,d)=>l==null?void 0:l.handleChainEnd(ue(c[d],"output")))),c}catch(c){o===void 0&&(o=c)}throw o?(await Promise.all(i.map(u=>u==null?void 0:u.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}};function gt(n){if(typeof n=="function")return new ga({func:n});if(Z.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){let e={};for(let[t,r]of Object.entries(n))e[t]=gt(r);return new Dt({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}var wn=class extends Z{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Dt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){let r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){let a=this.mapper.getStepsKeys(),[s,i]=Po(e),o=this.mapper.transform(i,oe(r,{callbacks:t==null?void 0:t.getChild()})),u=o.next();for await(let c of s){if(typeof c!="object"||Array.isArray(c))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof c}`);let l=Object.fromEntries(Object.entries(c).filter(([d])=>!a.includes(d)));Object.keys(l).length>0&&(yield l)}yield(await u).value;for await(let c of o)yield c}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=new ft(this.transform(r(),t));return await a.setup,Xe.fromAsyncGenerator(a)}},Us=class extends Z{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{let t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(let t of e){let r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}let a=new ft(this.transform(r(),t));return await a.setup,Xe.fromAsyncGenerator(a)}};var dm=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n;var hm=()=>!1,ya=class extends Z{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){var t,r,a;super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=(t=e.verbose)!=null?t:hm(),this.callbacks=e.callbacks,this.tags=(r=e.tags)!=null?r:[],this.metadata=(a=e.metadata)!=null?a:{}}},ba=class extends ya{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e!=null?e:t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=Ya.global():this.cache=void 0,this.caller=new ot(r!=null?r:{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await wc("modelName"in this?dm(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new Qa(e):Array.isArray(e)?new es(e.map(nr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){let t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(t).filter(([s,i])=>i!==void 0).map(([s,i])=>`${s}:${JSON.stringify(i)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}};var vn=class n extends ba{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){let[t,r]=super._separateRunnableConfigFromCallOptions(e);return r!=null&&r.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){let r=n._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===n.prototype._streamResponseChunks)yield this.invoke(e,t);else{let a=n._convertInputToPromptValue(e).toChatMessages(),[s,i]=this._separateRunnableConfigFromCallOptions(t),o=await ae.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),u={options:i,invocation_params:this==null?void 0:this.invocationParams(i),batch_size:1},c=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),[a],void 0,void 0,u,void 0,void 0,s.runName)),l;try{for await(let d of this._streamResponseChunks(a,i,c==null?void 0:c[0]))d.message.response_metadata={...d.generationInfo,...d.message.response_metadata},yield d.message,l?l=l.concat(d):l=d}catch(d){throw await Promise.all((c!=null?c:[]).map(h=>h==null?void 0:h.handleLLMError(d))),d}await Promise.all((c!=null?c:[]).map(d=>d==null?void 0:d.handleLLMEnd({generations:[[l]]})))}}async _generateUncached(e,t,r){var h;let a=e.map(p=>p.map(nr)),s=await ae.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},o=await(s==null?void 0:s.handleChatModelStart(this.toJSON(),a,void 0,void 0,i,void 0,void 0,r.runName)),u=await Promise.allSettled(a.map((p,m)=>this._generate(p,{...t,promptIndex:m},o==null?void 0:o[m]))),c=[],l=[];await Promise.all(u.map(async(p,m)=>{var y,g;if(p.status==="fulfilled"){let _=p.value;for(let w of _.generations)w.message.response_metadata={...w.generationInfo,...w.message.response_metadata};return _.generations.length===1&&(_.generations[0].message.response_metadata={..._.llmOutput,..._.generations[0].message.response_metadata}),c[m]=_.generations,l[m]=_.llmOutput,(y=o==null?void 0:o[m])==null?void 0:y.handleLLMEnd({generations:[_.generations],llmOutput:_.llmOutput})}else return await((g=o==null?void 0:o[m])==null?void 0:g.handleLLMError(p.reason)),Promise.reject(p.reason)}));let d={generations:c,llmOutput:l.length?(h=this._combineLLMOutput)==null?void 0:h.call(this,...l):void 0};return Object.defineProperty(d,Ja,{value:o?{runIds:o==null?void 0:o.map(p=>p.runId)}:void 0,configurable:!0}),d}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:a,handledOptions:s}){let i=e.map(y=>y.map(nr)),o=await ae.configure(s.callbacks,this.callbacks,s.tags,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),u={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1,cached:!0},c=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),i,void 0,void 0,u,void 0,void 0,s.runName)),l=[],h=(await Promise.allSettled(i.map(async(y,g)=>{let _=n._convertInputToPromptValue(y).toString(),w=await t.lookup(_,r);return w==null&&l.push(g),w}))).map((y,g)=>({result:y,runManager:c==null?void 0:c[g]})).filter(({result:y})=>y.status==="fulfilled"&&y.value!=null||y.status==="rejected"),p=[];await Promise.all(h.map(async({result:y,runManager:g},_)=>{if(y.status==="fulfilled"){let w=y.value;return p[_]=w,w.length&&await(g==null?void 0:g.handleLLMNewToken(w[0].text)),g==null?void 0:g.handleLLMEnd({generations:[w]})}else return await(g==null?void 0:g.handleLLMError(y.reason)),Promise.reject(y.reason)}));let m={generations:p,missingPromptIndices:l};return Object.defineProperty(m,Ja,{value:c?{runIds:c==null?void 0:c.map(y=>y.runId)}:void 0,configurable:!0}),m}async generate(e,t,r){var p,m;let a;Array.isArray(t)?a={stop:t}:a=t;let s=e.map(y=>y.map(nr)),[i,o]=this._separateRunnableConfigFromCallOptions(a);if(i.callbacks=(p=i.callbacks)!=null?p:r,!this.cache)return this._generateUncached(s,o,i);let{cache:u}=this,c=this._getSerializedCacheKeyParametersForCall(o),{generations:l,missingPromptIndices:d}=await this._generateCached({messages:s,cache:u,llmStringKey:c,parsedOptions:o,handledOptions:i}),h={};if(d.length>0){let y=await this._generateUncached(d.map(g=>s[g]),o,i);await Promise.all(y.generations.map(async(g,_)=>{let w=d[_];l[w]=g;let M=n._convertInputToPromptValue(s[w]).toString();return u.update(M,c,g)})),h=(m=y.llmOutput)!=null?m:{}}return{generations:l,llmOutput:h}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){let a=e.map(s=>s.toChatMessages());return this.generate(a,t,r)}async call(e,t,r){return(await this.generate([e.map(nr)],t,r)).generations[0][0].message}async callPrompt(e,t,r){let a=e.toChatMessages();return this.call(a,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){let a=new se(e),s=await this.call([a],t,r);if(typeof s.content!="string")throw new Error("Cannot use predict when output is not a string.");return s.content}};function pm(n){var t;let e=n._getType();return It.isInstance(n)?n.role:(t=n.name)!=null?t:e}function fm(n){switch(n){case"ai":case"model":return"model";case"system":case"human":return"user";default:throw new Error(`Unknown / unsupported author: ${n}`)}}function mm(n,e){return typeof n=="string"?[{text:n}]:n.map(t=>{if(t.type==="text")return{text:t.text};if(t.type==="image_url"){if(!e)throw new Error("This model does not support images");if(typeof t.image_url!="string")throw new Error("Please provide image as base64 encoded data URL");let[r,a]=t.image_url.split(",");if(!r.startsWith("data:"))throw new Error("Please provide image as base64 encoded data URL");let[s,i]=r.replace(/^data:/,"").split(";");if(i!=="base64")throw new Error("Please provide image as base64 encoded data URL");return{inlineData:{data:a,mimeType:s}}}throw new Error(`Unknown content type ${t.type}`)})}function ko(n,e){return n.reduce((t,r,a)=>{if(!rr(r))throw new Error("Unsupported message input");let s=pm(r);if(s==="system"&&a!==0)throw new Error("System message should be the first one");let i=fm(s),o=t.content[t.content.length];if(!t.mergeWithPreviousContent&&o&&o.role===i)throw new Error("Google Generative AI requires alternate messages between authors");let u=mm(r.content,e);if(t.mergeWithPreviousContent){let l=t.content[t.content.length-1];if(!l)throw new Error("There was a problem parsing your system message. Please try a prompt without one.");return l.parts.push(...u),{mergeWithPreviousContent:!1,content:t.content}}let c={role:i,parts:u};return{mergeWithPreviousContent:s==="system",content:[...t.content,c]}},{content:[],mergeWithPreviousContent:!1}).content}function Il(n){var i,o;if(!n.candidates||n.candidates.length===0||!n.candidates[0])return{generations:[],llmOutput:{filters:n.promptFeedback}};let[e]=n.candidates,{content:t,...r}=e,a=(o=(i=t==null?void 0:t.parts[0])==null?void 0:i.text)!=null?o:"";return{generations:[{text:a,message:new ce({content:a,name:t?t.role:void 0,additional_kwargs:r}),generationInfo:r}]}}function Tl(n){var s,i;if(!n.candidates||n.candidates.length===0)return null;let[e]=n.candidates,{content:t,...r}=e,a=(i=(s=t==null?void 0:t.parts[0])==null?void 0:s.text)!=null?i:"";return new it({text:a,message:new st({content:a,name:t?t.role:void 0,additional_kwargs:{}}),generationInfo:r})}var Bs=class extends vn{static lc_name(){return"googlegenerativeai"}get lc_secrets(){return{apiKey:"GOOGLE_API_KEY"}}get _isMultimodalModel(){return this.modelName.includes("vision")}constructor(e){var t,r,a,s,i,o,u,c,l,d;if(super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gemini-pro"}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxOutputTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topK",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stopSequences",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"safetySettings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.modelName=(r=(t=e==null?void 0:e.modelName)==null?void 0:t.replace(/^models\//,""))!=null?r:this.modelName,this.maxOutputTokens=(a=e==null?void 0:e.maxOutputTokens)!=null?a:this.maxOutputTokens,this.maxOutputTokens&&this.maxOutputTokens<0)throw new Error("`maxOutputTokens` must be a positive integer");if(this.temperature=(s=e==null?void 0:e.temperature)!=null?s:this.temperature,this.temperature&&(this.temperature<0||this.temperature>1))throw new Error("`temperature` must be in the range of [0.0,1.0]");if(this.topP=(i=e==null?void 0:e.topP)!=null?i:this.topP,this.topP&&this.topP<0)throw new Error("`topP` must be a positive integer");if(this.topP&&this.topP>1)throw new Error("`topP` must be below 1.");if(this.topK=(o=e==null?void 0:e.topK)!=null?o:this.topK,this.topK&&this.topK<0)throw new Error("`topK` must be a positive integer");if(this.stopSequences=(u=e==null?void 0:e.stopSequences)!=null?u:this.stopSequences,this.apiKey=(c=e==null?void 0:e.apiKey)!=null?c:H("GOOGLE_API_KEY"),!this.apiKey)throw new Error("Please set an API key for Google GenerativeAI in the environment variable GOOGLE_API_KEY or in the `apiKey` field of the ChatGoogleGenerativeAI constructor");if(this.safetySettings=(l=e==null?void 0:e.safetySettings)!=null?l:this.safetySettings,this.safetySettings&&this.safetySettings.length>0&&new Set(this.safetySettings.map(p=>p.category)).size!==this.safetySettings.length)throw new Error("The categories in `safetySettings` array must be unique");this.streaming=(d=e==null?void 0:e.streaming)!=null?d:this.streaming,this.client=new Jn(this.apiKey).getGenerativeModel({model:this.modelName,safetySettings:this.safetySettings,generationConfig:{candidateCount:1,stopSequences:this.stopSequences,maxOutputTokens:this.maxOutputTokens,temperature:this.temperature,topP:this.topP,topK:this.topK}})}_combineLLMOutput(){return[]}_llmType(){return"googlegenerativeai"}async _generate(e,t,r){var o,u,c;let a=ko(e,this._isMultimodalModel);if(this.streaming){let l={},d=this._streamResponseChunks(e,t,r),h={};for await(let m of d){let y=(u=(o=m.generationInfo)==null?void 0:o.completion)!=null?u:0;h[y]===void 0?h[y]=m:h[y]=h[y].concat(m)}return{generations:Object.entries(h).sort(([m],[y])=>parseInt(m,10)-parseInt(y,10)).map(([m,y])=>y),llmOutput:{estimatedTokenUsage:l}}}let s=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{var d;let l;try{l=await this.client.generateContent({contents:a})}catch(h){throw(d=h.message)!=null&&d.includes("400 Bad Request")&&(h.status=400),h}return l}),i=Il(s.response);return await(r==null?void 0:r.handleLLMNewToken((c=i.generations[0].text)!=null?c:"")),i}async*_streamResponseChunks(e,t,r){var i;let a=ko(e,this._isMultimodalModel),s=await this.caller.callWithOptions({signal:t==null?void 0:t.signal},async()=>{let{stream:o}=await this.client.generateContentStream({contents:a});return o});for await(let o of s){let u=Tl(o);u&&(yield u,await(r==null?void 0:r.handleLLMNewToken((i=u.text)!=null?i:"")))}}};var Cr="4.29.2";var Sl=!1,Sr,No,ym,bm,_m,Ro,wm,Hs,jo,$o,Mo,Ks,Do;function kl(n,e={auto:!1}){if(Sl)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(Sr)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${Sr}'\``);Sl=e.auto,Sr=n.kind,No=n.fetch,ym=n.Request,bm=n.Response,_m=n.Headers,Ro=n.FormData,wm=n.Blob,Hs=n.File,jo=n.ReadableStream,$o=n.getMultipartRequestOptions,Mo=n.getDefaultAgent,Ks=n.fileFromPath,Do=n.isFsReadStream}var qs=class{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}};function Nl({manuallyImported:n}={}){let e=n?"You may need to use polyfills":"Add one of these imports before your first `import \u2026 from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n",t,r,a,s;try{t=fetch,r=Request,a=Response,s=Headers}catch(i){throw new Error(`this environment is missing the following Web Fetch API type: ${i.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:a,Headers:s,FormData:typeof FormData!="undefined"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob!="undefined"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File!="undefined"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream!="undefined"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(i,o)=>({...o,body:new qs(i)}),getDefaultAgent:i=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:i=>!1}}Sr||kl(Nl(),{auto:!0});var Lo={};ji(Lo,{APIConnectionError:()=>yt,APIConnectionTimeoutError:()=>bt,APIError:()=>Q,APIUserAbortError:()=>X,AuthenticationError:()=>An,BadRequestError:()=>xn,ConflictError:()=>On,InternalServerError:()=>Cn,NotFoundError:()=>Pn,OpenAIError:()=>C,PermissionDeniedError:()=>En,RateLimitError:()=>Tn,UnprocessableEntityError:()=>In});var C=class extends Error{},Q=class n extends C{constructor(e,t,r,a){super(`${n.makeMessage(e,t,r)}`),this.status=e,this.headers=a;let s=t;this.error=s,this.code=s==null?void 0:s.code,this.param=s==null?void 0:s.param,this.type=s==null?void 0:s.type}static makeMessage(e,t,r){let a=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&a?`${e} ${a}`:e?`${e} status code (no body)`:a||"(no status code or body)"}static generate(e,t,r,a){if(!e)return new yt({cause:Vs(t)});let s=t==null?void 0:t.error;return e===400?new xn(e,s,r,a):e===401?new An(e,s,r,a):e===403?new En(e,s,r,a):e===404?new Pn(e,s,r,a):e===409?new On(e,s,r,a):e===422?new In(e,s,r,a):e===429?new Tn(e,s,r,a):e>=500?new Cn(e,s,r,a):new n(e,s,r,a)}},X=class extends Q{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},yt=class extends Q{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},bt=class extends yt{constructor({message:e}={}){super({message:e!=null?e:"Request timed out."})}},xn=class extends Q{constructor(){super(...arguments),this.status=400}},An=class extends Q{constructor(){super(...arguments),this.status=401}},En=class extends Q{constructor(){super(...arguments),this.status=403}},Pn=class extends Q{constructor(){super(...arguments),this.status=404}},On=class extends Q{constructor(){super(...arguments),this.status=409}},In=class extends Q{constructor(){super(...arguments),this.status=422}},Tn=class extends Q{constructor(){super(...arguments),this.status=429}},Cn=class extends Q{};var _t=class n{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1,a=new Fo;async function*s(){if(!e.body)throw t.abort(),new C("Attempted to iterate over a response with no body");let o=new Sn,u=Rl(e.body);for await(let c of u)for(let l of o.decode(c)){let d=a.decode(l);d&&(yield d)}for(let c of o.flush()){let l=a.decode(c);l&&(yield l)}}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(let u of s())if(!o){if(u.data.startsWith("[DONE]")){o=!0;continue}if(u.event===null){let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(c&&c.error)throw new Q(void 0,c.error,void 0,void 0);yield c}else{let c;try{c=JSON.parse(u.data)}catch(l){throw console.error("Could not parse message into JSON:",u.data),console.error("From chunk:",u.raw),l}if(u.event=="error")throw new Q(void 0,c.error,c.message,void 0);yield{event:u.event,data:c}}}o=!0}catch(u){if(u instanceof Error&&u.name==="AbortError")return;throw u}finally{o||t.abort()}}return new n(i,t)}static fromReadableStream(e,t){let r=!1;async function*a(){let i=new Sn,o=Rl(e);for await(let u of o)for(let c of i.decode(u))yield c;for(let u of i.flush())yield u}async function*s(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let i=!1;try{for await(let o of a())i||o&&(yield JSON.parse(o));i=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{i||t.abort()}}return new n(s,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){let e=[],t=[],r=this.iterator(),a=s=>({next:()=>{if(s.length===0){let i=r.next();e.push(i),t.push(i)}return s.shift()}});return[new n(()=>a(e),this.controller),new n(()=>a(t),this.controller)]}toReadableStream(){let e=this,t,r=new TextEncoder;return new jo({async start(){t=e[Symbol.asyncIterator]()},async pull(a){try{let{value:s,done:i}=await t.next();if(i)return a.close();let o=r.encode(JSON.stringify(s)+`
`);a.enqueue(o)}catch(s){a.error(s)}},async cancel(){var a;await((a=t.return)==null?void 0:a.call(t))}})}},Fo=class{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;let s={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],s}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,a]=xm(e,":");return a.startsWith(" ")&&(a=a.substring(1)),t==="event"?this.event=a:t==="data"&&this.data.push(a),null}},Sn=class n{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];let r=n.NEWLINE_CHARS.has(t[t.length-1]||""),a=t.split(n.NEWLINE_REGEXP);return r&&a.pop(),a.length===1&&!r?(this.buffer.push(a[0]),[]):(this.buffer.length>0&&(a=[this.buffer.join("")+a[0],...a.slice(1)],this.buffer=[]),r||(this.buffer=[a.pop()||""]),a)}decodeText(e){var t;if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer!="undefined"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new C(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder!="undefined"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return(t=this.textDecoder)!=null||(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new C(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new C("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];let e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}};Sn.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","\x85","\u2028","\u2029"]);Sn.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function xm(n,e){let t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function Rl(n){if(n[Symbol.asyncIterator])return n;let e=n.getReader();return{async next(){try{let t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){let t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}var jl=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",Am=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&$l(n),$l=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",Em=n=>Am(n)||jl(n)||Do(n);async function Bo(n,e,t={}){var a,s,i;if(n=await n,jl(n)){let o=await n.blob();return e||(e=(a=new URL(n.url).pathname.split(/[\\/]/).pop())!=null?a:"unknown_file"),new Hs([o],e,t)}let r=await Pm(n);if(e||(e=(s=Im(n))!=null?s:"unknown_file"),!t.type){let o=(i=r[0])==null?void 0:i.type;typeof o=="string"&&(t={...t,type:o})}return new Hs(r,e,t)}async function Pm(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if($l(n))e.push(await n.arrayBuffer());else if(Tm(n))for await(let r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${Om(n)}`);return e}function Om(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function Im(n){var e;return zo(n.name)||zo(n.filename)||((e=zo(n.path))==null?void 0:e.split(/[\\/]/).pop())}var zo=n=>{if(typeof n=="string")return n;if(typeof Buffer!="undefined"&&n instanceof Buffer)return String(n)},Tm=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",Ho=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody";var tt=async n=>{let e=await Ml(n.body);return $o(e,n)},Ml=async n=>{let e=new Ro;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Uo(e,t,r))),e};var Uo=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(Em(t)){let r=await Bo(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Uo(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,a])=>Uo(n,`${e}[${r}]`,a)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var Sm=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},km=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Zs;async function zl(n){let{response:e}=n;if(n.options.stream)return kn("response",e.status,e.url,e.headers,e.body),n.options.__streamClass?n.options.__streamClass.fromSSEResponse(e,n.controller):_t.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;let t=e.headers.get("content-type");if((t==null?void 0:t.includes("application/json"))||(t==null?void 0:t.includes("application/vnd.api+json"))){let s=await e.json();return kn("response",e.status,e.url,e.headers,s),s}let a=await e.text();return kn("response",e.status,e.url,e.headers,a),a}var Ws=class n extends Promise{constructor(e,t=zl){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new n(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){let[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}},Js=class{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:a,fetch:s}){this.baseURL=e,this.maxRetries=Ko("maxRetries",t),this.timeout=Ko("timeout",r),this.httpAgent=a,this.fetch=s!=null?s:No}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...Mm(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${zm()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(a=>({method:e,path:t,...a})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer!="undefined")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder!="undefined")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){var m,y,g,_,w,M;let{method:t,path:r,query:a,headers:s={}}=e,i=Ho(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(i),u=this.buildURL(r,a);"timeout"in e&&Ko("timeout",e.timeout);let c=(m=e.timeout)!=null?m:this.timeout,l=(g=(y=e.httpAgent)!=null?y:this.httpAgent)!=null?g:Mo(u),d=c+1e3;typeof((_=l==null?void 0:l.options)==null?void 0:_.timeout)=="number"&&d>((w=l.options.timeout)!=null?w:0)&&(l.options.timeout=d),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),s[this.idempotencyHeader]=e.idempotencyKey);let h=this.buildHeaders({options:e,headers:s,contentLength:o});return{req:{method:t,...i&&{body:i},headers:h,...l&&{agent:l},signal:(M=e.signal)!=null?M:null},url:u,timeout:c}}buildHeaders({options:e,headers:t,contentLength:r}){let a={};r&&(a["content-length"]=r);let s=this.defaultHeaders(e);return Fl(a,s),Fl(a,t),Ho(e.body)&&Sr!=="node"&&delete a["content-type"],this.validateHeaders(a,t),a}async prepareOptions(e){}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,a){return Q.generate(e,t,r,a)}request(e,t=null){return new Ws(this.makeRequest(e,t))}async makeRequest(e,t){var l,d,h;let r=await e;t==null&&(t=(l=r.maxRetries)!=null?l:this.maxRetries),await this.prepareOptions(r);let{req:a,url:s,timeout:i}=this.buildRequest(r);if(await this.prepareRequest(a,{url:s,options:r}),kn("request",s,r,a.headers),(d=r.signal)!=null&&d.aborted)throw new X;let o=new AbortController,u=await this.fetchWithTimeout(s,a,i,o).catch(Vs);if(u instanceof Error){if((h=r.signal)!=null&&h.aborted)throw new X;if(t)return this.retryRequest(r,t);throw u.name==="AbortError"?new bt:new yt({cause:u})}let c=Nm(u.headers);if(!u.ok){if(t&&this.shouldRetry(u)){let w=`retrying, ${t} attempts remaining`;return kn(`response (error; ${w})`,u.status,s,c),this.retryRequest(r,t,c)}let p=await u.text().catch(w=>Vs(w).message),m=Dm(p),y=m?void 0:p;throw kn(`response (error; ${t?"(error; no more retries left)":"(error; not retryable)"})`,u.status,s,c,y),this.makeStatusError(u.status,m,y,c)}return{response:u,options:r,controller:o}}requestAPIList(e,t){let r=this.makeRequest(t,null);return new qo(this,r,e)}buildURL(e,t){let r=Fm(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),a=this.defaultQuery();return Ul(a)||(t={...a,...t}),typeof t=="object"&&t&&!Array.isArray(t)&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r!="undefined").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new C(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,a){let{signal:s,...i}=t||{};s&&s.addEventListener("abort",()=>a.abort());let o=setTimeout(()=>a.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:a.signal,...i}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){let t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){var o;let a,s=r==null?void 0:r["retry-after-ms"];if(s){let u=parseFloat(s);Number.isNaN(u)||(a=u)}let i=r==null?void 0:r["retry-after"];if(i&&!a){let u=parseFloat(i);Number.isNaN(u)?a=Date.parse(i)-Date.now():a=u*1e3}if(!(a&&0<=a&&a<60*1e3)){let u=(o=e.maxRetries)!=null?o:this.maxRetries;a=this.calculateDefaultRetryTimeoutMillis(t,u)}return await Vo(a),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){let s=t-e,i=Math.min(.5*Math.pow(2,s),8),o=1-Math.random()*.25;return i*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${Cr}`}},_a=class{constructor(e,t,r,a){Zs.set(this,void 0),Sm(this,Zs,e,"f"),this.options=a,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){let e=this.nextPageInfo();if(!e)throw new C("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");let t={...this.options};if("params"in e&&typeof t.query=="object")t.query={...t.query,...e.params};else if("url"in e){let r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(let[a,s]of r)e.url.searchParams.set(a,s);t.query=void 0,t.path=e.url.toString()}return await km(this,Zs,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(Zs=new WeakMap,Symbol.asyncIterator)](){for await(let e of this.iterPages())for(let t of e.getPaginatedItems())yield t}},qo=class extends Ws{constructor(e,t,r){super(t,async a=>new r(e,a.response,await zl(a),a.options))}async*[Symbol.asyncIterator](){let e=await this;for await(let t of e)yield t}},Nm=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){let r=t.toString();return e[r.toLowerCase()]||e[r]}}),Rm={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0,__streamClass:!0},ee=n=>typeof n=="object"&&n!==null&&!Ul(n)&&Object.keys(n).every(e=>Bl(Rm,e)),jm=()=>{if(typeof Deno!="undefined"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cr,"X-Stainless-OS":Ll(Deno.build.os),"X-Stainless-Arch":Dl(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime!="undefined")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process!="undefined"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cr,"X-Stainless-OS":Ll(process.platform),"X-Stainless-Arch":Dl(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};let n=$m();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":Cr,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function $m(){if(typeof navigator=="undefined"||!navigator)return null;let n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(let{key:e,pattern:t}of n){let r=t.exec(navigator.userAgent);if(r){let a=r[1]||0,s=r[2]||0,i=r[3]||0;return{browser:e,version:`${a}.${s}.${i}`}}}return null}var Dl=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",Ll=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown"),Gs,Mm=()=>Gs!=null?Gs:Gs=jm(),Dm=n=>{try{return JSON.parse(n)}catch(e){return}},Lm=new RegExp("^(?:[a-z]+:)?//","i"),Fm=n=>Lm.test(n),Vo=n=>new Promise(e=>setTimeout(e,n)),Ko=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new C(`${n} must be an integer`);if(e<0)throw new C(`${n} must be a positive integer`);return e},Vs=n=>n instanceof Error?n:new Error(n);var Ys=n=>{var e,t,r,a,s,i;if(typeof process!="undefined")return(r=(t=(e=process.env)==null?void 0:e[n])==null?void 0:t.trim())!=null?r:void 0;if(typeof Deno!="undefined")return(i=(s=(a=Deno.env)==null?void 0:a.get)==null?void 0:s.call(a,n))==null?void 0:i.trim()};function Ul(n){if(!n)return!0;for(let e in n)return!1;return!0}function Bl(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Fl(n,e){for(let t in e){if(!Bl(e,t))continue;let r=t.toLowerCase();if(!r)continue;let a=e[t];a===null?delete n[r]:a!==void 0&&(n[r]=a)}}function kn(n,...e){typeof process!="undefined"&&process.env.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}var zm=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{let e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Hl=()=>typeof window!="undefined"&&typeof window.document!="undefined"&&typeof navigator!="undefined";function Zo(n){return n!=null&&typeof n=="object"&&!Array.isArray(n)}var Lt=class extends _a{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[],this.object=r.object}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){return null}nextPageInfo(){return null}},te=class extends _a{constructor(e,t,r,a){super(e,t,r,a),this.data=r.data||[]}getPaginatedItems(){var e;return(e=this.data)!=null?e:[]}nextPageParams(){let e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;let t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;let e=this.getPaginatedItems();if(!e.length)return null;let t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}};var P=class{constructor(e){this._client=e}};var kr=class extends P{create(e,t){var r;return this._client.post("/chat/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};kr||(kr={});var Ft=class extends P{constructor(){super(...arguments),this.completions=new kr(this._client)}};(function(n){n.Completions=kr})(Ft||(Ft={}));var Nr=class extends P{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}};Nr||(Nr={});var Rr=class extends P{create(e,t){return this._client.post("/audio/transcriptions",tt({body:e,...t}))}};Rr||(Rr={});var jr=class extends P{create(e,t){return this._client.post("/audio/translations",tt({body:e,...t}))}};jr||(jr={});var zt=class extends P{constructor(){super(...arguments),this.transcriptions=new Rr(this._client),this.translations=new jr(this._client),this.speech=new Nr(this._client)}};(function(n){n.Transcriptions=Rr,n.Translations=jr,n.Speech=Nr})(zt||(zt={}));var $r=class extends P{create(e,t,r){return this._client.post(`/assistants/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e,t={},r){return ee(t)?this.list(e,{},t):this._client.getAPIList(`/assistants/${e}/files`,Mr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}},Mr=class extends te{};(function(n){n.AssistantFilesPage=Mr})($r||($r={}));var Dr=class extends P{constructor(){super(...arguments),this.files=new $r(this._client)}create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e={},t){return ee(e)?this.list({},e):this._client.getAPIList("/assistants",Lr,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}},Lr=class extends te{};(function(n){n.AssistantsPage=Lr,n.Files=$r,n.AssistantFilesPage=Mr})(Dr||(Dr={}));function Go(n){return typeof n.parse=="function"}var Ut=n=>(n==null?void 0:n.role)==="assistant",Wo=n=>(n==null?void 0:n.role)==="function",Jo=n=>(n==null?void 0:n.role)==="tool";var He=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},$=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},pe,Xs,Qs,wa,va,ei,xa,wt,Aa,ti,ri,Nn,Yo,ni,Xo,Qo,eu,tu,Gl,ru,Zl=10,Rn=class{constructor(){pe.add(this),this.controller=new AbortController,Xs.set(this,void 0),Qs.set(this,()=>{}),wa.set(this,()=>{}),va.set(this,void 0),ei.set(this,()=>{}),xa.set(this,()=>{}),wt.set(this,{}),this._chatCompletions=[],this.messages=[],Aa.set(this,!1),ti.set(this,!1),ri.set(this,!1),Nn.set(this,!1),tu.set(this,e=>{if(He(this,ti,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new X),e instanceof X)return He(this,ri,!0,"f"),this._emit("abort",e);if(e instanceof C)return this._emit("error",e);if(e instanceof Error){let t=new C(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new C(String(e)))}),He(this,Xs,new Promise((e,t)=>{He(this,Qs,e,"f"),He(this,wa,t,"f")}),"f"),He(this,va,new Promise((e,t)=>{He(this,ei,e,"f"),He(this,xa,t,"f")}),"f"),$(this,Xs,"f").catch(()=>{}),$(this,va,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},$(this,tu,"f"))},0)}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);let t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Wo(e)||Jo(e))&&e.content)this._emit("functionCallResult",e.content);else if(Ut(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Ut(e)&&e.tool_calls)for(let r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||($(this,Qs,"f").call(this),this._emit("connect"))}get ended(){return $(this,Aa,"f")}get errored(){return $(this,ti,"f")}get aborted(){return $(this,ri,"f")}abort(){this.controller.abort()}on(e,t){return($(this,wt,"f")[e]||($(this,wt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=$(this,wt,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return($(this,wt,"f")[e]||($(this,wt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{He(this,Nn,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){He(this,Nn,!0,"f"),await $(this,va,"f")}async finalChatCompletion(){await this.done();let e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new C("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),$(this,pe,"m",Yo).call(this)}async finalMessage(){return await this.done(),$(this,pe,"m",ni).call(this)}async finalFunctionCall(){return await this.done(),$(this,pe,"m",Xo).call(this)}async finalFunctionCallResult(){return await this.done(),$(this,pe,"m",Qo).call(this)}async totalUsage(){return await this.done(),$(this,pe,"m",eu).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if($(this,Aa,"f"))return;e==="end"&&(He(this,Aa,!0,"f"),$(this,ei,"f").call(this));let r=$(this,wt,"f")[e];if(r&&($(this,wt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!$(this,Nn,"f")&&!(r!=null&&r.length)&&Promise.reject(a),$(this,wa,"f").call(this,a),$(this,xa,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!$(this,Nn,"f")&&!(r!=null&&r.length)&&Promise.reject(a),$(this,wa,"f").call(this,a),$(this,xa,"f").call(this,a),this._emit("end")}}_emitFinal(){let e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);let t=$(this,pe,"m",ni).call(this);t&&this._emit("finalMessage",t);let r=$(this,pe,"m",Yo).call(this);r&&this._emit("finalContent",r);let a=$(this,pe,"m",Xo).call(this);a&&this._emit("finalFunctionCall",a);let s=$(this,pe,"m",Qo).call(this);s!=null&&this._emit("finalFunctionCallResult",s),this._chatCompletions.some(i=>i.usage)&&this._emit("totalUsage",$(this,pe,"m",eu).call(this))}async _createChatCompletion(e,t,r){let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),$(this,pe,"m",Gl).call(this,t);let s=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(s)}async _runChatCompletion(e,t,r){for(let a of t.messages)this._addMessage(a,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var h;let a="function",{function_call:s="auto",stream:i,...o}=t,u=typeof s!="string"&&(s==null?void 0:s.name),{maxChatCompletions:c=Zl}=r||{},l={};for(let p of t.functions)l[p.name||p.function.name]=p;let d=t.functions.map(p=>({name:p.name||p.function.name,parameters:p.parameters,description:p.description}));for(let p of t.messages)this._addMessage(p,!1);for(let p=0;p<c;++p){let y=(h=(await this._createChatCompletion(e,{...o,function_call:s,functions:d,messages:[...this.messages]},r)).choices[0])==null?void 0:h.message;if(!y)throw new C("missing message in ChatCompletion response");if(!y.function_call)return;let{name:g,arguments:_}=y.function_call,w=l[g];if(w){if(u&&u!==g){let S=`Invalid function_call: ${JSON.stringify(g)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,name:g,content:S});continue}}else{let S=`Invalid function_call: ${JSON.stringify(g)}. Available options are: ${d.map(V=>JSON.stringify(V.name)).join(", ")}. Please try again`;this._addMessage({role:a,name:g,content:S});continue}let M;try{M=Go(w)?await w.parse(_):_}catch(S){this._addMessage({role:a,name:g,content:S instanceof Error?S.message:String(S)});continue}let z=await w.function(M,this),D=$(this,pe,"m",ru).call(this,z);if(this._addMessage({role:a,name:g,content:D}),u)return}}async _runTools(e,t,r){var h,p;let a="tool",{tool_choice:s="auto",stream:i,...o}=t,u=typeof s!="string"&&((h=s==null?void 0:s.function)==null?void 0:h.name),{maxChatCompletions:c=Zl}=r||{},l={};for(let m of t.tools)m.type==="function"&&(l[m.function.name||m.function.function.name]=m.function);let d="tools"in t?t.tools.map(m=>m.type==="function"?{type:"function",function:{name:m.function.name||m.function.function.name,parameters:m.function.parameters,description:m.function.description}}:m):void 0;for(let m of t.messages)this._addMessage(m,!1);for(let m=0;m<c;++m){let g=(p=(await this._createChatCompletion(e,{...o,tool_choice:s,tools:d,messages:[...this.messages]},r)).choices[0])==null?void 0:p.message;if(!g)throw new C("missing message in ChatCompletion response");if(!g.tool_calls)return;for(let _ of g.tool_calls){if(_.type!=="function")continue;let w=_.id,{name:M,arguments:z}=_.function,D=l[M];if(D){if(u&&u!==M){let B=`Invalid tool_call: ${JSON.stringify(M)}. ${JSON.stringify(u)} requested. Please try again`;this._addMessage({role:a,tool_call_id:w,content:B});continue}}else{let B=`Invalid tool_call: ${JSON.stringify(M)}. Available options are: ${d.map(at=>JSON.stringify(at.function.name)).join(", ")}. Please try again`;this._addMessage({role:a,tool_call_id:w,content:B});continue}let S;try{S=Go(D)?await D.parse(z):z}catch(B){let at=B instanceof Error?B.message:String(B);this._addMessage({role:a,tool_call_id:w,content:at});continue}let V=await D.function(S,this),k=$(this,pe,"m",ru).call(this,V);if(this._addMessage({role:a,tool_call_id:w,content:k}),u)return}}}};Xs=new WeakMap,Qs=new WeakMap,wa=new WeakMap,va=new WeakMap,ei=new WeakMap,xa=new WeakMap,wt=new WeakMap,Aa=new WeakMap,ti=new WeakMap,ri=new WeakMap,Nn=new WeakMap,tu=new WeakMap,pe=new WeakSet,Yo=function(){var e;return(e=$(this,pe,"m",ni).call(this).content)!=null?e:null},ni=function(){var t;let e=this.messages.length;for(;e-- >0;){let r=this.messages[e];if(Ut(r))return{...r,content:(t=r.content)!=null?t:null}}throw new C("stream ended without producing a ChatCompletionMessage with role=assistant")},Xo=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){let a=this.messages[r];if(Ut(a)&&(a!=null&&a.function_call))return a.function_call;if(Ut(a)&&((e=a==null?void 0:a.tool_calls)!=null&&e.length))return(t=a.tool_calls.at(-1))==null?void 0:t.function}},Qo=function(){for(let e=this.messages.length-1;e>=0;e--){let t=this.messages[e];if(Wo(t)&&t.content!=null||Jo(t)&&t.content!=null&&this.messages.some(r=>{var a;return r.role==="assistant"&&((a=r.tool_calls)==null?void 0:a.some(s=>s.type==="function"&&s.id===t.tool_call_id))}))return t.content}},eu=function(){let e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(let{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Gl=function(e){if(e.n!=null&&e.n>1)throw new C("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ru=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};var Ea=class n extends Rn{static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}_addMessage(e){super._addMessage(e),Ut(e)&&e.content&&this._emit("content",e.content)}};var Ke=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},nu=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},rt,Bt,au,su,ai,Wl,jn=class n extends Rn{constructor(){super(...arguments),rt.add(this),Bt.set(this,void 0)}get currentChatCompletionSnapshot(){return Ke(this,Bt,"f")}static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){let a=new n;return a._run(()=>a._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}async _createChatCompletion(e,t,r){var i;let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort())),Ke(this,rt,"m",au).call(this);let s=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(let o of s)Ke(this,rt,"m",su).call(this,o);if((i=s.controller.signal)!=null&&i.aborted)throw new X;return this._addChatCompletion(Ke(this,rt,"m",ai).call(this))}async _fromReadableStream(e,t){var i;let r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Ke(this,rt,"m",au).call(this),this._connected();let a=_t.fromReadableStream(e,this.controller),s;for await(let o of a)s&&s!==o.id&&this._addChatCompletion(Ke(this,rt,"m",ai).call(this)),Ke(this,rt,"m",su).call(this,o),s=o.id;if((i=a.controller.signal)!=null&&i.aborted)throw new X;return this._addChatCompletion(Ke(this,rt,"m",ai).call(this))}[(Bt=new WeakMap,rt=new WeakSet,au=function(){this.ended||nu(this,Bt,void 0,"f")},su=function(t){var i,o,u;if(this.ended)return;let r=Ke(this,rt,"m",Wl).call(this,t);this._emit("chunk",t,r);let a=(o=(i=t.choices[0])==null?void 0:i.delta)==null?void 0:o.content,s=(u=r.choices[0])==null?void 0:u.message;a!=null&&(s==null?void 0:s.role)==="assistant"&&(s!=null&&s.content)&&this._emit("content",a,s.content)},ai=function(){if(this.ended)throw new C("stream has ended, this shouldn't happen");let t=Ke(this,Bt,"f");if(!t)throw new C("request ended without sending any chunks");return nu(this,Bt,void 0,"f"),Vm(t)},Wl=function(t){var c,l,d,h;var r,a,s;let i=Ke(this,Bt,"f"),{choices:o,...u}=t;i?Object.assign(i,u):i=nu(this,Bt,{...u,choices:[]},"f");for(let{delta:p,finish_reason:m,index:y,logprobs:g=null,..._}of t.choices){let w=i.choices[y];if(w||(w=i.choices[y]={finish_reason:m,index:y,message:{},logprobs:g,..._}),g)if(!w.logprobs)w.logprobs=Object.assign({},g);else{let{content:k,...B}=g;Object.assign(w.logprobs,B),k&&((c=(r=w.logprobs).content)!=null||(r.content=[]),w.logprobs.content.push(...k))}if(m&&(w.finish_reason=m),Object.assign(w,_),!p)continue;let{content:M,function_call:z,role:D,tool_calls:S,...V}=p;if(Object.assign(w.message,V),M&&(w.message.content=(w.message.content||"")+M),D&&(w.message.role=D),z&&(w.message.function_call?(z.name&&(w.message.function_call.name=z.name),z.arguments&&((l=(a=w.message.function_call).arguments)!=null||(a.arguments=""),w.message.function_call.arguments+=z.arguments)):w.message.function_call=z),S){w.message.tool_calls||(w.message.tool_calls=[]);for(let{index:k,id:B,type:at,function:Te,...Ba}of S){let Ge=(d=(s=w.message.tool_calls)[k])!=null?d:s[k]={};Object.assign(Ge,Ba),B&&(Ge.id=B),at&&(Ge.type=at),Te&&((h=Ge.function)!=null||(Ge.function={arguments:""})),Te!=null&&Te.name&&(Ge.function.name=Te.name),Te!=null&&Te.arguments&&(Ge.function.arguments+=Te.arguments)}}}return i},Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("chunk",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new _t(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}};function Vm(n){let{id:e,choices:t,created:r,model:a,system_fingerprint:s,...i}=n;return{...i,id:e,choices:t.map(({message:o,finish_reason:u,index:c,logprobs:l,...d})=>{if(!u)throw new C(`missing finish_reason for choice ${c}`);let{content:h=null,function_call:p,tool_calls:m,...y}=o,g=o.role;if(!g)throw new C(`missing role for choice ${c}`);if(p){let{arguments:_,name:w}=p;if(_==null)throw new C(`missing function_call.arguments for choice ${c}`);if(!w)throw new C(`missing function_call.name for choice ${c}`);return{...d,message:{content:h,function_call:{arguments:_,name:w},role:g},finish_reason:u,index:c,logprobs:l}}return m?{...d,index:c,finish_reason:u,logprobs:l,message:{...y,role:g,content:h,tool_calls:m.map((_,w)=>{let{function:M,type:z,id:D,...S}=_,{arguments:V,name:k,...B}=M||{};if(D==null)throw new C(`missing choices[${c}].tool_calls[${w}].id
${si(n)}`);if(z==null)throw new C(`missing choices[${c}].tool_calls[${w}].type
${si(n)}`);if(k==null)throw new C(`missing choices[${c}].tool_calls[${w}].function.name
${si(n)}`);if(V==null)throw new C(`missing choices[${c}].tool_calls[${w}].function.arguments
${si(n)}`);return{...S,id:D,type:z,function:{...B,name:k,arguments:V}}})}}:{...d,message:{...y,content:h,role:g},finish_reason:u,index:c,logprobs:l}}),created:r,model:a,object:"chat.completion",...s?{system_fingerprint:s}:{}}}function si(n){return JSON.stringify(n)}var Pa=class n extends jn{static fromReadableStream(e){let t=new n;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return a._run(()=>a._runFunctions(e,t,s)),a}static runTools(e,t,r){let a=new n,s={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return a._run(()=>a._runTools(e,t,s)),a}};var Oa=class extends P{runFunctions(e,t){return e.stream?Pa.runFunctions(this._client.chat.completions,e,t):Ea.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?Pa.runTools(this._client.chat.completions,e,t):Ea.runTools(this._client.chat.completions,e,t)}stream(e,t){return jn.createChatCompletion(this._client.chat.completions,e,t)}};var Fr=class extends P{constructor(){super(...arguments),this.completions=new Oa(this._client)}};(function(n){n.Completions=Oa})(Fr||(Fr={}));var qe=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},W=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ii,oi,Ia,Ta,ui,Ca,vt,Sa,ci,li,$n,iu,di=class{constructor(){this.controller=new AbortController,ii.set(this,void 0),oi.set(this,()=>{}),Ia.set(this,()=>{}),Ta.set(this,void 0),ui.set(this,()=>{}),Ca.set(this,()=>{}),vt.set(this,{}),Sa.set(this,!1),ci.set(this,!1),li.set(this,!1),$n.set(this,!1),iu.set(this,e=>{if(qe(this,ci,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new X),e instanceof X)return qe(this,li,!0,"f"),this._emit("abort",e);if(e instanceof C)return this._emit("error",e);if(e instanceof Error){let t=new C(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new C(String(e)))}),qe(this,ii,new Promise((e,t)=>{qe(this,oi,e,"f"),qe(this,Ia,t,"f")}),"f"),qe(this,Ta,new Promise((e,t)=>{qe(this,ui,e,"f"),qe(this,Ca,t,"f")}),"f"),W(this,ii,"f").catch(()=>{}),W(this,Ta,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emit("end")},W(this,iu,"f"))},0)}_addRun(e){return e}_connected(){this.ended||(W(this,oi,"f").call(this),this._emit("connect"))}get ended(){return W(this,Sa,"f")}get errored(){return W(this,ci,"f")}get aborted(){return W(this,li,"f")}abort(){this.controller.abort()}on(e,t){return(W(this,vt,"f")[e]||(W(this,vt,"f")[e]=[])).push({listener:t}),this}off(e,t){let r=W(this,vt,"f")[e];if(!r)return this;let a=r.findIndex(s=>s.listener===t);return a>=0&&r.splice(a,1),this}once(e,t){return(W(this,vt,"f")[e]||(W(this,vt,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{qe(this,$n,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){qe(this,$n,!0,"f"),await W(this,Ta,"f")}_emit(e,...t){if(W(this,Sa,"f"))return;e==="end"&&(qe(this,Sa,!0,"f"),W(this,ui,"f").call(this));let r=W(this,vt,"f")[e];if(r&&(W(this,vt,"f")[e]=r.filter(a=>!a.once),r.forEach(({listener:a})=>a(...t))),e==="abort"){let a=t[0];!W(this,$n,"f")&&!(r!=null&&r.length)&&Promise.reject(a),W(this,Ia,"f").call(this,a),W(this,Ca,"f").call(this,a),this._emit("end");return}if(e==="error"){let a=t[0];!W(this,$n,"f")&&!(r!=null&&r.length)&&Promise.reject(a),W(this,Ia,"f").call(this,a),W(this,Ca,"f").call(this,a),this._emit("end")}}async _threadAssistantStream(e,t,r){return await this._createThreadAssistantStream(t,e,r)}async _runAssistantStream(e,t,r,a){return await this._createAssistantStream(t,e,r,a)}async _runToolAssistantStream(e,t,r,a,s){return await this._createToolAssistantStream(r,e,t,a,s)}async _createThreadAssistantStream(e,t,r){let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s=await e.createAndRun({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addRun(s)}async _createToolAssistantStream(e,t,r,a,s){let i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o=await e.submitToolOutputs(t,r,{...a,stream:!1},{...s,signal:this.controller.signal});return this._connected(),this._addRun(o)}async _createAssistantStream(e,t,r,a){let s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i=await e.create(t,{...r,stream:!1},{...a,signal:this.controller.signal});return this._connected(),this._addRun(i)}};ii=new WeakMap,oi=new WeakMap,Ia=new WeakMap,Ta=new WeakMap,ui=new WeakMap,Ca=new WeakMap,vt=new WeakMap,Sa=new WeakMap,ci=new WeakMap,li=new WeakMap,$n=new WeakMap,iu=new WeakMap;var A=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Oe=function(n,e,t,r,a){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!a)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!a:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?a.call(n,t):a?a.value=t:e.set(n,t),t},be,ou,nt,hi,Ve,Ur,Mn,zr,yi,Ie,pi,fi,ka,mi,gi,Jl,Yl,Xl,Ql,ed,td,rd,xt=class n extends di{constructor(){super(...arguments),be.add(this),ou.set(this,[]),nt.set(this,{}),hi.set(this,{}),Ve.set(this,void 0),Ur.set(this,void 0),Mn.set(this,void 0),zr.set(this,void 0),yi.set(this,void 0),Ie.set(this,void 0),pi.set(this,void 0),fi.set(this,void 0),ka.set(this,void 0)}[(ou=new WeakMap,nt=new WeakMap,hi=new WeakMap,Ve=new WeakMap,Ur=new WeakMap,Mn=new WeakMap,zr=new WeakMap,yi=new WeakMap,Ie=new WeakMap,pi=new WeakMap,fi=new WeakMap,ka=new WeakMap,be=new WeakSet,Symbol.asyncIterator)](){let e=[],t=[],r=!1;return this.on("event",a=>{let s=t.shift();s?s.resolve(a):e.push(a)}),this.on("end",()=>{r=!0;for(let a of t)a.resolve(void 0);t.length=0}),this.on("abort",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),this.on("error",a=>{r=!0;for(let s of t)s.reject(a);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise((s,i)=>t.push({resolve:s,reject:i})).then(s=>s?{value:s,done:!1}:{value:void 0,done:!0}),return:async()=>(this.abort(),{value:void 0,done:!0})}}toReadableStream(){return new _t(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}static createToolAssistantStream(e,t,r,a,s){let i=new n;return i._run(()=>i._runToolAssistantStream(e,t,r,a,{...s,headers:{...s==null?void 0:s.headers,"X-Stainless-Helper-Method":"stream"}})),i}async _createToolAssistantStream(e,t,r,a,s){var c;let i=s==null?void 0:s.signal;i&&(i.aborted&&this.controller.abort(),i.addEventListener("abort",()=>this.controller.abort()));let o={...a,stream:!0},u=await e.submitToolOutputs(t,r,o,{...s,signal:this.controller.signal});this._connected();for await(let l of u)A(this,be,"m",mi).call(this,l);if((c=u.controller.signal)!=null&&c.aborted)throw new X;return this._addRun(A(this,be,"m",gi).call(this))}static createThreadAssistantStream(e,t,r){let a=new n;return a._run(()=>a._threadAssistantStream(e,t,{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),a}static createAssistantStream(e,t,r,a){let s=new n;return s._run(()=>s._runAssistantStream(e,t,r,{...a,headers:{...a==null?void 0:a.headers,"X-Stainless-Helper-Method":"stream"}})),s}currentEvent(){return A(this,pi,"f")}currentRun(){return A(this,fi,"f")}currentMessageSnapshot(){return A(this,Ve,"f")}currentRunStepSnapshot(){return A(this,ka,"f")}async finalRunSteps(){return await this.done(),Object.values(A(this,nt,"f"))}async finalMessages(){return await this.done(),Object.values(A(this,hi,"f"))}async finalRun(){if(await this.done(),!A(this,Ur,"f"))throw Error("Final run was not received.");return A(this,Ur,"f")}async _createThreadAssistantStream(e,t,r){var o;let a=r==null?void 0:r.signal;a&&(a.aborted&&this.controller.abort(),a.addEventListener("abort",()=>this.controller.abort()));let s={...t,stream:!0},i=await e.createAndRun(s,{...r,signal:this.controller.signal});this._connected();for await(let u of i)A(this,be,"m",mi).call(this,u);if((o=i.controller.signal)!=null&&o.aborted)throw new X;return this._addRun(A(this,be,"m",gi).call(this))}async _createAssistantStream(e,t,r,a){var u;let s=a==null?void 0:a.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort()));let i={...r,stream:!0},o=await e.create(t,i,{...a,signal:this.controller.signal});this._connected();for await(let c of o)A(this,be,"m",mi).call(this,c);if((u=o.controller.signal)!=null&&u.aborted)throw new X;return this._addRun(A(this,be,"m",gi).call(this))}static accumulateDelta(e,t){for(let[r,a]of Object.entries(t)){if(!e.hasOwnProperty(r)){e[r]=a;continue}let s=e[r];if(s==null){e[r]=a;continue}if(r==="index"||r==="type"){e[r]=a;continue}if(typeof s=="string"&&typeof a=="string")s+=a;else if(typeof s=="number"&&typeof a=="number")s+=a;else if(Zo(s)&&Zo(a))s=this.accumulateDelta(s,a);else if(Array.isArray(s)&&Array.isArray(a)){if(s.every(i=>typeof i=="string"||typeof i=="number")){s.push(...a);continue}}else throw Error(`Unhandled record type: ${r}, deltaValue: ${a}, accValue: ${s}`);e[r]=s}return e}};mi=function(e){if(!this.ended)switch(Oe(this,pi,e,"f"),A(this,be,"m",Xl).call(this,e),e.event){case"thread.created":break;case"thread.run.created":case"thread.run.queued":case"thread.run.in_progress":case"thread.run.requires_action":case"thread.run.completed":case"thread.run.failed":case"thread.run.cancelling":case"thread.run.cancelled":case"thread.run.expired":A(this,be,"m",rd).call(this,e);break;case"thread.run.step.created":case"thread.run.step.in_progress":case"thread.run.step.delta":case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":A(this,be,"m",Yl).call(this,e);break;case"thread.message.created":case"thread.message.in_progress":case"thread.message.delta":case"thread.message.completed":case"thread.message.incomplete":A(this,be,"m",Jl).call(this,e);break;case"error":throw new Error("Encountered an error event in event processing - errors should be processed earlier")}},gi=function(){if(this.ended)throw new C("stream has ended, this shouldn't happen");if(!A(this,Ur,"f"))throw Error("Final run has been been received");return A(this,Ur,"f")},Jl=function(e){let[t,r]=A(this,be,"m",ed).call(this,e,A(this,Ve,"f"));Oe(this,Ve,t,"f"),A(this,hi,"f")[t.id]=t;for(let a of r){let s=t.content[a.index];(s==null?void 0:s.type)=="text"&&this._emit("textCreated",s.text)}switch(e.event){case"thread.message.created":this._emit("messageCreated",e.data);break;case"thread.message.in_progress":break;case"thread.message.delta":if(this._emit("messageDelta",e.data.delta,t),e.data.delta.content)for(let a of e.data.delta.content){if(a.type=="text"&&a.text){let s=a.text,i=t.content[a.index];if(i&&i.type=="text")this._emit("textDelta",s,i.text);else throw Error("The snapshot associated with this text delta is not text or missing")}if(a.index!=A(this,Mn,"f")){if(A(this,zr,"f"))switch(A(this,zr,"f").type){case"text":this._emit("textDone",A(this,zr,"f").text,A(this,Ve,"f"));break;case"image_file":this._emit("imageFileDone",A(this,zr,"f").image_file,A(this,Ve,"f"));break}Oe(this,Mn,a.index,"f")}Oe(this,zr,t.content[a.index],"f")}break;case"thread.message.completed":case"thread.message.incomplete":if(A(this,Mn,"f")!==void 0){let a=e.data.content[A(this,Mn,"f")];if(a)switch(a.type){case"image_file":this._emit("imageFileDone",a.image_file,A(this,Ve,"f"));break;case"text":this._emit("textDone",a.text,A(this,Ve,"f"));break}}A(this,Ve,"f")&&this._emit("messageDone",e.data),Oe(this,Ve,void 0,"f")}},Yl=function(e){let t=A(this,be,"m",Ql).call(this,e);switch(Oe(this,ka,t,"f"),e.event){case"thread.run.step.created":this._emit("runStepCreated",e.data);break;case"thread.run.step.delta":let r=e.data.delta;if(r.step_details&&r.step_details.type=="tool_calls"&&r.step_details.tool_calls&&t.step_details.type=="tool_calls")for(let s of r.step_details.tool_calls)s.index==A(this,yi,"f")?this._emit("toolCallDelta",s,t.step_details.tool_calls[s.index]):(A(this,Ie,"f")&&this._emit("toolCallDone",A(this,Ie,"f")),Oe(this,yi,s.index,"f"),Oe(this,Ie,t.step_details.tool_calls[s.index],"f"),A(this,Ie,"f")&&this._emit("toolCallCreated",A(this,Ie,"f")));this._emit("runStepDelta",e.data.delta,t);break;case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":Oe(this,ka,void 0,"f"),e.data.step_details.type=="tool_calls"&&A(this,Ie,"f")&&(this._emit("toolCallDone",A(this,Ie,"f")),Oe(this,Ie,void 0,"f")),this._emit("runStepDone",e.data,t);break;case"thread.run.step.in_progress":break}},Xl=function(e){A(this,ou,"f").push(e),this._emit("event",e)},Ql=function(e){switch(e.event){case"thread.run.step.created":return A(this,nt,"f")[e.data.id]=e.data,e.data;case"thread.run.step.delta":let t=A(this,nt,"f")[e.data.id];if(!t)throw Error("Received a RunStepDelta before creation of a snapshot");let r=e.data;if(r.delta){let a=xt.accumulateDelta(t,r.delta);A(this,nt,"f")[e.data.id]=a}return A(this,nt,"f")[e.data.id];case"thread.run.step.completed":case"thread.run.step.failed":case"thread.run.step.cancelled":case"thread.run.step.expired":case"thread.run.step.in_progress":A(this,nt,"f")[e.data.id]=e.data;break}if(A(this,nt,"f")[e.data.id])return A(this,nt,"f")[e.data.id];throw new Error("No snapshot available")},ed=function(e,t){let r=[];switch(e.event){case"thread.message.created":return[e.data,r];case"thread.message.delta":if(!t)throw Error("Received a delta with no existing snapshot (there should be one from message creation)");let a=e.data;if(a.delta.content)for(let s of a.delta.content)if(s.index in t.content){let i=t.content[s.index];t.content[s.index]=A(this,be,"m",td).call(this,s,i)}else t.content[s.index]=s,r.push(s);return[t,r];case"thread.message.in_progress":case"thread.message.completed":case"thread.message.incomplete":if(t)return[t,r];throw Error("Received thread message event with no existing snapshot")}throw Error("Tried to accumulate a non-message event")},td=function(e,t){return xt.accumulateDelta(t,e)},rd=function(e){switch(Oe(this,fi,e.data,"f"),e.event){case"thread.run.created":break;case"thread.run.queued":break;case"thread.run.in_progress":break;case"thread.run.requires_action":case"thread.run.cancelled":case"thread.run.failed":case"thread.run.completed":case"thread.run.expired":Oe(this,Ur,e.data,"f"),A(this,Ie,"f")&&(this._emit("toolCallDone",A(this,Ie,"f")),Oe(this,Ie,void 0,"f"));break;case"thread.run.cancelling":break}};var Br=class extends P{retrieve(e,t,r,a){return this._client.get(`/threads/${e}/messages/${t}/files/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t,r={},a){return ee(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/messages/${t}/files`,Hr,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}},Hr=class extends te{};(function(n){n.MessageFilesPage=Hr})(Br||(Br={}));var Kr=class extends P{constructor(){super(...arguments),this.files=new Br(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t={},r){return ee(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,qr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}},qr=class extends te{};(function(n){n.MessagesPage=qr,n.Files=Br,n.MessageFilesPage=Hr})(Kr||(Kr={}));var Vr=class extends P{retrieve(e,t,r,a){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t,r={},a){return ee(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,Zr,{query:r,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}},Zr=class extends te{};(function(n){n.RunStepsPage=Zr})(Vr||(Vr={}));var Gr=class extends P{constructor(){super(...arguments),this.steps=new Vr(this._client)}create(e,t,r){var a;return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers},stream:(a=t.stream)!=null?a:!1})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,a){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers}})}list(e,t={},r){return ee(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,Wr,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}createAndStream(e,t,r){return xt.createAssistantStream(e,this._client.beta.threads.runs,t,r)}submitToolOutputs(e,t,r,a){var s;return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...a,headers:{"OpenAI-Beta":"assistants=v1",...a==null?void 0:a.headers},stream:(s=r.stream)!=null?s:!1})}submitToolOutputsStream(e,t,r,a){return xt.createToolAssistantStream(e,t,this._client.beta.threads.runs,r,a)}},Wr=class extends te{};(function(n){n.RunsPage=Wr,n.Steps=Vr,n.RunStepsPage=Zr})(Gr||(Gr={}));var Jr=class extends P{constructor(){super(...arguments),this.runs=new Gr(this._client),this.messages=new Kr(this._client)}create(e={},t){return ee(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}createAndRun(e,t){var r;return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers},stream:(r=e.stream)!=null?r:!1})}createAndRunStream(e,t){return xt.createThreadAssistantStream(e,this._client.beta.threads,t)}};(function(n){n.Runs=Gr,n.RunsPage=Wr,n.Messages=Kr,n.MessagesPage=qr})(Jr||(Jr={}));var Ht=class extends P{constructor(){super(...arguments),this.chat=new Fr(this._client),this.assistants=new Dr(this._client),this.threads=new Jr(this._client)}};(function(n){n.Chat=Fr,n.Assistants=Dr,n.AssistantsPage=Lr,n.Threads=Jr})(Ht||(Ht={}));var Kt=class extends P{create(e,t){var r;return this._client.post("/completions",{body:e,...t,stream:(r=e.stream)!=null?r:!1})}};Kt||(Kt={});var qt=class extends P{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};qt||(qt={});var Vt=class extends P{create(e,t){return this._client.post("/files",tt({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return ee(e)?this.list({},e):this._client.getAPIList("/files",Zt,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){let a=new Set(["processed","error","deleted"]),s=Date.now(),i=await this.retrieve(e);for(;!i.status||!a.has(i.status);)if(await Vo(t),i=await this.retrieve(e),Date.now()-s>r)throw new bt({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return i}},Zt=class extends Lt{};(function(n){n.FileObjectsPage=Zt})(Vt||(Vt={}));var Yr=class extends P{create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return ee(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Xr,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return ee(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Qr,{query:t,...r})}},Xr=class extends te{},Qr=class extends te{};(function(n){n.FineTuningJobsPage=Xr,n.FineTuningJobEventsPage=Qr})(Yr||(Yr={}));var Gt=class extends P{constructor(){super(...arguments),this.jobs=new Yr(this._client)}};(function(n){n.Jobs=Yr,n.FineTuningJobsPage=Xr,n.FineTuningJobEventsPage=Qr})(Gt||(Gt={}));var Wt=class extends P{createVariation(e,t){return this._client.post("/images/variations",tt({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",tt({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}};Wt||(Wt={});var Jt=class extends P{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Yt,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}},Yt=class extends Lt{};(function(n){n.ModelsPage=Yt})(Jt||(Jt={}));var Xt=class extends P{create(e,t){return this._client.post("/moderations",{body:e,...t})}};Xt||(Xt={});var ud,J=class extends Js{constructor({baseURL:e=Ys("OPENAI_BASE_URL"),apiKey:t=Ys("OPENAI_API_KEY"),organization:r=(s=>(s=Ys("OPENAI_ORG_ID"))!=null?s:null)(),...a}={}){var o;if(t===void 0)throw new C("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");let i={apiKey:t,organization:r,...a,baseURL:e||"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Hl())throw new C(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:(o=i.timeout)!=null?o:6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new Kt(this),this.chat=new Ft(this),this.embeddings=new qt(this),this.files=new Vt(this),this.images=new Wt(this),this.audio=new zt(this),this.moderations=new Xt(this),this.models=new Jt(this),this.fineTuning=new Gt(this),this.beta=new Ht(this),this._options=i,this.apiKey=t,this.organization=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};ud=J;J.OpenAI=ud;J.OpenAIError=C;J.APIError=Q;J.APIConnectionError=yt;J.APIConnectionTimeoutError=bt;J.APIUserAbortError=X;J.NotFoundError=Pn;J.ConflictError=On;J.RateLimitError=Tn;J.BadRequestError=xn;J.AuthenticationError=An;J.InternalServerError=Cn;J.PermissionDeniedError=En;J.UnprocessableEntityError=In;var{OpenAIError:SE,APIError:kE,APIConnectionError:NE,APIConnectionTimeoutError:cd,APIUserAbortError:ld,NotFoundError:RE,ConflictError:jE,RateLimitError:$E,BadRequestError:ME,AuthenticationError:DE,InternalServerError:LE,PermissionDeniedError:FE,UnprocessableEntityError:zE}=Lo;(function(n){n.toFile=Bo,n.fileFromPath=Ks,n.Page=Lt,n.CursorPage=te,n.Completions=Kt,n.Chat=Ft,n.Embeddings=qt,n.Files=Vt,n.FileObjectsPage=Zt,n.Images=Wt,n.Audio=zt,n.Moderations=Xt,n.Models=Jt,n.ModelsPage=Yt,n.FineTuning=Gt,n.Beta=Ht})(J||(J={}));function dd(n){return{name:n.name,description:n.description,parameters:Tr(n.schema)}}function uu(n){return{type:"function",function:dd(n)}}var en=class extends Z{static lc_name(){return"RunnablePassthrough"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),e&&(this.func=e.func)}async invoke(e,t){let r=K(t);return this.func&&await this.func(e,r),this._callWithConfig(a=>Promise.resolve(a),e,r)}async*transform(e,t){let r=K(t),a,s=!0;for await(let i of this._transformStreamWithConfig(e,o=>o,r))if(yield i,s)if(a===void 0)a=i;else try{a=Qe(a,i)}catch(o){a=void 0,s=!1}this.func&&a!==void 0&&await this.func(a,r)}static assign(e){return new wn(new Dt({steps:e}))}};var Dn=class extends Z{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}_baseMessageToString(e){return typeof e.content=="string"?e.content:this._baseMessageContentToString(e.content)}_baseMessageContentToString(e){return JSON.stringify(e)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async(r,a)=>this.parseResult([{text:r}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"}):this._callWithConfig(async(r,a)=>this.parseResult([{message:r,text:this._baseMessageToString(r)}],a==null?void 0:a.callbacks),e,{...t,runType:"parser"})}},Ln=class extends Dn{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}},tn=class extends Error{constructor(e,t,r,a=!1){if(super(e),Object.defineProperty(this,"llmOutput",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"observation",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sendToLLM",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.llmOutput=t,this.observation=r,this.sendToLLM=a,a&&(r===void 0||t===void 0))throw new Error("Arguments 'observation' & 'llmOutput' are required if 'sendToLlm' is true")}};function Na(n,e){let t=typeof n;if(t!==typeof e)return!1;if(Array.isArray(n)){if(!Array.isArray(e))return!1;let r=n.length;if(r!==e.length)return!1;for(let a=0;a<r;a++)if(!Na(n[a],e[a]))return!1;return!0}if(t==="object"){if(!n||!e)return n===e;let r=Object.keys(n),a=Object.keys(e);if(r.length!==a.length)return!1;for(let i of r)if(!Na(n[i],e[i]))return!1;return!0}return n===e}var PP=typeof self!="undefined"&&self.location&&self.location.origin!=="null"?new URL(self.location.origin+self.location.pathname+location.search):new URL("https://github.com/cfworker");var eg=/^(\d\d\d\d)-(\d\d)-(\d\d)$/,tg=[0,31,28,31,30,31,30,31,31,30,31,30,31],rg=/^(\d\d):(\d\d):(\d\d)(\.\d+)?(z|[+-]\d\d(?::?\d\d)?)?$/i,ng=/^(?=.{1,253}\.?$)[a-z0-9](?:[a-z0-9-]{0,61}[a-z0-9])?(?:\.[a-z0-9](?:[-0-9a-z]{0,61}[0-9a-z])?)*\.?$/i,ag=/^(?:[a-z][a-z0-9+\-.]*:)?(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'"()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'"()*+,;=:@]|%[0-9a-f]{2})*)*)?(?:\?(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'"()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i,sg=/^(?:(?:[^\x00-\x20"'<>%\\^`{|}]|%[0-9a-f]{2})|\{[+#./;?&=,!@|]?(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?(?:,(?:[a-z0-9_]|%[0-9a-f]{2})+(?::[1-9][0-9]{0,3}|\*)?)*\})*$/i,ig=/^(?:(?:https?|ftp):\/\/)(?:\S+(?::\S*)?@)?(?:(?!10(?:\.\d{1,3}){3})(?!127(?:\.\d{1,3}){3})(?!169\.254(?:\.\d{1,3}){2})(?!192\.168(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)(?:\.(?:[a-z\u{00a1}-\u{ffff}0-9]+-?)*[a-z\u{00a1}-\u{ffff}0-9]+)*(?:\.(?:[a-z\u{00a1}-\u{ffff}]{2,})))(?::\d{2,5})?(?:\/[^\s]*)?$/iu,og=/^(?:urn:uuid:)?[0-9a-f]{8}-(?:[0-9a-f]{4}-){3}[0-9a-f]{12}$/i,ug=/^(?:\/(?:[^~/]|~0|~1)*)*$/,cg=/^#(?:\/(?:[a-z0-9_\-.!$&'()*+,;:=@]|%[0-9a-f]{2}|~0|~1)*)*$/i,lg=/^(?:0|[1-9][0-9]*)(?:#|(?:\/(?:[^~/]|~0|~1)*)*)$/,dg=/^\d\d\d\d-[0-1]\d-[0-3]\d$/,hg=/^(?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)?$/i,pg=/^\d\d\d\d-[0-1]\d-[0-3]\d[t\s](?:[0-2]\d:[0-5]\d:[0-5]\d|23:59:60)(?:\.\d+)?(?:z|[+-]\d\d(?::?\d\d)?)$/i,fg=/^(?:(?:[a-z][a-z0-9+-.]*:)?\/?\/)?(?:[^\\\s#][^\s#]*)?(?:#[^\\\s]*)?$/i,mg=n=>{if(n[0]==='"')return!1;let[e,t,...r]=n.split("@");return!e||!t||r.length!==0||e.length>64||t.length>253||e[0]==="."||e.endsWith(".")||e.includes("..")||!/^[a-z0-9.-]+$/i.test(t)||!/^[a-z0-9.!#$%&'*+/=?^_`{|}~-]+$/i.test(e)?!1:t.split(".").every(a=>/^[a-z0-9]([a-z0-9-]{0,61}[a-z0-9])?$/i.test(a))},gg=/^(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)$/,yg=/^((([0-9a-f]{1,4}:){7}([0-9a-f]{1,4}|:))|(([0-9a-f]{1,4}:){6}(:[0-9a-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){5}(((:[0-9a-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9a-f]{1,4}:){4}(((:[0-9a-f]{1,4}){1,3})|((:[0-9a-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){3}(((:[0-9a-f]{1,4}){1,4})|((:[0-9a-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){2}(((:[0-9a-f]{1,4}){1,5})|((:[0-9a-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9a-f]{1,4}:){1}(((:[0-9a-f]{1,4}){1,6})|((:[0-9a-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9a-f]{1,4}){1,7})|((:[0-9a-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))$/i,bg=n=>n.length>1&&n.length<80&&(/^P\d+([.,]\d+)?W$/.test(n)||/^P[\dYMDTHS]*(\d[.,]\d+)?[YMDHS]$/.test(n)&&/^P([.,\d]+Y)?([.,\d]+M)?([.,\d]+D)?(T([.,\d]+H)?([.,\d]+M)?([.,\d]+S)?)?$/.test(n));function xe(n){return n.test.bind(n)}var _g={date:hd,time:pd.bind(void 0,!1),"date-time":Ag,duration:bg,uri:Og,"uri-reference":xe(ag),"uri-template":xe(sg),url:xe(ig),email:mg,hostname:xe(ng),ipv4:xe(gg),ipv6:xe(yg),regex:Tg,uuid:xe(og),"json-pointer":xe(ug),"json-pointer-uri-fragment":xe(cg),"relative-json-pointer":xe(lg)},wg={..._g,date:xe(dg),time:xe(hg),"date-time":xe(pg),"uri-reference":xe(fg)};function vg(n){return n%4===0&&(n%100!==0||n%400===0)}function hd(n){let e=n.match(eg);if(!e)return!1;let t=+e[1],r=+e[2],a=+e[3];return r>=1&&r<=12&&a>=1&&a<=(r==2&&vg(t)?29:tg[r])}function pd(n,e){let t=e.match(rg);if(!t)return!1;let r=+t[1],a=+t[2],s=+t[3],i=!!t[5];return(r<=23&&a<=59&&s<=59||r==23&&a==59&&s==60)&&(!n||i)}var xg=/t|\s/i;function Ag(n){let e=n.split(xg);return e.length==2&&hd(e[0])&&pd(!0,e[1])}var Eg=/\/|:/,Pg=/^(?:[a-z][a-z0-9+\-.]*:)(?:\/?\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:]|%[0-9a-f]{2})*@)?(?:\[(?:(?:(?:(?:[0-9a-f]{1,4}:){6}|::(?:[0-9a-f]{1,4}:){5}|(?:[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){4}|(?:(?:[0-9a-f]{1,4}:){0,1}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){3}|(?:(?:[0-9a-f]{1,4}:){0,2}[0-9a-f]{1,4})?::(?:[0-9a-f]{1,4}:){2}|(?:(?:[0-9a-f]{1,4}:){0,3}[0-9a-f]{1,4})?::[0-9a-f]{1,4}:|(?:(?:[0-9a-f]{1,4}:){0,4}[0-9a-f]{1,4})?::)(?:[0-9a-f]{1,4}:[0-9a-f]{1,4}|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?))|(?:(?:[0-9a-f]{1,4}:){0,5}[0-9a-f]{1,4})?::[0-9a-f]{1,4}|(?:(?:[0-9a-f]{1,4}:){0,6}[0-9a-f]{1,4})?::)|[Vv][0-9a-f]+\.[a-z0-9\-._~!$&'()*+,;=:]+)\]|(?:(?:25[0-5]|2[0-4]\d|[01]?\d\d?)\.){3}(?:25[0-5]|2[0-4]\d|[01]?\d\d?)|(?:[a-z0-9\-._~!$&'()*+,;=]|%[0-9a-f]{2})*)(?::\d*)?(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*|\/(?:(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)?|(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})+(?:\/(?:[a-z0-9\-._~!$&'()*+,;=:@]|%[0-9a-f]{2})*)*)(?:\?(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?(?:#(?:[a-z0-9\-._~!$&'()*+,;=:@/?]|%[0-9a-f]{2})*)?$/i;function Og(n){return Eg.test(n)&&Pg.test(n)}var Ig=/[^\\]\\Z/;function Tg(n){if(Ig.test(n))return!1;try{return new RegExp(n),!0}catch(e){return!1}}var Fn=class extends Ln{async*_transform(e){for await(let t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:this._baseMessageToString(t)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}},Ra=class extends Fn{constructor(e){var t;super(e),Object.defineProperty(this,"diff",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.diff=(t=e==null?void 0:e.diff)!=null?t:this.diff}async*_transform(e){let t,r;for await(let a of e){if(typeof a!="string"&&typeof a.content!="string")throw new Error("Cannot handle non-string output.");let s;if(Bu(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new it({message:a,text:a.content})}else if(rr(a)){if(typeof a.content!="string")throw new Error("Cannot handle non-string message output.");s=new it({message:a.toChunk(),text:a.content})}else s=new Tt({text:a});r===void 0?r=s:r=r.concat(s);let i=await this.parsePartialResult([r]);i!=null&&!Na(i,t)&&(this.diff?yield this._diff(t,i):yield i,t=i)}}};var bi=class extends Ln{static lc_name(){return"StructuredOutputParser"}toJSON(){return this.toJSONNotImplemented()}constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","structured"]})}static fromZodSchema(e){return new this(e)}static fromNamesAndDescriptions(e){let t=dt.object(Object.fromEntries(Object.entries(e).map(([r,a])=>[r,dt.string().describe(a)])));return new this(t)}getFormatInstructions(){return`You must format your output as a JSON value that adheres to a given "JSON Schema" instance.

"JSON Schema" is a declarative language that allows you to annotate and validate JSON documents.

For example, the example "JSON Schema" instance {{"properties": {{"foo": {{"description": "a list of test words", "type": "array", "items": {{"type": "string"}}}}}}, "required": ["foo"]}}}}
would match an object with one required property, "foo". The "type" property specifies "foo" must be an "array", and the "description" property semantically describes it as "a list of test words". The items within "foo" must be strings.
Thus, the object {{"foo": ["bar", "baz"]}} is a well-formatted instance of this example "JSON Schema". The object {{"properties": {{"foo": ["bar", "baz"]}}}} is not well-formatted.

Your output will be parsed and type-checked according to the provided schema instance, so make sure all fields in your output match the schema exactly and there are no trailing commas!

Here is the JSON Schema instance your output must adhere to. Include the enclosing markdown codeblock:
\`\`\`json
${JSON.stringify(Tr(this.schema))}
\`\`\`
`}async parse(e){try{let t=e.includes("```")?e.trim().split(/```(?:json)?/)[1]:e.trim();return await this.schema.parseAsync(JSON.parse(t))}catch(t){throw new tn(`Failed to parse. Text: "${e}". Error: ${t}`,e)}}};var _i=class extends Ra{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"JsonOutputParser"}_diff(e,t){if(t)return e?Ns(e,t):[{op:"replace",path:"",value:t}]}async parsePartialResult(e){return fd(e[0].text)}async parse(e){return fd(e,JSON.parse)}getFormatInstructions(){return""}};function fd(n,e=Sg){n=n.trim();let t=/```(json)?(.*)```/s.exec(n);return e(t?t[2]:n)}function Sg(n){if(typeof n=="undefined")return null;try{return JSON.parse(n)}catch(s){}let e="",t=[],r=!1,a=!1;for(let s of n){if(r)s==='"'&&!a?r=!1:s===`
`&&!a?s="\\n":s==="\\"?a=!a:a=!1;else if(s==='"')r=!0,a=!1;else if(s==="{")t.push("}");else if(s==="[")t.push("]");else if(s==="}"||s==="]")if(t&&t[t.length-1]===s)t.pop();else return null;e+=s}r&&(e+='"');for(let s=t.length-1;s>=0;s-=1)e+=t[s];try{return JSON.parse(e)}catch(s){return null}}var cu=class extends Dn{static lc_name(){return"JsonOutputToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),this.returnId=(t=e==null?void 0:e.returnId)!=null?t:this.returnId}async parseResult(e){let t=e[0].message.additional_kwargs.tool_calls;if(!t)throw new Error(`No tools_call in message ${JSON.stringify(e)}`);let r=JSON.parse(JSON.stringify(t)),a=[];for(let s of r)if(s.function!==void 0){let i={type:s.function.name,args:JSON.parse(s.function.arguments)};this.returnId&&(i.id=s.id),Object.defineProperty(i,"name",{get(){return this.type}}),Object.defineProperty(i,"arguments",{get(){return this.args}}),a.push(i)}return a}},ja=class extends Dn{static lc_name(){return"JsonOutputKeyToolsParser"}constructor(e){var t;super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","output_parsers","openai_tools"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"returnId",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"keyName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"returnSingle",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"zodSchema",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keyName=e.keyName,this.returnSingle=(t=e.returnSingle)!=null?t:this.returnSingle,this.initialParser=new cu(e),this.zodSchema=e.zodSchema}async _validateResult(e){if(this.zodSchema===void 0)return e;let t=await this.zodSchema.safeParseAsync(e);if(t.success)return t.data;throw new tn(`Failed to parse. Text: "${JSON.stringify(e,null,2)}". Error: ${JSON.stringify(t.error.errors)}`,JSON.stringify(e,null,2))}async parseResult(e){let r=(await this.initialParser.parseResult(e)).filter(i=>i.type===this.keyName),a=r;return this.returnId||(a=r.map(i=>i.args)),this.returnSingle?this._validateResult(a[0]):await Promise.all(a.map(i=>this._validateResult(i)))}};function lu(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage={...n.errorMessage,[e]:t})}function F(n,e,t,r,a){n[e]=t,lu(n,e,r,a)}var md={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",pipeStrategy:"all",dateStrategy:"string",mapStrategy:"entries",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1,markdownDescription:!1,patternStrategy:"escape",emailStrategy:"format:email"},gd=n=>typeof n=="string"?{...md,name:n}:{...md,...n};function yd(){return{}}function bd(n,e){var r,a;let t={type:"array"};return((a=(r=n.type)==null?void 0:r._def)==null?void 0:a.typeName)!==f.ZodAny&&(t.items=I(n.type._def,{...e,currentPath:[...e.currentPath,"items"]})),n.minLength&&F(t,"minItems",n.minLength.value,n.minLength.message,e),n.maxLength&&F(t,"maxItems",n.maxLength.value,n.maxLength.message,e),n.exactLength&&(F(t,"minItems",n.exactLength.value,n.exactLength.message,e),F(t,"maxItems",n.exactLength.value,n.exactLength.message,e)),t}function _d(n,e){let t={type:"integer",format:"int64"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"?r.inclusive?F(t,"minimum",r.value,r.message,e):F(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),F(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?F(t,"maximum",r.value,r.message,e):F(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),F(t,"maximum",r.value,r.message,e));break;case"multipleOf":F(t,"multipleOf",r.value,r.message,e);break}return t}function wd(){return{type:"boolean"}}function vd(n,e){return I(n.type._def,e)}var xd=(n,e)=>I(n.innerType._def,e);function Ad(n,e){return e.dateStrategy=="integer"?kg(n,e):{type:"string",format:"date-time"}}var kg=(n,e)=>{let t={type:"integer",format:"unix-time"};for(let r of n.checks)switch(r.kind){case"min":e.target==="jsonSchema7"&&F(t,"minimum",r.value,r.message,e);break;case"max":e.target==="jsonSchema7"&&F(t,"maximum",r.value,r.message,e);break}return t};function Ed(n,e){return{...I(n.innerType._def,e),default:n.defaultValue()}}function Pd(n,e){return e.effectStrategy==="input"?I(n.schema._def,e):{}}function Od(n){return{type:"string",enum:n.values}}var Ng=n=>"type"in n&&n.type==="string"?!1:"allOf"in n;function Id(n,e){let t=[I(n.left._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),I(n.right._def,{...e,currentPath:[...e.currentPath,"allOf","1"]})].filter(s=>!!s),r=e.target==="jsonSchema2019-09"?{unevaluatedProperties:!1}:void 0,a=[];return t.forEach(s=>{if(Ng(s))a.push(...s.allOf),s.unevaluatedProperties===void 0&&(r=void 0);else{let i=s;if("additionalProperties"in s&&s.additionalProperties===!1){let{additionalProperties:o,...u}=s;i=u}else r=void 0;a.push(i)}}),a.length?{allOf:a,...r}:void 0}function Td(n,e){let t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}var $a={cuid:"^[cC][^\\s-]{8,}$",cuid2:"^[a-z][a-z0-9]*$",ulid:"^[0-9A-HJKMNP-TV-Z]{26}$",email:"^(?!\\.)(?!.*\\.\\.)([a-zA-Z0-9_+-\\.]*)[a-zA-Z0-9_+-]@([a-zA-Z0-9][a-zA-Z0-9\\-]*\\.)+[a-zA-Z]{2,}$",emoji:"^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$",uuid:"^[0-9a-fA-F]{8}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{4}\\b-[0-9a-fA-F]{12}$",ipv4:"^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$",ipv6:"^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$"};function wi(n,e){let t={type:"string"};function r(a){return e.patternStrategy==="escape"?Rg(a):a}if(n.checks)for(let a of n.checks)switch(a.kind){case"min":F(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e);break;case"max":F(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"email":switch(e.emailStrategy){case"format:email":rn(t,"email",a.message,e);break;case"format:idn-email":rn(t,"idn-email",a.message,e);break;case"pattern:zod":At(t,$a.email,a.message,e);break}break;case"url":rn(t,"uri",a.message,e);break;case"uuid":rn(t,"uuid",a.message,e);break;case"regex":At(t,a.regex.source,a.message,e);break;case"cuid":At(t,$a.cuid,a.message,e);break;case"cuid2":At(t,$a.cuid2,a.message,e);break;case"startsWith":At(t,"^"+r(a.value),a.message,e);break;case"endsWith":At(t,r(a.value)+"$",a.message,e);break;case"datetime":rn(t,"date-time",a.message,e);break;case"length":F(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,a.value):a.value,a.message,e),F(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,a.value):a.value,a.message,e);break;case"includes":{At(t,r(a.value),a.message,e);break}case"ip":{a.version!=="v6"&&rn(t,"ipv4",a.message,e),a.version!=="v4"&&rn(t,"ipv6",a.message,e);break}case"emoji":At(t,$a.emoji,a.message,e);break;case"ulid":{At(t,$a.ulid,a.message,e);break}case"toLowerCase":case"toUpperCase":case"trim":break;default:}return t}var Rg=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),rn=(n,e,t,r)=>{var a;n.format||(a=n.anyOf)!=null&&a.some(s=>s.format)?(n.anyOf||(n.anyOf=[]),n.format&&(n.anyOf.push({format:n.format,...n.errorMessage&&r.errorMessages&&{errorMessage:{format:n.errorMessage.format}}}),delete n.format,n.errorMessage&&(delete n.errorMessage.format,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.anyOf.push({format:e,...t&&r.errorMessages&&{errorMessage:{format:t}}})):F(n,"format",e,t,r)},At=(n,e,t,r)=>{var a;n.pattern||(a=n.allOf)!=null&&a.some(s=>s.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push({pattern:n.pattern,...n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}}}),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push({pattern:e,...t&&r.errorMessages&&{errorMessage:{pattern:t}}})):F(n,"pattern",e,t,r)};function vi(n,e){var r,a,s,i,o;if(e.target==="openApi3"&&((r=n.keyType)==null?void 0:r._def.typeName)===f.ZodEnum)return{type:"object",required:n.keyType._def.values,properties:n.keyType._def.values.reduce((u,c)=>{var l;return{...u,[c]:(l=I(n.valueType._def,{...e,currentPath:[...e.currentPath,"properties",c]}))!=null?l:{}}},{}),additionalProperties:!1};let t={type:"object",additionalProperties:(a=I(n.valueType._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?a:{}};if(e.target==="openApi3")return t;if(((s=n.keyType)==null?void 0:s._def.typeName)===f.ZodString&&((i=n.keyType._def.checks)!=null&&i.length)){let u=Object.entries(wi(n.keyType._def,e)).reduce((c,[l,d])=>l==="type"?c:{...c,[l]:d},{});return{...t,propertyNames:u}}else if(((o=n.keyType)==null?void 0:o._def.typeName)===f.ZodEnum)return{...t,propertyNames:{enum:n.keyType._def.values}};return t}function Cd(n,e){if(e.mapStrategy==="record")return vi(n,e);let t=I(n.keyType._def,{...e,currentPath:[...e.currentPath,"items","items","0"]})||{},r=I(n.valueType._def,{...e,currentPath:[...e.currentPath,"items","items","1"]})||{};return{type:"array",maxItems:125,items:{type:"array",items:[t,r],minItems:2,maxItems:2}}}function Sd(n){let e=n.values,r=Object.keys(n.values).filter(s=>typeof e[e[s]]!="number").map(s=>e[s]),a=Array.from(new Set(r.map(s=>typeof s)));return{type:a.length===1?a[0]==="string"?"string":"number":["string","number"],enum:r}}function kd(){return{not:{}}}function Nd(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}var Ma={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function jd(n,e){if(e.target==="openApi3")return Rd(n,e);let t=n.options instanceof Map?Array.from(n.options.values()):n.options;if(t.every(r=>r._def.typeName in Ma&&(!r._def.checks||!r._def.checks.length))){let r=t.reduce((a,s)=>{let i=Ma[s._def.typeName];return i&&!a.includes(i)?[...a,i]:a},[]);return{type:r.length>1?r:r[0]}}else if(t.every(r=>r._def.typeName==="ZodLiteral"&&!r.description)){let r=t.reduce((a,s)=>{let i=typeof s._def.value;switch(i){case"string":case"number":case"boolean":return[...a,i];case"bigint":return[...a,"integer"];case"object":if(s._def.value===null)return[...a,"null"];case"symbol":case"undefined":case"function":default:return a}},[]);if(r.length===t.length){let a=r.filter((s,i,o)=>o.indexOf(s)===i);return{type:a.length>1?a:a[0],enum:t.reduce((s,i)=>s.includes(i._def.value)?s:[...s,i._def.value],[])}}}else if(t.every(r=>r._def.typeName==="ZodEnum"))return{type:"string",enum:t.reduce((r,a)=>[...r,...a._def.values.filter(s=>!r.includes(s))],[])};return Rd(n,e)}var Rd=(n,e)=>{let t=(n.options instanceof Map?Array.from(n.options.values()):n.options).map((r,a)=>I(r._def,{...e,currentPath:[...e.currentPath,"anyOf",`${a}`]})).filter(r=>!!r&&(!e.strictUnions||typeof r=="object"&&Object.keys(r).length>0));return t.length?{anyOf:t}:void 0};function $d(n,e){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(n.innerType._def.typeName)&&(!n.innerType._def.checks||!n.innerType._def.checks.length))return e.target==="openApi3"?{type:Ma[n.innerType._def.typeName],nullable:!0}:{type:[Ma[n.innerType._def.typeName],"null"]};if(e.target==="openApi3"){let r=I(n.innerType._def,{...e,currentPath:[...e.currentPath]});return r&&"$ref"in r?{allOf:[r],nullable:!0}:r&&{...r,nullable:!0}}let t=I(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","0"]});return t&&{anyOf:[t,{type:"null"}]}}function Md(n,e){let t={type:"number"};if(!n.checks)return t;for(let r of n.checks)switch(r.kind){case"int":t.type="integer",lu(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?F(t,"minimum",r.value,r.message,e):F(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),F(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?F(t,"maximum",r.value,r.message,e):F(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),F(t,"maximum",r.value,r.message,e));break;case"multipleOf":F(t,"multipleOf",r.value,r.message,e);break}return t}function Dd(n,e){var r;let t={type:"object",...Object.entries(n.shape()).reduce((a,[s,i])=>{if(i===void 0||i._def===void 0)return a;let o=I(i._def,{...e,currentPath:[...e.currentPath,"properties",s],propertyPath:[...e.currentPath,"properties",s]});return o===void 0?a:{properties:{...a.properties,[s]:o},required:i.isOptional()?a.required:[...a.required,s]}},{properties:{},required:[]}),additionalProperties:n.catchall._def.typeName==="ZodNever"?n.unknownKeys==="passthrough":(r=I(n.catchall._def,{...e,currentPath:[...e.currentPath,"additionalProperties"]}))!=null?r:!0};return t.required.length||delete t.required,t}var Ld=(n,e)=>{var r;if(e.currentPath.toString()===((r=e.propertyPath)==null?void 0:r.toString()))return I(n.innerType._def,e);let t=I(n.innerType._def,{...e,currentPath:[...e.currentPath,"anyOf","1"]});return t?{anyOf:[{not:{}},t]}:{}};var Fd=(n,e)=>{if(e.pipeStrategy==="input")return I(n.in._def,e);if(e.pipeStrategy==="output")return I(n.out._def,e);let t=I(n.in._def,{...e,currentPath:[...e.currentPath,"allOf","0"]}),r=I(n.out._def,{...e,currentPath:[...e.currentPath,"allOf",t?"1":"0"]});return{allOf:[t,r].filter(a=>a!==void 0)}};function zd(n,e){return I(n.type._def,e)}function Ud(n,e){let r={type:"array",uniqueItems:!0,items:I(n.valueType._def,{...e,currentPath:[...e.currentPath,"items"]})};return n.minSize&&F(r,"minItems",n.minSize.value,n.minSize.message,e),n.maxSize&&F(r,"maxItems",n.maxSize.value,n.maxSize.message,e),r}function Bd(n,e){return n.rest?{type:"array",minItems:n.items.length,items:n.items.map((t,r)=>I(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[]),additionalItems:I(n.rest._def,{...e,currentPath:[...e.currentPath,"additionalItems"]})}:{type:"array",minItems:n.items.length,maxItems:n.items.length,items:n.items.map((t,r)=>I(t._def,{...e,currentPath:[...e.currentPath,"items",`${r}`]})).reduce((t,r)=>r===void 0?t:[...t,r],[])}}function Hd(){return{not:{}}}function Kd(){return{}}var qd=(n,e)=>I(n.innerType._def,e);function I(n,e,t=!1){let r=e.seen.get(n);if(r&&!t){let i=jg(r,e);if(i!==void 0)return i}let a={def:n,path:e.currentPath,jsonSchema:void 0};e.seen.set(n,a);let s=Mg(n,n.typeName,e);return s&&Dg(n,e,s),a.jsonSchema=s,s}var jg=(n,e)=>{switch(e.$refStrategy){case"root":return{$ref:n.path.join("/")};case"relative":return{$ref:$g(e.currentPath,n.path)};case"none":case"seen":return n.path.length<e.currentPath.length&&n.path.every((t,r)=>e.currentPath[r]===t)?(console.warn(`Recursive reference detected at ${e.currentPath.join("/")}! Defaulting to any`),{}):e.$refStrategy==="seen"?{}:void 0}},$g=(n,e)=>{let t=0;for(;t<n.length&&t<e.length&&n[t]===e[t];t++);return[(n.length-t).toString(),...e.slice(t)].join("/")},Mg=(n,e,t)=>{switch(e){case f.ZodString:return wi(n,t);case f.ZodNumber:return Md(n,t);case f.ZodObject:return Dd(n,t);case f.ZodBigInt:return _d(n,t);case f.ZodBoolean:return wd();case f.ZodDate:return Ad(n,t);case f.ZodUndefined:return Hd();case f.ZodNull:return Nd(t);case f.ZodArray:return bd(n,t);case f.ZodUnion:case f.ZodDiscriminatedUnion:return jd(n,t);case f.ZodIntersection:return Id(n,t);case f.ZodTuple:return Bd(n,t);case f.ZodRecord:return vi(n,t);case f.ZodLiteral:return Td(n,t);case f.ZodEnum:return Od(n);case f.ZodNativeEnum:return Sd(n);case f.ZodNullable:return $d(n,t);case f.ZodOptional:return Ld(n,t);case f.ZodMap:return Cd(n,t);case f.ZodSet:return Ud(n,t);case f.ZodLazy:return I(n.getter()._def,t);case f.ZodPromise:return zd(n,t);case f.ZodNaN:case f.ZodNever:return kd();case f.ZodEffects:return Pd(n,t);case f.ZodAny:return yd();case f.ZodUnknown:return Kd();case f.ZodDefault:return Ed(n,t);case f.ZodBranded:return vd(n,t);case f.ZodReadonly:return qd(n,t);case f.ZodCatch:return xd(n,t);case f.ZodPipeline:return Fd(n,t);case f.ZodFunction:case f.ZodVoid:case f.ZodSymbol:return;default:return(r=>{})(e)}},Dg=(n,e,t)=>(n.description&&(t.description=n.description,e.markdownDescription&&(t.markdownDescription=n.description)),t);var Vd=n=>{let e=gd(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return{...e,currentPath:t,propertyPath:void 0,seen:new Map(Object.entries(e.definitions).map(([r,a])=>[a._def,{def:a._def,path:[...e.basePath,e.definitionPath,r],jsonSchema:void 0}]))}};var xi=(n,e)=>{var o;let t=Vd(e),r=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((u,[c,l])=>{var d;return{...u,[c]:(d=I(l._def,{...t,currentPath:[...t.basePath,t.definitionPath,c]},!0))!=null?d:{}}},{}):void 0,a=typeof e=="string"?e:e==null?void 0:e.name,s=(o=I(n._def,a===void 0?t:{...t,currentPath:[...t.basePath,t.definitionPath,a]},!1))!=null?o:{},i=a===void 0?r?{...s,[t.definitionPath]:r}:s:{$ref:[...t.$refStrategy==="relative"?[]:t.basePath,t.definitionPath,a].join("/"),[t.definitionPath]:{...r,[a]:s}};return t.target==="jsonSchema7"?i.$schema="http://json-schema.org/draft-07/schema#":t.target==="jsonSchema2019-09"&&(i.$schema="https://json-schema.org/draft/2019-09/schema#"),i};function Da(n){let{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:a,baseURL:s}=n;if(r&&a&&e)return`${a}/${e}`;if(r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return s}function La(n){let e;return n.constructor.name===cd.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===ld.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function Lg(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function Zd(n){var t;let e=["namespace functions {",""];for(let r of n)r.description&&e.push(`// ${r.description}`),Object.keys((t=r.parameters.properties)!=null?t:{}).length>0?(e.push(`type ${r.name} = (_: {`),e.push(Gd(r.parameters,0)),e.push("}) => any;")):e.push(`type ${r.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Gd(n,e){var r,a;let t=[];for(let[s,i]of Object.entries((r=n.properties)!=null?r:{}))i.description&&e<2&&t.push(`// ${i.description}`),(a=n.required)!=null&&a.includes(s)?t.push(`${s}: ${Ai(i,e)},`):t.push(`${s}?: ${Ai(i,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function Ai(n,e){if(Lg(n))return n.anyOf.map(t=>Ai(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Gd(n,e+2),"}"].join(`
`);case"array":return n.items?`${Ai(n.items,e)}[]`:"any[]";default:return""}}function Fg(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function Yd(n){let e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!It.isInstance(n))throw new Error("Invalid generic chat message");return Fg(n)}default:throw new Error(`Unknown message type: ${e}`)}}function zg(n){var e;switch(n.role){case"assistant":return new ce(n.content||"",{function_call:n.function_call,tool_calls:n.tool_calls});default:return new It(n.content||"",(e=n.role)!=null?e:"unknown")}}function Ug(n,e){var s,i;let t=(s=n.role)!=null?s:e,r=(i=n.content)!=null?i:"",a;return n.function_call?a={function_call:n.function_call}:n.tool_calls?a={tool_calls:n.tool_calls}:a={},t==="user"?new Kn({content:r}):t==="assistant"?new st({content:r,additional_kwargs:a}):t==="system"?new qn({content:r}):t==="function"?new Vn({content:r,additional_kwargs:a,name:n.name}):t==="tool"?new Va({content:r,additional_kwargs:a,tool_call_id:n.tool_call_id}):new Zn({content:r,role:t})}function Wd(n){return n.map(e=>({role:Yd(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}var Fa=class extends vn{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,a,s,i,o,u,c,l,d,h,p,m,y,g,_,w,M,z,D,S,V,k,B,at,Te,Ba,Ge;if(super(e!=null?e:{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"logprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"topLogprobs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(r=e==null?void 0:e.openAIApiKey)!=null?r:H("OPENAI_API_KEY"),this.azureOpenAIApiKey=(a=e==null?void 0:e.azureOpenAIApiKey)!=null?a:H("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(s=e==null?void 0:e.azureOpenAIApiInstanceName)!=null?s:H("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(i=e==null?void 0:e.azureOpenAIApiDeploymentName)!=null?i:H("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(o=e==null?void 0:e.azureOpenAIApiVersion)!=null?o:H("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(u=e==null?void 0:e.azureOpenAIBasePath)!=null?u:H("AZURE_OPENAI_BASE_PATH"),this.organization=(l=(c=e==null?void 0:e.configuration)==null?void 0:c.organization)!=null?l:H("OPENAI_ORGANIZATION"),this.modelName=(d=e==null?void 0:e.modelName)!=null?d:this.modelName,this.modelKwargs=(h=e==null?void 0:e.modelKwargs)!=null?h:{},this.timeout=e==null?void 0:e.timeout,this.temperature=(p=e==null?void 0:e.temperature)!=null?p:this.temperature,this.topP=(m=e==null?void 0:e.topP)!=null?m:this.topP,this.frequencyPenalty=(y=e==null?void 0:e.frequencyPenalty)!=null?y:this.frequencyPenalty,this.presencePenalty=(g=e==null?void 0:e.presencePenalty)!=null?g:this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.logprobs=e==null?void 0:e.logprobs,this.topLogprobs=e==null?void 0:e.topLogprobs,this.n=(_=e==null?void 0:e.n)!=null?_:this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.user=e==null?void 0:e.user,this.streaming=(w=e==null?void 0:e.streaming)!=null?w:!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=(M=this.openAIApiKey)!=null?M:""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:(D=t==null?void 0:t.basePath)!=null?D:(z=e==null?void 0:e.configuration)==null?void 0:z.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:(B=(S=t==null?void 0:t.baseOptions)==null?void 0:S.headers)!=null?B:(k=(V=e==null?void 0:e.configuration)==null?void 0:V.baseOptions)==null?void 0:k.headers,defaultQuery:(Ge=(at=t==null?void 0:t.baseOptions)==null?void 0:at.params)!=null?Ge:(Ba=(Te=e==null?void 0:e.configuration)==null?void 0:Te.baseOptions)==null?void 0:Ba.params,...t,...e==null?void 0:e.configuration}}invocationParams(e){var a;function t(s){return s!==void 0&&s.every(i=>Array.isArray(i.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,logprobs:this.logprobs,top_logprobs:this.topLogprobs,n:this.n,logit_bias:this.logitBias,stop:(a=e==null?void 0:e.stop)!=null?a:this.stop,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:t(e==null?void 0:e.tools)?e==null?void 0:e.tools.map(uu):e==null?void 0:e.tools,tool_choice:e==null?void 0:e.tool_choice,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var u,c,l,d,h;let a=Wd(e),s={...this.invocationParams(t),messages:a,stream:!0},i,o=await this.completionWithRetry(s,t);for await(let p of o){let m=p==null?void 0:p.choices[0];if(!m)continue;let{delta:y}=m;if(!y)continue;let g=Ug(y,i);i=(u=y.role)!=null?u:i;let _={prompt:(c=t.promptIndex)!=null?c:0,completion:(l=m.index)!=null?l:0};if(typeof g.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}let w={..._};m.finish_reason!==void 0&&(w.finish_reason=m.finish_reason),this.logprobs&&(w.logprobs=m.logprobs);let M=new it({message:g,text:g.content,generationInfo:w});yield M,r==null||r.handleLLMNewToken((d=M.text)!=null?d:"",_,void 0,void 0,void 0,{chunk:M})}if((h=t.signal)!=null&&h.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,u,c,l,d,h,p,m,y,g;let a={},s=this.invocationParams(t),i=Wd(e);if(s.stream){let _=this._streamResponseChunks(e,t,r),w={};for await(let k of _){k.message.response_metadata={...k.generationInfo,...k.message.response_metadata};let B=(u=(o=k.generationInfo)==null?void 0:o.completion)!=null?u:0;w[B]===void 0?w[B]=k:w[B]=w[B].concat(k)}let M=Object.entries(w).sort(([k],[B])=>parseInt(k,10)-parseInt(B,10)).map(([k,B])=>B),{functions:z,function_call:D}=this.invocationParams(t),S=await this.getEstimatedTokenCountFromPrompt(e,z,D),V=await this.getNumTokensFromGenerations(M);return a.promptTokens=S,a.completionTokens=V,a.totalTokens=S+V,{generations:M,llmOutput:{estimatedTokenUsage:a}}}else{let _=await this.completionWithRetry({...s,stream:!1,messages:i},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:w,prompt_tokens:M,total_tokens:z}=(c=_==null?void 0:_.usage)!=null?c:{};w&&(a.completionTokens=((l=a.completionTokens)!=null?l:0)+w),M&&(a.promptTokens=((d=a.promptTokens)!=null?d:0)+M),z&&(a.totalTokens=((h=a.totalTokens)!=null?h:0)+z);let D=[];for(let S of(p=_==null?void 0:_.choices)!=null?p:[]){let k={text:(y=(m=S.message)==null?void 0:m.content)!=null?y:"",message:zg((g=S.message)!=null?g:{role:"assistant"})};k.generationInfo={...S.finish_reason?{finish_reason:S.finish_reason}:{},...S.logprobs?{logprobs:S.logprobs}:{}},D.push(k)}return{generations:D,llmOutput:{tokenUsage:a}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let a=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){let s=Zd(t);a+=await this.getNumTokens(s),a+=9}return t&&e.find(s=>s._getType()==="system")&&(a-=4),r==="none"?a+=1:typeof r=="object"&&(a+=await this.getNumTokens(r.name)+4),a}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var a;return(a=r.message.additional_kwargs)!=null&&a.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,a)=>r+a,0)}async getNumTokensFromMessages(e){let t=0,r=0,a=0;this.modelName==="gpt-3.5-turbo-0301"?(r=4,a=-1):(r=3,a=1);let s=await Promise.all(e.map(async i=>{var h,p,m,y,g,_;let o=await this.getNumTokens(i.content),u=await this.getNumTokens(Yd(i)),c=i.name!==void 0?a+await this.getNumTokens(i.name):0,l=o+r+u+c,d=i;if(d._getType()==="function"&&(l-=2),(h=d.additional_kwargs)!=null&&h.function_call&&(l+=3),(p=d==null?void 0:d.additional_kwargs.function_call)!=null&&p.name&&(l+=await this.getNumTokens((m=d.additional_kwargs.function_call)==null?void 0:m.name)),(y=d.additional_kwargs.function_call)!=null&&y.arguments)try{l+=await this.getNumTokens(JSON.stringify(JSON.parse((g=d.additional_kwargs.function_call)==null?void 0:g.arguments)))}catch(w){console.error("Error parsing function arguments",w,JSON.stringify(d.additional_kwargs.function_call)),l+=await this.getNumTokens((_=d.additional_kwargs.function_call)==null?void 0:_.arguments)}return t+=l,l}));return t+=3,{totalCount:t,countPerMessage:s}}async completionWithRetry(e,t){let r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(a){throw La(a)}})}_getClientOptions(e){if(!this.client){let r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},a=Da(r),s={...this.clientConfig,baseURL:a,timeout:this.timeout,maxRetries:0};s.baseURL||delete s.baseURL,this.client=new J(s)}let t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>{var a,s,i;return r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=(a=r.tokenUsage.completionTokens)!=null?a:0,t.tokenUsage.promptTokens+=(s=r.tokenUsage.promptTokens)!=null?s:0,t.tokenUsage.totalTokens+=(i=r.tokenUsage.totalTokens)!=null?i:0),t},{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}withStructuredOutput(e,t){var h;let r,a,s,i;Bg(e)?(r=e.schema,a=e.name,s=e.method,i=e.includeRaw):(r=e,a=t==null?void 0:t.name,s=t==null?void 0:t.method,i=t==null?void 0:t.includeRaw);let o,u;if(s==="jsonMode")o=this.bind({response_format:{type:"json_object"}}),Jd(r)?u=bi.fromZodSchema(r):u=new _i;else{let p=a!=null?a:"extract";if(Jd(r)){let m=xi(r);o=this.bind({tools:[{type:"function",function:{name:p,description:m.description,parameters:m}}],tool_choice:{type:"function",function:{name:p}}}),u=new ja({returnSingle:!0,keyName:p,zodSchema:r})}else{let m;typeof r.name=="string"&&typeof r.parameters=="object"&&r.parameters!=null?(m=r,p=r.name):m={name:p,description:(h=r.description)!=null?h:"",parameters:r},o=this.bind({tools:[{type:"function",function:m}],tool_choice:{type:"function",function:{name:p}}}),u=new ja({returnSingle:!0,keyName:p})}}if(!i)return o.pipe(u);let c=en.assign({parsed:(p,m)=>u.invoke(p.raw,m)}),l=en.assign({parsed:()=>null}),d=c.withFallbacks({fallbacks:[l]});return _n.from([{raw:o},d])}};function Jd(n){return typeof(n==null?void 0:n.parse)=="function"}function Bg(n){return n!==void 0&&typeof n.schema=="object"}var du=class extends Error{constructor(e,t){super(e),Object.defineProperty(this,"output",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.output=t}},hu=class extends ya{get lc_namespace(){return["langchain","tools"]}constructor(e){super(e!=null?e:{}),Object.defineProperty(this,"returnDirect",{enumerable:!0,configurable:!0,writable:!0,value:!1})}async invoke(e,t){return this.call(e,K(t))}async call(e,t,r){let a;try{a=await this.schema.parseAsync(e)}catch(c){throw new du("Received tool input did not match expected schema",JSON.stringify(e))}let s=Bc(t),i=await ae.configure(s.callbacks,this.callbacks,s.tags||r,this.tags,s.metadata,this.metadata,{verbose:this.verbose}),o=await(i==null?void 0:i.handleToolStart(this.toJSON(),typeof a=="string"?a:JSON.stringify(a),void 0,void 0,void 0,void 0,s.runName)),u;try{u=await this._call(a,o,s)}catch(c){throw await(o==null?void 0:o.handleToolError(c)),c}return await(o==null?void 0:o.handleToolEnd(u)),u}},Ei=class extends hu{constructor(e){super(e),Object.defineProperty(this,"schema",{enumerable:!0,configurable:!0,writable:!0,value:dt.object({input:dt.string().optional()}).transform(t=>t.input)})}call(e,t){return super.call(typeof e=="string"||!e?{input:e}:e,t)}};var pu=class extends Ei{static lc_name(){return"DallEAPIWrapper"}constructor(e){var s,i,o,u,c,l,d,h;super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"}),Object.defineProperty(this,"description",{enumerable:!0,configurable:!0,writable:!0,value:"A wrapper around OpenAI DALL-E API. Useful for when you need to generate images from a text description. Input should be an image description."}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"dall-e-3"}),Object.defineProperty(this,"style",{enumerable:!0,configurable:!0,writable:!0,value:"vivid"}),Object.defineProperty(this,"quality",{enumerable:!0,configurable:!0,writable:!0,value:"standard"}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"size",{enumerable:!0,configurable:!0,writable:!0,value:"1024x1024"}),Object.defineProperty(this,"responseFormat",{enumerable:!0,configurable:!0,writable:!0,value:"url"}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let t=(s=e==null?void 0:e.openAIApiKey)!=null?s:H("OPENAI_API_KEY"),r=(i=e==null?void 0:e.organization)!=null?i:H("OPENAI_ORGANIZATION"),a={apiKey:t,organization:r,dangerouslyAllowBrowser:!0};this.client=new J(a),this.modelName=(o=e==null?void 0:e.modelName)!=null?o:this.modelName,this.style=(u=e==null?void 0:e.style)!=null?u:this.style,this.quality=(c=e==null?void 0:e.quality)!=null?c:this.quality,this.n=(l=e==null?void 0:e.n)!=null?l:this.n,this.size=(d=e==null?void 0:e.size)!=null?d:this.size,this.responseFormat=(h=e==null?void 0:e.responseFormat)!=null?h:this.responseFormat,this.user=e==null?void 0:e.user}async _call(e){let t=await this.client.images.generate({model:this.modelName,prompt:e,n:this.n,size:this.size,response_format:this.responseFormat,style:this.style,quality:this.quality,user:this.user}),r="";return this.responseFormat==="url"?[r]=t.data.map(a=>a.url).filter(a=>a!=="undefined"):[r]=t.data.map(a=>a.b64_json).filter(a=>a!=="undefined"),r}};Object.defineProperty(pu,"toolName",{enumerable:!0,configurable:!0,writable:!0,value:"dalle_api_wrapper"});var nn={},Xd=n=>{nn[n]&&delete nn[n]},Qt=n=>{switch(!0){case n.modelName.contains("gpt"):nn[n.modelId]||(nn[n.modelId]=new Fa({openAIApiKey:n.apiKey,modelName:n.modelName,maxRetries:2,timeout:5e3,cache:!0,topP:n.topP,presencePenalty:n.topK,temperature:n.temperature}));break;case n.modelName.contains("gemini"):nn[n.modelId]||(nn[n.modelId]=new Bs({apiKey:n.apiKey,modelName:n.modelName,topK:n.topK,topP:n.topP,temperature:n.temperature,maxRetries:2,cache:!0,safetySettings:[{category:ar.HARM_CATEGORY_DANGEROUS_CONTENT,threshold:sr.BLOCK_NONE},{category:ar.HARM_CATEGORY_HARASSMENT,threshold:sr.BLOCK_NONE},{category:ar.HARM_CATEGORY_HATE_SPEECH,threshold:sr.BLOCK_NONE},{category:ar.HARM_CATEGORY_SEXUALLY_EXPLICIT,threshold:sr.BLOCK_NONE}]}));break}return nn[n.modelId]};var Pi=n=>{let e=[],t;for(let r of n)t&&t._getType()===r._getType()?t.content+=`
"""
`+r.content:(e.push(r),t=r);return e};var Ii="ai-assistant-view",Oi=class extends Ne.ItemView{constructor(e,t){super(e),this.plugin=t,this.resetConversation()}resetConversation(){this.messageListEl&&this.messageListEl.empty(),this.conversation=[new se(this.plugin.settings.systemPrompt),new ce("How can I help you?")]}async onload(){this.renderView()}renderHeader(e){let t=e.createDiv(q.header);t.createEl("h2",{text:"Use AI",cls:q.title});let r=t.createDiv({cls:q.actions}),a=t.createEl("button",{cls:"clickable-icon"});(0,Ne.setIcon)(a,"lucide-plus"),r.appendChild(a),this.registerDomEvent(a,"click",()=>{this.resetConversation(),this.renderMessageList(this.contentEl)});let s=t.createEl("button",{cls:"clickable-icon"});(0,Ne.setIcon)(s,"lucide-settings"),r.appendChild(s),t.appendChild(r)}renderSystemMessage(e,t){e.createDiv({cls:[q.messageItem,q.systemMessage]}).createDiv({cls:q.messageText,text:t.content})}renderHumanMessage(e,t){let r=e.createDiv({cls:[q.messageItem,q.humanMessage]});(0,Ne.setIcon)(r.createDiv({cls:q.avatar}),"lucide-user"),r.createDiv({cls:q.messageText,text:t.content})}renderAiMessage(e,t){let r=e.createDiv({cls:[q.messageItem,q.aiMessage]});(0,Ne.setIcon)(r.createDiv({cls:q.avatar}),"lucide-sparkles");let a=r.createDiv({cls:q.messageText,text:t.content});return{messageEl:r,messageTextEl:a}}renderMessageItem(e,t){switch(t._getType()){case"human":this.renderHumanMessage(e,t);break;case"ai":this.renderAiMessage(e,t);break;case"system":this.renderSystemMessage(e,t);break}this.contentEl.scrollTop=this.contentEl.scrollHeight}renderMessageList(e){this.messageListEl||(this.messageListEl=e.createDiv({cls:q.messageList})),this.conversation.forEach(t=>{this.renderMessageItem(this.messageListEl,t)})}async generateAiMessage(){if(this.plugin.settings.models.length===0){new Ne.Notice("No models found");return}let e=this.plugin.settings.models[0],t=Qt(e),r=Pi(this.conversation),{messageTextEl:a}=this.renderAiMessage(this.messageListEl,new ce("Loading..."));try{let s=await t.stream(r,{}),i="";for await(let o of s)i+=o.content,a.innerHTML=i,this.contentEl.scrollTop=this.contentEl.scrollHeight;this.conversation.push(new ce(i))}catch(s){a.innerHTML="Error"}}async addHumanMessage(e){e=await this.resolveMessageVariables(e);let t=new se(e);this.conversation.push(t),this.renderMessageItem(this.messageListEl,t)}async resolveMessageVariables(e){var t;if(e.includes("[[page]]")){let r=(t=this.app.workspace.getActiveFile())==null?void 0:t.path;if(!r)return e;let a=this.app.vault.getFileByPath(r);if(!a)return e;let s=r?await this.app.vault.read(a):"";s&&(e=e.replace("[[page]]",s))}if(e.includes("[[selection]]")){let r=this.app.workspace.getActiveViewOfType(Ne.MarkdownView);if(!r)return e;let a=r.editor.getSelection();a&&(e=e.replace("[[selection]]",a))}return e}renderUserInputs(e){let t=e.createDiv({cls:q.inputContainer}),r=t.createEl("div",{cls:q.textInput});r.setAttribute("contenteditable","true"),r.setAttribute("placeholder","Type a message..."),this.registerDomEvent(r,"keydown",async u=>{let c=u.shiftKey;if(u.key==="Enter"&&!u.shiftKey&&r.innerText.trim().length>0){u.preventDefault(),r.removeAttribute("contenteditable");let l=r.innerText.trim();r.innerHTML="loading...",await this.addHumanMessage(l),await this.generateAiMessage(),r.setAttribute("contenteditable","true"),r.innerHTML=""}}),this.registerDomEvent(r,"focus",()=>{t.addClass(q.focus)}),this.registerDomEvent(r,"blur",()=>{t.removeClass(q.focus)});let a=t.createDiv({cls:q.controls}),i=a.createDiv({cls:q.attachments}).createEl("button",{cls:[q.attachButton,"clickable-icon","side-dock-ribbon-action"]});i.innerText="[[page]]",this.registerDomEvent(i,"click",()=>{r.innerHTML+="[[page]]"});let o=a.createEl("button",{cls:[q.sendButton,"clickable-icon","side-dock-ribbon-action"]});(0,Ne.setIcon)(o,"lucide-send"),this.registerDomEvent(o,"click",async()=>{let u=r.innerText.trim();u&&(await this.addHumanMessage(u),await this.generateAiMessage(),r.innerHTML="")})}renderView(){this.contentEl.empty(),this.contentEl.addClass(q.container),this.renderHeader(this.contentEl),this.renderMessageList(this.contentEl),this.renderUserInputs(this.contentEl)}onunload(){super.onunload()}onPaneMenu(e,t){super.onPaneMenu(e,t),e.addItem(r=>{r.setTitle("Help..."),r.setIcon("globe"),r.onClick(()=>{open("https://twitter.com/duocdev")})})}getViewType(){return Ii}getDisplayText(){return"AI Assistant"}getIcon(){return"lucide-sparkles"}};var Qd=require("obsidian"),zn=n=>{let e=n.workspace.getActiveViewOfType(Qd.ItemView);return(e==null?void 0:e.getViewType())==="canvas"?e.canvas:null};function Ti(n,e){let t=Object.keys(e).map(r=>Hg(n,r,e[r]));return t.length===1?t[0]:function(){t.forEach(r=>r())}}function Hg(n,e,t){let r=n[e],a=n.hasOwnProperty(e),s=a?r:function(){return Object.getPrototypeOf(n)[e].apply(this,arguments)},i=t(s);return r&&Object.setPrototypeOf(i,r),Object.setPrototypeOf(o,i),n[e]=o,u;function o(...c){return i===s&&n[e]===o&&u(),i.apply(this,c)}function u(){n[e]===o&&(a?n[e]=s:delete n[e]),i!==s&&(i=s,Object.setPrototypeOf(o,r||Function))}}var fu=!1,mu=!1,gu=!1,Kg=(n,e)=>e.menu?(n.register(Ti(e.menu.constructor.prototype,{render:t=>function(...r){let a=t.call(this,...r);if(this.menuEl.children.length===0||this.canvas.selection.size!==1)return a;let s=this.canvas.selection.values().next().value;return Object.prototype.hasOwnProperty.call(s,"path")||Object.prototype.hasOwnProperty.call(s,"bgPath")||n.events.trigger("canvas:node-menu",this,this.canvas,s),a}})),!0):!1,qg=(n,e)=>{let t=Object.getPrototypeOf(e);return n.register(Ti(t,{addEdge:r=>function(...a){var s,i;return a[0].color=(i=(s=a[0].from)==null?void 0:s.node)==null?void 0:i.color,r.call(this,...a)},showCreationMenu:r=>function(...a){let s=a[0],i=a[1];return n.events.trigger("canvas:creation-menu",s,e,i),r.call(this,...a)}})),!0},Vg=(n,e)=>{let t=e.nodes;if(t.size==0)return!1;let r=Object.getPrototypeOf(t.values().next().value);return n.register(Ti(r,{render:a=>function(...s){return a.call(this,...s)},showMenu:a=>function(...s){let i=s[0];return i.addSeparator(),i.addItem(o=>{o.setTitle("Split list to notes"),o.setIcon("lucide-list"),o.onClick(()=>{n.events.trigger("canvas:split-node",e,this)})}),a.call(this,...s)}})),!0},yu=n=>{console.log("patching all");let e=zn(n.app);return e?(mu||(mu=Kg(n,e)),fu||(fu=qg(n,e)),gu||(gu=Vg(n,e)),gu&&fu&&mu):!1};var rh=require("obsidian");var za=n=>{let e=[];for(let t=0;t<n;t++)e.push((16*Math.random()|0).toString(16));return e.join("")};var eh=async(n,e,t,r,a)=>{if(!n)return;let s=n.getData();s&&(n.importData({edges:[...s.edges,{...a,id:e,fromNode:t.node.id,fromSide:t.side,toNode:r.node.id,toSide:r.side}],nodes:s.nodes}),await n.requestFrame())};var th=async(n,e)=>{if(!n)return;let t=n.getData();t&&(n.importData({edges:[...t.edges,...e],nodes:t.nodes}),await n.requestFrame())};var Ci=50,Un=80;function Wg(n,e,t,r){var l,d,h,p,m,y;let a=e.x+e.width+Un,s=e.y+e.height+Un,i=n.getEdgesForNode(e).filter(g=>g.from.node.id==e.id&&g.from.side==t).map(g=>g.to.node),o=i.reduce((g,_)=>{switch(t){case"left":case"right":return _.y>g.y?_:g;case"top":case"bottom":return _.x>g.x?_:g}},i[0]),u=(d=(l=r==null?void 0:r.size)==null?void 0:l.width)!=null?d:500,c=(p=(h=r==null?void 0:r.size)==null?void 0:h.height)!=null?p:250;switch(t){case"left":a=o?o.x+o.width-u:e.x-u-Un,s=o?o.y+o.height+Ci:e.y+e.height/2-c/2;break;case"right":a=(m=o==null?void 0:o.x)!=null?m:e.x+e.width+Un,s=o?o.y+o.height+Ci:e.y+e.height/2-c/2;break;case"top":a=o?o.x+o.width+Ci:e.x+e.width/2-u/2,s=o?o.y+o.height-c:e.y-c-Un;break;case"bottom":a=o?o.x+o.width+Ci:e.x+e.width/2-u/2,s=(y=o==null?void 0:o.y)!=null?y:e.y+e.height+Un;break}return{x:a,y:s,width:u,height:c}}var Bn=async(n,e,t,r,a)=>{var p,m,y,g;let s=n.getEdgesForNode(e).filter(_=>_.to.node.id===e.id),i="bottom",o="top";if(s.length>0){let _=s[0];_.to.side==="left"?(i="right",o="left"):_.to.side==="right"?(i="left",o="right"):_.to.side==="top"?(i="bottom",o="top"):_.to.side==="bottom"&&(i="top",o="bottom")}let{x:u,y:c,width:l,height:d}=Wg(n,e,i,t),h=n.createTextNode({pos:{x:u,y:c},size:{height:(m=(p=t==null?void 0:t.size)==null?void 0:p.height)!=null?m:d,width:(g=(y=t==null?void 0:t.size)==null?void 0:y.width)!=null?g:l},text:t==null?void 0:t.text,focus:!1});return r&&h.setData(r),n.deselectAll(),n.addNode(h),await eh(n,za(16),{side:i,node:e},{side:o,node:h},a),h};var bu=async(n,e)=>{let t=zn(n);if(!t){new rh.Notice("No active canvas");return}let a=t.selection.values().next().value;t.deselectAll();let s=await Bn(t,a,{size:{height:50,width:250}},{role:"user"});e&&await s.setText(e),await t.requestSave(),await t.requestFrame(),setTimeout(()=>{s.startEditing()},100)};var Ni=require("obsidian");function Jg(n){let t=n.canvas.getEdgesForNode(n).filter(r=>r.to.node.id===n.id).map(r=>r.from.node);return t.sort((r,a)=>a.x-r.x),t}async function nh(n,e,t=Jg){let r=new Set,a=[{node:n,depth:0}];for(;a.length>0;){let{node:s,depth:i}=a.shift();if(r.has(s.id))continue;if(!await e(s,i))break;r.add(s.id);let u=t(s);for(let c of u)r.has(c.id)||a.push({node:c,depth:i+1})}}var Pk=je(require("electron")),Si=require("obsidian");async function Yg(n,e,t){var a;let r=await n.vault.read(e);if(t){let s=n.metadataCache.getFileCache(e);if(s){let i=(0,Si.resolveSubpath)(s,t);if(!i)return console.warn("Failed to get subpath",{file:e,subpath:t}),r;if(i.start||i.end){let o=r.slice(i.start.offset,(a=i.end)==null?void 0:a.offset);return o||(console.warn("Failed to get subpath",{file:e,subpath:t}),r)}}}return r}async function Xg(n){return await n.executeJavaScript("document.body.innerText")}var Qg="https://get-youtube-transcript.fly.dev/transcripts/:id/?format=plain&chunk-size=3000&include-time=true";async function ey(n){var s;let e=(s=n.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([^&]+)/))==null?void 0:s[1];if(!e)throw new Error("Failed to get youtube id");let t=Qg.replace(":id",e),r=await fetch(t);if(!r.ok)throw new Error("Failed to get youtube transcript");return(await r.json()).join(" ")}async function ki(n){let e=n.app,t=n.getData();switch(t.type){case"text":return t.text;case"file":{let r=e.vault.getAbstractFileByPath(t.file);if(r instanceof Si.TFile){let a=await e.vault.read(r);return n.subpath?await Yg(e,r,t.subpath):`## ${r.basename}
${a}`}throw new Error("Failed to get file content")}case"link":{let r;if(t.url.includes("youtube.com"))r=await ey(t.url);else{let s=n.nodeEl.querySelector("webview");s&&(r=await Xg(s))}return r!=null?r:t.url}}}var ah=async n=>{let e=[];return await nh(n,async(r,a)=>{let s=r.getData(),i=await ki(r);return i===void 0||i.length===0||i.startsWith("function")||(s.role==="ai"?e.push(new ce(i)):s.role==="system"?e.push(new tr(i)):e.push(new se(i))),!0}),e.reverse()};var ty=(n,e,t)=>{if(e.modelName.contains("gpt"))return n.unshift(new tr(t));if(e.modelName.contains("gemini"))return n.unshift(new se(t))},ry=async(n,e,t)=>{let r=t.getData();return Object.prototype.hasOwnProperty.call(r,"role")&&r.role==="ai"?t:t.text===""?(t.setData({...t.getData(),role:"ai"}),t):Bn(n,t,{},{role:"ai"},{label:e.modelId})},ny=async(n,e,t,r)=>{let a=await ah(t);return ty(a,e,n),t.getData().role==="ai"&&a[a.length-1].content===t.text&&a.splice(-1),a[a.length-1]._getType()==="ai"&&e.modelName.contains("gemini")&&(a[a.length-1]=new se(a[a.length-1])),a=Pi(a),a},ay=async(n,e,t,r)=>{let a=Qt(n);if(!a){new Ni.Notice("Model not found");return}try{let s=await a.stream(e,{}),i="";for await(let o of s)i+=o.content,await t.setText(i);t.setData({...t.getData(),status:"generated"})}catch(s){await t.setText("Error: "+s.message)}},sy="#2d9bd2",sh=async(n,e,t,r)=>{var i;let a=await ry(t,e,r);await a.setText("Generating..."),a.setData({...a.getData(),status:"generating",model:e.modelName}),a.color=(i=e.color)!=null?i:sy;let s=[];try{s=await ny(n,e,r,t)}catch(o){new Ni.Notice("Failed to prepare conversation"),await a.setText("Error: "+o.message);return}try{t.setReadonly(!0),await ay(e,s,a,t)}catch(o){new Ni.Notice("Failed to generate content"),await a.setText("Error: "+o.message),a.setData({...a.getData(),status:"error"})}finally{t.setReadonly(!1),await t.requestSave(),await t.requestFrame()}};var ih=async(n,e,t="right")=>{let r=n.getLeavesOfType(e);if(r.length>0){n.revealLeaf(r[0]);return}let a=await iy(n,e,t);a&&n.revealLeaf(a)},iy=async(n,e,t="right")=>{let r=null;switch(t){case"left":r=n.getLeftLeaf(!1);break;case"center":r=n.getLeaf(!1);break;case"right":default:r=n.getRightLeaf(!1);break}return await(r==null?void 0:r.setViewState({type:e,active:!0})),r};var oh=n=>{let e=n.split("-")[0],t=Math.random().toString(36).substring(2,15);return`${e}-${t}`};var _u=require("obsidian");var uh=async(n,e)=>{var i;let t=await ki(e);if(!t){new _u.Notice("No content found in the selected node");return}let r=t.split(`
`).filter(o=>o.trim()!=="");if(r.length===0){new _u.Notice("No list items found in the selected node");return}let a=n.getEdgesForNode(e).filter(o=>o.to.node.id===e.id),s=[];for(let o of r){let u=await Bn(n,e,{text:o});for(let c of a)s.push({label:(i=c.label)!=null?i:"",id:za(16),fromNode:c.from.node.id,fromSide:c.from.side,toNode:u.id,toSide:c.to.side})}s.length>0&&await th(n,s),n.removeNode(e)};var an=require("obsidian");var Re=require("obsidian");var ch=["#94D1BE","#EBD2B4","#DAC4F7","#32936F","#32936F","#F08A4B","#F2A541","#06BCC1"],lh=()=>ch[Math.floor(Math.random()*ch.length)];var Et={advancedField:"_advancedField_1mnnh_1",show:"_show_1mnnh_4",autoFlow:"_autoFlow_1mnnh_7"};var Ua=class extends Re.Modal{constructor(e,t){super(e),this.model={...t}}onOpen(){let{contentEl:e}=this;new Re.Setting(e).setName("Model ID").setDesc("This id is used to mention the model in the canvas, chat").addText(a=>{var s;return a.onChange(async i=>{this.model.modelId=i}).setValue((s=this.model.modelId)!=null?s:"")}),new Re.Setting(e).setName("Model name").setDesc("This name is used to call API").addDropdown(a=>a.onChange(async s=>{this.model.modelName=s}).addOptions({"gpt-4-0125-preview":"gpt-4-0125-preview","gpt-4-turbo-preview":"gpt-4-turbo-preview","gemini-1.0-pro-001":"gemini-1.0-pro-001"}).setValue(this.model.modelName)),new Re.Setting(e).setName("API Key").addText(a=>a.setValue(this.model.apiKey).onChange(async s=>{this.model.apiKey=s})),new Re.Setting(e).setName("Advanced settings").setDesc("Only change if you know what you are doing").addToggle(a=>{a.setValue(!1).onChange(s=>{let i=e.getElementsByClassName(Et.advancedField);for(let o=0;o<i.length;o++)i[o].classList.toggle(Et.show,s)})}),new Re.Setting(e).setName("Color").setClass(Et.advancedField).setDesc("The color will be used to display the AI's response").addColorPicker(a=>{var s;return a.setValue((s=this.model.color)!=null?s:lh()).onChange(async i=>{this.model.color=i})}),new Re.Setting(e).setName("Temperature").setClass(Et.advancedField).addText(a=>{var s;return a.setValue(`${(s=this.model.temperature)!=null?s:""}`).onChange(async i=>{this.model.temperature=parseFloat(i)})}),new Re.Setting(e).setName("TopP").setClass(Et.advancedField).addText(a=>{var s;return a.setValue(`${(s=this.model.topP)!=null?s:""}`).onChange(async i=>{this.model.topP=parseFloat(i)})}),new Re.Setting(e).setName("TopK").setClass(Et.advancedField).addText(a=>{var s;return a.setValue(`${(s=this.model.topK)!=null?s:""}`).onChange(async i=>{this.model.topK=parseFloat(i)})});let t=new Re.Setting(e).setClass("hidden"),r=e.createDiv("modal-button-container");r.createEl("button",{text:"Test connection",cls:"mod-cta"}).addEventListener("click",async()=>{t.settingEl.classList.remove("hidden"),t.setName("Send a test question...");let a=Qt(this.model),s="Very short explain about LLMs temperature parameter, 1 sentence.";try{let i=await a.invoke(s);t.setName("Success").setDesc(`Question: ${s}

AI Response: ${i.content}`)}catch(i){t.setName("Error").setDesc(`Error: ${i.message}`)}}),r.createEl("button",{text:"Save",cls:"mod-cta"}).addEventListener("click",async()=>{this.onSaveCb&&this.onSaveCb.call(this,this.model),this.close()})}onSave(e){return this.onSaveCb=e,this}};var wu=class extends an.PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let{containerEl:e}=this;e.empty(),new an.Setting(e).setName("Models").setDesc("Currently, we support OpenAI GPT, Google Gemini").setHeading().addButton(t=>{t.setButtonText("Add model").onClick(()=>{new Ua(this.app,{modelName:"",modelId:"",apiKey:""}).setTitle("Add model").onSave(async r=>{this.plugin.settings.models.push(r),await this.plugin.saveSettings(),this.display()}).open()})}),this.plugin.settings.models.forEach((t,r)=>{let a=new an.Setting(e);r>0&&a.addExtraButton(s=>{s.setIcon("arrow-up").onClick(async()=>{let i=this.plugin.settings.models[r-1];this.plugin.settings.models[r-1]=this.plugin.settings.models[r],this.plugin.settings.models[r]=i,await this.plugin.saveSettings(),this.display()}).setTooltip("Set as default")}),a.addExtraButton(s=>{s.setIcon("trash").setTooltip("Remove").onClick(async()=>{this.plugin.settings.models.splice(r,1),await this.plugin.saveSettings(),this.display()})}).setName(`${t.modelId}${r===0?" (default)":""}`).addExtraButton(s=>{s.setIcon("edit").onClick(()=>{new Ua(this.app,t).setTitle("Edit model").onSave(async i=>{this.plugin.settings.models[r]=i,this.plugin.events.trigger("model-update",i),await this.plugin.saveSettings(),this.display()}).open()})})}),new an.Setting(e).setName("Default system prompt").setDesc("The system prompt sent with each request to the API.").setClass(Et.autoFlow).addTextArea(t=>{t.inputEl.rows=5,t.setValue(this.plugin.settings.systemPrompt),t.onChange(async r=>{this.plugin.settings.systemPrompt=r,await this.plugin.saveSettings()})}),new an.Setting(e).setName("Follow me on Twitter").setDesc("@duocdev").addButton(t=>{t.setCta(),t.setButtonText("Document").onClick(()=>{window.open("https://useai.aiocean.io/")})}).addButton(t=>{t.setCta(),t.setButtonText("Follow for update").onClick(()=>{window.open("https://twitter.com/duocdev")})}).addButton(t=>{t.setCta(),t.setButtonText("Bug report").onClick(()=>{window.open("https://aiocean.atlassian.net/servicedesk/customer/portal/5")})}).addButton(t=>{t.buttonEl.outerHTML="<a href='https://paypal.me/duocnguyen' target='_blank'><img style='border:0px;height:35px;' src='https://cdn.ko-fi.com/cdn/kofi3.png?v=3' /></a>"})}},dh=wu;var vu=`
You are a critical-thinking assistant bot.
Consider the intent of my questions before responding.
Do not restate my information unless I ask for it.
Do not include caveats or disclaimers.
Use step-by-step reasoning. Be brief.`,hh={models:[],systemPrompt:vu,debug:!1};var Ri=class extends Ze.Plugin{constructor(e,t,r){super(e,t),this.events=new qa}async onload(){await this.loadSettings(),await this.migrateSettings(),this.addSettingTab(new dh(this.app,this)),this.registerCommands(),this.patchObsidian(),this.registerEvents(),this.registerView(Ii,e=>new Oi(e,this)),this.addRibbonIcon("lucide-sparkles","AI Assistant",async()=>{await ih(this.app.workspace,Ii)})}appendAiButton(e,t,r,a){let s=createEl("button","clickable-icon gpt-menu-item"),i=(t==null?void 0:t.role)==="ai"?"Regenerate":"Ask question with AI",o=(t==null?void 0:t.role)==="ai"?"refresh-ccw":"lucide-sparkles";(0,Ze.setTooltip)(s,i,{placement:"top"}),(0,Ze.setIcon)(s,o),s.addEventListener("click",async()=>{this.events.trigger("canvas:node-menu:ask-question",r,a)}),e.menuEl.appendChild(s)}appendUserButton(e){let t=createEl("button","clickable-icon gpt-menu-item");(0,Ze.setTooltip)(t,"add user node",{placement:"top"}),(0,Ze.setIcon)(t,"message-square"),t.addEventListener("click",async()=>{await bu(this.app)}),e.menuEl.appendChild(t)}isMenuPatched(e){return e.menuEl.querySelector(".gpt-menu-item")!==null}isNodeGenerating(e){return(e==null?void 0:e.status)==="generating"}registerEvents(){this.registerEvent(this.events.on("canvas:node-menu",(e,t,r)=>{let a=r.getData();this.isMenuPatched(e)||this.isNodeGenerating(a)||(this.appendAiButton(e,a,t,r),this.appendUserButton(e))})),this.registerEvent(this.events.on("canvas:node-menu:ask-question",async(e,t)=>{if(this.settings.models.length===0){new Ze.Notice("API key or model is not set. Please set the API key and model in the settings");return}let r=e.getEdgesForNode(t).filter(s=>s.to.node.id===t.id).first(),a;(r==null?void 0:r.label)!==void 0&&(r==null?void 0:r.label)!==""&&(a=this.settings.models.find(s=>s.modelId===r.label)),a||(a=this.settings.models[0]),await sh(this.settings.systemPrompt,a,e,t)})),this.registerEvent(this.events.on("model-update",async e=>{Xd(e.modelName)})),this.registerEvent(this.events.on("canvas:split-node",async(e,t)=>{await uh(e,t)})),this.registerEvent(this.events.on("canvas:creation-menu",async(e,t,r)=>{e.addSeparator(),e.addItem(a=>{a.setTitle("Add prompt").setIcon("lucide-list").onClick(()=>{Ou(this.app,s=>{bu(this.app,s.prompt),t.createTextNode({pos:r,size:{height:150,width:300},text:s.prompt,focus:!1})})})}),e.addItem(a=>{a.setTitle("Add tool").setIcon("lucide-list").onClick(()=>{Eu(this.app,"This modal is for inserting tools into the canvas.")})})}))}patchObsidian(){this.app.workspace.onLayoutReady(()=>{if(yu(this))return;let e=this.app.workspace.on("layout-change",()=>{yu(this)&&this.app.workspace.offref(e)});this.registerEvent(e)})}async migrateSettings(){let e=!1;this.settings.models===void 0&&(this.settings.models=[],e=!0),this.settings.systemPrompt===void 0&&(this.settings.systemPrompt=vu,e=!0);for(let t of this.settings.models)t.modelId===void 0&&(t.modelId=oh(t.modelName),e=!0);e&&await this.saveSettings()}async loadSettings(){this.settings=Object.assign({},hh,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}registerCommands(){[{id:"split-list-to-note",name:"Split list to notes",icon:"lucide-list",checkCallback:t=>{let r=zn(this.app);if(!r)return!1;let a=r.selection;if(a.size!==1)return!1;let s=a.values().next().value;return t||this.events.trigger("canvas:split-node",r,s),!0}},{id:"continue-writing",name:"Continue writing",editorCallback:async(t,r)=>{let a=this.settings.models[0],s=Qt(a),i=t.getValue();console.log(t);try{let o=await s.stream(i,{});for await(let u of o)t.replaceRange(u.content,t.getCursor()),t.refresh()}catch(o){new Ze.Notice("Error generating content")}}}].forEach(t=>this.addCommand(t))}};
/*! Bundled license information:

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2023 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@google/generative-ai/dist/index.mjs:
  (**
   * @license
   * Copyright 2023 Google LLC
   *
   * Licensed under the Apache License, Version 2.0 (the "License");
   * you may not use this file except in compliance with the License.
   * You may obtain a copy of the License at
   *
   *   http://www.apache.org/licenses/LICENSE-2.0
   *
   * Unless required by applicable law or agreed to in writing, software
   * distributed under the License is distributed on an "AS IS" BASIS,
   * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   * See the License for the specific language governing permissions and
   * limitations under the License.
   *)

@langchain/core/dist/utils/js-sha1/hash.js:
  (*
   * [js-sha1]{@link https://github.com/emn178/js-sha1}
   *
   * @version 0.6.0
   * @author Chen, Yi-Cyuan [emn178@gmail.com]
   * @copyright Chen, Yi-Cyuan 2014-2017
   * @license MIT
   *)

@langchain/core/dist/utils/fast-json-patch/src/helpers.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

@langchain/core/dist/utils/fast-json-patch/src/duplex.js:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2013-2021 Joachim Wester
   * MIT license
   *)
*/
